---
phase: 13-vip-ritualized-entry
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/services/message/vip_entry.py (NEW FILE)
  - bot/services/message/__init__.py (update exports)
autonomous: true
estimated_minutes: 10

must_haves:
  truths:
    - "VIPEntryFlowMessages class exists with BaseMessageProvider inheritance"
    - "stage_1_activation_confirmation() returns message + keyboard with 'Continuar' button"
    - "stage_2_expectation_alignment() returns message + keyboard with 'Estoy listo' button"
    - "stage_3_access_delivery() returns message with embedded 'Cruzar el umbral' link button"
    - "expired_subscription_message() returns Lucien-voiced expiry blocking message"
    - "All messages use ðŸŽ© emoji for Lucien (no stage-specific emojis)"
    - "No variations - every VIP gets same ritual experience"
    - "VIPEntryFlowMessages accessible via container.message.user.vip_entry"
  artifacts:
    - path: "bot/services/message/vip_entry.py"
      provides: "VIPEntryFlowMessages provider with 3-stage ritual messages"
      min_lines: 150
    - path: "bot/services/message/__init__.py"
      provides: "UserMessages.vip_entry property for lazy-loaded access"
      min_lines: 20
  key_links:
    - from: "bot/services/message/vip_entry.py"
      to: "bot/handlers/user/vip_entry.py (Plan 03)"
      via: "Stage-specific message methods for each ritual phase"
      pattern: "stage_\\d+_(confirmation|alignment|delivery)"
    - from: "bot/services/message/vip_entry.py"
      to: "bot/services/message/__init__.py"
      via: "Added as UserMessages.vip_entry property for container access"
      pattern: "container.message.user.vip_entry"
---

# Plan 02: VIP Entry Flow Messages Provider

## Objective

Create VIPEntryFlowMessages provider with Lucien's voice for 3-phase ritual admission process (activation confirmation, expectation alignment, access delivery).

**Purpose:**
Centralize all VIP entry ritual messages in a stateless provider following BaseMessageProvider pattern, ensuring consistent Lucien voice across the 3-stage flow.

**Output:**
- VIPEntryFlowMessages class with 5 message methods
- All messages use exact wording from design spec
- Stage-specific keyboards with progressive button text
- Expiry blocking message with Lucien's voice

---

## Context

### BaseMessageProvider Pattern (bot/services/message/base.py)

```python
class BaseMessageProvider:
    """
    Base class for message providers.

    Enforces stateless interface:
    - No session/bot injection in __init__
    - All context passed as parameters
    - Template composition utilities available
    """

    def _create_content_with_navigation(
        self,
        body: str,
        content_buttons: List[Dict[str, str]],
        navigation_buttons: List[Dict[str, str]]
    ) -> Tuple[str, InlineKeyboardMarkup]:
        """Factory method for structured messages with keyboards."""
```

### Message Design Spec (from Phase 13 Context)

**Stage 1 (Activation Confirmation):**
> ðŸŽ© Lucien:
>
> Veo que ha dado el paso que muchos contemplanâ€¦ y pocos toman.
>
> Su acceso al DivÃ¡n de Diana estÃ¡ siendo preparado.
>
> Este no es un espacio pÃºblico.
> No es un canal mÃ¡s.
> Y definitivamente no es para quien solo siente curiosidad.
>
> Antes de entregarle la entrada, hay algo que debe saberâ€¦
>
> [Continuar]

**Stage 2 (Expectation Alignment):**
> ðŸŽ© Lucien:
>
> El DivÃ¡n no es un lugar donde se mira y se olvida.
> Es un espacio Ã­ntimo, sin filtros, sin mÃ¡scaras.
>
> AquÃ­ Diana se muestra sin la distancia de las redes,
> y eso exige discreciÃ³n, respeto y presencia real.
>
> Si ha llegado hasta aquÃ­ solo para observar de pasoâ€¦
> este es el momento de detenerse.
>
> Si entiende lo que significa entrarâ€¦ entonces sÃ­.
>
> [Estoy listo]

**Stage 3 (Access Delivery):**
> ðŸŽ© Lucien:
>
> Entonces no le harÃ© esperar mÃ¡s.
>
> Diana le abre la puerta al DivÃ¡n.
>
> Este acceso es personal.
> No se comparte.
> No se replica.
> Y se cierra cuando el vÃ­nculo termina.
>
> Tiene 24 horas para usar el enlace.
>
> Entre con intenciÃ³n.
>
> ðŸ‘‡
>
> [Cruzar el umbral] â†’ VIP invite link button

### Voice Rationale (from Phase 13 Decisions)

- **Continuous flow:** Messages reference each other as one extended conversation
- **No variations:** Every VIP gets the same ritual experience (consistency over novelty)
- **ðŸŽ© emoji only:** No stage-specific emojis (maintains visual identity)
- **Direct delivery in Stage 3:** No explicit acknowledgment of "Estoy listo" click
- **Abstract expiry time:** Show "24 hours" not timestamp

---

## Tasks

### T1: Create VIPEntryFlowMessages Provider Skeleton
**File:** `bot/services/message/vip_entry.py` (NEW FILE)

**Structure:**
```python
"""
VIP Entry Flow Messages - Lucien's voice for 3-stage ritual admission.

Phase 13: Ritualized VIP entry flow with sequential stages:
- Stage 1: Activation confirmation (mysterious acknowledgment)
- Stage 2: Expectation alignment (intimate warning)
- Stage 3: Access delivery (dramatic link delivery)

Voice Rationale:
- No variations - every VIP gets same ritual (consistency over novelty)
- Continuous flow - messages reference each other as extended conversation
- ðŸŽ© emoji only - no stage-specific emojis (maintains visual identity)
- Abstract time - show "24 hours" not timestamp (mystery over precision)
"""
import logging
from typing import Tuple, List, Dict, Optional
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder

from bot.services.message.base import BaseMessageProvider

logger = logging.getLogger(__name__)


class VIPEntryFlowMessages(BaseMessageProvider):
    """
    Message provider for VIP ritual entry flow.

    Provides 5 message methods for 3-stage admission ritual:
    - Stage 1: Activation confirmation with "Continuar" button
    - Stage 2: Expectation alignment with "Estoy listo" button
    - Stage 3: Access delivery with embedded "Cruzar el umbral" link button
    - Expiry: Lucien-voiced blocking message for expired subscriptions
    - Resumption: Seamless return to current stage after abandonment

    All messages use Lucien's voice with ðŸŽ© emoji (no variations).
    """

    def __init__(self):
        """Initialize provider (stateless, no dependencies)."""
        super().__init__()
        logger.debug("âœ… VIPEntryFlowMessages inicializado")

    # ===== STAGE 1: ACTIVATION CONFIRMATION =====

    def stage_1_activation_confirmation(self) -> Tuple[str, InlineKeyboardMarkup]:
        """
        Stage 1: Mysterious acknowledgment emphasizing exclusivity.

        Message: "Veo que ha dado el paso que muchos contemplan... y pocos toman."
        Button: "Continuar" (advances to Stage 2)

        Returns:
            Tuple of (message_text, keyboard_markup)

        Voice Rationale:
            Creates mystery and exclusivity perception.
            References "few take this step" to validate user's commitment.
            Hints at something important to know before access (builds anticipation).
        """
        pass  # Implement in T2

    # ===== STAGE 2: EXPECTATION ALIGNMENT =====

    def stage_2_expectation_alignment(self) -> Tuple[str, InlineKeyboardMarkup]:
        """
        Stage 2: Intimate warning about the nature of the space.

        Message: "El DivÃ¡n no es un lugar donde se mira y se olvida..."
        Button: "Estoy listo" (commits to Stage 3)

        Returns:
            Tuple of (message_text, keyboard_markup)

        Voice Rationale:
            Sets expectations about intimate, unfiltered content.
            Warns about "no masks" and "real presence" required.
            Gives opportunity to opt out before final commitment.
        """
        pass  # Implement in T3

    # ===== STAGE 3: ACCESS DELIVERY =====

    def stage_3_access_delivery(
        self,
        invite_link: str
    ) -> Tuple[str, InlineKeyboardMarkup]:
        """
        Stage 3: Dramatic delivery with VIP channel invite link.

        Message: "Entonces no le harÃ© esperar mÃ¡s. Diana le abre la puerta..."
        Button: "Cruzar el umbral" â†’ opens invite link

        Args:
            invite_link: VIP channel invite link URL

        Returns:
            Tuple of (message_text, keyboard_markup)

        Voice Rationale:
            Dramatic culmination of ritual ("no le harÃ© esperar mÃ¡s").
            Emphasizes link is personal, non-shareable, expires with subscription.
            Abstract time ("24 hours") not timestamp (mystery over precision).
            Direct delivery - no acknowledgment of "Estoy listo" click.
        """
        pass  # Implement in T4

    # ===== EXPIRY & CANCELLATION =====

    def expired_subscription_message(self) -> str:
        """
        Lucien-voiced expiry message blocking further progress.

        Shown when VIPSubscriber expires during Stages 1-2.

        Returns:
            Message text (no keyboard - flow blocked)

        Voice Rationale:
            Consistent with ritual tone (not neutral system message).
            Maintains mystery even in rejection.
            No retry option - subscription must be renewed.
        """
        pass  # Implement in T5

    def stage_resumption_message(self, stage: int) -> str:
        """
        Seamless return to current stage after abandonment.

        Shown when user returns to flow after leaving (no time limit).

        Args:
            stage: Current vip_entry_stage (1, 2, or 3)

        Returns:
            Message text (no keyboard - uses stage-specific keyboard)

        Voice Rationale:
            No acknowledgment of time gap (seamless resumption).
            Brief reminder of current stage context.
            Does NOT show "you've been away" message (breaks immersion).
        """
        pass  # Implement in T5
```

**Acceptance:**
- [ ] File created with VIPEntryFlowMessages class
- [ ] Inherits from BaseMessageProvider
- [ ] All 5 method signatures defined with docstrings
- [ ] Docstrings include Voice Rationale sections
- [ ] No __init__ parameters (stateless pattern)

---

### T2: Implement Stage 1 Activation Confirmation
**File:** `bot/services/message/vip_entry.py`

**Implementation:**
```python
def stage_1_activation_confirmation(self) -> Tuple[str, InlineKeyboardMarkup]:
    """
    Stage 1: Mysterious acknowledgment emphasizing exclusivity.

    Message: "Veo que ha dado el paso que muchos contemplan... y pocos toman."
    Button: "Continuar" (advances to Stage 2)

    Returns:
        Tuple of (message_text, keyboard_markup)

    Voice Rationale:
        Creates mystery and exclusivity perception.
        References "few take this step" to validate user's commitment.
        Hints at something important to know before access (builds anticipation).
    """
    # Message body (exact wording from spec)
    body = """Veo que ha dado el paso que muchos contemplanâ€¦ y pocos toman.

Su acceso al DivÃ¡n de Diana estÃ¡ siendo preparado.

Este no es un espacio pÃºblico.
No es un canal mÃ¡s.
Y definitivamente no es para quien solo siente curiosidad.

Antes de entregarle la entrada, hay algo que debe saberâ€¦"""

    # Format with Lucien's header
    message = f"ðŸŽ© Lucien:\n\n{body}"

    # Create keyboard with "Continuar" button
    keyboard = InlineKeyboardBuilder()
    keyboard.button(
        text="Continuar",
        callback_data="vip_entry:stage_2"
    )

    return message, keyboard.as_markup()
```

**Acceptance:**
- [ ] Message uses exact wording from spec
- [ ] ðŸŽ© Lucien: header included
- [ ] "Continuar" button with callback_data="vip_entry:stage_2"
- [ ] Message formatted with proper line breaks
- [ ] No variations (static text)

---

### T3: Implement Stage 2 Expectation Alignment
**File:** `bot/services/message/vip_entry.py`

**Implementation:**
```python
def stage_2_expectation_alignment(self) -> Tuple[str, InlineKeyboardMarkup]:
    """
    Stage 2: Intimate warning about the nature of the space.

    Message: "El DivÃ¡n no es un lugar donde se mira y se olvida..."
    Button: "Estoy listo" (commits to Stage 3)

    Returns:
        Tuple of (message_text, keyboard_markup)

    Voice Rationale:
        Sets expectations about intimate, unfiltered content.
        Warns about "no masks" and "real presence" required.
        Gives opportunity to opt out before final commitment.
    """
    # Message body (exact wording from spec)
    body = """El DivÃ¡n no es un lugar donde se mira y se olvida.
Es un espacio Ã­ntimo, sin filtros, sin mÃ¡scaras.

AquÃ­ Diana se muestra sin la distancia de las redes,
y eso exige discreciÃ³n, respeto y presencia real.

Si ha llegado hasta aquÃ­ solo para observar de pasoâ€¦
este es el momento de detenerse.

Si entiende lo que significa entrarâ€¦ entonces sÃ­."""

    # Format with Lucien's header
    message = f"ðŸŽ© Lucien:\n\n{body}"

    # Create keyboard with "Estoy listo" button
    keyboard = InlineKeyboardBuilder()
    keyboard.button(
        text="Estoy listo",
        callback_data="vip_entry:stage_3"
    )

    return message, keyboard.as_markup()
```

**Acceptance:**
- [ ] Message uses exact wording from spec
- [ ] ðŸŽ© Lucien: header included
- [ ] "Estoy listo" button with callback_data="vip_entry:stage_3"
- [ ] Proper line breaks and paragraph spacing
- [ ] No variations (static text)

---

### T4: Implement Stage 3 Access Delivery
**File:** `bot/services/message/vip_entry.py`

**Implementation:**
```python
def stage_3_access_delivery(
    self,
    invite_link: str
) -> Tuple[str, InlineKeyboardMarkup]:
    """
    Stage 3: Dramatic delivery with VIP channel invite link.

    Message: "Entonces no le harÃ© esperar mÃ¡s. Diana le abre la puerta..."
    Button: "Cruzar el umbral" â†’ opens invite link

    Args:
        invite_link: VIP channel invite link URL

    Returns:
        Tuple of (message_text, keyboard_markup)

    Voice Rationale:
        Dramatic culmination of ritual ("no le harÃ© esperar mÃ¡s").
        Emphasizes link is personal, non-shareable, expires with subscription.
        Abstract time ("24 hours") not timestamp (mystery over precision).
        Direct delivery - no acknowledgment of "Estoy listo" click.
    """
    # Message body (exact wording from spec)
    body = """Entonces no le harÃ© esperar mÃ¡s.

Diana le abre la puerta al DivÃ¡n.

Este acceso es personal.
No se comparte.
No se replica.
Y se cierra cuando el vÃ­nculo termina.

Tiene 24 horas para usar el enlace.

Entre con intenciÃ³n.

ðŸ‘‡"""

    # Format with Lucien's header
    message = f"ðŸŽ© Lucien:\n\n{body}"

    # Create keyboard with "Cruzar el umbral" button (URL button)
    keyboard = InlineKeyboardBuilder()
    keyboard.button(
        text="Cruzar el umbral",
        url=invite_link  # URL button, not callback
    )

    return message, keyboard.as_markup()
```

**Acceptance:**
- [ ] Message uses exact wording from spec
- [ ] ðŸŽ© Lucien: header included
- [ ] "Cruzar el umbral" button with url=invite_link (not callback_data)
- [ ] "ðŸ‘‡" indicator before button (visual cue)
- [ ] No variations (static text)
- [ ] Abstract time ("24 hours") not timestamp

---

### T5: Implement Expiry and Resumption Messages
**File:** `bot/services/message/vip_entry.py`

**Implementation:**
```python
def expired_subscription_message(self) -> str:
    """
    Lucien-voiced expiry message blocking further progress.

    Shown when VIPSubscriber expires during Stages 1-2.

    Returns:
        Message text (no keyboard - flow blocked)

    Voice Rationale:
        Consistent with ritual tone (not neutral system message).
        Maintains mystery even in rejection.
        No retry option - subscription must be renewed.
    """
    # Claude's discretion: Use Lucien's voice for expiry
    message = """ðŸŽ© Lucien:

El tiempo en el DivÃ¡n es limitadoâ€¦ y su tiempo ha concluido.

El vÃ­nculo que le permitÃ­a el acceso se ha disuelto.

Si desea volver al cÃ­rculo, deberÃ¡ renovar su conexiÃ³n.

El umbral permanece cerrado hasta entonces."""

    return message


def stage_resumption_message(self, stage: int) -> str:
    """
    Seamless return to current stage after abandonment.

    Shown when user returns to flow after leaving (no time limit).

    Args:
        stage: Current vip_entry_stage (1, 2, or 3)

    Returns:
        Message text (no keyboard - uses stage-specific keyboard)

    Voice Rationale:
        No acknowledgment of time gap (seamless resumption).
        Brief reminder of current stage context.
        Does NOT show "you've been away" message (breaks immersion).
    """
    if stage == 1:
        return "ðŸŽ© Lucien:\n\nContinuemos donde nos quedamos."
    elif stage == 2:
        return "ðŸŽ© Lucien:\n\nEstaba a punto de contarle lo que debe saber."
    elif stage == 3:
        return "ðŸŽ© Lucien:\n\nLa puerta estÃ¡ abierta. El enlace espera."
    else:
        return "ðŸŽ© Lucien:\n\nContinuemos."
```

**Acceptance:**
- [ ] expired_subscription_message() uses Lucien's voice (not neutral)
- [ ] expired_subscription_message() has no keyboard (blocks continuation)
- [ ] stage_resumption_message() has stage-specific context (1/2/3)
- [ ] stage_resumption_message() does NOT mention time gap (seamless)
- [ ] All messages use ðŸŽ© emoji

---

### T6: Add VIPEntryFlowMessages to LucienVoiceService
**File:** `bot/services/message/__init__.py`

**Location:** In the UserMessages class (after line 286)

**Changes:**
```python
# 1. Add VIPEntryFlowMessages to imports (at top of file)
from .vip_entry import VIPEntryFlowMessages

# 2. Update __all__ list to include VIPEntryFlowMessages
__all__ = [
    # ... existing exports ...
    "VIPEntryFlowMessages",
]

# 3. In UserMessages class, add vip_entry property (after self._menu = None)
class UserMessages:
    def __init__(self):
        self._start = None
        self._flows = None
        self._menu = None
        self._vip_entry = None  # NEW

    @property
    def vip_entry(self):
        """
        VIP entry flow messages (Phase 13 Plan 02) âœ… NEW.

        Lazy-loaded: creates VIPEntryFlowMessages instance on first access.
        Provides 3-stage ritual admission messages with Lucien's voice.

        Returns:
            VIPEntryFlowMessages: Provider for VIP entry ritual messages

        Examples:
            >>> user = UserMessages()
            >>> text, kb = user.vip_entry.stage_1_activation_confirmation()
            >>> 'ðŸŽ© Lucien:' in text and 'pocos toman' in text
            True
        """
        if self._vip_entry is None:
            from .vip_entry import VIPEntryFlowMessages
            self._vip_entry = VIPEntryFlowMessages()
        return self._vip_entry
```

**Acceptance:**
- [ ] VIPEntryFlowMessages imported at module level
- [ ] VIPEntryFlowMessages added to __all__ list
- [ ] vip_entry property added to UserMessages class
- [ ] Property follows lazy-loading pattern (if None check)
- [ ] Docstring includes example usage
- [ ] No import errors when running bot

---

## Verification

### Pre-Commit Verification:
1. **Import test:** `from bot.services.message.vip_entry import VIPEntryFlowMessages` - no errors
2. **Method existence:** All 5 methods exist and are callable
3. **Base class:** Inherits from BaseMessageProvider
4. **Callback patterns:** vip_entry:stage_2, vip_entry:stage_3

### Post-Commit Testing:
```python
# Test Stage 1
provider = VIPEntryFlowMessages()
msg1, kb1 = provider.stage_1_activation_confirmation()
assert "ðŸŽ© Lucien:" in msg1
assert "pocos toman" in msg1
assert "Continuar" in kb1.keyboard[0][0].text
assert kb1.keyboard[0][0].callback_data == "vip_entry:stage_2"

# Test Stage 2
msg2, kb2 = provider.stage_2_expectation_alignment()
assert "sin mÃ¡scaras" in msg2
assert "Estoy listo" in kb2.keyboard[0][0].text
assert kb2.keyboard[0][0].callback_data == "vip_entry:stage_3"

# Test Stage 3
msg3, kb3 = provider.stage_3_access_delivery("https://t.me/+abc123")
assert "Diana le abre la puerta" in msg3
assert "24 horas" in msg3
assert "Cruzar el umbral" in kb3.keyboard[0][0].text
assert kb3.keyboard[0][0].url == "https://t.me/+abc123"

# Test expiry
msg_exp = provider.expired_subscription_message()
assert "ðŸŽ© Lucien:" in msg_exp
assert "vÃ­nculo" in msg_exp.lower()

# Test resumption
msg_res1 = provider.stage_resumption_message(1)
assert "Continuemos" in msg_res1
```

---

## Integration Notes

**Callback Patterns:**
- Stage 1 â†’ Stage 2: `vip_entry:stage_2`
- Stage 2 â†’ Stage 3: `vip_entry:stage_3`
- Stage 3: URL button (no callback, direct link)

**Handler Integration (Plan 03):**
```python
# In vip_entry.py handlers - access via container.message.user.vip_entry
from bot.services.container import ServiceContainer

async def show_stage_1(message: Message, container: ServiceContainer):
    # VIPEntryFlowMessages accessed via user namespace
    provider = container.message.user.vip_entry
    text, keyboard = provider.stage_1_activation_confirmation()
    await message.answer(text, reply_markup=keyboard)
```

**Integration Point:**
- VIPEntryFlowMessages added as `user.vip_entry` in LucienVoiceService
- Accessed via `container.message.user.vip_entry` (not `container.message.vip_entry`)
- Follows same pattern as user.start, user.flows, user.menu

**Voice Consistency:**
- No variations - every VIP sees same messages
- ðŸŽ© emoji only (no stage-specific emojis)
- Continuous flow (messages reference each other)

---

## Output

After completion, create `.planning/phases/13-vip-ritualized-entry/13-02-SUMMARY.md` with:
- VIPEntryFlowMessages class structure
- All 5 message methods with exact wording
- Callback pattern documentation
- Voice rationale summary
