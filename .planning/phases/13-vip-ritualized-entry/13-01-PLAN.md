---
phase: 13-vip-ritualized-entry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/database/models.py
  - bot/services/subscription.py
autonomous: true
estimated_minutes: 8

must_haves:
  truths:
    - "VIPSubscriber model has vip_entry_stage column (Integer, default=1)"
    - "VIPSubscriber model has vip_entry_token column (String(64), unique, nullable)"
    - "VIPSubscriber model has invite_link_sent_at column (DateTime, nullable)"
    - "Index idx_vip_entry_stage exists on vip_subscribers table"
    - "activate_vip_subscription() sets vip_entry_stage=1 for new subscribers"
    - "Existing active subscribers (migration) have vip_entry_stage=NULL"
  artifacts:
    - path: "bot/database/models.py"
      provides: "VIPSubscriber model with entry stage fields"
      min_lines: 20
    - path: "bot/services/subscription.py"
      provides: "activate_vip_subscription() with stage initialization"
      min_lines: 10
  key_links:
    - from: "bot/database/models.py"
      to: "bot/services/vip_entry.py (Plan 04)"
      via: "vip_entry_stage field for stage tracking"
      pattern: "vip_entry_stage"
    - from: "bot/services/subscription.py"
      to: "bot/handlers/user/start.py (Plan 03)"
      via: "activate_vip_subscription() initializes stage=1"
      pattern: "vip_entry_stage = 1"
---

# Plan 01: Database Extension - VIP Entry Stage Fields

## Objective

Extend VIPSubscriber model with fields to track 3-stage VIP entry ritual progression and update activation logic to initialize stage=1 for new subscribers.

**Purpose:**
Enable tracking of user progress through the ritualized VIP entry flow (Stage 1 ‚Üí Stage 2 ‚Üí Stage 3 ‚Üí complete) while maintaining backward compatibility with existing subscribers.

**Output:**
- VIPSubscriber model with 3 new fields: vip_entry_stage, vip_entry_token, invite_link_sent_at
- Updated activate_vip_subscription() method to set vip_entry_stage=1
- Database migration documentation for existing subscribers

---

## Context

### Current VIPSubscriber Model (bot/database/models.py, line 256+)

```python
class VIPSubscriber(Base):
    __tablename__ = "vip_subscribers"

    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(BigInteger, ForeignKey("users.user_id"), unique=True, nullable=False, index=True)
    join_date = Column(DateTime, default=datetime.utcnow, nullable=False)
    expiry_date = Column(DateTime, nullable=False)
    status = Column(String(20), default="active", nullable=False, index=True)
    token_id = Column(Integer, ForeignKey("invitation_tokens.id"), nullable=False)

    # Relationships
    token = relationship("InvitationToken", back_populates="subscribers")
    user = relationship("User", uselist=False, lazy="selectin")
```

**Current Flow:**
- Token activated ‚Üí VIPSubscriber created with status="active"
- UserRole set to VIP immediately
- Invite link sent immediately via deep_link_activation_success()

### New Fields Needed

**Field 1: vip_entry_stage**
- Type: Integer (nullable)
- Default: 1 (start at stage 1)
- Purpose: Track progress through ritual (1 ‚Üí 2 ‚Üí 3 ‚Üí NULL)
- NULL value: Flow completed (for existing subscribers and post-Stage 3)

**Field 2: vip_entry_token**
- Type: String(64) (nullable, unique)
- Purpose: One-time token for Stage 3 invite link generation
- Unique constraint: Prevents token reuse
- NULL value: Not yet at Stage 3, or already used

**Field 3: invite_link_sent_at**
- Type: DateTime (nullable)
- Purpose: Track when Stage 3 link was sent (for 24h expiry)
- NULL value: Not yet at Stage 3
- Used by: Background task to check link expiry

---

## Tasks

### T1: Add VIP Entry Stage Fields to VIPSubscriber Model
**File:** `bot/database/models.py`

**Location:** After line 280 (after status column, before token_id)

**Changes:**
```python
class VIPSubscriber(Base):
    __tablename__ = "vip_subscribers"

    # ... existing fields ...

    status = Column(String(20), default="active", nullable=False, index=True)

    # VIP Entry Ritual Fields (Phase 13)
    vip_entry_stage = Column(Integer, nullable=True, default=1, index=True)  # 1, 2, 3, or NULL (complete)
    vip_entry_token = Column(String(64), unique=True, nullable=True)  # One-time token for Stage 3 link
    invite_link_sent_at = Column(DateTime, nullable=True)  # When Stage 3 link was generated

    # Token used
    token_id = Column(Integer, ForeignKey("invitation_tokens.id"), nullable=False)
```

**Index Addition:**
```python
# Add to __table_args__ (after existing Index)
__table_args__ = (
    Index('idx_status_expiry', 'status', 'expiry_date'),
    Index('idx_vip_entry_stage', 'vip_entry_stage'),  # NEW: Stage lookup optimization
)
```

**Docstring Update:**
Add to class docstring:
```python
"""
Suscriptores del canal VIP.

Cada suscriptor:
- Canje√≥ un token de invitaci√≥n
- Tiene fecha de expiraci√≥n
- Puede estar activo o expirado
- Progresa por ritual de entrada en 3 etapas (Phase 13)

Etapa de entrada (vip_entry_stage):
- 1: Confirmaci√≥n de activaci√≥n
- 2: Alineaci√≥n de expectativas
- 3: Entrega de enlace de acceso
- NULL: Ritual completado (acceso concedido)

Campos de ritual:
- vip_entry_stage: Etapa actual (1-3) o NULL (completado)
- vip_entry_token: Token √∫nico para enlace de etapa 3
- invite_link_sent_at: Timestamp de generaci√≥n de enlace
"""
```

**Acceptance:**
- [ ] vip_entry_stage column added (Integer, nullable, default=1, indexed)
- [ ] vip_entry_token column added (String(64), unique, nullable)
- [ ] invite_link_sent_at column added (DateTime, nullable)
- [ ] Index idx_vip_entry_stage added to __table_args__
- [ ] Class docstring updated with Phase 13 ritual description

---

### T2: Update activate_vip_subscription() to Initialize Stage
**File:** `bot/services/subscription.py`

**Location:** activate_vip_subscription() method (line 312+)

**Current Code:**
```python
async def activate_vip_subscription(
    self,
    user_id: int,
    token_id: int,
    duration_hours: int
) -> VIPSubscriber:
    """
    Activa una suscripci√≥n VIP para un usuario (m√©todo privado de deep link).

    NUEVO: Usado por el flujo de deep link para activar autom√°ticamente
    la suscripci√≥n sin pasar por el flujo de canje manual.

    Args:
        user_id: ID del usuario que activa
        token_id: ID del token a usar
        duration_hours: Duraci√≥n de la suscripci√≥n en horas

    Returns:
        VIPSubscriber: Suscriptor creado o actualizado
    """
```

**Changes:**
1. Update docstring to mention vip_entry_stage initialization
2. Set vip_entry_stage=1 when creating new VIPSubscriber
3. Keep vip_entry_stage=NULL for existing subscribers (renewals)

**Implementation:**
```python
async def activate_vip_subscription(
    self,
    user_id: int,
    token_id: int,
    duration_hours: int
) -> VIPSubscriber:
    """
    Activa una suscripci√≥n VIP para un usuario (m√©todo privado de deep link).

    NUEVO: Usado por el flujo de deep link para activar autom√°ticamente
    la suscripci√≥n sin pasar por el flujo de canje manual.

    Phase 13: Inicializa vip_entry_stage=1 para nuevos suscriptores,
    iniciando el flujo ritualizado de entrada en 3 etapas.

    Args:
        user_id: ID del usuario que activa
        token_id: ID del token a usar
        duration_hours: Duraci√≥n de la suscripci√≥n en horas

    Returns:
        VIPSubscriber: Suscriptor creado o actualizado
    """
    # Calculate expiry
    expiry_date = datetime.utcnow() + timedelta(hours=duration_hours)

    # Check if subscriber already exists (renewal)
    from sqlalchemy import select

    result = await self.session.execute(
        select(VIPSubscriber).where(VIPSubscriber.user_id == user_id)
    )
    existing_subscriber = result.scalar_one_or_none()

    if existing_subscriber:
        # Renew existing subscription
        existing_subscriber.expiry_date = expiry_date
        existing_subscriber.status = "active"
        existing_subscriber.token_id = token_id

        # Phase 13: Reset entry stage if expired, otherwise keep NULL (completed)
        if existing_subscriber.vip_entry_stage is not None:
            existing_subscriber.vip_entry_stage = 1  # Restart ritual

        subscriber = existing_subscriber
        logger.info(f"üîÑ Suscripci√≥n VIP renovada para user {user_id}")
    else:
        # Create new subscription with vip_entry_stage=1
        subscriber = VIPSubscriber(
            user_id=user_id,
            token_id=token_id,
            join_date=datetime.utcnow(),
            expiry_date=expiry_date,
            status="active",
            vip_entry_stage=1  # Phase 13: Start ritual at stage 1
        )
        self.session.add(subscriber)
        logger.info(f"‚úÖ Nueva suscripci√≥n VIP creada para user {user_id} (stage=1)")

    return subscriber
```

**Acceptance:**
- [ ] New subscribers get vip_entry_stage=1
- [ ] Renewals preserve vip_entry_stage=NULL if already completed
- [ ] Renewals reset vip_entry_stage=1 if ritual was in progress
- [ ] Docstring updated with Phase 13 behavior
- [ ] Logging includes stage information

---

### T3: Create Database Migration Documentation
**File:** `.planning/phases/13-vip-ritualized-entry/DATABASE_MIGRATION.md`

**Content:**
```markdown
# Database Migration - Phase 13: VIP Entry Stage Fields

## Overview
Add 3 new fields to vip_subscribers table to track 3-stage ritual entry flow.

## New Fields

### vip_entry_stage
- Type: INTEGER (nullable)
- Default: 1
- Purpose: Track progress through ritual (1 ‚Üí 2 ‚Üí 3 ‚Üí NULL)
- Index: Yes (idx_vip_entry_stage)

### vip_entry_token
- Type: VARCHAR(64) (nullable, unique)
- Purpose: One-time token for Stage 3 invite link generation

### invite_link_sent_at
- Type: TIMESTAMP (nullable)
- Purpose: Track when Stage 3 link was sent (24h expiry)

## SQL Migration

### Option 1: Automatic (SQLAlchemy)
SQLAlchemy will create these columns automatically on next app start via `create_all()`.
New columns are nullable, so existing records work without manual migration.

### Option 2: Manual SQL
```sql
-- Add new columns
ALTER TABLE vip_subscribers ADD COLUMN vip_entry_stage INTEGER DEFAULT 1;
ALTER TABLE vip_subscribers ADD COLUMN vip_entry_token VARCHAR(64) UNIQUE;
ALTER TABLE vip_subscribers ADD COLUMN invite_link_sent_at TIMESTAMP;

-- Create index
CREATE INDEX idx_vip_entry_stage ON vip_subscribers(vip_entry_stage);

-- Set NULL for existing active subscribers (skip ritual flow)
UPDATE vip_subscribers SET vip_entry_stage = NULL
WHERE status = 'active' AND vip_entry_stage = 1;

-- Verify
SELECT COUNT(*) FROM vip_subscribers WHERE vip_entry_stage IS NULL;  -- Existing active subs
SELECT COUNT(*) FROM vip_subscribers WHERE vip_entry_stage = 1;      -- New activations
```

## Backward Compatibility

### Existing Active Subscribers
- vip_entry_stage = NULL (skip ritual, already have access)
- Continue to work normally
- No change to existing behavior

### New VIP Activations
- vip_entry_stage = 1 (start ritual)
- Go through 3-stage flow before accessing channel
- UserRole remains FREE until Stage 3 completion

## Rollback
```sql
DROP INDEX IF EXISTS idx_vip_entry_stage;
ALTER TABLE vip_subscribers DROP COLUMN IF EXISTS vip_entry_stage;
ALTER TABLE vip_subscribers DROP COLUMN IF EXISTS vip_entry_token;
ALTER TABLE vip_subscribers DROP COLUMN IF EXISTS invite_link_sent_at;
```
```

**Acceptance:**
- [ ] Migration documentation created
- [ ] Both automatic (SQLAlchemy) and manual SQL options documented
- [ ] Backward compatibility explained
- [ ] Rollback instructions provided

---

## Verification

### Pre-Commit Verification:
1. **Import test:** `from bot.database.models import VIPSubscriber` - no errors
2. **Field existence:** `hasattr(VIPSubscriber, 'vip_entry_stage')` - True
3. **Index existence:** Check table has idx_vip_entry_stage index
4. **Service method:** `activate_vip_subscription()` sets vip_entry_stage=1

### Post-Commit Testing:
```python
# Test new subscriber creation
subscriber = await container.subscription.activate_vip_subscription(
    user_id=123456,
    token_id=1,
    duration_hours=24
)
assert subscriber.vip_entry_stage == 1  # New subs start at stage 1
assert subscriber.vip_entry_token is None  # No token yet
assert subscriber.invite_link_sent_at is None  # No link yet

# Test renewal (existing subscriber)
existing_sub = await container.subscription.get_vip_subscriber(123456)
existing_sub.vip_entry_stage = None  # Completed flow
renewed = await container.subscription.activate_vip_subscription(
    user_id=123456,
    token_id=2,
    duration_hours=24
)
assert renewed.vip_entry_stage is None  # Preserves completed state
```

---

## Integration Notes

**Breaking Changes:** None
- New fields are nullable with sensible defaults
- Existing subscribers get vip_entry_stage=NULL (skip flow)

**Data Migration:**
- SQLAlchemy auto-creates columns (create_all)
- Manual SQL sets NULL for existing active subscribers
- No downtime required

**Service Integration:**
- Plan 02 (Messages Provider) uses vip_entry_stage for message selection
- Plan 03 (FSM Handlers) checks vip_entry_stage for state transitions
- Plan 04 (VIPEntryService) advances vip_entry_stage through flow

---

## Output

After completion, create `.planning/phases/13-vip-ritualized-entry/13-01-SUMMARY.md` with:
- Database schema changes (3 new fields + 1 index)
- activate_vip_subscription() modification details
- Migration strategy (automatic vs manual SQL)
- Backward compatibility explanation
