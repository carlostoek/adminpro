---
wave: 2
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - bot/handlers/user/start.py
  - bot/handlers/user/free_flow.py
autonomous: true
---

# 03-04: Handler Migration & Cleanup

## Goal
Migrate user handlers (start.py, free_flow.py) to use UserMessages providers, remove deprecated vip_flow.py, and validate all E2E tests still pass.

## Context
Current user handlers have 327 lines of hardcoded messages across 3 files:
- `start.py` (327 lines) - /start command with deep link activation, role detection
- `vip_flow.py` (189 lines) - **BEING REMOVED** - Manual token redemption deprecated
- `free_flow.py` (93 lines) - Free channel request with duplicate handling

Phase 2 proved migration pattern with admin handlers:
1. Import message service via ServiceContainer
2. Replace hardcoded f-strings with provider method calls
3. Remove keyboard construction (delegated to provider)
4. Validate E2E tests still pass

Key differences for user handlers:
- Time-of-day greetings work automatically (datetime.now() in provider)
- Role detection stays in handler (is_admin, is_vip checks)
- Deep link activation uses celebratory messaging
- Free request shows wait time from config

## Tasks

<tasks>
<task>
<summary>Migrate bot/handlers/user/start.py to use UserStartMessages</summary>
<details>
- Open `bot/handlers/user/start.py`
- Add import: `from bot.services.message import LucienVoiceService` (if not present)
- Update `_send_welcome_message()` function:
  - Remove hardcoded greeting messages
  - Remove time-of-day detection logic
  - Remove role-based message construction
  - Replace with: `text, keyboard = container.message.user.start.greeting(user_name, is_admin, is_vip, vip_days_remaining)`
  - Remove manual keyboard construction
- Update `_activate_token_from_deeplink()` function:
  - Remove hardcoded success messages
  - Remove hardcoded error messages
  - Success: Use `container.message.user.start.deep_link_activation_success(user_name, plan_name, duration_days, price, days_remaining, invite_link)`
  - Error: Use `container.message.user.start.deep_link_activation_error(error_type, details)`
  - Remove manual message formatting
- Keep all business logic (role detection, VIP checks, token validation)
- Keep FSM state management
- Only replace text/keyboard generation
</details>
<verification>- start.py uses container.message.user.start.greeting()
- start.py uses container.message.user.start.deep_link_activation_success()
- start.py uses container.message.user.start.deep_link_activation_error()
- Zero hardcoded message strings remain
- Zero manual keyboard construction
- Business logic intact (role detection, token validation)
- FSM state management unchanged
- Type hints maintained</verification>
</task>

<task>
<summary>Migrate bot/handlers/user/free_flow.py to use UserFlowMessages</summary>
<details>
- Open `bot/handlers/user/free_flow.py`
- Add import: `from bot.services.message import LucienVoiceService` (if not present)
- Update `callback_request_free()` handler:
  - Remove hardcoded success message
  - Replace with: `text = container.message.user.flows.free_request_success(wait_time_minutes)`
  - Remove manual message formatting
- Update duplicate request handling:
  - Remove hardcoded duplicate message
  - Calculate time_elapsed and time_remaining (business logic)
  - Replace with: `text = container.message.user.flows.free_request_duplicate(time_elapsed, time_remaining)`
  - Remove manual message formatting
- Add error handling for edge cases:
  - If channel not configured: `container.message.user.flows.free_request_error("channel_not_configured")`
  - If user already in channel: `container.message.user.flows.free_request_error("already_in_channel")`
  - If rate limited: `container.message.user.flows.free_request_error("rate_limited")`
- Keep all business logic (request creation, duplicate detection, wait time calculation)
- Keep FSM state management
- Only replace text generation
</details>
<verification>- free_flow.py uses container.message.user.flows.free_request_success()
- free_flow.py uses container.message.user.flows.free_request_duplicate()
- free_flow.py uses container.message.user.flows.free_request_error()
- Zero hardcoded message strings remain
- Business logic intact (request creation, duplicate checks)
- FSM state management unchanged
- Error cases handled with provider methods
- Type hints maintained</verification>
</task>

<task>
<summary>Remove bot/handlers/user/vip_flow.py file</summary>
<details>
- Delete file `bot/handlers/user/vip_flow.py` (189 lines)
- Manual token redemption is deprecated - only deep link activation exists
- Update `bot/handlers/user/__init__.py`:
  - Remove import of vip_flow module or TokenRedemptionStates
  - Remove vip_router if exported
  - Keep start and free_flow imports
- Verify no other files import vip_flow:
  - Grep codebase for "from bot.handlers.user import vip_flow"
  - Grep for "user.vip_flow" imports
  - Remove any remaining references
</details>
<verification>- vip_flow.py file deleted
- __init__.py no longer imports vip_flow
- No remaining imports of vip_flow in codebase
- TokenRedemptionStates no longer referenced
- Grep shows zero vip_flow references
- Handlers start and free_flow still work</verification>
</task>

<task>
<summary>Remove TokenRedemptionStates from states files</summary>
<details>
- Open `bot/states/user.py`
- Remove TokenRedemptionStates class (1 state: waiting_for_token)
- Keep FreeAccessStates (still used by free_flow.py)
- Update `bot/states/__init__.py`:
  - Remove TokenRedemptionStates from exports
  - Keep FreeAccessStates export
- Verify no handlers reference TokenRedemptionStates
</details>
<verification>- TokenRedemptionStates removed from user.py
- __init__.py no longer exports TokenRedemptionStates
- FreeAccessStates still present and exported
- No handler references TokenRedemptionStates
- Grep shows zero TokenRedemptionStates references</verification>
</task>

<task>
<summary>Run all E2E tests and verify zero regressions</summary>
<details>
- Execute: `pytest tests/ -v --tb=short`
- Verify all existing E2E tests pass
- Check specifically:
  - `test_vip_flow_complete` - Should still work (deep link activation)
  - `test_free_flow_complete` - Free request flow
  - `test_duplicate_free_request_prevention` - Duplicate handling
  - All Phase 1 tests (message service, common messages)
  - All Phase 2 tests (admin providers)
  - All Phase 3 tests (user providers)
- Expected: All tests pass, zero failures
- If any test fails, investigate and fix
  - Common issue: Test expects exact string match → Update to use semantic assertions
  - Common issue: Missing keyboard → Check provider returns keyboard
  - Common issue: Wrong provider method → Verify method signature matches
</details>
<verification>- pytest tests/ passes 100% (all existing + new tests)
- Zero test failures
- Zero test errors
- E2E tests validate:
  - /start command works for all roles (admin/VIP/free)
  - Deep link activation works
  - Free request flow works
  - Duplicate request handling works
- No regressions from Phase 1 or Phase 2
- New Phase 3 user message tests pass (17 tests)</verification>
</task>

<task>
<summary>Validate handler file sizes reduced (code cleanup)</summary>
<details>
- Check line counts before/after:
  - start.py: Should reduce from ~327 to ~180 lines (message generation removed)
  - free_flow.py: Should reduce from ~93 to ~60 lines
  - vip_flow.py: Deleted (was 189 lines)
- Total reduction: ~369 lines of hardcoded messages removed
- Verify zero hardcoded f-strings with Spanish text remain
  - Grep for pattern: `f"[Bb]uenos` or `f"[Ee]xcelente`
  - Should find zero results in user handlers
- Verify zero manual keyboard construction in handlers
  - Grep for `InlineKeyboardMarkup` in user handlers
  - Should only be in providers, not handlers
</details>
<verification>- start.py reduced to ~180 lines (-147 lines)
- free_flow.py reduced to ~60 lines (-33 lines)
- vip_flow.py deleted (-189 lines)
- Total: ~369 lines of hardcoded messages removed
- Grep for hardcoded Spanish strings: zero results
- Grep for InlineKeyboardMarkup in handlers: zero results
- All keyboard construction in providers only</verification>
</task>

<task>
<summary>Update CLAUDE.md and docs with user flow migration complete</summary>
<details>
- Open `CLAUDE.md`
- Update Phase 3 status to COMPLETE
- Add checklist items:
  - [x] REFAC-04: user/start.py migrated
  - [x] REFAC-05: user/vip_flow.py removed (manual redemption deprecated)
  - [x] REFAC-06: user/free_flow.py migrated
  - [x] REFAC-07: All E2E tests pass
  - [x] TEST-01: Semantic helpers created
  - [x] TEST-02: Unit tests for user messages
  - [x] TEST-03: Integration tests pass
- Add statistics:
  - User providers created: 2 (UserStartMessages, UserFlowMessages)
  - User handlers migrated: 2 (start.py, free_flow.py)
  - User handlers removed: 1 (vip_flow.py)
  - Lines of hardcoded messages removed: ~369
  - Tests added: 17 (UserStartMessages + UserFlowMessages)
- Update next steps: Phase 4 - Advanced Voice Features
</details>
<verification>- CLAUDE.md Phase 3 marked COMPLETE
- All REFAC requirements checked
- All TEST requirements checked
- Statistics updated (providers, handlers, lines removed, tests)
- Next steps mention Phase 4
- Documentation matches implementation</verification>
</task>
</tasks>

## Success Criteria (must_haves)
1. start.py migrated to UserStartMessages provider (zero hardcoded messages)
2. free_flow.py migrated to UserFlowMessages provider (zero hardcoded messages)
3. vip_flow.py removed (manual token redemption deprecated)
4. TokenRedemptionStates removed from states
5. All E2E tests pass (zero regressions)
6. ~369 lines of hardcoded messages removed
7. 17 new tests passing (semantic, variation-safe)
8. CLAUDE.md updated with Phase 3 complete

## Notes
- Manual token redemption completely removed - only deep link activation remains
- Business logic stays in handlers (role detection, token validation, FSM state)
- Only text/keyboard generation delegated to providers
- Semantic assertions prevent test brittleness when adding variations
- E2E tests validate actual functionality (not just message formatting)
- Total reduction: 369 lines of hardcoded strings = 369 opportunities for voice inconsistency eliminated
