---
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - tests/conftest.py
  - tests/test_user_messages.py
autonomous: true
---

# 03-03: Semantic Test Helpers

## Goal
Create semantic test helpers in conftest.py that prevent test brittleness from string matching, plus comprehensive tests for UserStartMessages and UserFlowMessages providers.

## Context
Current tests use exact string matching (`assert text == "Buenos d√≠as, Juan"`). This breaks when adding message variations - 20+ tests fail even though semantic meaning unchanged.

Phase 1 created `test_message_service.py` with 449 lines using some assertions. Phase 3 needs:
- **Semantic helpers** - Test intent not exact wording
- **Reusable fixtures** - Define once, use everywhere
- **Variation-safe** - Survive message changes without breaking

Research identified critical patterns:
- `assert_greeting_present()` - Checks for any Spanish greeting
- `assert_lucien_voice()` - Validates voice characteristics (emoji, no tutear, no jargon)
- `assert_token_error_type()` - Checks error category not exact message
- `assert_time_aware()` - Validates time-of-day adaptation

## Tasks

<tasks>
<task>
<summary>Create assert_greeting_present() fixture in conftest.py</summary>
<details>
- Add to `tests/conftest.py`
- Fixture returns assertion function
- Check for common Spanish greetings: "buenos d√≠as", "buen d√≠a", "buenas tardes", "buena tarde", "buenas noches", "buena noche", "bienvenido", "bienvenida", "hola", "saludos"
- Case-insensitive matching
- Fail with helpful message if no greeting found: "Message must contain greeting, got: {first_100_chars}"
</details>
<verification>- assert_greeting_present fixture exists in conftest.py
- Checks all common Spanish greetings
- Case-insensitive
- Returns callable assertion function
- Helpful failure message showing message content</verification>
</task>

<task>
<summary>Create assert_lucien_voice() fixture in conftest.py</summary>
<details>
- Add to `tests/conftest.py`
- Fixture returns assertion function
- Validate voice characteristics:
  - üé© emoji must be present
  - No tutear (forbidden: "tienes", "tu ", "tu.", "haz", "puedes")
  - No technical jargon (forbidden: "database", "api", "exception", "error code", "null")
  - HTML formatting present (contains <b> or <i>)
- Fail with specific violation: "Voice violated: {reason}"
</details>
<verification>- assert_lucien_voice fixture exists
- Checks for üé© emoji
- Validates no tutear (usted form maintained)
- Validates no technical jargon
- Validates HTML formatting
- Returns callable with specific violation messages</verification>
</task>

<task>
<summary>Create assert_time_aware() fixture in conftest.py</summary>
<details>
- Add to `tests/conftest.py`
- Fixture returns assertion function with signature: (text: str, time_period: str)
- Time periods: "morning", "afternoon", "evening"
- Time indicators dict:
  - "morning": ["buenos d√≠as", "buen d√≠a", "ma√±ana"]
  - "afternoon": ["buenas tardes", "buena tarde"]
  - "evening": ["buenas noches", "buena noche", "noche"]
- Case-insensitive matching
- Fail with: "Message must be {time_period}-aware, got: {first_100_chars}"
</details>
<verification>- assert_time_aware fixture exists
- Handles all 3 time periods
- Case-insensitive matching
- Returns callable assertion function
- Helpful failure message</verification>
</task>

<task>
<summary>Create tests/test_user_messages.py with UserStartMessages tests</summary>
<details>
- Create file `tests/test_user_messages.py`
- Import pytest, semantic fixtures
- Test class: TestUserStartMessages
- Test methods:
  1. `test_greeting_morning_time_aware` - Mock datetime 9AM, assert_time_aware("morning")
  2. `test_greeting_afternoon_time_aware` - Mock datetime 3PM, assert_time_aware("afternoon")
  3. `test_greeting_evening_time_aware` - Mock datetime 10PM, assert_time_aware("evening")
  4. `test_greeting_admin_redirect` - is_admin=True, check /admin mentioned, no keyboard
  5. `test_greeting_vip_shows_days` - is_vip=True, verify vip_days_remaining shown
  6. `test_greeting_free_has_options_keyboard` - Free user, verify keyboard with 2 buttons
  7. `test_greeting_variations_distribution` - Generate 30 greetings, assert >=2 unique
  8. `test_deep_link_activation_success_celebratory` - Check celebratory tone, all details shown
  9. `test_deep_link_activation_error_types` - Test "invalid", "used", "expired", "no_plan"
  10. `test_all_messages_maintain_lucien_voice` - Parametrize all methods, assert_lucien_voice
- Use @pytest.mark.parametrize for time-of-day tests
- Use unittest.mock.patch for datetime mocking
</details>
<verification>- test_user_messages.py created
- TestUserStartMessages class exists
- All 10 test methods implemented
- Time-of-day tests use parametrize
- Datetime mocking with patch
- Semantic assertions used (not string matching)
- Tests cover all UserStartMessages methods</verification>
</task>

<task>
<summary>Add UserFlowMessages tests to test_user_messages.py</summary>
<details>
- Add to `tests/test_user_messages.py`
- Test class: TestUserFlowMessages
- Test methods:
  1. `test_free_request_success_shows_wait_time` - Verify wait_time_minutes shown
  2. `test_free_request_success_reassures_automatic` - Check "autom√°tico" mentioned
  3. `test_free_request_success_can_close_chat` - Verify "puede cerrar" mentioned
  4. `test_free_request_duplicate_shows_progress` - Check elapsed and remaining shown
  5. `test_free_request_duplicate_polite_tone` - Not scolding, reassuring
  6. `test_free_request_error_types` - Test "channel_not_configured", "already_in_channel", "rate_limited"
  7. `test_all_free_messages_maintain_voice` - Assert_lucien_voice on all methods
- Use semantic assertions
- No string matching (assert text == "...")
</details>
<verification>- TestUserFlowMessages class exists
- All 7 test methods implemented
- Semantic assertions used throughout
- No exact string matching
- Tests cover all UserFlowMessages methods
- Voice consistency validated</verification>
</task>

<task>
<summary>Run all user message tests and verify 100% passing</summary>
<details>
- Execute: `pytest tests/test_user_messages.py -v`
- Verify all 17 tests pass (10 UserStartMessages + 7 UserFlowMessages)
- Check output shows no failures
- Run with coverage: `pytest tests/test_user_messages.py --cov=bot.services.message.user_start --cov=bot.services.message.user_flows --cov-report=term-missing`
- Verify >85% coverage on both provider files
- Fix any failing tests
</details>
<verification>- pytest test_user_messages.py passes (17/17 tests)
- No test failures or errors
- Coverage >85% on both providers
- All semantic assertions working
- No string matching brittleness</verification>
</task>

<task>
<summary>Update existing test suite to use semantic helpers</summary>
<details>
- Review `tests/test_message_service.py` from Phase 1
- Replace exact string matches with semantic assertions where applicable
- Add assert_lucien_voice() to CommonMessages tests
- Ensure backward compatibility (existing tests still pass)
- Run full test suite: `pytest tests/ -v`
- Verify no regressions
</details>
<verification>- Existing tests updated with semantic helpers
- assert_lucien_voice used in CommonMessages tests
- Full test suite passes (Phase 1 + Phase 3 tests)
- No regressions introduced
- Test count increased (new tests added)</verification>
</task>
</tasks>

## Success Criteria (must_haves)
1. conftest.py has 3 semantic assertion fixtures (greeting, voice, time_aware)
2. test_user_messages.py created with 17 tests covering both user providers
3. All tests use semantic assertions (no exact string matching)
4. 100% of tests passing (17/17)
5. Coverage >85% on UserStartMessages and UserFlowMessages
6. Existing Phase 1 tests still pass (no regressions)
7. Tests are variation-safe (adding new message variants won't break tests)

## Notes
- Semantic assertions test INTENT not EXACT WORDING
- N=30 iterations for variation tests catches all variants with >99% confidence
- Use assert >=2 not ==3 for variation distribution (pragmatic, handles <1% randomness)
- Datetime mocking uses patch('bot.services.message.user_start.datetime')
- All test fixtures are reusable across test files (conftest.py makes them global)
