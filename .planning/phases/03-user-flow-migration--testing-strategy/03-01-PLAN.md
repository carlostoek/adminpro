---
wave: 1
depends_on: []
files_modified:
  - bot/services/message/__init__.py
  - bot/services/message/user_start.py
autonomous: true
---

# 03-01: UserStartMessages Provider

## Goal
Create UserStartMessages provider with time-of-day greetings, role-based adaptation, and deep link handling.

## Context
User-facing `/start` command currently has 327 lines of hardcoded messages in `bot/handlers/user/start.py`. This provider centralizes all user start messages with Lucien's consistent voice.

Phase 2 established patterns for admin message providers (AdminVIP, AdminFree, AdminMain). User messages differ:
- **More variations needed** - Users see /start repeatedly, admins don't
- **Time-of-day awareness** - Greetings adapt to morning/afternoon/evening
- **Role-based adaptation** - Single method handles admin/VIP/free cases
- **Deep link handling** - Auto-activation flow needs celebratory messaging

## Tasks

<tasks>
<task>
<summary>Create UserStartMessages provider class</summary>
<details>
- Create file `bot/services/message/user_start.py`
- Inherit from BaseMessageProvider
- Implement docstring with voice characteristics (warmer than admin, time-aware, role-based)
- Add __init__ (no state, calls super())
- All methods return Tuple[text, keyboard] or str (text-only)
</details>
<verification>- File exists with UserStartMessages class
- Inherits BaseMessageProvider
- Stateless (no session/bot in __init__)
- Docstring documents voice characteristics</verification>
</task>

<task>
<summary>Implement greeting() method with time-of-day detection</summary>
<details>
- Method signature: `greeting(user_name: str, is_admin: bool = False, is_vip: bool = False, vip_days_remaining: int = 0) -> Tuple[str, Optional[InlineKeyboardMarkup]]`
- Time detection: `hour = datetime.now().hour`
- Morning (6-12): "Buenos d√≠as", "Buen d√≠a", "Bienvenido esta ma√±ana" (weights 0.5, 0.3, 0.2)
- Afternoon (12-20): "Buenas tardes", "Bienvenido", "Buena tarde" (weights 0.5, 0.3, 0.2)
- Evening (20-6): "Buenas noches", "Buena noche", "Bienvenido esta noche" (weights 0.5, 0.3, 0.2)
- Role adaptation:
  - Admin: Concise redirect to /admin, no keyboard
  - VIP: Show days remaining, no keyboard
  - Free: Warm welcome + options keyboard (redeem token, request free)
- Use self._choose_variant() for weighted selection
- Use self._compose() for message assembly
- Use escape_html(user_name) for HTML safety
- Return (text, keyboard) tuple
</details>
<verification>- greeting() method exists with correct signature
- Time-of-day branches (morning/afternoon/evening) implemented
- Role branches (admin/VIP/free) implemented
- Uses _choose_variant with weights
- Uses _compose for assembly
- Returns (text, keyboard) tuple
- Admin gets no keyboard, free users get options keyboard
- VIP sees vip_days_remaining in message</verification>
</task>

<task>
<summary>Implement deep_link_activation_success() method</summary>
<details>
- Method signature: `deep_link_activation_success(user_name: str, plan_name: str, duration_days: int, price: str, days_remaining: int, invite_link: str) -> Tuple[str, InlineKeyboardMarkup]`
- Celebratory tone (different from manual redemption)
- Two equal-weight variants: "¬°Excelente! Su suscripci√≥n VIP ha sido activada", "¬°Bienvenido al c√≠rculo exclusivo! Todo est√° listo."
- Display plan details: plan_name, price, duration_days, days_remaining
- CTA: "Haga click en el bot√≥n para unirse ahora"
- Urgency: "El acceso expira en 5 horas"
- Keyboard: Single button "‚≠ê Unirse al Canal VIP" with url
- Use self._choose_variant() for celebration selection
- Use self._compose() for message assembly
- Return (text, keyboard) tuple
</details>
<verification>- deep_link_activation_success() method exists
- Has 2 equal-weight celebration variants
- Displays all plan details (name, price, duration, days)
- Mentions 5-hour expiry
- Returns keyboard with URL button pointing to invite_link
- Celebratory tone (different from manual redemption)</verification>
</task>

<task>
<summary>Implement deep_link_activation_error() method</summary>
<details>
- Method signature: `deep_link_activation_error(error_type: str, details: str = "") -> str`
- Error types: "invalid", "used", "expired", "no_plan"
- Error messages dict with polite but clear explanations
- "invalid": Lists possible causes (incorrect, used, expired)
- "used": Mentions Diana doesn't allow multiple use
- "expired": Suggests requesting new invitation
- "no_plan": Suggests consulting admin
- Append details if provided
- Use self._compose() for assembly
- Return str (no keyboard, error messages don't need actions)
</details>
<verification>- deep_link_activation_error() method exists
- Handles all 4 error types
- Each error type has distinct message
- Returns str (text-only, no keyboard)
- Polite but clear error explanations
- Appends details when provided</verification>
</task>

<task>
<summary>Export UserStartMessages from message service</summary>
<details>
- Update `bot/services/message/__init__.py`
- Import UserStartMessages from user_start.py
- Add to LucienVoiceService as lazy-loaded property `user_start`
- Follow same pattern as admin providers (Phase 2)
- Property decorated with @lru_cache maxsize=1
- Return UserStartMessages instance
</details>
<verification>- __init__.py imports UserStartMessages
- LucienVoiceService has @property user_start
- user_start uses @lru_cache maxsize=1
- Returns UserStartMessages() instance
- Same pattern as admin providers</verification>
</task>
</tasks>

## Success Criteria (must_haves)
1. UserStartMessages provider created with time-of-day greetings (3 periods, 3 variants each)
2. greeting() method handles all three roles (admin/VIP/free) with appropriate messaging
3. deep_link_activation_success() provides celebratory messaging distinct from manual redemption
4. deep_link_activation_error() handles all error types with clear explanations
5. Provider exported from LucienVoiceService with lazy loading
6. Zero hardcoded message strings in provider (all use _compose and _choose_variant)
7. All methods maintain Lucien's voice (üé©, usted form, elegant, mysterious)
8. Type hints 100%, docstrings with examples

## Notes
- Time-of-day uses server timezone (UTC) - sufficient for Phase 3
- User timezone handling deferred to Phase 4 if needed
- 3 weighted variations (50/30/20) provide variety without explosion
- Research validates N=30 iterations catches all variations with >99% confidence
- Deep link messaging intentionally different from manual redemption (UX distinction)
