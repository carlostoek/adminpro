---
wave: 1
depends_on: []
files_modified:
  - bot/services/message/__init__.py
  - bot/services/message/user_flows.py
autonomous: true
---

# 03-02: UserFlowMessages Provider (Free Channel Only)

## Goal
Create UserFlowMessages provider for Free channel request flow with clear instructions, progress tracking, and reassuring messaging.

## Context
User flow handler `free_flow.py` has 93 lines of hardcoded messages. VIP manual token redemption is being removed - only deep link activation remains (covered in 03-01).

This provider focuses exclusively on Free channel requests:
- Request confirmation with wait time
- Duplicate request handling with progress tracking
- Clear messaging about automatic process

Phase 2 established admin flow patterns. User Free flow differs:
- **Reassurance needed** - Users need to know process is automatic
- **Progress tracking** - Show elapsed/remaining time for duplicates
- **No action needed** - Emphasize users can close chat
- **Patience messaging** - Async process requires setting expectations

## Tasks

<tasks>
<task>
<summary>Create UserFlowMessages provider class</summary>
<details>
- Create file `bot/services/message/user_flows.py`
- Inherit from BaseMessageProvider
- Implement docstring with voice characteristics (reassuring, clear, patient)
- Add __init__ (no state, calls super())
- All methods return str (text-only, Free flow has no keyboards needed)
</details>
<verification>- File exists with UserFlowMessages class
- Inherits BaseMessageProvider
- Stateless (no session/bot in __init__)
- Docstring documents voice characteristics (Free flow focus)</verification>
</task>

<task>
<summary>Implement free_request_success() method</summary>
<details>
- Method signature: `free_request_success(wait_time_minutes: int) -> str`
- Confirmation: "Excelente. Su solicitud ha sido registrada"
- Display wait_time prominently: "‚è±Ô∏è Tiempo de espera: X minutos"
- Reassurance: "üì® Recibir√° un mensaje con el enlace de invitaci√≥n cuando el tiempo se cumpla"
- Important: "üí° No necesita hacer nada m√°s. El proceso es autom√°tico"
- Closing: "Puede cerrar este chat. Le notificar√© cuando est√© listo... üîî"
- Use self._compose() for message assembly
- Return str (no keyboard - async process, no action needed)
</details>
<verification>- free_request_success() method exists
- Shows wait_time_minutes prominently with emoji
- Reassures automatic process with üí°
- Tells user they can close chat
- Returns str (text-only)
- Encouraging tone with üîî emoji
- Maintains Lucien's voice (usted, elegant)</verification>
</task>

<task>
<summary>Implement free_request_duplicate() method</summary>
<details>
- Method signature: `free_request_duplicate(time_elapsed_minutes: int, time_remaining_minutes: int) -> str`
- Polite reminder: "Ya tiene una solicitud en proceso"
- Show progress with emojis:
  - "‚è±Ô∏è Tiempo transcurrido: X minutos"
  - "‚åõ Tiempo restante: X minutos"
- Reassurance: "Recibir√° el enlace de acceso autom√°ticamente cuando el tiempo se cumpla"
- Closing: "üí° Puede cerrar este chat. Le notificar√© cuando est√© listo."
- Use self._compose() for message assembly
- Return str (no keyboard - duplicate, no new action needed)
</details>
<verification>- free_request_duplicate() method exists
- Shows both elapsed and remaining time with distinct emojis
- Polite reminder tone (not scolding)
- Reassures automatic delivery
- Returns str (text-only)
- Progress indicators clearly visible
- Maintains Lucien's voice</verification>
</task>

<task>
<summary>Implement free_request_error() method</summary>
<details>
- Method signature: `free_request_error(error_type: str, details: str = "") -> str`
- Error types: "channel_not_configured", "already_in_channel", "rate_limited"
- Error messages dict:
  - "channel_not_configured": "El canal Free a√∫n no est√° configurado. Por favor, contacte al administrador."
  - "already_in_channel": "Ya tiene acceso al canal Free. No necesita solicitarlo nuevamente."
  - "rate_limited": "Ha solicitado acceso muy frecuentemente. Por favor, espere antes de solicitar nuevamente."
- Append details if provided
- Maintain polite but clear tone
- Use self._compose() for message assembly
- Return str (no keyboard)
</details>
<verification>- free_request_error() method exists
- Handles all 3 error types
- Each error type has distinct, clear message
- Returns str (text-only, no keyboard)
- Polite error tone
- Appends details when provided
- Maintains Lucien's voice</verification>
</task>

<task>
<summary>Export UserFlowMessages from message service</summary>
<details>
- Update `bot/services/message/__init__.py`
- Import UserFlowMessages from user_flows.py
- Add to LucienVoiceService as lazy-loaded property `user_flows`
- Follow same pattern as user_start provider (03-01)
- Property decorated with @lru_cache maxsize=1
- Return UserFlowMessages instance
</details>
<verification>- __init__.py imports UserFlowMessages
- LucienVoiceService has @property user_flows
- user_flows uses @lru_cache maxsize=1
- Returns UserFlowMessages() instance
- Same pattern as other providers</verification>
</task>

<task>
<summary>Create user namespace in LucienVoiceService</summary>
<details>
- Add nested namespace structure to LucienVoiceService
- Create `@property user` that returns a UserNamespace object
- UserNamespace has properties: `start` ‚Üí UserStartMessages, `flows` ‚Üí UserFlowMessages
- Each nested property uses @lru_cache maxsize=1
- Mirrors admin namespace structure (admin.main, admin.vip, admin.free)
- Access pattern: `container.message.user.start.greeting()`
- Access pattern: `container.message.user.flows.free_request_success()`
</details>
<verification>- LucienVoiceService has @property user returning UserNamespace
- UserNamespace class defined with start and flows properties
- Access pattern: container.message.user.start works
- Access pattern: container.message.user.flows works
- Nested lazy loading maintained
- Mirrors admin namespace structure</verification>
</task>
</tasks>

## Success Criteria (must_haves)
1. UserFlowMessages provider created with Free flow methods only
2. free_request_success() shows wait time and emphasizes automatic process
3. free_request_duplicate() shows progress (elapsed/remaining time) to reduce anxiety
4. free_request_error() handles all error cases with clear messaging
5. Provider exported from LucienVoiceService with lazy loading
6. User namespace created (user.start, user.flows) mirroring admin structure
7. Zero hardcoded message strings (all use _compose)
8. Type hints 100%, docstrings with examples

## Notes
- VIP manual token redemption REMOVED - only deep link activation exists (03-01)
- Free messages emphasize automatic process (no user action needed)
- Progress indicators in duplicate request prevent user anxiety
- Error messaging maintains Lucien's polite but clear voice
- All methods return str (no keyboards needed for Free flow)
