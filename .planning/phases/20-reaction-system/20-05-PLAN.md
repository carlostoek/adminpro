---
phase: 20-reaction-system
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/database/models.py
  - alembic/versions/20260211_000001_fix_reaction_unique_constraint.py
  - bot/services/reaction.py
  - bot/handlers/user/reactions.py
  - tests/services/test_reaction_service.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can only react once per message (regardless of emoji)"
    - "Second reaction attempt shows 'Ya reaccionaste a este contenido'"
    - "Database enforces one reaction per user per content at the constraint level"
    - "Existing duplicate reactions are deduplicated (first kept, others removed)"
  artifacts:
    - path: "bot/database/models.py"
      provides: "UserReaction model with unique constraint on (user_id, content_id) only"
      contains: "Index('idx_user_content', 'user_id', 'content_id', unique=True)"
    - path: "alembic/versions/20260211_000001_fix_reaction_unique_constraint.py"
      provides: "Migration that deduplicates existing data and updates constraint"
      contains: "DROP INDEX idx_user_content_emoji, CREATE INDEX idx_user_content"
    - path: "bot/services/reaction.py"
      provides: "ReactionService checking only user_id + content_id for duplicates"
      contains: "_is_duplicate_reaction() without emoji in WHERE clause"
    - path: "bot/handlers/user/reactions.py"
      provides: "Updated error message for duplicate reaction"
      contains: "'Ya reaccionaste a este contenido'"
  key_links:
    - from: "bot/services/reaction.py"
      to: "bot/database/models.py"
      via: "_is_duplicate_reaction() query"
      pattern: "UserReaction.user_id == user_id, UserReaction.content_id == content_id"
---

<objective>
Fix the duplicate reaction logic to enforce "one reaction per message" instead of "one reaction per emoji per message".

Purpose: User reported that users can react multiple times to the same message with different emojis. The system should only allow ONE reaction per message total, not one per emoji.

Output: Updated model constraint, database migration, service logic, error message, and tests all aligned to enforce single reaction per content.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/20-reaction-system/20-UAT.md

# Gap being fixed:
# - truth: "User cannot react twice to the same content - only one reaction per message allowed"
#   status: diagnosed
#   reason: "User reported: Los usuarios pueden reaccionar varias veces al mismo mensaje"
#   root_cause: "Unique constraint and deduplication logic include emoji column"
#   artifacts:
#     - path: "bot/database/models.py" - Unique index idx_user_content_emoji includes emoji column
#     - path: "bot/services/reaction.py" - _is_duplicate_reaction() checks user_id + content_id + emoji
#     - path: "bot/handlers/user/reactions.py" - Error message 'Ya reaccionaste con este emoji'
#   missing:
#     - Change unique constraint from (user_id, content_id, emoji) to (user_id, content_id)
#     - Remove emoji from _is_duplicate_reaction() WHERE clause
#     - Update error message to 'Ya reaccionaste a este contenido'
#     - Database migration to handle existing duplicates (keep first, delete others)

@bot/database/models.py
@alembic/versions/20260210_044700_add_user_reactions_table_for_reaction_.py
@bot/services/reaction.py
@bot/handlers/user/reactions.py
@tests/services/test_reaction_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update UserReaction Model Unique Constraint</name>
  <files>bot/database/models.py</files>
  <action>
Update the UserReaction model's __table_args__ to change the unique constraint:

1. Change line 823 from:
   Index('idx_user_content_emoji', 'user_id', 'content_id', 'emoji', unique=True)
   To:
   Index('idx_user_content', 'user_id', 'content_id', unique=True)

2. Keep the other indexes unchanged:
   - idx_user_reactions_recent (user_id, created_at)
   - idx_content_reactions (channel_id, content_id, emoji)

The idx_content_reactions index should remain as-is because it's used for counting reactions per emoji on content (showing how many users reacted with each emoji). Only the unique constraint needs to change.
  </action>
  <verify>grep -n "idx_user_content" bot/database/models.py | head -5</verify>
  <done>Model shows Index('idx_user_content', 'user_id', 'content_id', unique=True) without emoji</done>
</task>

<task type="auto">
  <name>Task 2: Create Alembic Migration for Constraint Change</name>
  <files>alembic/versions/20260211_000001_fix_reaction_unique_constraint.py</files>
  <action>
Create a new Alembic migration that:

1. Deduplicates existing reactions - for each (user_id, content_id) combination, keep only the first reaction (oldest created_at) and delete the rest

2. Drops the old unique index idx_user_content_emoji

3. Creates the new unique index idx_user_content on (user_id, content_id)

The migration should handle both SQLite and PostgreSQL dialects (use batch_alter_table for SQLite compatibility).

Example deduplication logic:
- Query for all reactions grouped by user_id, content_id having count > 1
- For each group, keep the one with MIN(created_at), delete others
- Or use a CTE/subquery approach to delete duplicates

Make the migration reversible (downgrade recreates the old index, though data deduplication can't be undone).
  </action>
  <verify>alembic upgrade head && alembic downgrade -1 && alembic upgrade head</verify>
  <done>Migration created, runs successfully, and is reversible</done>
</task>

<task type="auto">
  <name>Task 3: Update ReactionService._is_duplicate_reaction()</name>
  <files>bot/services/reaction.py</files>
  <action>
Update the _is_duplicate_reaction method to check only user_id + content_id:

1. Change the method signature from:
   async def _is_duplicate_reaction(self, user_id: int, content_id: int, emoji: str) -> bool
   To:
   async def _is_duplicate_reaction(self, user_id: int, content_id: int) -> bool

2. Update the query to remove emoji from WHERE clause:
   From:
   .where(
       UserReaction.user_id == user_id,
       UserReaction.content_id == content_id,
       UserReaction.emoji == emoji
   )
   To:
   .where(
       UserReaction.user_id == user_id,
       UserReaction.content_id == content_id
   )

3. Update the docstring to reflect the new behavior:
   "Verifica si el usuario ya reaccion√≥ a este contenido."
   (Remove "con este emoji")

4. Update the call site in add_reaction() method - remove the emoji parameter from the call
  </action>
  <verify>grep -A 15 "async def _is_duplicate_reaction" bot/services/reaction.py</verify>
  <done>Method signature updated, query no longer includes emoji filter, docstring updated</done>
</task>

<task type="auto">
  <name>Task 4: Update Error Message in Handler</name>
  <files>bot/handlers/user/reactions.py</files>
  <action>
Update the error message for duplicate reactions:

Line 154, change from:
"duplicate": "Ya reaccionaste con este emoji üëÜ"
To:
"duplicate": "Ya reaccionaste a este contenido üëÜ"

This better reflects the new behavior where users can only react once per content, regardless of which emoji they choose.
  </action>
  <verify>grep -n "Ya reaccionaste" bot/handlers/user/reactions.py</verify>
  <done>Error message shows "Ya reaccionaste a este contenido"</done>
</task>

<task type="auto">
  <name>Task 5: Update Tests for New Behavior</name>
  <files>tests/services/test_reaction_service.py</files>
  <action>
Update the test file to reflect the new "one reaction per content" behavior:

1. Update TestDuplicateDetection class:
   - test_duplicate_detected: Keep but remove emoji from _is_duplicate_reaction call
   - test_different_emoji_not_duplicate: CHANGE this test - with the new logic, reacting with a different emoji SHOULD now be considered a duplicate (since user already reacted to this content). Either delete this test or update it to expect is_dup=True

2. Update test_add_reaction related tests:
   - In test_duplicate_reaction_fails, remove emoji parameter from _is_duplicate_reaction call
   - In test_rate_limited_reaction_fails, the second reaction uses a different emoji (üî• vs ‚ù§Ô∏è) - this test should still pass because rate limiting happens before duplicate checking, but verify the logic flow

3. Update any other tests that call _is_duplicate_reaction with emoji parameter

4. Add a new test: test_different_emoji_same_content_is_duplicate - verify that reacting with a different emoji to the same content is blocked
  </action>
  <verify>pytest tests/services/test_reaction_service.py -v -k "duplicate"</verify>
  <done>All duplicate-related tests pass with new behavior</done>
</task>

</tasks>

<verification>
1. Run the new migration: alembic upgrade head
2. Run all reaction tests: pytest tests/services/test_reaction_service.py -v
3. Run handler tests: pytest tests/handlers/test_reaction_handlers.py -v
4. Verify constraint in database: .schema user_reactions (SQLite) or \d user_reactions (PostgreSQL)
5. Check that idx_user_content exists and is unique on (user_id, content_id)
6. Check that idx_user_content_emoji no longer exists
</verification>

<success_criteria>
- UserReaction model has unique constraint on (user_id, content_id) only
- Database migration successfully deduplicates existing data
- _is_duplicate_reaction() checks only user_id + content_id
- Error message reads "Ya reaccionaste a este contenido"
- Test test_different_emoji_not_duplicate updated or removed
- All 38 reaction service tests pass
- All 20 reaction handler tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-reaction-system/20-05-SUMMARY.md`

Update 20-UAT.md to mark test 3 as passing with the new expected behavior.
</output>
