---
phase: 08-interest-notification-system
plan: 04
type: execute
wave: 4
depends_on: [08-01, 08-02, 08-03]
files_modified: [bot/handlers/admin/interests.py, bot/handlers/admin/main.py, bot/handlers/admin/menu_callbacks.py]
autonomous: true

must_haves:
  truths:
    - "Admin puede navegar a men√∫ de intereses desde men√∫ principal"
    - "Admin puede ver lista de intereses con paginaci√≥n (10 por p√°gina)"
    - "Admin puede filtrar intereses por estado (pendientes/atendidos) y tipo de paquete"
    - "Admin puede ver detalles de inter√©s individual con informaci√≥n de usuario y paquete"
    - "Admin puede marcar inter√©s como atendido con confirmaci√≥n"
    - "Admin puede ver estad√≠sticas de intereses"
  artifacts:
    - path: "bot/handlers/admin/interests.py"
      provides: "Interest management callback handlers for navigation, listing, filtering, detail view, and marking as attended"
      min_lines: 250
      exports: ["callback_interests_menu", "callback_interests_list", "callback_interests_page", "callback_interests_view", "callback_interests_filters", "callback_interest_attend"]
  key_links:
    - from: "bot/handlers/admin/main.py"
      to: "bot/handlers/admin/interests.py"
      via: "admin:interests callback handler registration"
      pattern: "@admin_router\\.callback_query\\(F\\.data == \"admin:interests\"\\)"
    - from: "callback handlers"
      to: "AdminInterestMessages"
      via: "ServiceContainer.message.admin.interest"
      pattern: "container\\.message\\.admin\\.interest\\."
    - from: "callback handlers"
      to: "InterestService"
      via: "ServiceContainer.interest"
      pattern: "await container\\.interest\\."
---

<objective>
Create interest management handlers (bot/handlers/admin/interests.py) with callback handlers for navigation, interest listing with pagination and filters, detail view, stats display, and mark as attended functionality using InterestService and AdminInterestMessages.

Purpose: Complete interest management interface with full CRUD-like operations (list, view filters, mark attended) following established admin handler patterns (content.py, pricing.py) with unified callback structure admin:interests:*.
Output: New interests.py handler file with 8+ callback handlers, integrated into admin router.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-interest-notification-system/08-CONTEXT.md

@bot/handlers/admin/content.py
@bot/handlers/admin/pricing.py
@bot/utils/pagination.py
@bot/services/interest.py (plan 08-01)
@bot/services/message/admin_interest.py (plan 08-03)
@.planning/phases/07-admin-menu-content-management/07-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create interests.py handler file with navigation callbacks</name>
  <files>bot/handlers/admin/interests.py</files>
  <action>
Create bot/handlers/admin/interests.py with interest management callback handlers:

1. File structure:
```python
"""
Interest Management Handlers - Admin interface for managing user interests.

Handlers for listing, viewing, filtering, and marking user interests as attended.
"""
import logging
from aiogram import Router, F
from aiogram.types import CallbackQuery
from sqlalchemy.ext.asyncio import AsyncSession

from bot.middlewares import DatabaseMiddleware
from bot.services.container import ServiceContainer
from bot.utils.pagination import Paginator

logger = logging.getLogger(__name__)

# Router for interest management handlers
interests_router = Router(name="admin_interests")

# Apply middleware (AdminAuth already on admin_router, this integrates into it)
interests_router.callback_query.middleware(DatabaseMiddleware())
```

2. Required callback handlers:

**a. Menu handler (admin:interests):**
```python
@interests_router.callback_query(F.data == "admin:interests")
async def callback_interests_menu(callback: CallbackQuery, session: AsyncSession):
    """
    Show main interests management menu.

    Args:
        callback: Callback query
        session: Sesi√≥n de BD (inyectada por middleware)
    """
    logger.debug(f"üîî Admin {callback.from_user.id} opened interests menu")

    container = ServiceContainer(session, callback.bot)

    # Get stats for menu display
    stats = await container.interest.get_interest_stats()
    pending_count = stats.get("total_pending", 0)
    total_count = stats.get("total_pending", 0) + stats.get("total_attended", 0)

    # Get menu message
    text, keyboard = container.message.admin.interest.interests_menu(
        pending_count=pending_count,
        total_count=total_count
    )

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")
        # Try sending new message if edit fails
        await callback.message.answer(text=text, reply_markup=keyboard, parse_mode="HTML")

    await callback.answer()
```

**b. List handler (admin:interests:list:{filter}):**
```python
@interests_router.callback_query(F.data.startswith("admin:interests:list:"))
async def callback_interests_list(callback: CallbackQuery, session: AsyncSession):
    """
    Show interests list with filter.

    Callback data format: "admin:interests:list:{filter_type}"

    Filters:
    - all: All interests
    - pending: Only pending (is_attended=False)
    - attended: Only attended (is_attended=True)
    - vip_premium: Only VIP Premium packages
    - vip_content: Only VIP Content packages
    - free_content: Only Free Content packages

    Args:
        callback: Callback query
        session: Sesi√≥n de BD
    """
    logger.debug(f"üîî Admin {callback.from_user.id} viewing interests list")

    container = ServiceContainer(session, callback.bot)

    # Extract filter type from callback
    parts = callback.data.split(":")
    filter_type = parts[3] if len(parts) > 3 else "all"

    # Map filter to InterestService params
    is_attended = None
    package_type = None

    if filter_type == "pending":
        is_attended = False
    elif filter_type == "attended":
        is_attended = True
    elif filter_type == "vip_premium":
        package_type = PackageType.VIP_PREMIUM
    elif filter_type == "vip_content":
        package_type = PackageType.VIP_CONTENT
    elif filter_type == "free_content":
        package_type = PackageType.FREE_CONTENT

    # Get interests with pagination (first page)
    interests, total_count = await container.interest.get_interests(
        is_attended=is_attended,
        package_type=package_type,
        limit=10,
        offset=0,
        sort_newest_first=True
    )

    # Calculate total pages
    total_pages = (total_count + 9) // 10  # Round up

    # Generate list message
    if interests:
        text, keyboard = container.message.admin.interest.interests_list(
            interests=interests,
            page=1,
            total_pages=total_pages,
            filter_type=filter_type
        )
    else:
        text, keyboard = container.message.admin.interest.interests_empty(filter_type)

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")
        await callback.message.answer(text=text, reply_markup=keyboard, parse_mode="HTML")

    await callback.answer()
```

**c. Page handler (admin:interests:page:{page}:{filter}):**
```python
@interests_router.callback_query(F.data.startswith("admin:interests:page:"))
async def callback_interests_page(callback: CallbackQuery, session: AsyncSession):
    """
    Show specific page of interests list.

    Callback data format: "admin:interests:page:{page_num}:{filter_type}"

    Args:
        callback: Callback query
        session: Sesi√≥n de BD
    """
    container = ServiceContainer(session, callback.bot)

    # Extract page and filter from callback
    parts = callback.data.split(":")
    page = int(parts[3]) if len(parts) > 3 else 1
    filter_type = parts[4] if len(parts) > 4 else "all"

    # Map filter to params
    is_attended = None
    package_type = None

    if filter_type == "pending":
        is_attended = False
    elif filter_type == "attended":
        is_attended = True
    elif filter_type == "vip_premium":
        package_type = PackageType.VIP_PREMIUM
    elif filter_type == "vip_content":
        package_type = PackageType.VIP_CONTENT
    elif filter_type == "free_content":
        package_type = PackageType.FREE_CONTENT

    # Get interests with pagination
    offset = (page - 1) * 10
    interests, total_count = await container.interest.get_interests(
        is_attended=is_attended,
        package_type=package_type,
        limit=10,
        offset=offset,
        sort_newest_first=True
    )

    # Calculate total pages
    total_pages = (total_count + 9) // 10

    # Generate list message
    if interests:
        text, keyboard = container.message.admin.interest.interests_list(
            interests=interests,
            page=page,
            total_pages=total_pages,
            filter_type=filter_type
        )
    else:
        text, keyboard = container.message.admin.interest.interests_empty(filter_type)

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")

    await callback.answer()
```

**d. View detail handler (admin:interest:view:{id}):**
```python
@interests_router.callback_query(F.data.startswith("admin:interest:view:"))
async def callback_interests_view(callback: CallbackQuery, session: AsyncSession):
    """
    Show detailed view of single interest.

    Callback data format: "admin:interest:view:{interest_id}"

    Args:
        callback: Callback query
        session: Sesi√≥n de BD
    """
    container = ServiceContainer(session, callback.bot)

    # Extract interest ID
    interest_id = int(callback.data.split(":")[-1])

    # Get interest with relationships loaded
    interest = await container.interest.get_interest_by_id(interest_id)

    if not interest:
        await callback.answer("‚ùå Inter√©s no encontrado", show_alert=True)
        return

    # Generate detail message
    text, keyboard = container.message.admin.interest.interest_detail(interest)

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")
        await callback.message.answer(text=text, reply_markup=keyboard, parse_mode="HTML")

    await callback.answer()
```

**e. Filters handler (admin:interests:filters:{current}):**
```python
@interests_router.callback_query(F.data.startswith("admin:interests:filters"))
async def callback_interests_filters(callback: CallbackQuery, session: AsyncSession):
    """
    Show filter selection screen.

    Callback data format: "admin:interests:filters" or "admin:interests:filters:{current_filter}"

    Args:
        callback: Callback query
        session: Sesi√≥n de BD
    """
    container = ServiceContainer(session, callback.bot)

    # Extract current filter
    parts = callback.data.split(":")
    current_filter = parts[3] if len(parts) > 3 else "all"

    # Generate filter selection message
    text, keyboard = container.message.admin.interest.interests_filters(current_filter)

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")
        await callback.message.answer(text=text, reply_markup=keyboard, parse_mode="HTML")

    await callback.answer()
```

**f. Filter selection handler (admin:interests:filter:{filter_type}):**
```python
@interests_router.callback_query(F.data.startswith("admin:interests:filter:"))
async def callback_interests_filter_select(callback: CallbackQuery, session: AsyncSession):
    """
    Apply selected filter and show list.

    Callback data format: "admin:interests:filter:{filter_type}"

    Args:
        callback: Callback query
        session: Sesi√≥n de BD
    """
    # Redirect to list handler with selected filter
    filter_type = callback.data.split(":")[-1]
    new_callback_data = f"admin:interests:list:{filter_type}"

    # Simulate callback with new data
    from unittest.mock import Mock
    mock_callback = Mock(spec=CallbackQuery)
    mock_callback.message = callback.message
    mock_callback.from_user = callback.from_user
    mock_callback.bot = callback.bot
    mock_callback.data = new_callback_data

    await callback_interests_list(mock_callback, session)
    await callback.answer()
```

**g. Stats handler (admin:interests:stats):**
```python
@interests_router.callback_query(F.data == "admin:interests:stats")
async def callback_interests_stats(callback: CallbackQuery, session: AsyncSession):
    """
    Show interest statistics.

    Args:
        callback: Callback query
        session: Sesi√≥n de BD
    """
    logger.debug(f"üìä Admin {callback.from_user.id} viewing interest stats")

    container = ServiceContainer(session, callback.bot)

    # Get stats from InterestService
    stats = await container.interest.get_interest_stats()

    # Generate stats message
    text, keyboard = container.message.admin.interest.interests_stats(stats)

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")
        await callback.message.answer(text=text, reply_markup=keyboard, parse_mode="HTML")

    await callback.answer()
```

**h. Mark attended confirmation (admin:interest:attend:{id}):**
```python
@interests_router.callback_query(F.data.startswith("admin:interest:attend:"))
async def callback_interest_attend_confirm(callback: CallbackQuery, session: AsyncSession):
    """
    Show confirmation dialog for marking interest as attended.

    Callback data format: "admin:interest:attend:{interest_id}"

    Args:
        callback: Callback query
        session: Sesi√≥n de BD
    """
    container = ServiceContainer(session, callback.bot)

    # Extract interest ID
    interest_id = int(callback.data.split(":")[-1])

    # Get interest
    interest = await container.interest.get_interest_by_id(interest_id)

    if not interest:
        await callback.answer("‚ùå Inter√©s no encontrado", show_alert=True)
        return

    if interest.is_attended:
        await callback.answer("‚úÖ Este inter√©s ya est√° marcado como atendido", show_alert=True)
        return

    # Generate confirmation message
    text, keyboard = container.message.admin.interest.mark_attended_confirm(interest)

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")
        await callback.message.answer(text=text, reply_markup=keyboard, parse_mode="HTML")

    await callback.answer()
```

**i. Mark attended action (admin:interest:attend:confirm:{id}):**
```python
@interests_router.callback_query(F.data.startswith("admin:interest:attend:confirm:"))
async def callback_interest_attend(callback: CallbackQuery, session: AsyncSession):
    """
    Mark interest as attended (confirmed).

    Callback data format: "admin:interest:attend:confirm:{interest_id}"

    Args:
        callback: Callback query
        session: Sesi√≥n de BD
    """
    container = ServiceContainer(session, callback.bot)

    # Extract interest ID
    interest_id = int(callback.data.split(":")[-1])

    # Mark as attended using InterestService
    success, message = await container.interest.mark_as_attended(interest_id)

    if not success:
        await callback.answer(f"‚ùå {message}", show_alert=True)
        return

    # Get updated interest
    interest = await container.interest.get_interest_by_id(interest_id)

    if interest:
        # Generate success message
        text, keyboard = container.message.admin.interest.mark_attended_success(interest)

        try:
            await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
        except Exception as e:
            logger.warning(f"Could not edit message: {e}")
            await callback.message.answer(text=text, reply_markup=keyboard, parse_mode="HTML")

    await callback.answer("‚úÖ Inter√©s marcado como atendido", show_alert=True)
    logger.info(f"‚úÖ Admin {callback.from_user.id} marked interest {interest_id} as attended")
```

3. Import PackageType:
```python
from bot.database.enums import PackageType
```

DO NOT:
- Add AdminAuthMiddleware (applied at admin_router level)
- Call session.commit() (SessionContextManager handles it)
- Use hardcoded pagination (use InterestService methods)
- Use InlineKeyboardBuilder directly (use AdminInterestMessages keyboards)
- Forget callback.answer() at end of handlers
- Handle "message is not modified" errors gracefully (try/except on edit_text)
  </action>
  <verify>
1. File created: bot/handlers/admin/interests.py
2. Has interests_router with Router(name="admin_interests")
3. Has 9+ callback handlers: menu, list, page, view, filters, filter_select, stats, attend_confirm, attend_action
4. All handlers use ServiceContainer
5. All handlers use AdminInterestMessages for text/keyboards
6. All handlers call callback.answer()
7. No session.commit() calls
8. Pagination uses InterestService.get_interests with limit/offset
9. Filter mapping: all, pending, attended, vip_premium, vip_content, free_content
10. Follows admin handler pattern (content.py, pricing.py)
11. Handles "message is not modified" errors with try/except
  </verify>
  <done>
Interest management handler file created with navigation, listing, filtering, detail view, stats, and mark attended callbacks, using InterestService and AdminInterestMessages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate interests_router into admin router</name>
  <files>bot/handlers/admin/main.py</files>
  <action>
Update bot/handlers/admin/main.py to include interests_router:

1. Import interests_router:
```python
from bot.handlers.admin import interests as admin_interests
```

2. After admin_router definition, include interests_router:
```python
# Include interest management router
admin_router.include_router(admin_interests.interests_router)
```

3. Placement: After other router includes (content, etc.), before handler definitions

DO NOT:
- Modify existing handlers
- Change AdminAuthMiddleware application (stays on admin_router)
- Duplicate router registration
  </action>
  <verify>
1. admin_interests.interests_router imported
2. admin_router.include_router() called for interests_router
3. Interest management callbacks registered in admin router
4. Existing admin handlers unchanged
5. AdminAuthMiddleware still applies (via admin_router inheritance)
  </verify>
  <done>
Interests router integrated into admin router, all interest management callbacks active.
  </done>
</task>

<task type="auto">
  <name>Task 3: Handle direct notification callback links</name>
  <files>bot/handlers/admin/menu_callbacks.py</files>
  <action>
Update bot/handlers/admin/menu_callbacks.py to handle callback links from admin notifications:

1. Add handler for "admin:interests:list:pending" callback (from notification button):
```python
@admin_router.callback_query(F.data == "admin:interests:list:pending")
async def callback_interests_pending(callback: CallbackQuery, session: AsyncSession):
    """
    Redirect to pending interests list (from admin notification button).

    This handler is needed because the notification sends callbacks
    to the main admin_router, not the interests sub-router.
    """
    # Import to avoid circular dependency
    from bot.handlers.admin.interests import callback_interests_list

    # Create mock callback with correct data
    from unittest.mock import Mock
    mock_callback = Mock(spec=CallbackQuery)
    mock_callback.message = callback.message
    mock_callback.from_user = callback.from_user
    mock_callback.bot = callback.bot
    mock_callback.data = "admin:interests:list:pending"

    await callback_interests_list(mock_callback, session)
    await callback.answer()
```

2. Add handler for "admin:interest:attend:{id}" callback (from notification button):
```python
@admin_router.callback_query(F.data.startswith("admin:interest:attend:"))
async def callback_interest_attend_from_notification(callback: CallbackQuery, session: AsyncSession):
    """
    Redirect to mark attended (from admin notification button).

    This handler is needed because the notification sends callbacks
    to the main admin_router, not the interests sub-router.
    """
    # Import to avoid circular dependency
    from bot.handlers.admin.interests import callback_interest_attend_confirm

    # Create mock callback with correct data
    from unittest.mock import Mock
    mock_callback = Mock(spec=CallbackQuery)
    mock_callback.message = callback.message
    mock_callback.from_user = callback.from_user
    mock_callback.bot = callback.bot
    mock_callback.data = callback.data

    await callback_interest_attend_confirm(mock_callback, session)
    await callback.answer()
```

3. Add handler for "admin:user:block_contact:{user_id}" callback (from notification button):
```python
@admin_router.callback_query(F.data.startswith("admin:user:block_contact:"))
async def callback_user_block_contact(callback: CallbackQuery, session: AsyncSession):
    """
    Block user from contact features (from admin notification button).

    Note: Full implementation deferred to Phase 9 (User Management).
    This is a placeholder for now.
    """
    user_id = int(callback.data.split(":")[-1])

    # TODO: Implement contact blocking in Phase 9
    await callback.answer(
        "‚ö†Ô∏è Funci√≥n de bloqueo ser√° implementada en Phase 9 (Gesti√≥n de Usuarios)",
        show_alert=True
    )
    logger.info(f"üö´ Admin {callback.from_user.id} attempted to block contact for user {user_id} (not yet implemented)")
```

DO NOT:
- Modify existing callback handlers
- Remove or change other callback registrations
- Implement full user blocking (deferred to Phase 9)
  </action>
  <verify>
1. callback_interests_pending handler exists in menu_callbacks.py
2. Redirects to interests list handler with "pending" filter
3. callback_interest_attend_from_notification handler exists
4. Redirects to attend confirmation handler
5. callback_user_block_contact handler exists (placeholder for Phase 9)
6. All handlers use Mock to redirect to sub-router handlers
7. All handlers call callback.answer()
8. Existing callbacks unchanged
  </verify>
  <done>
Admin notification callback links handled via redirect handlers in main router, connecting notification buttons to interest management interface.
  </done>
</task>

</tasks>

<verification>
Overall phase verification:
1. bot/handlers/admin/interests.py exists with interests_router
2. 9+ callback handlers implemented (menu, list, page, view, filters, filter_select, stats, attend_confirm, attend_action)
3. interests_router included in admin_router
4. Admin can navigate: /admin ‚Üí Intereses ‚Üí Ver Pendientes ‚Üí View Detail ‚Üí Mark Attended
5. Pagination works with Next/Prev buttons
6. Filters work: Pending, Attended, VIP Premium, VIP Content, Free Content
7. Stats display shows pending/attended counts and breakdown by type
8. Mark attended works with confirmation dialog
9. All handlers use AdminInterestMessages
10. All handlers call callback.answer()
11. No session commits in handlers
12. Notification callback links handled in menu_callbacks.py
13. "Message is not modified" errors handled gracefully
</verification>

<success_criteria>
1. Admin clicks "üîî Intereses" and sees interests menu with pending count
2. Admin clicks "‚è≥ Ver Pendientes" and sees pending interests list (paginated, 10 per page)
3. Admin can navigate pages with Next/Prev buttons
4. Admin clicks "üîç Filtros" and sees 6 filter options
5. Admin selects filter and sees filtered list
6. Admin clicks interest and sees detail view with user info, package details, timestamp
7. Admin clicks "‚úÖ Marcar como Atendido" and sees confirmation dialog
8. Admin confirms and sees success message, interest removed from pending list
9. Admin clicks "üìä Ver Estad√≠sticas" and sees stats display with breakdown
10. Admin clicks notification "üìã Ver Todos los Intereses" and goes to pending list
11. Admin clicks notification "‚úÖ Marcar como Atendido" and goes to confirmation
12. All navigation works with back buttons
</success_criteria>

<output>
After completion, create `.planning/phases/08-interest-notification-system/08-04-SUMMARY.md`
</output>
