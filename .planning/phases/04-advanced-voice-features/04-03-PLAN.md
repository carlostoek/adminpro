# Plan 04-03: Message Preview CLI Tool

**Wave:** 2 (Tooling - parallel with 04-02)
**Autonomous:** Yes
**Files Modified:**
- `tools/preview_messages.py` (NEW)
- `README.md` (UPDATE - add CLI usage section)

**Depends On:** None (Phase 1-3 message providers complete, can run in parallel with 04-02)

---

## Summary

Build command-line tool for previewing message variations without full bot startup. Enables rapid iteration on voice changes during development. Uses `argparse` for CLI interface, generates messages directly from LucienVoiceService, displays both text and keyboard markup, supports generating all variations to verify distribution. No bot restart required, ~500ms execution time vs ~10s for full bot startup.

---

## Tasks

### Task 1: Create CLI Entry Point

**File:** `tools/preview_messages.py`

**Requirements:**
- Shebang: `#!/usr/bin/env python3`
- Docstring explaining usage
- Import `argparse`, `sys`, `pathlib`
- Add parent directory to sys.path for imports
- Import `LucienVoiceService` from bot.services.message
- Create `main()` function with argparse subparsers
- Call `main()` if `__name__ == "__main__"`

**CLI Structure:**
```bash
python tools/preview_messages.py <command> [options]

Commands:
  greeting          Preview /start greeting message
  deep-link-success Preview deep link activation success
  variations        Preview all variations of a message
  list              List all available message methods

Global Options:
  -h, --help        Show help message
```

**Acceptance Criteria:**
- [x] Executable script (chmod +x) ‚úÖ
- [x] Argparse with subparsers for each command ‚úÖ
- [x] Help text available via --help ‚úÖ
- [x] Parent directory added to sys.path for imports ‚úÖ
**Committed:** c5ca285

---

### Task 2: Implement Greeting Preview Command

**File:** `tools/preview_messages.py`

**Function:** `preview_greeting(args)`

**Requirements:**
- Create LucienVoiceService instance
- Call `service.user.start.greeting()` with args:
  - `user_name=args.user_name` (default: "Usuario")
  - `is_admin=args.admin` (flag)
  - `is_vip=args.vip` (flag)
  - `vip_days_remaining=args.days` (optional int)
- Display formatted output with:
  - Header: "üìã MESSAGE PREVIEW: user.start.greeting()"
  - Divider: "============================================================"
  - User info: name, role, VIP days (if applicable)
  - Text section: "üìù TEXT:" with divider
  - Message text
  - Keyboard section: "‚å®Ô∏è KEYBOARD:" with button list
  - Empty keyboard indicator if None

**Argparse Options:**
```python
greeting_parser = subparsers.add_parser("greeting", help="Preview /start greeting")
greeting_parser.add_argument("--user-name", default="Usuario", help="User name")
greeting_parser.add_argument("--admin", action="store_true", help="User is admin")
greeting_parser.add_argument("--vip", action="store_true", help="User is VIP")
greeting_parser.add_argument("--days", type=int, help="VIP days remaining")
```

**Acceptance Criteria:**
- [x] Function generates greeting message ‚úÖ
- [x] Output formatted with clear sections ‚úÖ
- [x] Keyboard buttons displayed with text and callback_data/url ‚úÖ
- [x] All CLI arguments mapped to provider parameters ‚úÖ
**Committed:** c5ca285 (part of Task 1)

---

### Task 3: Implement Deep Link Success Preview Command

**File:** `tools/preview_messages.py`

**Function:** `preview_deep_link_success(args)`

**Requirements:**
- Create LucienVoiceService instance
- Call `service.user.start.deep_link_activation_success()` with args:
  - `user_name=args.user_name` (default: "Usuario")
  - `plan_name=args.plan` (default: "Plan Mensual")
  - `duration_days=args.days` (default: 30)
  - `price=args.price` (default: "$9.99")
  - `days_remaining=args.days` (same as duration)
  - `invite_link=args.invite_link` (default: "https://t.me/+EXAMPLE")
- Display formatted output (same structure as greeting)

**Argparse Options:**
```python
dl_parser = subparsers.add_parser("deep-link-success", help="Preview deep link success")
dl_parser.add_argument("--user-name", default="Usuario", help="User name")
dl_parser.add_argument("--plan", default="Plan Mensual", help="Plan name")
dl_parser.add_argument("--days", type=int, default=30, help="Plan duration")
dl_parser.add_argument("--price", default="$9.99", help="Plan price")
dl_parser.add_argument("--invite-link", default="https://t.me/+EXAMPLE", help="Invite link")
```

**Acceptance Criteria:**
- [x] Function generates deep link success message ‚úÖ
- [x] Output formatted with clear sections ‚úÖ
- [x] Keyboard displayed with invite link URL ‚úÖ
- [x] All CLI arguments mapped to provider parameters ‚úÖ
**Committed:** c5ca285 (part of Task 1)

---

### Task 4: Implement Variations Preview Command

**File:** `tools/preview_messages.py`

**Function:** `preview_variations(args)`

**Requirements:**
- Create LucienVoiceService instance
- Generate `args.count` messages (default: 30)
- Call appropriate method based on `args.method`:
  - "greeting": service.user.start.greeting()
- Collect unique messages in a set
- Display output:
  - Header: "üé≤ VARIATION PREVIEW: {method}"
  - Sample count
  - Number of unique variations found
  - Each variation with index and text

**Argparse Options:**
```python
var_parser = subparsers.add_parser("variations", help="Preview all variations")
var_parser.add_argument("method", help="Message method name (e.g., greeting)")
var_parser.add_argument("--user-name", default="Usuario", help="User name")
var_parser.add_argument("--count", type=int, default=30, help="Number of samples")
```

**Acceptance Criteria:**
- [x] Function generates multiple samples ‚úÖ
- [x] Unique variations counted and displayed ‚úÖ
- [x] Output shows all distinct variations found ‚úÖ
- [x] Supports multiple message methods (extensible) ‚úÖ
**Committed:** c5ca285 (part of Task 1)

---

### Task 5: Implement List Command

**File:** `tools/preview_messages.py`

**Function:** `list_message_methods(args)`

**Requirements:**
- Display all available message methods organized by provider
- Format as tree structure:
  ```
  Available Message Methods:

  user.start:
    - greeting              /start greeting with time-aware variations
    - deep_link_activation_success    Deep link activation success
    - token_error           Token redemption error

  user.flows:
    - free_request_success  Free channel request success
    - free_request_duplicate  Duplicate request warning
    ...
  ```
- Extract method names via introspection (dir() on providers)
- Filter for callable public methods (not starting with "_")

**Acceptance Criteria:**
- [x] Lists all message methods from all providers ‚úÖ
- [x] Organized by provider namespace (user.start, user.flows, admin.*, etc.) ‚úÖ
- [x] Includes brief description from docstrings ‚úÖ
- [x] Formatted as readable tree ‚úÖ
**Committed:** c5ca285 (part of Task 1)

---

### Task 6: Update README with CLI Usage

**File:** `README.md`

**Section to Add:** "Message Preview CLI"

**Requirements:**
- Add section after "Testing" or "Development"
- Include usage examples:
  ```bash
  # Preview greeting for VIP user
  python tools/preview_messages.py greeting --user-name "Juan" --vip --days 15

  # Preview deep link success
  python tools/preview_messages.py deep-link-success --plan "Premium" --days 30

  # Generate 30 variations to check distribution
  python tools/preview_messages.py variations greeting --count 30

  # List all available message methods
  python tools/preview_messages.py list
  ```
- Explain benefits (faster than bot restart, no telegram client needed)

**Acceptance Criteria:**
- [x] README updated with CLI usage section ‚úÖ
- [x] Examples cover all main commands ‚úÖ
- [x] Clear explanation of when to use CLI ‚úÖ
**Committed:** 1a68fd8

---

### Task 7: Write Tests for CLI Tool

**File:** `tests/test_preview_cli.py` (NEW)

**Test Cases:**

1. **test_greeting_command_generates_message**
   - Run CLI with "greeting --user-name TestUser"
   - Capture stdout
   - Assert "üìã MESSAGE PREVIEW" in output
   - Assert "TestUser" in output
   - Assert "üìù TEXT:" in output

2. **test_greeting_includes_keyboard**
   - Run CLI with "greeting"
   - Assert "‚å®Ô∏è KEYBOARD:" in output
   - Assert button text displayed

3. **test_variations_command_shows_distribution**
   - Run CLI with "variations greeting --count 30"
   - Assert unique variations counted
   - Assert multiple variations shown

4. **test_list_command_displays_methods**
   - Run CLI with "list"
   - Assert provider names displayed
   - Assert method names displayed

5. **test_deep_link_command_with_args**
   - Run CLI with "deep-link-success --plan Premium --days 60"
   - Assert "Premium" in output
   - Assert "60" in output

**Acceptance Criteria:**
- [x] All 5 test cases implemented ‚úÖ
- [x] Tests use subprocess.run() to execute CLI ‚úÖ
- [x] Tests verify stdout output ‚úÖ
- [x] Tests cover main CLI commands ‚úÖ
**Committed:** 2f1547d
**Note:** 9 tests implemented (5 required + 4 additional), all passing

---

## Verification Criteria

1. **CLIExecution:** Script runs without errors on all commands
2. **OutputFormat:** Clear, readable output with sections and dividers
3. **KeyboardDisplay:** InlineKeyboard buttons shown with text and callback_data/url
4. **VariationDistribution:** Multiple samples generate expected variations (2-3 unique per method)
5. **Performance:** <500ms execution time for single message, <2s for 30 variations
6. **Extensibility:** New message methods can be added to CLI without breaking existing commands

---

## Must Haves (Goal-Backward Verification)

**Goal:** Enable rapid message testing without full bot restart

1. **Must generate messages from LucienVoiceService:**
   - Import and instantiate service
   - Call provider methods directly
   - Verified by test_greeting_command_generates_message

2. **Must display both text and keyboard:**
   - Extract text from tuple result
   - Iterate over keyboard.inline_keyboard
   - Verified by test_greeting_includes_keyboard

3. **Must support multiple user roles:**
   - --admin flag for admin greeting
   - --vip flag for VIP greeting
   - Default (no flags) for free user
   - Verified by test_greeting_command_with_different_roles

4. **Must generate variations to check distribution:**
   - Loop N times calling same method
   - Collect unique messages in set
   - Display count of unique variations
   - Verified by test_variations_command_shows_distribution

5. **Must be faster than bot restart:**
   - Target: <500ms vs ~10s bot startup
   - No database init, no telegram polling
   - Verified by manual timing (optional)

---

## Implementation Notes

- **No Async Required:** LucienVoiceService providers are synchronous, no async/await needed
- **Path Handling:** Add `sys.path.insert(0, str(parent))` to import from bot package
- **Output Formatting:** Use "‚ïê" characters for visual dividers (60 chars wide)
- **Keyboard Iteration:**
  ```python
  if keyboard:
      for row_idx, row in enumerate(keyboard.inline_keyboard):
          print(f"  Row {row_idx}:")
          for button in row:
              print(f"    - [{button.text}] ‚Üí {button.callback_data or button.url}")
  ```
- **Variation Collection:**
  ```python
  messages = set()
  for i in range(args.count):
      text, _ = service.user.start.greeting(user_name=args.user_name or "Usuario")
      messages.add(text)
  ```
- **Method Introspection for List Command:**
  ```python
  for provider_name, provider in [("user.start", service.user.start), ...]:
      print(f"\n{provider_name}:")
      for method_name in dir(provider):
          if not method_name.startswith('_'):
              method = getattr(provider, method_name)
              if callable(method):
                  print(f"  - {method_name}")
  ```

---

## CLI Output Examples

### Example 1: Greeting for VIP User
```bash
$ python tools/preview_messages.py greeting --user-name "Mar√≠a" --vip --days 15

============================================================
üìã MESSAGE PREVIEW: user.start.greeting()
============================================================
User: Mar√≠a
Role: VIP
VIP Days: 15

üìù TEXT:
------------------------------------------------------------
üé© Buenos d√≠as, Mar√≠a.

Le agradezco su paciencia mientras Diana atiende sus asuntos.

üå∏ Espero que el c√≠rculo exclusivo le est√© brindando el acceso
merecido. Si necesita algo, este mayordomo est√° a su orden.
------------------------------------------------------------

‚å®Ô∏è KEYBOARD:
  Row 0:
    - [‚ú® Ver C√≠rculo Exclusivo] ‚Üí https://t.me/+example
  Row 1:
    - [üìä Consultar Estado] ‚Üí check_status
```

### Example 2: Variations Distribution
```bash
$ python tools/preview_messages.py variations greeting --count 30

============================================================
üé≤ VARIATION PREVIEW: greeting
============================================================
Generating 30 samples...

Unique variations found: 3

VARIATION 1:
------------------------------------------------------------
üé© Buenos d√≠as, Usuario.
[full message text]
------------------------------------------------------------

VARIATION 2:
------------------------------------------------------------
üé© Buen d√≠a, Usuario.
[full message text]
------------------------------------------------------------

VARIATION 3:
------------------------------------------------------------
üé© Buenos d√≠as. Le saluda atentamente.
[full message text]
------------------------------------------------------------
```

---

## Open Questions

1. **Q:** Should we add admin message previews (admin.vip.*, admin.free.*, admin.main*)?
   **A:** Yes, add to Phase 4.1 or as follow-up task (not critical for initial release)

2. **Q:** Should CLI support session context (--user-id option for session-aware testing)?
   **A:** No - session tracking requires running user interactions, CLI is for static preview only

3. **Q:** Should we add --json flag for machine-readable output?
   **A:** No - human-readable output is primary goal, JSON overkill for preview tool

4. **Q:** Should CLI validate voice rules (emoji, HTML, tutear) and show warnings?
   **A:** No - pre-commit hook handles validation, CLI is for preview not linting

---

## Success Metrics

- **Execution time:** <500ms for single message, <2s for 30 variations
- **Usage frequency:** Used in >50% of message-related PRs (measured via git history)
- **Developer satisfaction:** >80% of developers prefer CLI over bot restart (survey after 30 days)
- **Bug reduction:** 30% fewer voice-related bugs in PRs that use CLI for testing

---

**Status:** READY FOR EXECUTION
**Confidence:** HIGH (stdlib argparse, simple stdout output, no external dependencies)
