# Plan 04-02: Voice Linting Pre-Commit Hook

**Wave:** 2 (Tooling - parallel with 04-03)
**Autonomous:** Yes
**Files Modified:**
- `.hooks/pre-commit` (NEW)
- `.hooks/voice_linter.py` (NEW)
- `bot/utils/voice_linter.py` (NEW - AST checker logic)
- `tests/test_voice_linter.py` (NEW)
- `.git/hooks/pre-commit` (symlink created via git hook install)

**Depends On:** None (Phase 1 foundation complete, can run in parallel with 04-03)

---

## Summary

Create voice consistency validation using AST parsing to detect voice violations before code is committed. Pre-commit hook runs automatically on git commit, checks only staged message provider files, uses stdlib `ast` module (no external linter dependencies), catches 80% of voice violations (tutear, technical jargon, missing emoji, missing HTML). Performance target: <100ms per file.

---

## Tasks

### Task 1: Create VoiceViolationChecker AST Visitor

**File:** `bot/utils/voice_linter.py`

**Requirements:**
- Import `ast`, `typing`, `pathlib`
- Define violation patterns as module constants:
  - `FORBIDDEN_TUTEAR = ["tienes", "tu ", "tu.", "haz", "puedes", "hagas"]`
  - `TECHNICAL_JARGON = ["database", "api", "exception", "error code", "null"]`
  - `LUCIEN_EMOJI = "ðŸŽ©"`
- Create `VoiceViolationChecker(ast.NodeVisitor)` class:
  - `__init__(self, filename: str)` - store filename, violations list, current_method
  - `check_string(self, string: str, lineno: int) -> None` - check string for violations
  - `visit_Str(self, node: ast.Str)` - Python 3.7 string literal visitor
  - `visit_Constant(self, node: ast.Constant)` - Python 3.8+ constant visitor
  - `visit_FunctionDef(self, node: ast.FunctionDef)` - track current method name

**check_string Logic:**
- Skip strings <50 chars (likely not messages)
- Skip strings starting with "<" (pure HTML tags)
- Convert to lowercase for matching
- Check for tutear words (FORBIDDEN_TUTEAR)
- Check for technical jargon (TECHNICAL_JARGON)
- Check for missing emoji in multi-line strings (contains "\n")
- Check for missing HTML in long messages (>400 chars)
- Append violations to self.violations with dict structure:
  - `{"line": lineno, "type": "tutear"|"jargon"|"missing_emoji"|"missing_html", "message": str}`

**Acceptance Criteria:**
- [x] VoiceViolationChecker extends ast.NodeVisitor
- [x] All violation pattern constants defined
- [x] check_string method implements all 4 checks
- [x] visit_Str and visit_Constant call check_string
- [x] visit_FunctionDef tracks current_method context
- [x] Violations stored with structured dict format

**Implementation Notes:**
```python
class VoiceViolationChecker(ast.NodeVisitor):
    """AST visitor that detects voice violations in message providers."""

    def __init__(self, filename: str):
        self.filename = filename
        self.violations = []
        self.current_method = None

    def check_string(self, string: str, lineno: int) -> None:
        """Check a string literal for voice violations."""
        # Skip short strings and pure HTML
        if len(string) < 50 or string.strip().startswith("<"):
            return

        string_lower = string.lower()

        # Check 1: Tutear
        for word in FORBIDDEN_TUTEAR:
            if word in string_lower:
                self.violations.append({
                    "line": lineno,
                    "type": "tutear",
                    "word": word,
                    "message": f'Uses tutear form "{word}"'
                })

        # Check 2: Technical jargon
        for term in TECHNICAL_JARGON:
            if term in string_lower:
                self.violations.append({
                    "line": lineno,
                    "type": "jargon",
                    "term": term,
                    "message": f'Contains technical jargon "{term}"'
                })

        # Check 3: Missing emoji in multi-line strings
        if "\\n" in string and LUCIEN_EMOJI not in string:
            self.violations.append({
                "line": lineno,
                "type": "missing_emoji",
                "message": f"Multi-line message missing ðŸŽ© emoji"
            })

        # Check 4: Missing HTML in long messages
        if len(string) > 400 and "<b>" not in string and "<i>" not in string:
            self.violations.append({
                "line": lineno,
                "type": "missing_html",
                "message": f"Long message (>400 chars) missing HTML formatting"
            })
```

---

### Task 2: Create check_file() Function

**File:** `bot/utils/voice_linter.py`

**Requirements:**
- `def check_file(filepath: Path) -> list:` - single file checker
- Open file with UTF-8 encoding
- Parse source with `ast.parse(source, filename=str(filepath))`
- Catch SyntaxError and return violation dict
- Create VoiceViolationChecker instance
- Call checker.visit(tree)
- Return checker.violations list

**Acceptance Criteria:**
- [x] check_file returns list of violation dicts
- [x] SyntaxErrors caught and returned as violation
- [x] UTF-8 encoding handling
- [x] Filename passed to AST parser for error reporting

---

### Task 3: Create Pre-Commit Hook Script

**File:** `.hooks/pre-commit`

**Requirements:**
- Shebang: `#!/usr/bin/env python3`
- Docstring explaining purpose
- Import `sys`, `subprocess`, `pathlib`
- Add parent directory to sys.path (to import bot.utils.voice_linter)
- Import `check_file` from bot.utils.voice_linter
- `main()` function:
  - Run `git diff --cached --name-only --diff-filter=ACM` to get staged files
  - Filter for `bot/services/message/*.py` files only
  - Return 0 if no message provider files changed
  - Iterate over files, call check_file, collect violations
  - Return 0 if no violations
  - Print formatted violations and return 1 if violations found

**Output Format:**
```
âŒ Voice consistency violations detected:

  bot/services/message/admin_vip.py:42
    TUTEAR: Uses tutear form "tienes"

  bot/services/message/user_start.py:15
    MISSING_EMOJI: Multi-line message missing ðŸŽ© emoji

Please fix these violations before committing.
Voice guidelines: docs/guia-estilo.md
```

**Acceptance Criteria:**
- [x] Executable script (chmod +x)
- [x] Only checks staged message provider files
- [x] Returns 0 for no violations, 1 for violations
- [x] Clear output format with file:line and violation type
- [x] References voice guidelines document

---

### Task 4: Create Git Hook Installation

**File:** `.hooks/install.sh` (NEW)

**Requirements:**
- Bash script to symlink `.hooks/pre-commit` to `.git/hooks/pre-commit`
- Check if hook already exists, backup if present
- Create symlink: `ln -sf ../../.hooks/pre-commit .git/hooks/pre-commit`
- Make executable: `chmod +x .git/hooks/pre-commit`
- Print success message

**Acceptance Criteria:**
- [x] Script creates symlink in .git/hooks/
- [x] Hook is executable
- [x] Existing hooks backed up before overwrite
- [x] Clear success/error messages

---

### Task 5: Write Tests for Voice Linter

**File:** `tests/test_voice_linter.py`

**Test Cases:**

1. **test_tutear_detection**
   - Create temp Python file with "tienes" in string
   - Run check_file
   - Assert violation detected with type="tutear"

2. **test_jargon_detection**
   - Create temp file with "database" in string
   - Run check_file
   - Assert violation with type="jargon"

3. **test_missing_emoji_multiline**
   - Create temp file with multi-line string without emoji
   - Run check_file
   - Assert violation with type="missing_emoji"

4. **test_missing_html_long_message**
   - Create temp file with >400 char string without HTML
   - Run check_file
   - Assert violation with type="missing_html"

5. **test_no_violations_clean_code**
   - Create temp file with clean Lucien voice
   - Run check_file
   - Assert empty violations list

6. **test_syntax_error_handling**
   - Create temp file with Python syntax error
   - Run check_file
   - Assert violation with type="syntax"

7. **test_skips_short_strings**
   - Create temp file with <50 char strings
   - Run check_file
   - Assert no violations for short strings

8. **test_skips_html_only_strings**
   - Create temp file with strings starting with "<"
   - Run check_file
   - Assert no violations for HTML-only strings

**Acceptance Criteria:**
- [x] All 8 test cases implemented
- [x] Tests use pytest fixtures (tmp_path)
- [x] Tests verify violation structure (type, message, line)
- [x] Tests cover all violation types

---

### Task 6: Integration Test with Pre-Commit Hook

**File:** `tests/test_voice_linter.py` (append)

**Test Case:** `test_pre_commit_hook_blocks_violations`

**Requirements:**
- Create temporary git repo (tmp_path)
- Create message provider file with voice violation
- Stage file with `git add`
- Run pre-commit hook script
- Assert returns 1 (failure)
- Assert violation printed to stdout

**Test Case:** `test_pre_commit_hook_allows_clean_code`

**Requirements:**
- Create temporary git repo
- Create message provider file with clean voice
- Stage file
- Run pre-commit hook
- Assert returns 0 (success)

**Acceptance Criteria:**
- [x] Integration test simulates real git workflow
- [x] Hook blocks violations (exit code 1)
- [x] Hook allows clean code (exit code 0)

---

## Verification Criteria

1. **ASTParsingAccuracy:** Detects violations in all message provider files without false positives on comments/docstrings
2. **Performance:** <100ms per file on typical message provider (500 lines)
3. **ViolationCoverage:** Catches 80% of voice violations (tutear, jargon, emoji, HTML)
4. **GitIntegration:** Pre-commit hook runs automatically on `git commit`
5. **BypassAvailable:** `git commit --no-verify` bypasses hook for edge cases
6. **StdlibOnly:** No external dependencies (pure Python ast module)

---

## Must Haves (Goal-Backward Verification)

**Goal:** Catch 80% of voice violations before they reach repository

1. **Must detect tutear:**
   - FORBIDDEN_TUTEAR list checked in check_string
   - Verified by test_tutear_detection

2. **Must detect technical jargon:**
   - TECHNICAL_JARGON list checked
   - Verified by test_jargon_detection

3. **Must detect missing emoji in multi-line messages:**
   - Check for "\n" without "ðŸŽ©"
   - Verified by test_missing_emoji_multiline

4. **Must detect missing HTML in long messages:**
   - Check length >400 without <b> or <i>
   - Verified by test_missing_html_long_message

5. **Must only check message provider files:**
   - Filter for bot/services/message/*.py
   - Verified by test_pre_commit_hook_allows_clean_code

6. **Must be fast (<100ms per file):**
   - AST parsing is O(n) with low constant
   - Verified by performance test (optional)

---

## Implementation Notes

- **AST vs Regex:** AST isolates string literals from comments, regex would have false positives
- **Python 3.7 vs 3.8:** Implement both visit_Str (3.7) and visit_Constant (3.8+) for compatibility
- **Tutear Word Boundary:** "tu " and "tu." with space/period to avoid false positives on "future", "actual"
- **HTML Detection:** Check for <b> or <i> tags, not just any HTML (allows <a>, <code> in specific contexts)
- **Multi-line Detection:** Check for "\n" not just length, some single-line messages are long
- **Hook Installation:** Symlink pattern allows hook updates without re-running install script

---

## Voice Rule Rationale

**Why these specific violations?**

1. **Tutear (tienes, tu, haz, puedes):**
   - Lucien is formal mayordomo, uses "usted" exclusively
   - Tutear breaks character and feels inconsistent

2. **Technical jargon (database, api, exception):**
   - Lucien speaks naturally to users, not developers
   - Technical terms confuse non-technical users
   - Exception: Admin error messages may use technical terms appropriately

3. **Missing ðŸŽ© emoji:**
   - Emoji is Lucien's signature, identifies him
   - Users recognize ðŸŽ© as "this is Lucien speaking"
   - Multi-line messages without emoji feel like generic bot

4. **Missing HTML formatting:**
   - Long messages (>400 chars) need visual structure
   - HTML formatting (bold, italic) improves readability
   - Plain text walls are hard to read on mobile

---

## Open Questions

1. **Q:** Should we add more forbidden words to FORBIDDEN_TUTEAR?
   **A:** Start with current list, collect violation statistics for 30 days post-deployment

2. **Q:** Should hook block commit or just warn?
   **A:** Block commit (exit code 1) enforces voice rules, --no-verify available for edge cases

3. **Q:** Should we add whitelist for acceptable contexts?
   **A:** No - current leniency (skip <50 chars, skip HTML-only) covers most cases

4. **Q:** Should we check admin messages differently than user messages?
   **A:** No - Lucien's voice is consistent across all contexts (formal mayordomo personality)

---

## Success Metrics

- **Violation detection rate:** 80% of voice violations caught before commit
- **False positive rate:** <10% (legitimate code flagged incorrectly)
- **Hook adoption:** 100% of developers have hook installed (via install.sh in onboarding)
- **Performance:** <100ms per file, <500ms for typical commit (5 files changed)
- **Developer satisfaction:** >70% of developers agree hook improves code quality (survey after 30 days)

---

**Status:** READY FOR EXECUTION
**Confidence:** HIGH (stdlib ast module proven, pre-commit pattern standard, violation patterns based on Phase 1-3 experience)
