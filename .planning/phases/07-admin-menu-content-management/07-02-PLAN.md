---
phase: 07-admin-menu-content-management
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified: [bot/handlers/admin/content.py, bot/handlers/admin/main.py]
autonomous: true

must_haves:
  truths:
    - "Admin puede navegar a men√∫ de contenido desde men√∫ principal"
    - "Admin puede ver lista de paquetes con paginaci√≥n"
    - "Admin puede ver detalles de paquete individual"
    - "Navegaci√≥n usa callbacks unificados (admin:content:*)"
  artifacts:
    - path: "bot/handlers/admin/content.py"
      provides: "Content management callback handlers for list, detail, and navigation"
      min_lines: 200
      exports: ["callback_content_menu", "callback_content_list", "callback_content_page", "callback_content_view"]
  key_links:
    - from: "bot/handlers/admin/main.py"
      to: "bot/handlers/admin/content.py"
      via: "admin:content callback handler registration"
      pattern: "@admin_router\\.callback_query\\(F\\.data == \"admin:content\"\\)"
    - from: "callback handlers"
      to: "AdminContentMessages"
      via: "ServiceContainer.message.admin.content"
      pattern: "container\\.message\\.admin\\.content\\."
---

<objective>
Create content management handlers (bot/handlers/admin/content.py) with callback handlers for navigation, package listing with pagination, and package detail view.

Purpose: Implement navigation and display logic for content management interface using AdminContentMessages from plan 07-01, following established admin handler patterns (main.py, pricing.py) with unified callback structure admin:content:*.
Output: New content.py handler file with 5+ callback handlers, integrated into admin router.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-admin-menu-content-management/07-CONTEXT.md
@.planning/phases/07-admin-menu-content-management/07-RESEARCH.md

@bot/handlers/admin/main.py
@bot/handlers/admin/pricing.py
@bot/utils/pagination.py
@bot/services/content.py
@.planning/phases/07-admin-menu-content-management/07-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create content.py handler file with navigation callbacks</name>
  <files>bot/handlers/admin/content.py</files>
  <action>
Create bot/handlers/admin/content.py with content management callback handlers:

1. File structure:
```python
"""
Content Management Handlers - Admin interface for managing content packages.

Handlers for listing, viewing, creating, editing, and deactivating content packages.
"""
import logging
from aiogram import Router, F
from aiogram.types import CallbackQuery
from sqlalchemy.ext.asyncio import AsyncSession

from bot.middlewares import DatabaseMiddleware
from bot.services.container import ServiceContainer
from bot.utils.pagination import Paginator, create_pagination_keyboard

logger = logging.getLogger(__name__)

# Router for content management handlers
content_router = Router(name="admin_content")

# Apply middleware (AdminAuth already on admin_router, this integrates into it)
content_router.callback_query.middleware(DatabaseMiddleware())
```

2. Required callback handlers:
   - callback_content_menu(F.data == "admin:content")
     ‚Üí Show content menu with [List Packages] [Create Package] [Back to Main]

   - callback_content_list(F.data == "admin:content:list")
     ‚Üí Show first page of packages (page 1, limit 10)

   - callback_content_page(F.data.startswith("admin:content:page:"))
     ‚Üí Show specific page, extract page number from callback data

   - callback_content_view(F.data.startswith("admin:content:view:"))
     ‚Üí Show package details, extract package_id from callback data

   - callback_content_back(F.data == "admin:content")
     ‚Üí Return to content menu (same as callback_content_menu)

3. Navigation pattern (from RESEARCH.md):
```python
@content_router.callback_query(F.data == "admin:content")
async def callback_content_menu(callback: CallbackQuery, session: AsyncSession):
    """Show content management submenu."""
    container = ServiceContainer(session, callback.bot)
    text, keyboard = container.message.admin.content.content_menu()
    await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    await callback.answer()
```

4. Pagination pattern (from RESEARCH.md):
```python
@content_router.callback_query(F.data.startswith("admin:content:page:"))
async def callback_content_page(callback: CallbackQuery, session: AsyncSession):
    """Show specific page of content packages."""
    page_num = int(callback.data.split(":")[-1])
    container = ServiceContainer(session, callback.bot)

    # Get all packages (in-memory pagination per RESEARCH.md recommendation)
    all_packages = await container.content.list_packages(is_active=None)
    paginator = Paginator(items=all_packages, page_size=10)
    page = paginator.get_page(page_num)

    # Format display using AdminContentMessages
    text, keyboard = container.message.admin.content.content_list_page(page)
    await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    await callback.answer()
```

5. Detail view pattern:
```python
@content_router.callback_query(F.data.startswith("admin:content:view:"))
async def callback_content_view(callback: CallbackQuery, session: AsyncSession):
    """Show package details with action buttons."""
    package_id = int(callback.data.split(":")[-1])
    container = ServiceContainer(session, callback.bot)

    package = await container.content.get_package(package_id)
    if not package:
        await callback.answer("‚ùå Paquete no encontrado", show_alert=True)
        return

    text, keyboard = container.message.admin.content.package_detail(package)
    await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    await callback.answer()
```

DO NOT:
- Add AdminAuthMiddleware (applied at admin_router level, not per-subrouter)
- Call session.commit() (SessionContextManager handles it)
- Use hardcoded pagination (use Paginator utility)
- Use InlineKeyboardBuilder directly (use AdminContentMessages keyboards)
- Forget callback.answer() at end of handlers
  </action>
  <verify>
1. File created: bot/handlers/admin/content.py
2. Has content_router with Router(name="admin_content")
3. Has 5+ callback handlers (menu, list, page, view, back)
4. All handlers use ServiceContainer
5. All handlers use AdminContentMessages for text/keyboards
6. All handlers call callback.answer()
7. No session.commit() calls
8. Pagination uses Paginator utility
9. Follows admin handler pattern (main.py, pricing.py)
  </verify>
  <done>
Content management handler file created with navigation and display callbacks, using AdminContentMessages and following established patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate content_router into admin router</name>
  <files>bot/handlers/admin/main.py</files>
  <action>
Update bot/handlers/admin/main.py to include content_router:

1. Import content_router:
```python
from bot.handlers.admin import content as admin_content
```

2. After admin_router definition, include content_router:
```python
# Include content management router
admin_router.include_router(admin_content.content_router)
```

3. Placement: After other router includes (if any), before handler definitions

DO NOT:
- Modify existing handlers
- Change AdminAuthMiddleware application (stays on admin_router)
- Duplicate router registration
  </action>
  <verify>
1. admin_content.content_router imported
2. admin_router.include_router() called for content_router
3. Content management callbacks registered in admin router
4. Existing admin handlers unchanged
5. AdminAuthMiddleware still applies (via admin_router inheritance)
  </verify>
  <done>
Content router integrated into admin router, all content management callbacks active.
  </done>
</task>

</tasks>

<verification>
Overall phase verification:
1. bot/handlers/admin/content.py exists with content_router
2. 5+ callback handlers implemented (menu, list, page, view, back)
3. content_router included in admin_router
4. Admin can navigate: /admin ‚Üí Paquetes de Contenido ‚Üí List ‚Üí View Detail
5. Pagination works with Next/Prev buttons
6. All handlers use AdminContentMessages
7. All handlers call callback.answer()
8. No session commits in handlers
</verification>

<success_criteria>
1. Admin clicks "üì¶ Paquetes de Contenido" and sees content menu
2. Admin clicks "Listar Paquetes" and sees package list (paginated)
3. Admin can navigate pages with Next/Prev buttons
4. Admin clicks package and sees detail view
5. Detail view shows all package fields with action buttons
6. Navigation works: List ‚Üí Detail ‚Üí Back to List ‚Üí Back to Menu
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-menu-content-management/07-02-SUMMARY.md`
</output>
