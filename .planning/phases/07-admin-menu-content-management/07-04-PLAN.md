---
phase: 07-admin-menu-content-management
plan: 04
type: execute
wave: 4
depends_on: [07-01, 07-02, 07-03]
files_modified: [bot/handlers/admin/content.py]
autonomous: true

must_haves:
  truths:
    - "Admin puede crear nuevo paquete con wizard paso a paso"
    - "Wizard valida cada campo antes de avanzar"
    - "Admin puede editar paquetes existentes (nombre, precio, descripción)"
    - "Admin puede desactivar/reactivar paquetes con confirmación"
    - "FSM states se limpian al cancelar/completar"
  artifacts:
    - path: "bot/handlers/admin/content.py"
      provides: "Content CRUD operations (create, edit, toggle) with FSM wizard"
      contains: "callback_content_create_start, process_content_name, process_content_type, process_content_price, process_content_description"
      exports: ["create wizard handlers", "edit handlers", "toggle handlers"]
  key_links:
    - from: "create wizard handlers"
      to: "ContentPackageStates"
      via: "state.set_state() and state.update_data()"
      pattern: "await state\\.set_state\\(ContentPackageStates\\."
    - from: "CRUD handlers"
      to: "ContentService"
      via: "ServiceContainer.content"
      pattern: "await container\\.content\\.(create_package|update_package|toggle_package)"
---

<objective>
Implement content CRUD operations (create wizard, edit prompts, toggle active/inactive) in bot/handlers/admin/content.py using ContentPackageStates FSM and ContentService.

Purpose: Complete content management functionality with multi-step creation wizard, inline editing for single fields, and soft delete toggle with confirmation, following patterns from pricing.py and research recommendations.
Output: Enhanced content.py with 10+ handlers for create, edit, and toggle operations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-admin-menu-content-management/07-CONTEXT.md
@.planning/phases/07-admin-menu-content-management/07-RESEARCH.md

@bot/handlers/admin/pricing.py
@bot/states/admin.py
@bot/services/content.py
@bot/services/message/admin_content.py
@.planning/phases/07-admin-menu-content-management/07-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement content package creation wizard</name>
  <files>bot/handlers/admin/content.py</files>
  <action>
Add creation wizard handlers to bot/handlers/admin/content.py:

1. Import FSM components:
```python
from aiogram.fsm.context import FSMContext
from bot.states.admin import ContentPackageStates
```

2. Creation handlers (following pricing.py pattern lines 97-132):

**a. Start wizard (callback):**
```python
@content_router.callback_query(F.data == "admin:content:create")
async def callback_content_create_start(callback: CallbackQuery, state: FSMContext):
    """Inicia flujo de creación de paquete."""
    await state.set_state(ContentPackageStates.waiting_for_name)

    container = ServiceContainer(...)

    text, keyboard = container.message.admin.content.create_step_name()
    await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    await callback.answer()
```

**b. Process name (message):**
```python
@content_router.message(ContentPackageStates.waiting_for_name)
async def process_content_name(message: Message, state: FSMContext, session: AsyncSession):
    """Procesa nombre del paquete."""
    name = message.text.strip()

    # Validación: no vacío, max 200 chars
    if not name or len(name) > 200:
        await message.answer("❌ Nombre inválido. Debe tener 1-200 caracteres.")
        return  # Keep state active for retry

    await state.update_data(name=name)
    await state.set_state(ContentPackageStates.waiting_for_type)

    container = ServiceContainer(session, message.bot)
    text, keyboard = container.message.admin.content.create_step_type()
    await message.answer(text=text, reply_markup=keyboard, parse_mode="HTML")
```

**c. Process type (callback - inline buttons):**
```python
@content_router.callback_query(F.data.startswith("admin:content:type:"), ContentPackageStates.waiting_for_type)
async def process_content_type(callback: CallbackQuery, state: FSMContext, session: AsyncSession):
    """Procesa tipo seleccionado via botones."""
    # Extract type from callback: "admin:content:type:VIP_PREMIUM"
    package_type_str = callback.data.split(":")[-1]

    # Convert to enum
    from bot.database.enums import PackageType
    package_type = PackageType[package_type_str]

    await state.update_data(package_type=package_type)
    await state.set_state(ContentPackageStates.waiting_for_price)

    container = ServiceContainer(session, callback.bot)
    text, keyboard = container.message.admin.content.create_step_price()
    await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    await callback.answer()
```

**d. Process price (message - optional):**
```python
@content_router.message(ContentPackageStates.waiting_for_price)
async def process_content_price(message: Message, state: FSMContext, session: AsyncSession):
    """Procesa precio (opcional)."""
    text = message.text.strip()

    # Allow /skip to omit
    if text == "/skip":
        await state.update_data(price=None)
        await state.set_state(ContentPackageStates.waiting_for_description)
        # Continue to description step...
        return

    # Validate: must be numeric, non-negative
    try:
        price = float(text)
        if price < 0:
            raise ValueError("Price cannot be negative")
    except ValueError:
        await message.answer("❌ Precio inválido. Envía un número positivo o /skip para omitir.")
        return  # Keep state active

    await state.update_data(price=price)
    await state.set_state(ContentPackageStates.waiting_for_description)
    # Continue to description step...
```

**e. Process description (message - optional) and complete:**
```python
@content_router.message(ContentPackageStates.waiting_for_description)
async def process_content_description(message: Message, state: FSMContext, session: AsyncSession):
    """Procesa descripción y crea paquete."""
    description = message.text.strip()

    # Allow /skip to omit
    if description == "/skip":
        description = None

    # Get all collected data
    data = await state.get_data()

    # Create package using ContentService
    container = ServiceContainer(session, message.bot)
    package = await container.content.create_package(
        name=data["name"],
        category=data["package_type"],  # Note: using category field
        description=description,
        price=data.get("price")
    )

    # Clear FSM state (CRITICAL - per RESEARCH.md Pitfall 1)
    await state.clear()

    # Show success message with action buttons
    text, keyboard = container.message.admin.content.create_success(package)
    await message.answer(text=text, reply_markup=keyboard, parse_mode="HTML")
```

**f. Cancel handler (callback):**
```python
@content_router.callback_query(F.data == "admin:content:create:cancel")
async def callback_content_create_cancel(callback: CallbackQuery, state: FSMContext, session: AsyncSession):
    """Cancela creación de paquete."""
    await state.clear()  # CRITICAL: Always clear FSM state

    container = ServiceContainer(session, callback.bot)
    text, keyboard = container.message.admin.content.content_menu()
    await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    await callback.answer()
```

DO NOT:
- Forget to call await state.clear() on cancel/complete (Pitfall 1)
- Forget callback.answer() at end of callback handlers (Pitfall 2)
- Call session.commit() (SessionContextManager handles it) (Pitfall 5)
- Skip validation for price field (Pitfall 4)
- Use InlineKeyboardBuilder directly (use AdminContentMessages)
  </action>
  <verify>
1. Creation start handler: callback_content_create_start
2. Name handler: process_content_name with validation
3. Type handler: process_content_type with inline buttons
4. Price handler: process_content_price with /skip support
5. Description handler: process_content_description with /skip support
6. Cancel handler: callback_content_create_cancel
7. All handlers clear FSM state appropriately
8. All callback handlers call callback.answer()
9. No session.commit() calls
10. Validation for name (not empty, max 200) and price (numeric, non-negative)
  </verify>
  <done>
Creation wizard implemented with 4-step FSM flow, validation at each stage, cancel support, and proper state cleanup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement content package edit handlers</name>
  <files>bot/handlers/admin/content.py</files>
  <action>
Add edit handlers to bot/handlers/admin/content.py following inline prompt pattern from RESEARCH.md:

Note: waiting_for_edit state is already defined in ContentPackageStates (added in plan 07-03).

1. Edit initiation (callback from detail view):
```python
@content_router.callback_query(F.data.startswith("admin:content:edit:"))
async def callback_content_edit_field(callback: CallbackQuery, state: FSMContext, session: AsyncSession):
    """Prompt for field value edit."""
    # Extract package_id and field from callback: "admin:content:edit:123:name"
    parts = callback.data.split(":")
    package_id = int(parts[3])
    field = parts[4]  # name, price, or description

    await state.set_state(ContentPackageStates.waiting_for_edit)
    await state.update_data(package_id=package_id, field=field)

    container = ServiceContainer(session, callback.bot)
    package = await container.content.get_package(package_id)

    # Get current value for display
    current_value = getattr(package, field, "N/A")

    text, keyboard = container.message.admin.content.edit_prompt(field, current_value)
    await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    await callback.answer()
```

2. Process edit (message):
```python
@content_router.message(ContentPackageStates.waiting_for_edit)
async def process_content_edit(message: Message, state: FSMContext, session: AsyncSession):
    """Process field edit and update package."""
    data = await state.get_data()
    package_id = data["package_id"]
    field = data["field"]

    # Allow /skip to keep current value
    if message.text.strip() == "/skip":
        await state.clear()
        # Return to detail view...
        return

    container = ServiceContainer(session, message.bot)

    # Validate based on field
    if field == "price":
        try:
            new_value = float(message.text.strip())
            if new_value < 0:
                raise ValueError("Price cannot be negative")
        except ValueError:
            await message.answer("❌ Precio inválido. Debe ser un número positivo.")
            return  # Keep state active
    else:
        new_value = message.text.strip()
        # Name validation
        if field == "name" and (not new_value or len(new_value) > 200):
            await message.answer("❌ Nombre inválido. Debe tener 1-200 caracteres.")
            return

    # Update using ContentService
    await container.content.update_package(package_id, **{field: new_value})

    await state.clear()

    # Show updated detail view
    package = await container.content.get_package(package_id)
    text, keyboard = container.message.admin.content.package_detail(package)
    await message.answer(text=text, reply_markup=keyboard, parse_mode="HTML")
```

DO NOT:
- Allow editing type/category field (locked per CONTEXT.md decision)
- Forget state.clear() after edit
- Skip validation for name and price fields
- Use /skip pattern (must be supported)
  </action>
  <verify>
1. Edit initiation handler: callback_content_edit_field
2. Process edit handler: process_content_edit
3. Uses ContentPackageStates.waiting_for_edit (from plan 07-03)
4. Supports /skip to keep current value
5. Validates name (not empty, max 200) and price (numeric, non-negative)
6. Type field cannot be edited (not in edit options)
7. FSM state cleared after edit
8. Returns to detail view after successful edit
  </verify>
  <done>
Edit handlers implemented with inline prompt pattern, field validation, /skip support, and return to detail view.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement content package toggle (activate/deactivate) handlers</name>
  <files>bot/handlers/admin/content.py</files>
<action>
Add toggle handlers to bot/handlers/admin/content.py following soft delete pattern from RESEARCH.md:

1. Deactivate confirmation (callback from detail view):
```python
@content_router.callback_query(F.data.startswith("admin:content:deactivate:"))
async def callback_content_deactivate_confirm(callback: CallbackQuery, session: AsyncSession):
    """Show deactivation confirmation dialog."""
    package_id = int(callback.data.split(":")[-1])

    container = ServiceContainer(session, callback.bot)
    package = await container.content.get_package(package_id)

    if not package:
        await callback.answer("❌ Paquete no encontrado", show_alert=True)
        return

    text, keyboard = container.message.admin.content.deactivate_confirm(package)
    await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    await callback.answer()
```

2. Deactivate action (callback from confirmation):
```python
@content_router.callback_query(F.data.startswith("admin:content:deactivate:confirm:"))
async def callback_content_deactivate(callback: CallbackQuery, session: AsyncSession):
    """Deactivate package (soft delete)."""
    package_id = int(callback.data.split(":")[-1])

    container = ServiceContainer(session, callback.bot)
    result = await container.content.deactivate_package(package_id)

    if result:
        await callback.answer("✅ Paquete desactivado", show_alert=True)
        # Return to detail view...
        package = await container.content.get_package(package_id)
        text, keyboard = container.message.admin.content.package_detail(package)
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    else:
        await callback.answer("❌ Error al desactivar", show_alert=True)
```

3. Reactivate confirmation (callback from detail view for inactive packages):
```python
@content_router.callback_query(F.data.startswith("admin:content:reactivate:"))
async def callback_content_reactivate_confirm(callback: CallbackQuery, session: AsyncSession):
    """Show reactivation confirmation dialog."""
    package_id = int(callback.data.split(":")[-1])

    container = ServiceContainer(session, callback.bot)
    package = await container.content.get_package(package_id)

    if not package:
        await callback.answer("❌ Paquete no encontrado", show_alert=True)
        return

    text, keyboard = container.message.admin.content.reactivate_confirm(package)
    await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    await callback.answer()
```

4. Reactivate action (callback from confirmation):
```python
@content_router.callback_query(F.data.startswith("admin:content:reactivate:confirm:"))
async def callback_content_reactivate(callback: CallbackQuery, session: AsyncSession):
    """Reactivate package."""
    package_id = int(callback.data.split(":")[-1])

    container = ServiceContainer(session, callback.bot)
    result = await container.content.activate_package(package_id)

    if result:
        await callback.answer("✅ Paquete reactivado", show_alert=True)
        # Return to detail view...
        package = await container.content.get_package(package_id)
        text, keyboard = container.message.admin.content.package_detail(package)
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    else:
        await callback.answer("❌ Error al reactivar", show_alert=True)
```

Note: activate_package() method should exist in ContentService (soft delete reactivation). If not, use toggle_package().

DO NOT:
- Use hard delete (session.delete()) - always use soft delete
- Forget callback.answer() with show_alert for user feedback
- Call session.commit() manually
- Skip error handling for missing packages
  </action>
  <verify>
1. Deactivate confirmation handler: callback_content_deactivate_confirm
2. Deactivate action handler: callback_content_deactivate
3. Reactivate confirmation handler: callback_content_reactivate_confirm
4. Reactivate action handler: callback_content_reactivate
5. Uses soft delete (deactivate_package/activate_package from ContentService)
6. Returns to detail view after action
7. Shows alert with success/error feedback
8. No session.commit() calls
9. Error handling for missing packages
  </verify>
  <done>
Toggle handlers implemented with soft delete pattern, confirmation dialogs, and user feedback via alerts.
  </done>
</task>

</tasks>

<verification>
Overall phase verification:
1. Creation wizard: 6 handlers (start, name, type, price, description, cancel)
2. Edit handlers: 2 handlers (initiate, process) with waiting_for_edit state
3. Toggle handlers: 4 handlers (deactivate confirm/action, reactivate confirm/action)
4. All FSM states cleared appropriately
5. All callbacks call callback.answer()
6. No session.commit() calls
7. Validation for name, price fields
8. /skip support for optional fields
9. Type field locked (not editable)
10. Soft delete used (no hard delete)
</verification>

<success_criteria>
1. Admin can create package via 4-step wizard
2. Wizard validates each field before advancing
3. Admin can cancel wizard at any step
4. Admin can edit name, price, description (not type)
5. Edit uses inline prompt with /skip support
6. Admin can deactivate package with confirmation
7. Admin can reactivate inactive package
8. All operations return to appropriate view (detail/list/menu)
9. FSM states never leak (always cleared)
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-menu-content-management/07-04-SUMMARY.md`
</output>
