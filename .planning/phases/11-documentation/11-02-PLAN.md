---
phase: 11-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/MENU_SYSTEM.md
autonomous: true

must_haves:
  truths:
    - "MENU_SYSTEM.md exists with complete menu system architecture documentation"
    - "Document explains role-based menu routing (Admin/VIP/Free)"
    - "Message provider architecture is documented with diagrams"
    - "Keyboard factory patterns and callback handling are explained"
    - "Lucien's voice integration across all menus is documented"
  artifacts:
    - path: "docs/MENU_SYSTEM.md"
      provides: "Menu system architecture documentation"
      min_lines: 300
      contains: ["Role Detection", "Message Providers", "Keyboard Factory", "Callback Routing", "Lucien Voice"]
  key_links:
    - from: "docs/MENU_SYSTEM.md"
      to: "bot/services/message/*.py"
      via: "Architecture documentation links implementation"
      pattern: "Reference to message provider files"
    - from: "docs/MENU_SYSTEM.md"
      to: "bot/handlers/**/*.py"
      via: "Handler routing documentation"
      pattern: "Handler routing examples"
---

<objective>
Create comprehensive architecture documentation for the menu system (MENU_SYSTEM.md).

Purpose: Provide developers with complete understanding of how role-based menus work, message provider architecture, keyboard factory patterns, and callback routing.
Output: 300+ line documentation file with diagrams, code examples, and architecture explanations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@docs/ARCHITECTURE.md
@docs/guia-estilo.md

# Menu system implementation
@bot/services/message/base.py
@bot/services/message/user_menu.py
@bot/middlewares/role_detection.py
@bot/handlers/vip/menu.py
@bot/handlers/free/menu.py
@bot/handlers/admin/menu.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MENU_SYSTEM.md with Architecture Overview</name>
  <files>
    docs/MENU_SYSTEM.md
  </files>
  <action>
    Create comprehensive menu system architecture documentation:

    **File structure:**
    ```markdown
    # Menu System Architecture

    ## Overview
    - Purpose and goals
    - Role-based menu concept
    - Lucien's voice integration

    ## Architecture Diagram
    - ASCII art showing component relationships
    - Request flow from user to response
    - Service interactions

    ## Role Detection System
    - UserRoleDetectionMiddleware
    - Priority order (Admin > VIP > Free)
    - Role change logging

    ## Message Provider Architecture
    - BaseMessageProvider pattern
    - Stateless design principles
    - Provider hierarchy
    - Voice consistency enforcement

    ## Keyboard Factory System
    - InlineKeyboardBuilder usage
    - Callback data patterns
    - Navigation helpers

    ## Callback Routing
    - Router separation by role
    - Callback pattern matching
    - Handler execution flow

    ## Lucien Voice Integration
    - Voice style guide reference
    - Session-aware variations
    - Role-specific terminology

    ## Code Examples
    - Adding a new menu option
    - Creating a message provider
    - Handling callbacks

    ## Testing Guide
    - Testing message providers
    - Testing keyboard interactions
    - Mocking services
    ```

    **Content requirements:**
    - Include ASCII architecture diagram showing all components
    - Document role detection priority and edge cases
    - Explain BaseMessageProvider stateless pattern with examples
    - Show callback data format conventions (e.g., "admin:content:list")
    - Include voice terminology reference (círculo, jardín, custodio)
    - Provide code examples for common operations
    - Link to relevant source files (@bot/services/message/*.py)

    **Diagrams to include:**
    ```
    Menu System Flow:
    User Message → Role Detection → Router Selection
                                         ↓
                            Message Provider → Keyboard Builder
                                         ↓
                            Response to User

    Provider Hierarchy:
    BaseMessageProvider (ABC)
         ├─ CommonMessages (shared)
         ├─ Admin*Messages (admin menus)
         └─ User*Messages (VIP/Free menus)
    ```

    **Write in Spanish** (consistent with project documentation style)
  </action>
  <verify>
    wc -l docs/MENU_SYSTEM.md
    grep -c "##" docs/MENU_SYSTEM.md
  </verify>
  <done>
    MENU_SYSTEM.md exists with:
    - 300+ lines of documentation
    - Architecture diagrams in ASCII art
    - All major sections completed
    - Code examples throughout
    - Links to implementation files
  </done>
</task>

<task type="auto">
  <name>Task 2: Document Role Detection and Routing</name>
  <files>
    docs/MENU_SYSTEM.md
  </files>
  <action>
    Add comprehensive role detection and routing documentation to MENU_SYSTEM.md:

    **Section: Sistema de Detección de Rol**
    ```markdown
    ## Sistema de Detección de Rol

    ### UserRoleDetectionMiddleware
    - How it works (stateless, recalculates on each request)
    - Detection priority: Admin > VIP > Free
    - Database queries involved
    - Role injection into event data

    ### Role Change Logging
    - RoleChangeService integration
    - Audit trail for all role changes
    - Automatic vs manual changes

    ### Router Architecture
    - Separate routers per role (admin_router, vip_router, free_router)
    - Router registration in main.py
    - Middleware application per router

    ### Code Example
    ```python
    # Role detection in action
    @router.message(Command("start"))
    async def start_handler(message: Message, user_role: UserRole):
        if user_role == UserRole.ADMIN:
            return await admin_menu(message)
        elif user_role == UserRole.VIP:
            return await vip_menu(message)
        else:
            return await free_menu(message)
    ```
    ```

    **Section: Callback Routing Patterns**
    ```markdown
    ## Patrones de Callback

    ### Format Convention
    - Hierarchical: `{scope}:{entity}:{action}:{id}`
    - Examples:
      - `admin:content:list` - List content packages
      - `admin:user:role:confirm:123:VIP` - Confirm role change
      - `user:vip:content:view:5` - View content package details

    ### Handler Pattern
    ```python
    @router.callback_query(F.data.startswith("admin:content:"))
    async def content_callback_handler(callback: CallbackQuery):
        parts = callback.data.split(":")
        action = parts[2]  # "list", "view", "edit"
        await callback.answer()

        if action == "list":
            return await show_content_list(callback)
        # ... other actions
    ```
    ```

    **Add to existing MENU_SYSTEM.md file**
  </action>
  <verify>
    grep -c "Sistema de Detección" docs/MENU_SYSTEM.md
    grep -c "Callback Routing" docs/MENU_SYSTEM.md
  </verify>
  <done>
    Role detection section includes:
    - Middleware explanation
    - Detection priority documented
    - Router architecture explained
    - Callback format conventions
    - Code examples for routing
  </done>
</task>

<task type="auto">
  <name>Task 3: Document Message Provider Patterns</name>
  <files>
    docs/MENU_SYSTEM.md
  </files>
  <action>
    Add message provider architecture documentation to MENU_SYSTEM.md:

    **Section: Arquitectura de Message Providers**
    ```markdown
    ## Arquitectura de Message Providers

    ### BaseMessageProvider Pattern
    - Abstract base class for all providers
    - Stateless design (no session/bot in __init__)
    - Context passed as parameters
    - Lazy loading via ServiceContainer

    ### Provider Hierarchy
    ```
    BaseMessageProvider
         ├─ CommonMessages (mensajes compartidos)
         │   └─ Success, Error, Navigation patterns
         ├─ Admin*Messages (7 providers)
         │   ├── AdminMainMessages
         │   ├── AdminVIPMessages
         │   ├── AdminFreeMessages
         │   ├── AdminContentMessages
         │   ├── AdminInterestMessages
         │   └── AdminUserMessages
         └─ User*Messages (3 providers)
             ├── UserStartMessages
             ├── UserMenuMessages
             └─ UserFlowMessages
    ```

    ### Stateless Pattern Benefits
    - Memory efficient (no per-user state)
    - Thread-safe (async/await compatible)
    - Testable (pure function-like behavior)
    - Cacheable (same input = same output)

    ### Session-Aware Variations
    - SessionHistory prevents repetition
    - Exclusion window of 2 variants
    - ~80 bytes/user memory overhead

    ### Code Example
    ```python
    # Creating a message provider
    class MyMenuMessages(BaseMessageProvider):
        def main_menu(self, user_name: str) -> tuple[str, InlineKeyboardMarkup]:
            """Generate main menu message."""
            text = self._greeting(user_name)
            keyboard = self._menu_keyboard()
            return text, keyboard

        def _greeting(self, user_name: str) -> str:
            return random_choice([
                f"Bienvenido, {user_name}.",
                f"Saludos, {user_name}.",
            ])
    ```
    ```

    **Section: Voz de Lucien**
    ```markdown
    ## Integración de la Voz de Lucien

    ### Voice Style Guide
    - Referencia: docs/guia-estilo.md
    - Personalidad: Sofisticado, misterioso, observador
    - Terminología:
      - Admin: "custodio"
      - VIP: "círculo exclusivo", "tesoros"
      - Free: "jardín público", "visitantes"

    ### Role-Specific Voice
    - VIP users: Elegant, exclusive tone
    - Free users: Welcoming, informative tone
    - Admin: Collaborative, formal tone

    ### Variation System
    - Weighted random selection (60/30/10)
    - Session-aware to prevent repetition
    - Voice linting via pre-commit hook
    ```

    **Add to existing MENU_SYSTEM.md file**
  </action>
  <verify>
    grep -c "Message Provider" docs/MENU_SYSTEM.md
    grep -c "Voz de Lucien" docs/MENU_SYSTEM.md
  </verify>
  <done>
    Message provider section includes:
    - BaseMessageProvider pattern explained
    - Provider hierarchy documented
    - Stateless pattern benefits listed
    - Session-aware variations explained
    - Lucien's voice integration documented
    - Code examples for creating providers
  </done>
</task>

</tasks>

<verification>
After completion, verify:
1. MENU_SYSTEM.md exists and is 300+ lines
2. All major sections are present (Overview, Role Detection, Message Providers, Callback Routing, Lucien Voice)
3. ASCII diagrams included for architecture visualization
4. Code examples provided for common operations
5. Links to implementation files included
6. Written in Spanish (consistent with project)
</verification>

<success_criteria>
1. File exists with 300+ lines
2. grep -c "##" returns 10+ section headers
3. All major components documented
4. Examples are copy-paste runnable
5. Developers can understand system without reading source
</success_criteria>

<output>
After completion, create `.planning/phases/11-documentation/11-02-SUMMARY.md`
</output>
