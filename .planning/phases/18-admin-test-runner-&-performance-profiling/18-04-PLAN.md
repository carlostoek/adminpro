---
phase: 18
plan: 04
name: SQLite to PostgreSQL Migration and N+1 Query Detection
wave: 3
depends_on: 18-02
autonomous: true
---

# Plan 18-04: SQLite to PostgreSQL Migration and N+1 Query Detection

## Objective

Create a robust data migration script to transfer all data from SQLite to PostgreSQL without loss, and implement N+1 query detection with SQLAlchemy logging to identify and fix performance bottlenecks.

## Success Criteria

1. `python scripts/migrate_to_postgres.py --source bot.db --target postgresql://...` migrates all data
2. Migration validates row counts match between source and target
3. N+1 query detection logs warnings when detected
4. Services use eager loading (selectinload) where appropriate
5. Query analyzer provides actionable optimization suggestions

## Tasks

### Task 1: Create Query Analyzer Utility

Create `bot/utils/query_analyzer.py` with:
- QueryInfo and NPlusOnePattern dataclasses
- QueryAnalyzer class with SQLAlchemy event listeners
- analyze_queries() context manager
- QueryOptimizationSuggestions helper class
- detect_n_plus_one_in_service decorator

### Task 2: Update Services with Eager Loading

Update `bot/services/subscription.py`:
- Add selectinload imports
- Add get_vip_subscriber_with_relations() method
- Add get_all_vip_subscribers_with_users() method with eager loading

Update `bot/services/channel.py`:
- Add similar eager loading patterns for channel queries

### Task 3: Create Migration Script

Create `scripts/migrate_to_postgres.py`:
- DatabaseMigrator class with MIGRATION_ORDER
- migrate_table() method with dry-run support
- validate_migration() with row count checks
- generate_report() for JSON output
- CLI with --source, --target, --dry-run, --validate-only, --output

### Task 4: Add Query Logging Configuration

Update `bot/database/engine.py`:
- Add create_async_engine_with_logging() function
- Support debug mode query logging
- Configure sqlalchemy.engine logger

### Task 5: Create Admin Query Analysis Command

Update `bot/handlers/admin/profile.py`:
- Add /analyzeQueries command
- Run test operations with QueryAnalyzer
- Report N+1 issues and slow queries
- Provide optimization suggestions

## Anti-Patterns to Avoid

1. Don't migrate without validation - Always verify row counts
2. Don't use lazy loading in loops - Use selectinload instead
3. Don't ignore slow query logs - Investigate queries >100ms
4. Don't migrate to production directly - Test on staging first
5. Don't keep query analysis on in production - It adds overhead
