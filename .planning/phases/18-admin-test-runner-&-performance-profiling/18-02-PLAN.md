---
wave: 2
depends_on: 18-01
files_modified:
  - bot/services/test_runner.py
  - bot/utils/test_report.py
  - bot/handlers/admin/tests.py
autonomous: true
---

# Plan 18-02: Test Reporting with Coverage and Detailed Results

## Objective

Enhance the test runner system with comprehensive reporting capabilities including coverage analysis, detailed failure reports, historical tracking, and formatted output suitable for Telegram messages.

## Context

The basic test runner from Plan 18-01 executes tests and returns raw results. This plan adds sophisticated reporting that transforms raw pytest output into actionable intelligence for administrators.

**Current State:**
- TestRunnerService executes tests and returns TestResult dataclass
- Basic formatting exists but lacks coverage integration
- No historical tracking of test runs
- Failure details are truncated in Telegram output

## Success Criteria

1. Coverage percentage displayed in test reports
2. Failed tests show file:line and error message excerpts
3. Reports include duration trends (vs previous runs)
4. HTML coverage reports generated and storable
5. Telegram messages use formatting (bold, code blocks, emojis)

## Tasks

### Task 1: Enhance TestResult with Coverage Data

Extend TestResult dataclass to include coverage_percent, coverage_by_module, failed_tests list, and warnings.

### Task 2: Create Test Report Utility Module

Create `bot/utils/test_report.py` with:
- TestRunRecord dataclass for historical tracking
- TestReportHistory class for JSON persistence
- TestReportFormatter with format_telegram(), format_console(), format_json(), generate_html_report()

### Task 3: Update TestRunnerService with Enhanced Reporting

Update `bot/services/test_runner.py` to integrate reporting:
- Add run_tests_with_report() method
- Git commit/branch tracking
- History integration for trend comparison
- HTML report generation option

### Task 4: Update Telegram Handler

Update `bot/handlers/admin/tests.py`:
- Use enhanced reporting in /run_tests
- Add /run_tests trend command
- Add /run_tests html option
- Split long reports into multiple messages
- Send HTML report as document

## Anti-Patterns to Avoid

1. Don't store full stdout in history - Too large
2. Don't generate HTML on every run - Make it optional
3. Don't show raw tracebacks in Telegram - Format and truncate
4. Don't block on history save - Use async file operations
5. Don't expose sensitive paths - Sanitize file paths
