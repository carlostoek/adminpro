---
phase: 14-database-migration-foundation
plan: 14-03
type: execute
wave: 3
depends_on: [14-02b]
files_modified:
  - bot/database/migrations.py
  - main.py
  - config.py
  - .env.example
  - docs/ROLLBACK.md
  - README.md
autonomous: true
must_haves:
  truths:
    - "Bot detects production mode via ENV=production environment variable"
    - "In production, bot executes alembic upgrade head automatically on startup"
    - "Bot logs each migration applied with verbose output"
    - "If migration fails, bot does NOT start (fail-fast behavior)"
    - "Rollback procedure is documented in docs/ROLLBACK.md"
    - "README.md includes migration documentation for developers"
  artifacts:
    - path: "bot/database/migrations.py"
      provides: "Alembic migration runner with production mode detection"
      contains: ["run_migrations_if_needed", "is_production", "rollback_last_migration"]
      min_lines: 150
    - path: "main.py"
      provides: "Integration of auto-migration into bot startup"
      contains: ["run_migrations_if_needed", "on_startup"]
    - path: "config.py"
      provides: "ENV environment variable for production/development mode"
      contains: ["ENV: str"]
    - path: ".env.example"
      provides: "ENV variable documentation"
      contains: ["ENV=development"]
    - path: "docs/ROLLBACK.md"
      provides: "Comprehensive rollback documentation"
      min_lines: 200
    - path: "README.md"
      provides: "Migration documentation for developers"
      contains: ["Database Migrations", "alembic upgrade head"]
  key_links:
    - from: "main.py"
      to: "bot/database/migrations.py"
      via: "import run_migrations_if_needed"
      pattern: "from bot.database.migrations import run_migrations_if_needed"
    - from: "main.py"
      to: "on_startup function"
      via: "call run_migrations_if_needed() before init_db()"
      pattern: "await run_migrations_if_needed\\(\\)"
    - from: "bot/database/migrations.py"
      to: "config.py"
      via: "is_production() reads Config.ENV"
      pattern: "Config.ENV"
    - from: "bot/database/migrations.py"
      to: "alembic.ini"
      via: "get_alembic_config() reads alembic.ini"
      pattern: 'Config\\("alembic.ini"\\)'
---

# Plan 14-03: Auto-Migration on Startup and Rollback Support

**Wave:** 3
**Depends on:** 14-02b (Initial migration generation)

---

## Overview

Implement automatic migration execution on production startup and document rollback procedures. The bot will detect production mode (via `ENV=production`) and run `alembic upgrade head` before initializing services. Migration failures will fail-fast with detailed error logs.

---

## Tasks

<task type="auto">
  <name>Task 1: Create migration runner module</name>
  <files>bot/database/migrations.py</files>
  <action>Create a dedicated module `bot/database/migrations.py` for running Alembic migrations programmatically:

```python
"""Alembic migration runner for automatic schema updates on startup.

This module provides:
- Automatic migration on production startup
- Verbose logging for debugging
- Fail-fast on migration errors
- Rollback support via Alembic commands

Usage:
    # In main.py startup handler:
    await run_migrations_if_needed()
"""
import logging
import os
from typing import Literal

from alembic.config import Config
from alembic import command
from alembic.script import ScriptDirectory

from config import Config as AppConfig

logger = logging.getLogger(__name__)


MigrationLevel = Literal["INFO", "WARNING", "ERROR", "CRITICAL"]


def is_production() -> bool:
    """
    Detect if running in production mode.

    Production mode is enabled by setting ENV=production environment variable.
    In production, migrations run automatically on startup.

    Returns:
        True if ENV=production, False otherwise
    """
    return os.getenv("ENV", "").lower() == "production"


def get_alembic_config() -> Config:
    """
    Create Alembic config object from project configuration.

    Uses the same DATABASE_URL as the application.

    Returns:
        Alembic Config object
    """
    alembic_cfg = Config("alembic.ini")
    # Ensure DATABASE_URL is set from environment
    alembic_cfg.set_main_option("sqlalchemy.url", AppConfig.DATABASE_URL)
    return alembic_cfg


def get_current_revision() -> str | None:
    """
    Get current database migration revision.

    Returns:
        Current revision hash or None if database is not migrated
    """
    try:
        cfg = get_alembic_config()
        command.current(cfg, verbose=True)
        # Note: command.current() prints to stdout, doesn't return value
        return None  # Placeholder - would need DB query for actual value
    except Exception as e:
        logger.warning(f"‚ö†Ô∏è Could not get current revision: {e}")
        return None


def show_migration_history() -> None:
    """Show full migration history (for debugging)."""
    cfg = get_alembic_config()
    logger.info("üìú Migration history:")
    command.history(cfg, verbose=True)


async def run_migrations(
    direction: Literal["upgrade", "downgrade"] = "upgrade",
    revision: str = "head"
) -> bool:
    """
    Run Alembic migrations in specified direction.

    Logs all migration activity with verbose output.
    Fails immediately on error.

    Args:
        direction: Either "upgrade" or "downgrade"
        revision: Target revision (default: "head" for upgrade, "-1" for downgrade)

    Returns:
        True if migrations succeeded, False if failed

    Raises:
        Exception: If migration fails (fail-fast)
    """
    cfg = get_alembic_config()

    logger.info(f"üîÑ Running migrations: {direction} to {revision}")

    try:
        if direction == "upgrade":
            command.upgrade(cfg, revision)
        elif direction == "downgrade":
            command.downgrade(cfg, revision)
        else:
            raise ValueError(f"Invalid direction: {direction}")

        logger.info(f"‚úÖ Migrations applied successfully ({direction} ‚Üí {revision})")
        return True

    except Exception as e:
        logger.error(f"‚ùå Migration failed: {e}", exc_info=True)
        logger.critical(
            "üí• DATABASE MIGRATION FAILED. "
            "Bot cannot start without proper schema. "
            "Fix the migration issue and restart."
        )
        raise


async def run_migrations_if_needed() -> bool:
    """
    Run migrations automatically if in production mode.

    In development mode, skip migrations (developer must run manually).
    Logs warnings if migrations fail.

    Returns:
        True if migrations succeeded or were skipped, False if failed
    """
    if not is_production():
        logger.info(
            "üîß Development mode detected. "
            "Skipping automatic migrations. "
            "Run 'alembic upgrade head' manually if needed."
        )
        return True

    # Production mode: run migrations automatically
    logger.info("üöÄ Production mode detected. Running migrations...")

    try:
        # Show current state
        logger.info("üìä Current migration state:")
        get_current_revision()

        # Run migrations to head
        await run_migrations("upgrade", "head")

        # Show history for debugging
        show_migration_history()

        return True

    except Exception as e:
        logger.critical(
            f"üí• CRITICAL: Automatic migrations failed in production. "
            f"The bot cannot start without a valid schema. "
            f"Error: {e}"
        )
        # Re-raise to prevent bot startup
        raise


async def rollback_last_migration() -> bool:
    """
    Rollback the last migration (convenience function).

    This is useful for reverting a problematic migration in production.

    Returns:
        True if rollback succeeded, False if failed

    Raises:
        Exception: If rollback fails
    """
    logger.warning("‚ö†Ô∏è Rolling back last migration...")
    return await run_migrations("downgrade", "-1")


async def rollback_to_base() -> bool:
    """
    Rollback all migrations to base state (empty schema).

    WARNING: This will drop all tables! Use with caution.

    Returns:
        True if rollback succeeded, False if failed

    Raises:
        Exception: If rollback fails
    """
    logger.critical("üí• Rolling back to base state (all tables will be dropped)...")
    return await run_migrations("downgrade", "base")
```

Key features:
- `is_production()` detects `ENV=production` (DBMIG-04 production mode detection)
- `run_migrations_if_needed()` skips migrations in development, runs in production
- `run_migrations()` executes `alembic upgrade head` with fail-fast behavior
- Verbose logging for all migration activity
- Rollback functions for manual intervention (DBMIG-07)
</action>
  <verify>
```python
from bot.database.migrations import is_production, run_migrations_if_needed, get_alembic_config
import os

# Test production detection
os.environ['ENV'] = 'production'
assert is_production() == True

os.environ['ENV'] = 'development'
assert is_production() == False

# Test config creation
cfg = get_alembic_config()
assert cfg.get_main_option("script_location") == "alembic"

# Test that run_migrations_if_needed returns True (development mode)
result = await run_migrations_if_needed()
assert result == True  # Should return True in development mode
```
</verify>
  <done>
- is_production() returns True when ENV=production
- is_production() returns False when ENV=development or unset
- run_migrations_if_needed() skips migrations in development mode
- run_migrations() executes alembic upgrade head in production
- run_migrations() raises exception on failure (fail-fast)
- rollback_last_migration() executes alembic downgrade -1 (DBMIG-07)
</done>
</task>

<task type="auto">
  <name>Task 2: Integrate migration runner into bot startup</name>
  <files>main.py</files>
  <action>Modify `main.py` to run migrations before initializing the database:

1. Import migration runner:
```python
from bot.database.migrations import run_migrations_if_needed
```

2. Modify `on_startup()` to run migrations FIRST (before init_db):

Find the existing `on_startup()` function and add migration execution RIGHT AFTER config validation and BEFORE database initialization:

```python
async def on_startup(bot: Bot, dispatcher: Dispatcher) -> None:
    """
    Callback ejecutado al iniciar el bot.

    Tareas:
    - Validar configuraci√≥n
    - Ejecutar migraciones autom√°ticas (producci√≥n)
    - Inicializar base de datos
    - Iniciar background tasks
    - Notificar a admins que el bot est√° online

    Args:
        bot: Instancia del bot
        dispatcher: Instancia del dispatcher
    """
    logger.info("üöÄ Iniciando bot...")

    # Validar configuraci√≥n
    if not Config.validate():
        logger.error("‚ùå Configuraci√≥n inv√°lida. Revisa tu archivo .env")
        sys.exit(1)

    logger.info(Config.get_summary())

    # ===== NUEVO: Ejecutar migraciones autom√°ticas =====
    # En producci√≥n, esto corre "alembic upgrade head" autom√°ticamente
    # En desarrollo, omite este paso (developer debe correr manualmente)
    try:
        await run_migrations_if_needed()
    except Exception as e:
        logger.error(f"‚ùå Error ejecutando migraciones: {e}")
        logger.error(
            "üí• El bot no puede iniciar sin migraciones exitosas. "
            "Fix the migration issue and restart."
        )
        sys.exit(1)
    # ===== FIN NUEVO =====

    # Inicializar base de datos
    try:
        await init_db()
    except Exception as e:
        logger.error(f"‚ùå Error al inicializar BD: {e}")
        sys.exit(1)

    # ... rest of existing startup code ...
```

CRITICAL: Migrations must run BEFORE init_db() to ensure schema is up-to-date before the application creates any sessions.
</action>
  <verify>
```bash
# Verify import is present
grep "from bot.database.migrations import run_migrations_if_needed" main.py

# Verify migration call is in on_startup
grep "await run_migrations_if_needed()" main.py

# Verify migration runs before init_db
grep -A 5 "run_migrations_if_needed" main.py | grep -v "init_db" | head -1
# Should show migration call, then later init_db
```
</verify>
  <done>
- on_startup() calls run_migrations_if_needed() before init_db()
- Migration failure results in sys.exit(1) (fail-fast)
- Startup continues only if migrations succeed
</done>
</task>

<task type="auto">
  <name>Task 3: Add ENV variable to configuration</name>
  <files>config.py</files>
  <action>Add `ENV` environment variable to distinguish production vs development mode:

1. Add ENV variable to Config class (with other environment variables):
```python
class Config:
    """
    Configuraci√≥n global del bot.

    Carga variables de entorno y proporciona valores por defecto.
    Valida que la configuraci√≥n m√≠nima est√© presente.
    """

    # ===== TELEGRAM =====
    BOT_TOKEN: str = os.getenv("BOT_TOKEN", "")

    # Admin IDs: lista de user IDs con permisos de administraci√≥n
    # Formato en .env: "123456,789012,345678"
    ADMIN_USER_IDS: List[int] = []

    # ===== ENVIRONMENT =====
    # Entorno: "production" o "development" (default: development)
    ENV: str = os.getenv("ENV", "development")

    # ===== DATABASE =====
    DATABASE_URL: str = os.getenv(
        "DATABASE_URL",
        "sqlite+aiosqlite:///bot.db"
    )
    # ... rest of existing config ...
```

2. Update `get_summary()` to show environment:
Find the existing `get_summary()` method and add environment line:
```python
@classmethod
def get_summary(cls) -> str:
    """
    Retorna un resumen de la configuraci√≥n actual (para logging).

    Oculta informaci√≥n sensible como el token completo.
    """
    token_preview = (
        f"{cls.BOT_TOKEN[:10]}..."
        if cls.BOT_TOKEN
        else "NO CONFIGURADO"
    )

    return f"""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë     CONFIGURACI√ìN DEL BOT              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
üåç Ambiente: {cls.ENV.upper()}
ü§ñ Bot Token: {token_preview}
üë§ Admins: {len(cls.ADMIN_USER_IDS)} configurado(s)
üíæ Database: {cls.DATABASE_URL}
üì∫ Canal VIP: {cls.VIP_CHANNEL_ID or 'No configurado'}
üì∫ Canal Free: {cls.FREE_CHANNEL_ID or 'No configurado'}
‚è±Ô∏è  Tiempo espera: {cls.DEFAULT_WAIT_TIME_MINUTES} min
üìù Log level: {cls.LOG_LEVEL}
        """.strip()
```
</action>
  <verify>
```python
from config import Config
import os

# Test default value
assert Config.ENV == "development"

# Test production value
os.environ['ENV'] = 'production'
# Reload config
assert Config.ENV == "production"

# Test summary shows environment
summary = Config.get_summary()
assert "Ambiente:" in summary or "ENVIRONMENT:" in summary
```
</verify>
  <done>
- Config.ENV reads from ENV environment variable (default: "development")
- Config.get_summary() displays environment in startup logs
</done>
</task>

<task type="auto">
  <name>Task 4: Update .env.example with ENV variable</name>
  <files>.env.example</files>
  <action>Add ENV variable to `.env.example` with explanatory comments:

```diff
# Telegram Bot Configuration
BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
ADMIN_USER_IDS=123456789,987654321

+# Environment
+# Options: "production" or "development" (default: development)
+# In production, migrations run automatically on startup
+ENV=development

# Database
```

Place this section AFTER the Telegram configuration and BEFORE the Database section.
</action>
  <verify>grep "^ENV=development" .env.example returns the line</verify>
  <done>
- .env.example includes ENV=development with explanatory comments
- Comments explain that production runs auto-migrations
</done>
</task>

<task type="auto">
  <name>Task 5: Create rollback documentation</name>
  <files>docs/ROLLBACK.md</files>
  <action>Create comprehensive documentation `docs/ROLLBACK.md` for rollback procedures:

```markdown
# Database Migration Rollback Guide

This guide explains how to rollback database migrations if something goes wrong.

---

## When to Rollback

Rollback is necessary when:
- A migration causes application errors
- Data is corrupted by a migration
- Performance degrades after a migration
- Schema changes need to be reverted

---

## Rollback Methods

### Method 1: Command Line (Recommended)

#### Rollback Last Migration

Revert the most recently applied migration:

```bash
alembic downgrade -1
```

#### Rollback Multiple Migrations

Revert the last N migrations:

```bash
# Revert last 2 migrations
alembic downgrade -2

# Revert last 3 migrations
alembic downgrade -3
```

#### Rollback to Specific Revision

Revert to a specific migration revision:

```bash
alembic downgrade <revision_id>
```

Example:
```bash
alembic downgrade 20250128_140000
```

#### Rollback to Base

Reset database to empty schema (WARNING: drops all tables):

```bash
alembic downgrade base
```

‚ö†Ô∏è **DANGER:** This will delete all data. Use only for testing.

---

### Method 2: Python Script

Use the migration runner module programmatically:

```python
import asyncio
from bot.database.migrations import rollback_last_migration, rollback_to_base

# Rollback last migration
async def main():
    success = await rollback_last_migration()
    if success:
        print("‚úÖ Rollback successful")
    else:
        print("‚ùå Rollback failed")

asyncio.run(main())
```

---

### Method 3: Production Rollback

In production, follow these steps:

#### Step 1: Stop the Bot

```bash
# On Railway
railway down

# Or kill the process
pkill -f "python main.py"
```

#### Step 2: Rollback Migration

```bash
# Set DATABASE_URL from Railway dashboard
export DATABASE_URL="postgresql://..."

# Rollback last migration
alembic downgrade -1
```

#### Step 3: Verify Schema

```bash
# Check current revision
alembic current

# View migration history
alembic history
```

#### Step 4: Restart the Bot

```bash
# On Railway
railway up

# Or restart the process
python main.py
```

---

## Migration States

### View Current Revision

```bash
alembic current
```

Output:
```
Current revision(s):
<revision_id> -> <migration_description> (head)
```

### View Migration History

```bash
alembic history
```

---

## Common Scenarios

### Scenario 1: Migration Fails in Production

**Problem:** Bot fails to start because migration failed.

**Solution:**
1. Check error logs for migration failure details
2. Fix the issue in the migration script
3. Rollback the failed migration: `alembic downgrade -1`
4. Update the migration script with the fix
5. Re-apply migration: `alembic upgrade head`

### Scenario 2: Data Loss After Migration

**Problem:** Migration accidentally deleted data.

**Solution:**
1. **STOP:** Do not apply any more migrations
2. Restore from database backup (if available)
3. If no backup, rollback the migration: `alembic downgrade -1`
4. Manually recover data from logs or other sources
5. Create a new migration that properly handles data

### Scenario 3: Performance Degradation

**Problem:** New indexes or schema changes slow down queries.

**Solution:**
1. Identify the problematic migration: `alembic history`
2. Rollback that migration: `alembic downgrade <revision_id>`
3. Analyze performance impact
4. Create optimized migration
5. Test in development first
6. Apply to production

---

## Data Safety Tips

### Always Backup Before Migration

```bash
# SQLite
cp bot.db bot.db.backup

# PostgreSQL
pg_dump $DATABASE_URL > backup.sql
```

### Test Migrations Locally First

```bash
# Test migration with SQLite
DATABASE_URL=sqlite:///test.db alembic upgrade head

# Test migration with PostgreSQL (if available)
DATABASE_URL=postgresql://localhost/test alembic upgrade head
```

### Review Generated Migrations

Autogenerate is not perfect. Always review:

```bash
alembic revision --autogenerate -m "Describe changes"
# Edit the generated file to check for errors
alembic upgrade head
```

---

## Rollback Best Practices

1. **Test downgrades:** Ensure `downgrade()` function works before deploying migration
2. **Document breaking changes:** Note which migrations cannot be safely rolled back
3. **Use transactions:** Alembic runs migrations in transactions by default
4. **Monitor after rollback:** Check application logs for errors after rollback
5. **Have a rollback plan:** Before deploying, know which migration to rollback to if needed

---

## Getting Help

If you encounter issues not covered here:

1. Check Alembic documentation: https://alembic.sqlalchemy.org/
2. Check application logs for detailed error messages
3. Ask for help in project issues/discussions
```
</action>
  <verify>
```bash
# Verify file exists
test -f docs/ROLLBACK.md

# Verify key sections exist
grep -E "When to Rollback|Rollback Methods|Common Scenarios" docs/ROLLBACK.md
```
</verify>
  <done>
- docs/ROLLBACK.md created
- Documentation covers command-line, programmatic, and production rollback methods
- Documentation includes common scenarios and troubleshooting tips
</done>
</task>

<task type="auto">
  <name>Task 6: Update README.md with migration documentation</name>
  <files>README.md</files>
  <action>Add a section to the main README about migrations.

Find the appropriate location in README.md (after project description, before other sections) and add:

```markdown
## Database Migrations

This project uses [Alembic](https://alembic.sqlalchemy.org/) for database migrations.

### Local Development

In development mode (`ENV=development`), migrations are NOT automatic. Run them manually:

```bash
# Apply all pending migrations
alembic upgrade head

# Check current version
alembic current

# View migration history
alembic history

# Rollback last migration
alembic downgrade -1
```

### Production Deployment

In production mode (`ENV=production`), migrations run **automatically** on bot startup.

The bot will:
1. Detect production mode from `ENV=production`
2. Run `alembic upgrade head` automatically
3. Fail-fast if migrations fail (bot will not start)
4. Log all migration activity

To deploy to production:

```bash
# Set environment variables
export ENV=production
export DATABASE_URL="postgresql://user:pass@host:5432/db"

# Start bot (migrations run automatically)
python main.py
```

### Creating Migrations

When modifying models, create a new migration:

```bash
# Generate migration from model changes
alembic revision --autogenerate -m "Description of changes"

# Review the generated file
alembic/versions/YYYYMMDD_HHMMSS_description.py

# Apply migration (local testing)
alembic upgrade head
```

### Rollback

See [docs/ROLLBACK.md](docs/ROLLBACK.md) for detailed rollback instructions.
```
</action>
  <verify>
```bash
# Verify section exists
grep -E "Database Migrations|alembic upgrade head" README.md
```
</verify>
  <done>
- README.md includes migration documentation
- Instructions distinguish between development and production modes
- Link to docs/ROLLBACK.md for detailed rollback guide
</done>
</task>

<task type="auto">
  <name>Task 7: Verify migration monitoring in startup logs</name>
  <files>bot/database/migrations.py</files>
  <action>Verify and enhance logging levels in bot/database/migrations.py:

Ensure the following logging patterns exist:
- `logger.info()` for normal migration activity
- `logger.warning()` for development mode skip
- `logger.error()` for migration failures
- `logger.critical()` for fail-fast messages

Key log messages that must exist:
1. "üîß Development mode detected. Skipping automatic migrations." (INFO)
2. "üöÄ Production mode detected. Running migrations..." (INFO)
3. "üîÑ Running migrations: upgrade to head" (INFO)
4. "‚úÖ Migrations applied successfully" (INFO)
5. "‚ùå Migration failed" (ERROR with exc_info=True)
6. "üí• CRITICAL: Automatic migrations failed" (CRITICAL)

These are already implemented in Task 1, this task just verifies they're correct.
</action>
  <verify>
```bash
# Verify log messages exist
grep "logger.info.*Development mode detected" bot/database/migrations.py
grep "logger.info.*Production mode detected" bot/database/migrations.py
grep "logger.critical.*Automatic migrations failed" bot/database/migrations.py
```
</verify>
  <done>
- Startup logs show "üîÑ Running migrations: upgrade to head" in production
- Startup logs show "üîß Development mode detected. Skipping automatic migrations." in development
- Migration failures show "‚ùå Migration failed" with stack trace
- Fail-fast shows "üí• CRITICAL: Automatic migrations failed"
</done>
</task>

---

## Verification Criteria

**Must-haves (goal-backward verification):**

1. ‚úÖ Bot detects production mode via `ENV=production` (DBMIG-04)
   - Set `ENV=production` ‚Üí `is_production()` returns `True`
   - Set `ENV=development` or unset ‚Üí `is_production()` returns `False`

2. ‚úÖ In production, bot executes `alembic upgrade head` before starting services (DBMIG-04)
   - Production startup: `on_startup()` calls `run_migrations_if_needed()`
   - Migrations run before `init_db()`
   - Logs show "üîÑ Running migrations: upgrade to head"

3. ‚úÖ Bot logs each migration applied
   - Each migration logged with revision ID and description
   - Show migration history after upgrade completes
   - Verbose logging for debugging

4. ‚úÖ If migration fails, bot does NOT start (fail fast) (DBMIG-04)
   - Migration failure ‚Üí `sys.exit(1)` in `on_startup()`
   - Error logged with details: "üí• CRITICAL: Automatic migrations failed"
   - Bot services never initialize

5. ‚úÖ Rollback procedure documented (DBMIG-07)
   - `docs/ROLLBACK.md` exists with comprehensive instructions
   - Covers command-line, programmatic, and production rollback methods
   - Includes common scenarios and troubleshooting tips

6. ‚úÖ Production mode detection (DBMIG-04)
   - `ENV=production` environment variable triggers auto-migration
   - `ENV=development` skips auto-migration
   - Config displays environment in startup logs

---

## Testing Notes

**Local development testing:**
```bash
# Development mode (auto-migrations disabled)
ENV=development python main.py
# Expected log: "üîß Development mode detected. Skipping automatic migrations."

# Manual migration
alembic upgrade head

# Start bot
python main.py
```

**Production simulation:**
```bash
# Production mode (auto-migrations enabled)
ENV=production DATABASE_URL=sqlite:///test.db python main.py
# Expected log: "üîÑ Running migrations: upgrade to head"

# Verify migrations ran
alembic current
```

**Migration failure test:**
```bash
# Create a broken migration
alembic revision -m "Broken migration"
# Edit file to include invalid SQL

# Try to start bot
ENV=production python main.py
# Expected: Bot exits with error, does not start
```

**Rollback test:**
```bash
# Apply migration
alembic upgrade head

# Rollback
alembic downgrade -1

# Verify
alembic current
```

---

## Implementation Notes

- **Fail-fast strategy:** If migrations fail, the bot MUST NOT start. This prevents running with an incompatible schema.
- **Verbose logging:** Log all migration activity ‚Äî start, each migration applied, warnings, errors. Essential for debugging production issues.
- **No retry logic:** Migration errors are schema problems, not transient network issues. Manual intervention is required.
- **Startup timing:** Migrations run as early as possible in `on_startup()`, before database initialization and service startup.
- **Development vs Production:** In development, auto-migrations are disabled to give developers control. In production, they're enabled to ensure schema is always up-to-date.

---

## Success Metrics

- ‚úÖ Production deployment applies migrations automatically without manual intervention (DBMIG-04)
- ‚úÖ Development deployment skips auto-migrations (developer must run manually)
- ‚úÖ Migration failures prevent bot startup with clear error messages (DBMIG-04)
- ‚úÖ Rollback documentation is comprehensive and easy to follow (DBMIG-07)
- ‚úÖ Startup logs clearly show migration activity for debugging
- ‚úÖ No data loss during normal migration workflow

---

## Output

After completion, create `.planning/phases/14-database-migration-foundation/14-03-SUMMARY.md`
