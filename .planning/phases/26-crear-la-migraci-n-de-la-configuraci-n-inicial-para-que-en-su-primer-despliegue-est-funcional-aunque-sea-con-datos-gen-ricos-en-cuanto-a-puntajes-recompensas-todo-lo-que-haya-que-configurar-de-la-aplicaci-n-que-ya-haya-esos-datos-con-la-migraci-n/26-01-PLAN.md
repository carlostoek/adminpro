---
phase: 26-initial-data-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - alembic/versions/20260221_000001_seed_gamification_data.py
autonomous: true

must_haves:
  truths:
    - "Alembic migration file exists with proper revision ID and down_revision"
    - "Migration updates BotConfig with default economy values (besitos_per_reaction=5, etc.)"
    - "Migration backfills UserGamificationProfile for all existing users"
    - "Migration seeds default rewards (Primeros Pasos, Ahorrador Principiante, Racha de 7 Dias)"
    - "Migration is idempotent - can run multiple times without errors"
    - "Downgrade resets config but preserves user data"
  artifacts:
    - path: "alembic/versions/20260221_000001_seed_gamification_data.py"
      provides: "Alembic data migration for gamification module"
      contains:
        - "revision = '"
        - "down_revision = '20260217_000001_fix_reaction_unique_constraint_add_emoji'"
        - "UPDATE bot_config SET level_formula"
        - "INSERT OR IGNORE INTO user_gamification_profiles"
        - "INSERT OR IGNORE INTO rewards"
  key_links:
    - from: "alembic/versions/20260221_000001_seed_gamification_data.py"
      to: "bot_config table (id=1)"
      via: "UPDATE statement with WHERE id = 1"
    - from: "alembic/versions/20260221_000001_seed_gamification_data.py"
      to: "users table"
      via: "INSERT...SELECT for backfilling profiles"
---

<objective>
Create the Alembic data migration file that seeds default gamification configuration and backfills existing users with gamification profiles.

Purpose: Ensure the production database has all necessary default data for the gamification module to function immediately after deployment, without requiring manual configuration.

Output: `alembic/versions/20260221_000001_seed_gamification_data.py` migration file
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-crear-la-migraci-n-de-la-configuraci-n-inicial-para-que-en-su-primer-despliegue-est-funcional-aunque-sea-con-datos-gen-ricos-en-cuanto-a-puntajes-recompensas-todo-lo-que-haya-que-configurar-de-la-aplicaci-n-que-ya-haya-esos-datos-con-la-migraci-n/26-RESEARCH.md

## Reference: Existing Migration Pattern

From `alembic/versions/20260129_050441_initial_schema_with_all_models.py` lines 159-163:
```python
# Insert default configuration with social media links
op.execute("""
    INSERT INTO bot_config (id, wait_time_minutes, vip_reactions, free_reactions, subscription_fees, created_at, updated_at, social_instagram, social_tiktok, social_x)
    VALUES (1, 60, '["‚ù§Ô∏è", "üî•", "üòç"]', '["‚ù§Ô∏è", "üëç"]', '{}', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, 'ella.es.diana', 'srtakinky', 'SrtaKinky')
""")
```

## Reference: Latest Migration

From `alembic/versions/20260217_000001_fix_reaction_unique_constraint_add_emoji.py`:
- This is the current head migration
- down_revision must point to: `'20260217_000001_fix_reaction_unique_constraint_add_emoji'`

## Locked Decisions (from RESEARCH.md)

- **Economy Values:**
  - `besitos_per_reaction=5`
  - `besitos_daily_gift=50` (besitos_daily_base=20 + streak_bonus logic)
  - `max_reactions_per_day=20`
  - `besitos_daily_streak_bonus=10`
  - `besitos_streak_bonus_per_day=2`
  - `besitos_streak_bonus_max=50`
- **Level Formula:** `floor(sqrt(total_earned / 100)) + 1`
- **BotConfig Pattern:** Singleton (id=1)

## Default Rewards to Seed

1. **Primeros Pasos** - First reaction reward
2. **Ahorrador Principiante** - Save 100 besitos badge
3. **Racha de 7 Dias** - 7-day streak reward

## Idempotency Requirements

- Use `INSERT OR IGNORE` for SQLite to prevent duplicate errors
- Use `UPDATE...WHERE id=1` for BotConfig (not INSERT)
- Use `INSERT...SELECT...WHERE NOT EXISTS` pattern for user backfill
</context>

<tasks>

<task type="auto">
  <name>Create Alembic data migration file</name>
  <files>alembic/versions/20260221_000001_seed_gamification_data.py</files>
  <action>
Create the Alembic migration file at `alembic/versions/20260221_000001_seed_gamification_data.py` with the following structure:

1. **Header:** Standard Alembic migration header with:
   - `revision = '20260221_000001_seed_gamification'` (or generate UUID)
   - `down_revision = '20260217_000001_fix_reaction_unique_constraint_add_emoji'`

2. **upgrade() function with three operations:**

   a) **Update BotConfig with economy defaults:**
   ```python
   op.execute("""
       UPDATE bot_config
       SET
           level_formula = 'floor(sqrt(total_earned / 100)) + 1',
           besitos_per_reaction = 5,
           besitos_daily_gift = 50,
           besitos_daily_streak_bonus = 10,
           max_reactions_per_day = 20,
           besitos_daily_base = 20,
           besitos_streak_bonus_per_day = 2,
           besitos_streak_bonus_max = 50,
           updated_at = CURRENT_TIMESTAMP
       WHERE id = 1
   """)
   ```

   b) **Backfill UserGamificationProfile for existing users:**
   ```python
   op.execute("""
       INSERT OR IGNORE INTO user_gamification_profiles
       (user_id, balance, total_earned, total_spent, level, created_at, updated_at)
       SELECT
           user_id,
           0 as balance,
           0 as total_earned,
           0 as total_spent,
           1 as level,
           CURRENT_TIMESTAMP as created_at,
           CURRENT_TIMESTAMP as updated_at
       FROM users
       WHERE user_id NOT IN (
           SELECT user_id FROM user_gamification_profiles
       )
   """)
   ```

   c) **Seed default rewards (idempotent):**
   ```python
   op.execute("""
       INSERT OR IGNORE INTO rewards
       (name, description, reward_type, reward_value, is_repeatable, is_secret, claim_window_hours, is_active, sort_order, created_at, updated_at)
       VALUES
       ('Primeros Pasos', 'Da tu primera reacci√≥n al contenido', 'BESITOS', '{"amount": 10}', 0, 0, 168, 1, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
       ('Ahorrador Principiante', 'Acumula 100 besitos en tu cuenta', 'BADGE', '{"badge_name": "ahorrador", "emoji": "üí∞"}', 0, 0, 168, 1, 1, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP),
       ('Racha de 7 D√≠as', 'Mant√©n una racha de 7 d√≠as reclamando el regalo diario', 'BESITOS', '{"amount": 50}', 0, 0, 168, 1, 2, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
   """)
   ```

3. **downgrade() function:**
   - Reset BotConfig economy fields to NULL (preserve user data)
   - Do NOT delete rewards or user profiles (production safety)
   ```python
   op.execute("""
       UPDATE bot_config
       SET
           level_formula = NULL,
           besitos_per_reaction = NULL,
           besitos_daily_gift = NULL,
           besitos_daily_streak_bonus = NULL,
           max_reactions_per_day = NULL,
           besitos_daily_base = NULL,
           besitos_streak_bonus_per_day = NULL,
           besitos_streak_bonus_max = NULL,
           updated_at = CURRENT_TIMESTAMP
       WHERE id = 1
   """)
   ```

4. **Add comprehensive docstring** explaining:
   - This is a DATA migration (not schema)
   - Idempotent design for production safety
   - What data is seeded
   - Downgrade behavior (preserves user data)
  </action>
  <verify>
    - File exists at `alembic/versions/20260221_000001_seed_gamification_data.py`
    - Contains `revision =` and `down_revision =` variables
    - Contains `def upgrade()` with three op.execute() calls
    - Contains `def downgrade()` that resets BotConfig
    - Uses `INSERT OR IGNORE` for idempotency
    - Uses proper JSON formatting for reward_value
  </verify>
  <done>
    - Migration file created with correct structure
    - upgrade() updates BotConfig, backfills profiles, seeds rewards
    - downgrade() resets config but preserves user data
    - All SQL uses SQLite-compatible syntax
  </done>
</task>

</tasks>

<verification>
After completing this plan:

1. **File Structure:**
   - `alembic/versions/20260221_000001_seed_gamification_data.py` exists
   - Has proper revision ID and down_revision pointing to latest migration
   - Contains upgrade() and downgrade() functions

2. **Idempotency Check:**
   - Uses `INSERT OR IGNORE` for rewards
   - Uses `INSERT OR IGNORE` for user profiles backfill
   - Uses `UPDATE...WHERE id=1` for BotConfig

3. **Data Seeded:**
   - BotConfig has economy configuration values
   - 3 default rewards exist
   - All existing users have gamification profiles

4. **Safety:**
   - Downgrade does not delete user data
   - Migration can run multiple times without errors
</verification>

<success_criteria>
- Alembic migration file created with correct revision chain
- Migration seeds all required default data
- Migration is idempotent (safe to run multiple times)
- Downgrade preserves user data (only resets config)
</success_criteria>

<output>
After completion, create `.planning/phases/26-crear-la-migraci-n-de-la-configuraci-n-inicial-para-que-en-su-primer-despliegue-est-funcional-aunque-sea-con-datos-gen-ricos-en-cuanto-a-puntajes-recompensas-todo-lo-que-haya-que-configurar-de-la-aplicaci-n-que-ya-haya-esos-datos-con-la-migraci-n/26-01-SUMMARY.md`
</output>
