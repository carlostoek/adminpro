---
phase: 26-initial-data-migration
plan: 03
type: execute
wave: 2
depends_on: ["26-01", "26-02"]
files_modified:
  - bot/database/seeders/__init__.py
  - bot/database/seeders/shop.py
autonomous: true

must_haves:
  truths:
    - "Shop seeder exists and creates sample products with content sets"
    - "Content sets are created with empty file_ids for admin to populate later"
    - "Products have VIP discount percentages configured"
    - "Seeder links products to content sets via foreign key"
    - "Seeder is idempotent - checks for existing products before creating"
  artifacts:
    - path: "bot/database/seeders/shop.py"
      provides: "Shop products seeding logic"
      contains:
        - "DEFAULT_PRODUCTS"
        - "async def seed_default_shop_products"
        - "ContentSet creation"
        - "ShopProduct creation with content_set_id"
    - path: "bot/database/seeders/__init__.py"
      provides: "Updated exports"
      exports: ["seed_default_rewards", "seed_default_shop_products"]
  key_links:
    - from: "bot/database/seeders/shop.py"
      to: "bot/database/models.py (ShopProduct, ContentSet)"
      via: "SQLAlchemy ORM imports"
    - from: "bot/database/seeders/shop.py"
      to: "bot/database/enums.py (ContentTier, ContentType)"
      via: "Enum imports for type safety"
---

<objective>
Create shop products seeder that creates sample products with their associated content sets for the gamification shop system.

Purpose: Provide default shop products that demonstrate the shop functionality, with empty content that the admin can populate after deployment.

Output: `bot/database/seeders/shop.py` with shop product seeding logic
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/26-crear-la-migraci-n-de-la-configuraci-n-inicial-para-que-en-su-primer-despliegue-est-funcional-aunque-sea-con-datos-gen-ricos-en-cuanto-a-puntajes-recompensas-todo-lo-que-haya-que-configurar-de-la-aplicaci-n-que-ya-haya-esos-datos-con-la-migraci-n/26-RESEARCH.md
@bot/database/models.py
@bot/database/enums.py

## Reference: ShopProduct and ContentSet Models

From `bot/database/models.py`:

```python
class ContentSet(Base):
    __tablename__ = "content_sets"
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(200), nullable=False)
    description = Column(String(1000), nullable=True)
    file_ids = Column(JSON, nullable=False, default=list)
    content_type = Column(Enum(ContentType), nullable=False, default=ContentType.PHOTO_SET)
    tier = Column(Enum(ContentTier), nullable=False, default=ContentTier.FREE)
    category = Column(String(50), nullable=True)
    is_active = Column(Boolean, nullable=False, default=True, index=True)
    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)
    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow, onupdate=datetime.utcnow)
    shop_products = relationship("ShopProduct", back_populates="content_set")

class ShopProduct(Base):
    __tablename__ = "shop_products"
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(200), nullable=False)
    description = Column(String(1000), nullable=True)
    content_set_id = Column(Integer, ForeignKey("content_sets.id"), nullable=False)
    besitos_price = Column(Integer, nullable=False)
    vip_discount_percentage = Column(Integer, nullable=False, default=0)
    vip_besitos_price = Column(Integer, nullable=True)
    tier = Column(Enum(ContentTier), nullable=False, default=ContentTier.FREE)
    is_active = Column(Boolean, nullable=False, default=True, index=True)
    sort_order = Column(Integer, nullable=False, default=0)
    purchase_count = Column(Integer, nullable=False, default=0)
    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)
    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow, onupdate=datetime.utcnow)
    content_set = relationship("ContentSet", back_populates="shop_products")
```

## Reference: Enums

From `bot/database/enums.py`:

```python
class ContentType(str, Enum):
    PHOTO_SET = "photo_set"
    VIDEO = "video"
    AUDIO = "audio"
    MIXED = "mixed"

class ContentTier(str, Enum):
    FREE = "free"
    VIP = "vip"
    PREMIUM = "premium"
    GIFT = "gift"
```

## Default Products to Seed

1. **Pack de Bienvenida** (Welcome Pack)
   - Price: 50 besitos
   - VIP Discount: 20%
   - Tier: FREE
   - Content: Photo set (empty file_ids)

2. **Pack VIP Especial** (VIP Special)
   - Price: 200 besitos
   - VIP Discount: 50%
   - Tier: VIP
   - Content: Mixed (empty file_ids)

## Pattern from Research

From `26-RESEARCH.md` lines 477-559:
- Create ContentSet first
- Use `await session.flush()` to get content_set.id
- Create ShopProduct with content_set_id
- Check for existing products by name before creating
</context>

<tasks>

<task type="auto">
  <name>Create shop products seeder</name>
  <files>bot/database/seeders/shop.py</files>
  <action>
Create `bot/database/seeders/shop.py` with the following content:

```python
"""Default shop products seeder for the gamification system."""
import logging
from typing import List, Dict, Any

from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

from bot.database.models import ShopProduct, ContentSet
from bot.database.enums import ContentTier, ContentType

logger = logging.getLogger(__name__)

# Default products configuration
DEFAULT_PRODUCTS: List[Dict[str, Any]] = [
    {
        "name": "Pack de Bienvenida",
        "description": "Contenido especial para nuevos miembros del canal. Incluye fotos exclusivas de bienvenida.",
        "besitos_price": 50,
        "vip_discount_percentage": 20,
        "tier": ContentTier.FREE,
        "sort_order": 0,
        "content_set": {
            "name": "Welcome Pack",
            "description": "Fotos de bienvenida para nuevos miembros",
            "content_type": ContentType.PHOTO_SET,
            "tier": ContentTier.FREE,
            "file_ids": [],  # Empty - to be populated by admin
            "category": "welcome"
        }
    },
    {
        "name": "Pack VIP Especial",
        "description": "Contenido exclusivo para suscriptores VIP. Material premium mensual.",
        "besitos_price": 200,
        "vip_discount_percentage": 50,
        "tier": ContentTier.VIP,
        "sort_order": 1,
        "content_set": {
            "name": "VIP Special",
            "description": "Contenido premium mensual para suscriptores VIP",
            "content_type": ContentType.MIXED,
            "tier": ContentTier.VIP,
            "file_ids": [],  # Empty - to be populated by admin
            "category": "premium"
        }
    }
]


async def seed_default_shop_products(session: AsyncSession) -> None:
    """
    Seed default shop products with their content sets.

    This function is idempotent - running it multiple times will not
    create duplicate products. It checks for existing products by name.

    Note: Content sets are created with empty file_ids. The admin must
    upload actual content files after deployment and update the file_ids.

    Args:
        session: Async database session

    Returns:
        None
    """
    logger.info("Starting default shop products seeding...")
    created_count = 0
    skipped_count = 0

    for product_data in DEFAULT_PRODUCTS:
        # Check if product exists by name
        result = await session.execute(
            select(ShopProduct).where(ShopProduct.name == product_data["name"])
        )
        existing_product = result.scalar_one_or_none()

        if existing_product:
            logger.debug(f"Shop product '{product_data['name']}' already exists, skipping")
            skipped_count += 1
            continue

        # Extract content set data
        content_data = product_data["content_set"]

        # Create content set first
        content_set = ContentSet(
            name=content_data["name"],
            description=content_data["description"],
            content_type=content_data["content_type"],
            tier=content_data["tier"],
            file_ids=content_data["file_ids"],
            category=content_data.get("category"),
            is_active=True
        )
        session.add(content_set)
        await session.flush()  # Get content_set.id

        # Create product with content_set_id
        product = ShopProduct(
            name=product_data["name"],
            description=product_data["description"],
            content_set_id=content_set.id,
            besitos_price=product_data["besitos_price"],
            vip_discount_percentage=product_data["vip_discount_percentage"],
            tier=product_data["tier"],
            is_active=True,
            sort_order=product_data["sort_order"]
        )
        session.add(product)

        logger.info(
            f"Created shop product: {product_data['name']} "
            f"(ID: {product.id}, ContentSet ID: {content_set.id})"
        )
        created_count += 1

    await session.commit()
    logger.info(
        f"Shop products seeding complete. Created: {created_count}, "
        f"Skipped: {skipped_count}"
    )
```

Key implementation details:
1. Create ContentSet first with empty file_ids array
2. Use `await session.flush()` to get content_set.id
3. Create ShopProduct with content_set_id foreign key
4. Check for existing products by name (idempotency)
5. Log creation with both product and content set IDs
6. Include docstring noting admin must populate file_ids
  </action>
  <verify>
    - File `bot/database/seeders/shop.py` exists
    - Contains DEFAULT_PRODUCTS list with 2 products
    - Contains `async def seed_default_shop_products(session)` function
    - Uses proper imports from bot.database.models and bot.database.enums
    - Creates ContentSet before ShopProduct
    - Uses await session.flush() to get content_set.id
  </verify>
  <done>
    - Shop seeder created with 2 default products
    - Each product has associated content set with empty file_ids
    - Seeder is idempotent and logs progress
    - Function can be called from migration or application startup
  </done>
</task>

<task type="auto">
  <name>Update seeders __init__.py exports</name>
  <files>bot/database/seeders/__init__.py</files>
  <action>
Update `bot/database/seeders/__init__.py` to export the shop seeder:

```python
"""Database seeders for default data initialization."""
from bot.database.seeders.rewards import seed_default_rewards
from bot.database.seeders.shop import seed_default_shop_products

__all__ = ["seed_default_rewards", "seed_default_shop_products"]
```
  </action>
  <verify>
    - `bot/database/seeders/__init__.py` exports seed_default_shop_products
    - Both seeders are importable from bot.database.seeders
  </verify>
  <done>
    - Module exports updated
    - All seeders available from single import location
  </done>
</task>

</tasks>

<verification>
After completing this plan:

1. **File Structure:**
   - `bot/database/seeders/shop.py` exists with seeding logic
   - `bot/database/seeders/__init__.py` exports both seeders

2. **Functionality:**
   - seed_default_shop_products is importable
   - Function accepts AsyncSession parameter
   - Function creates content sets and products
   - Function is idempotent

3. **Data Integrity:**
   - Uses proper ContentTier enum values
   - Uses proper ContentType enum values
   - Creates ContentSet with empty file_ids
   - Links ShopProduct to ContentSet via foreign key
   - VIP discounts configured (20% and 50%)

4. **Documentation:**
   - Docstring notes that admin must populate file_ids
   - Logging shows creation progress
</verification>

<success_criteria>
- Shop seeder created at bot/database/seeders/shop.py
- seed_default_shop_products function is importable and functional
n- Seeder creates 2 default products with their content sets
- Seeder is idempotent (safe to run multiple times)
- Module exports both reward and shop seeders
</success_criteria>

<output>
After completion, create `.planning/phases/26-crear-la-migraci-n-de-la-configuraci-n-inicial-para-que-en-su-primer-despliegue-est-funcional-aunque-sea-con-datos-gen-ricos-en-cuanto-a-puntajes-recompensas-todo-lo-que-haya-que-configurar-de-la-aplicaci-n-que-ya-haya-esos-datos-con-la-migraci-n/26-03-SUMMARY.md`
</output>
