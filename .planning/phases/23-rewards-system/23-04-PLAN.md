---
phase: 23-rewards-system
plan: 04
type: execute
wave: 3
depends_on: ["23-03"]
files_modified:
  - tests/services/test_reward_service.py
  - tests/handlers/test_reward_handlers.py
  - tests/requirements/test_reward_requirements.py
autonomous: true

must_haves:
  truths:
    - All 6 REWARD requirements have explicit tests
    - Condition evaluation tested for all types
    - Event-driven checking verified
    - Reward claiming flow tested
  artifacts:
    - path: "tests/services/test_reward_service.py"
      provides: "RewardService unit tests"
      min_lines: 200
    - path: "tests/handlers/test_reward_handlers.py"
      provides: "Reward handler tests"
      min_lines: 100
    - path: "tests/requirements/test_reward_requirements.py"
      provides: "REWARD requirement verification tests"
      min_lines: 150
  key_links:
    - from: "Test files"
      to: "RewardService, Reward models"
      via: "pytest fixtures and assertions"
---

<objective>
Create comprehensive tests for the Rewards System covering all requirements.

Purpose: Verify all REWARD requirements are met and the reward system works correctly.
Output: Test files covering service logic, handlers, and requirement verification.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/23-rewards-system/23-CONTEXT.md
@bot/services/reward.py
@tests/services/test_wallet.py
@tests/services/test_streak_service.py
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RewardService Unit Tests</name>
  <files>tests/services/test_reward_service.py</files>
  <action>
Create tests/services/test_reward_service.py with comprehensive unit tests:

**Fixtures:**
- reward_service: Create RewardService with mocked wallet/streak
- sample_reward: Create a BESITOS reward with conditions
- sample_content_reward: Create a CONTENT reward
- sample_user_reward: Create UserReward record for testing

**Test Classes:**

*TestConditionEvaluation:*
- test_evaluate_numeric_condition_total_points: Verify >= comparison
- test_evaluate_numeric_condition_level_reached: Verify level check
- test_evaluate_numeric_condition_besitos_spent: Verify spent check
- test_evaluate_numeric_condition_streak_length: Verify streak check
- test_evaluate_event_condition_first_purchase: Check UserContentAccess existence
- test_evaluate_event_condition_first_daily_gift: Check EARN_DAILY transaction
- test_evaluate_event_condition_first_reaction: Check UserReaction existence
- test_evaluate_exclusion_condition_not_vip: Verify role check
- test_evaluate_exclusion_condition_not_claimed_before: Verify claim_count check

*TestRewardConditionsLogic:*
- test_evaluate_reward_all_conditions_and_logic: All must pass
- test_evaluate_reward_or_group_logic: At least one in group passes
- test_evaluate_reward_mixed_and_or: Group 0 AND, Group 1 OR
- test_evaluate_reward_no_conditions: Empty conditions = eligible

*TestEventDrivenChecking:*
- test_check_rewards_on_daily_gift_event: Correct rewards triggered
- test_check_rewards_on_purchase_event: FIRST_PURCHASE triggered
- test_check_rewards_on_level_up: LEVEL_REACHED triggered
- test_multiple_rewards_same_event: All applicable rewards checked

*TestRewardClaiming:*
- test_claim_reward_besitos_success: Credits besitos via wallet
- test_claim_reward_content_success: Creates UserContentAccess
- test_claim_reward_expired_fails: Returns error if expired
- test_claim_reward_already_claimed_fails: Returns error if not repeatable
- test_claim_repeatable_reward_multiple_times: Allows multiple claims

*TestUserRewardManagement:*
- test_get_available_rewards_shows_non_secret: All non-secret visible
- test_get_available_rewards_hides_secret_locked: Secret hidden when locked
- test_get_available_rewards_shows_secret_unlocked: Secret visible when unlocked
- test_get_reward_progress_shows_current_values: Progress info correct
  </action>
  <verify>test -f tests/services/test_reward_service.py && grep -q "test_evaluate" tests/services/test_reward_service.py</verify>
  <done>RewardService unit tests created covering all condition types and logic</done>
</task>

<task type="auto">
  <name>Task 2: Create Reward Handler Tests</name>
  <files>tests/handlers/test_reward_handlers.py</files>
  <action>
Create tests/handlers/test_reward_handlers.py with handler integration tests:

**Fixtures:**
- mock_reward_message: Mock message for testing
- mock_reward_callback: Mock callback query for testing
- sample_rewards_list: List of rewards with different statuses

**Test Classes:**

*TestRewardsListHandler:*
- test_rewards_list_shows_all_rewards: Handler displays rewards
- test_rewards_list_shows_correct_status_emojis: ðŸ”’ âœ¨ âœ… displayed
- test_rewards_list_shows_claim_button_for_unlocked: Claim button present
- test_rewards_list_empty_shows_message: No rewards message

*TestRewardClaimHandler:*
- test_claim_unlocked_reward_success: Updates status to CLAIMED
- test_claim_locked_reward_fails: Error message shown
- test_claim_expired_reward_fails: Error message shown
- test_claim_already_claimed_fails: Error for non-repeatable
- test_claim_repeatable_second_time_success: Allows second claim

*TestRewardDetailHandler:*
- test_reward_detail_shows_conditions: All conditions listed
- test_reward_detail_shows_progress: Current vs required shown
- test_reward_detail_unlocked_has_claim_button: Claim option available

*TestVoiceConsistency:*
- test_rewards_list_uses_lucien_voice: ðŸŽ© emoji present
- test_reward_claim_success_uses_diana_voice: ðŸ«¦ emoji present for success
- test_reward_claim_error_uses_lucien_voice: ðŸŽ© emoji present for errors
  </action>
  <verify>test -f tests/handlers/test_reward_handlers.py && grep -q "test_rewards_list" tests/handlers/test_reward_handlers.py</verify>
  <done>Reward handler tests created covering UI and flow</done>
</task>

<task type="auto">
  <name>Task 3: Create REWARD Requirements Verification Tests</name>
  <files>tests/requirements/test_reward_requirements.py</files>
  <action>
Create tests/requirements/test_reward_requirements.py with explicit requirement tests:

**Test Structure:**
Each test maps directly to a REWARD requirement.

*REWARD-01: User can view available rewards with conditions*
- test_reward_01_user_can_view_available_rewards
  - Create rewards with conditions
  - Call get_available_rewards()
  - Assert: Returns list with reward names, descriptions, conditions
  - Assert: Each reward shows current status

*REWARD-02: System checks reward eligibility automatically*
- test_reward_02_system_checks_eligibility_on_event
  - Set up user meeting conditions
  - Trigger event (daily_gift_claimed)
  - Assert: System evaluates conditions automatically
  - Assert: UserReward status updated to UNLOCKED

*REWARD-03: User receives reward notification when conditions met*
- test_reward_03_user_receives_notification_when_conditions_met
  - Set up reward with conditions
  - Trigger event that meets conditions
  - Assert: build_reward_notification returns message
  - Assert: Message includes unlocked reward details

*REWARD-04: Rewards support streak, points, level, besitos spent conditions*
- test_reward_04_streak_length_condition
  - Create reward with STREAK_LENGTH >= 7 condition
  - User with streak = 7
  - Assert: Eligible
- test_reward_04_total_points_condition
  - Create reward with TOTAL_POINTS >= 1000 condition
  - User with total_earned = 1000
  - Assert: Eligible
- test_reward_04_level_reached_condition
  - Create reward with LEVEL_REACHED >= 5 condition
  - User with level = 5
  - Assert: Eligible
- test_reward_04_besitos_spent_condition
  - Create reward with BESITOS_SPENT >= 500 condition
  - User with total_spent = 500
  - Assert: Eligible

*REWARD-05: Multiple conditions use AND logic*
- test_reward_05_multiple_conditions_and_logic
  - Create reward with 3 conditions (all group 0)
  - User meets 2 of 3
  - Assert: Not eligible (AND requires all)
  - User meets all 3
  - Assert: Eligible
- test_reward_05_or_group_logic
  - Create reward with group 0 AND, group 1 OR
  - User meets group 0 but only 1 of 2 in group 1
  - Assert: Eligible (OR only needs one)

*REWARD-06: Reward value capped at maximum*
- test_reward_06_reward_value_capped
  - Create BESITOS reward with value 1000
  - Configure max_reward_besitos = 100 in config
  - Claim reward
  - Assert: User receives min(value, max) besitos
  </action>
  <verify>test -f tests/requirements/test_reward_requirements.py && grep -q "REWARD-01\|test_reward_01" tests/requirements/test_reward_requirements.py</verify>
  <done>All 6 REWARD requirements have explicit verification tests</done>
</task>

<task type="auto">
  <name>Task 4: Create Integration Tests for Event Flows</name>
  <files>tests/integration/test_reward_events.py</files>
  <action>
Create tests/integration/test_reward_events.py testing complete flows:

**TestDailyGiftRewardFlow:**
- test_daily_gift_triggers_streak_reward
  - User claims daily gift
  - Streak reaches 7 days
  - Assert: "Racha de 7 dÃ­as" reward unlocked
  - Assert: Notification includes both gift and reward

- test_daily_gift_no_duplicate_notifications
  - User claims daily gift
  - No new rewards unlocked
  - Assert: Only daily gift confirmation sent

**TestPurchaseRewardFlow:**
- test_first_purchase_triggers_reward
  - User makes first shop purchase
  - Assert: "Primera Compra" reward unlocked
  - Assert: Notification includes purchase + reward

- test_besitos_spent_threshold_triggers_reward
  - User spends 1000 besitos total
  - Assert: "Gastador VIP" reward unlocked

**TestLevelUpRewardFlow:**
- test_level_up_triggers_level_reward
  - User reaches level 5
  - Assert: "Nivel 5 Alcanzado" reward unlocked
  - Assert: Notification sent

**TestGroupedNotifications:**
- test_multiple_rewards_single_notification
  - Event triggers 3 rewards simultaneously
  - Assert: Single message with all 3 rewards
  - Assert: No duplicate/spam messages

**TestSecretRewards:**
- test_secret_reward_hidden_until_unlocked
  - Create secret reward
  - User views reward list
  - Assert: Secret reward not visible
  - User meets conditions
  - Assert: Secret reward now visible
  </action>
  <verify>test -f tests/integration/test_reward_events.py && grep -q "test_daily_gift" tests/integration/test_reward_events.py</verify>
  <done>Integration tests created for complete reward flows</done>
</task>

<task type="auto">
  <name>Task 5: Run All Tests and Verify Coverage</name>
  <files></files>
  <action>
Run the complete test suite for the Rewards System:

**Commands to run:**
```bash
# Run reward service tests
python -m pytest tests/services/test_reward_service.py -v

# Run reward handler tests
python -m pytest tests/handlers/test_reward_handlers.py -v

# Run requirement tests
python -m pytest tests/requirements/test_reward_requirements.py -v

# Run integration tests
python -m pytest tests/integration/test_reward_events.py -v

# Run all reward tests
python -m pytest tests/ -k reward -v
```

**Verify:**
- All tests pass
- No regressions in existing tests
- Coverage includes all condition types
- All 6 REWARD requirements explicitly tested

**If tests fail:**
- Fix issues in RewardService or handlers
- Re-run tests until all pass
- Document any known limitations
  </action>
  <verify>python -m pytest tests/ -k reward --co -q 2>/dev/null | grep -c "test_" | grep -q "[1-9]"</verify>
  <done>All reward tests created and passing</done>
</task>

</tasks>

<verification>
- tests/services/test_reward_service.py exists with condition evaluation tests
- tests/handlers/test_reward_handlers.py exists with UI flow tests
- tests/requirements/test_reward_requirements.py exists with REWARD-01 through REWARD-06 tests
- tests/integration/test_reward_events.py exists with flow tests
- All tests pass with pytest
</verification>

<success_criteria>
- 30+ unit tests for RewardService
- 15+ handler tests for reward UI
- 6 explicit requirement verification tests (REWARD-01 to REWARD-06)
- 10+ integration tests for complete flows
- All tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/23-rewards-system/23-04-SUMMARY.md`
</output>
