---
phase: 23-rewards-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/database/enums.py
  - bot/database/models.py
autonomous: true

must_haves:
  truths:
    - Reward and RewardCondition models exist in database
    - RewardType enum defines reward categories
    - RewardConditionType enum defines condition types
    - RewardStatus enum tracks claim states
    - UserReward model tracks user-reward relationships
  artifacts:
    - path: "bot/database/enums.py"
      provides: "RewardType, RewardConditionType, RewardStatus enums"
      contains: ["class RewardType", "class RewardConditionType", "class RewardStatus"]
    - path: "bot/database/models.py"
      provides: "Reward, RewardCondition, UserReward models"
      contains: ["class Reward", "class RewardCondition", "class UserReward"]
  key_links:
    - from: "Reward"
      to: "RewardCondition"
      via: "one-to-many relationship"
    - from: "UserReward"
      to: "Reward"
      via: "user reward tracking"
---

<objective>
Create database foundation for the Rewards System with models and enums.

Purpose: Establish the data structures needed to store rewards, their conditions, and track user progress toward claiming them.
Output: Reward and RewardCondition models with supporting enums.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/23-rewards-system/23-CONTEXT.md
@bot/database/enums.py
@bot/database/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Reward System Enums</name>
  <files>bot/database/enums.py</files>
  <action>
Add three new enums to bot/database/enums.py following the existing pattern:

1. **RewardType** - Types of rewards:
   - BESITOS: Virtual currency reward
   - CONTENT: Content unlock (ContentSet)
   - BADGE: Achievement badge (cosmetic)
   - VIP_EXTENSION: Extend VIP subscription

2. **RewardConditionType** - Condition types for checking eligibility:
   - STREAK_LENGTH: Current streak >= value
   - TOTAL_POINTS: total_earned >= value
   - LEVEL_REACHED: level >= value
   - BESITOS_SPENT: total_spent >= value
   - FIRST_PURCHASE: Has made at least one shop purchase
   - FIRST_DAILY_GIFT: Has claimed daily gift at least once
   - FIRST_REACTION: Has reacted to content at least once
   - NOT_VIP: User is not VIP (exclusion condition)
   - NOT_CLAIMED_BEFORE: Has not claimed this reward before

3. **RewardStatus** - Status of reward for a user:
   - LOCKED: Conditions not met
   - UNLOCKED: Conditions met, available to claim
   - CLAIMED: Already claimed
   - EXPIRED: Claim window passed

Each enum should follow the existing pattern with __str__, display_name property, and emoji property where appropriate.
  </action>
  <verify>grep -q "class RewardType" bot/database/enums.py && grep -q "class RewardConditionType" bot/database/enums.py && grep -q "class RewardStatus" bot/database/enums.py</verify>
  <done>All three enums exist with proper values and follow existing code patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create Reward Model</name>
  <files>bot/database/models.py</files>
  <action>
Add the Reward model to bot/database/models.py after the UserContentAccess model:

**Reward Model:**
- id: Primary key (Integer, autoincrement)
- name: Reward name (String 200, nullable=False)
- description: Reward description (String 1000, nullable=True)
- reward_type: RewardType enum (nullable=False)
- reward_value: JSON field for reward data (nullable=False)
  - For BESITOS: {"amount": 100}
  - For CONTENT: {"content_set_id": 123}
  - For BADGE: {"badge_name": "streak_master", "emoji": "ðŸ”¥"}
  - For VIP_EXTENSION: {"days": 7}
- is_repeatable: Boolean (default=False) - can claim multiple times
- is_secret: Boolean (default=False) - hidden until unlocked
- claim_window_hours: Integer (default=168 = 7 days) - time to claim after unlock
- is_active: Boolean (default=True, index=True)
- sort_order: Integer (default=0) - display order
- created_at: DateTime (default=utcnow)
- updated_at: DateTime (default=utcnow, onupdate=utcnow)

Relationships:
- conditions: One-to-many with RewardCondition (back_populates="reward")
- user_rewards: One-to-many with UserReward (back_populates="reward")

Indexes:
- idx_reward_active_type: (is_active, reward_type)
- idx_reward_sort: (sort_order)
  </action>
  <verify>grep -q "class Reward" bot/database/models.py</verify>
  <done>Reward model exists with all fields, relationships, and indexes</done>
</task>

<task type="auto">
  <name>Task 3: Create RewardCondition Model</name>
  <files>bot/database/models.py</files>
  <action>
Add the RewardCondition model to bot/database/models.py after Reward:

**RewardCondition Model:**
- id: Primary key (Integer, autoincrement)
- reward_id: ForeignKey to rewards.id (nullable=False, index=True)
- condition_type: RewardConditionType enum (nullable=False)
- condition_value: Integer or String depending on type (nullable=True)
  - For numeric conditions: the threshold value (>= comparison)
  - For event conditions: ignored (presence is enough)
  - For exclusion conditions: ignored
- condition_group: Integer (default=0) - for OR logic within group
  - All conditions in group 0 use AND logic (all must pass)
  - Conditions in group 1, 2, etc. use OR logic (at least one in group must pass)
- sort_order: Integer (default=0) - evaluation order
- created_at: DateTime (default=utcnow)

Relationships:
- reward: Many-to-one with Reward (back_populates="conditions")

Indexes:
- idx_condition_reward: (reward_id)
- idx_condition_type: (condition_type)

The model represents a single condition that must be met for a reward.
Multiple conditions per reward use AND logic by default (all must pass).
Conditions with the same non-zero condition_group use OR logic (at least one must pass).
  </action>
  <verify>grep -q "class RewardCondition" bot/database/models.py</verify>
  <done>RewardCondition model exists with all fields and relationships</done>
</task>

<task type="auto">
  <name>Task 4: Create UserReward Model</name>
  <files>bot/database/models.py</files>
  <action>
Add the UserReward model to bot/database/models.py after RewardCondition:

**UserReward Model:**
Tracks the relationship between users and rewards (progress, claims, history).

- id: Primary key (Integer, autoincrement)
- user_id: ForeignKey to users.user_id (nullable=False, index=True)
- reward_id: ForeignKey to rewards.id (nullable=False, index=True)
- status: RewardStatus enum (nullable=False, default=RewardStatus.LOCKED)
- unlocked_at: DateTime (nullable=True) - when conditions were first met
- claimed_at: DateTime (nullable=True) - when user claimed the reward
- expires_at: DateTime (nullable=True) - claim deadline
- claim_count: Integer (default=0) - how many times claimed (for repeatable)
- last_claimed_at: DateTime (nullable=True) - last claim timestamp
- created_at: DateTime (default=utcnow)
- updated_at: DateTime (default=utcnow, onupdate=utcnow)

Relationships:
- reward: Many-to-one with Reward (back_populates="user_rewards")

Indexes:
- idx_user_reward_user_status: (user_id, status) - for "my rewards" queries
- idx_user_reward_unlocked: (unlocked_at) - for expiration processing
- idx_user_reward_expires: (expires_at) - for finding expired rewards
- Unique constraint: (user_id, reward_id) - one record per user-reward pair

The model tracks:
- Current status (LOCKED/UNLOCKED/CLAIMED/EXPIRED)
- When it was unlocked (for expiration calculation)
- When it was claimed (for history)
- How many times claimed (for repeatable rewards)
  </action>
  <verify>grep -q "class UserReward" bot/database/models.py</verify>
  <done>UserReward model exists with all fields, relationships, and indexes</done>
</task>

</tasks>

<verification>
- All three enums exist in bot/database/enums.py
- All three models exist in bot/database/models.py
- Relationships are properly defined
- Indexes are properly defined
- Models follow existing SQLAlchemy patterns in codebase
</verification>

<success_criteria>
- RewardType, RewardConditionType, RewardStatus enums added
- Reward model with conditions and user_rewards relationships
- RewardCondition model with reward relationship
- UserReward model with reward relationship
- All fields, indexes, and constraints properly defined
</success_criteria>

<output>
After completion, create `.planning/phases/23-rewards-system/23-01-SUMMARY.md`
</output>
