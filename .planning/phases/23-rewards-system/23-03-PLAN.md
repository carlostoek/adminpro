---
phase: 23-rewards-system
plan: 03
type: execute
wave: 2
depends_on: ["23-02"]
files_modified:
  - bot/services/container.py
  - bot/handlers/user/rewards.py
  - bot/handlers/user/__init__.py
autonomous: true

must_haves:
  truths:
    - ServiceContainer exposes reward property with lazy loading
    - User can view available rewards via /rewards command
    - User can claim unlocked rewards via callback
    - Rewards integrated into daily gift flow with grouped notifications
  artifacts:
    - path: "bot/services/container.py"
      provides: "container.reward property"
      contains: ["def reward", "_reward_service"]
    - path: "bot/handlers/user/rewards.py"
      provides: "User reward handlers"
      min_lines: 200
      exports: ["rewards_router"]
  key_links:
    - from: "ServiceContainer.reward"
      to: "RewardService"
      via: "lazy loading property"
    - from: "Daily gift handler"
      to: "RewardService.check_rewards_on_event"
      via: "event-driven checking"
---

<objective>
Integrate RewardService into ServiceContainer and create user-facing reward handlers.

Purpose: Wire the reward system into the existing infrastructure and provide user interface for viewing and claiming rewards.
Output: ServiceContainer integration and user reward handlers with Lucien's voice.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/23-rewards-system/23-CONTEXT.md
@bot/services/container.py
@bot/handlers/user/streak_handlers.py
@bot/handlers/user/shop.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RewardService to ServiceContainer</name>
  <files>bot/services/container.py</files>
  <action>
Add RewardService integration to ServiceContainer following the existing pattern:

**In __init__:**
- Add `self._reward_service = None`

**Add reward property:**
```python
@property
def reward(self):
    """
    Service de recompensas y logros.

    Se carga lazy (solo en primer acceso).

    Returns:
        RewardService: Instancia del service

    Usage:
        # Check rewards on event
        unlocked = await container.reward.check_rewards_on_event(
            user_id=123, event_type="daily_gift_claimed"
        )

        # Get available rewards
        rewards = await container.reward.get_available_rewards(user_id=123)

        # Claim a reward
        success, msg, details = await container.reward.claim_reward(
            user_id=123, reward_id=456
        )
    """
    if self._reward_service is None:
        from bot.services.reward import RewardService
        logger.debug("ðŸ”„ Lazy loading: RewardService")
        # Inject wallet and streak services
        self._reward_service = RewardService(
            self._session,
            wallet_service=self.wallet,
            streak_service=self.streak
        )

    return self._reward_service
```

**Update get_loaded_services:**
- Add check for `self._reward_service` and append "reward" if loaded

**Update preload_critical_services (optional):**
- Reward service is not critical for startup, skip preload
  </action>
  <verify>grep -q "_reward_service" bot/services/container.py && grep -q "def reward" bot/services/container.py</verify>
  <done>RewardService integrated into ServiceContainer with lazy loading</done>
</task>

<task type="auto">
  <name>Task 2: Create User Reward Handlers</name>
  <files>bot/handlers/user/rewards.py</files>
  <action>
Create bot/handlers/user/rewards.py with user-facing reward handlers:

**Imports:**
- aiogram Router, F, types
- ServiceContainer from bot.services.container
- RewardStatus enum
- logging

**Create rewards_router:**
```python
rewards_router = Router(name="rewards")
```

**Handler: rewards_list_handler**
- Command: /rewards or callback "my_rewards"
- Get container from data["container"]
- Get available rewards: `rewards = await container.reward.get_available_rewards(user_id)`
- Build message with Lucien's voice (ðŸŽ©)
- Format:
  - Header: "ðŸŽ© <b>Su GalerÃ­a de Recompensas</b>"
  - For each reward show:
    - Status emoji (ðŸ”’ locked, âœ¨ unlocked, âœ… claimed)
    - Reward name and type emoji
    - Brief description
    - For unlocked: "[Reclamar]" button
    - For locked: progress hint if available
  - Footer: hint about how to unlock more

**Handler: reward_claim_handler**
- Callback pattern: "claim_reward:{reward_id}"
- Parse reward_id from callback data
- Call `container.reward.claim_reward(user_id, reward_id)`
- On success:
  - Show reward details and what was received
  - Use Diana's voice (ðŸ«¦) for user-facing success
  - Update message to show claimed status
- On failure:
  - Show error with Lucien's voice (ðŸŽ©)
  - Explain why (expired, already claimed, etc.)

**Handler: reward_detail_handler**
- Callback pattern: "reward_detail:{reward_id}"
- Show detailed view of single reward
- Show all conditions and current progress
- Show claim button if unlocked

**Helper: _format_reward_status(status)**
- Return appropriate emoji for each RewardStatus
  </action>
  <verify>test -f bot/handlers/user/rewards.py && grep -q "rewards_router" bot/handlers/user/rewards.py</verify>
  <done>User reward handlers created with list, claim, and detail views</done>
</task>

<task type="auto">
  <name>Task 3: Integrate Rewards into Daily Gift Flow</name>
  <files>bot/handlers/user/streak_handlers.py</files>
  <action>
Modify the daily gift handler to trigger reward checking:

**In daily_gift_claim_handler (after successful claim):**
- After claiming daily gift and getting result
- Call `container.reward.check_rewards_on_event(user_id, "daily_gift_claimed")`
- Get unlocked rewards list
- If rewards unlocked:
  - Build grouped notification using `container.reward.build_reward_notification()`
  - Send single message combining:
    - Daily gift claim confirmation (existing)
    - Newly unlocked rewards
  - Include buttons: [Reclamar Recompensas] [Ver Todas]
- If no rewards unlocked:
  - Send normal daily gift confirmation (existing behavior)

**Message format (grouped notification):**
```
ðŸŽ© <b>Regalo Diario Reclamado</b>

Ha recibido <b>{total}</b> besitos
(base: {base} + racha: {bonus})

âœ¨ <b>Nuevas Recompensas Desbloqueadas:</b>
â€¢ Racha de 7 dÃ­as - 50 besitos
â€¢ Fiel Participante - Insignia especial

[Reclamar Recompensas] [Ver Todas]
```

**Update imports:**
- Add RewardService import if needed for type hints
  </action>
  <verify>grep -q "check_rewards_on_event" bot/handlers/user/streak_handlers.py</verify>
  <done>Reward checking integrated into daily gift flow with grouped notifications</done>
</task>

<task type="auto">
  <name>Task 4: Register Rewards Router</name>
  <files>bot/handlers/user/__init__.py</files>
  <action>
Register the rewards router in the user handlers:

**In bot/handlers/user/__init__.py:**
- Import rewards_router from .rewards
- Add rewards_router to the list of routers
- Ensure it's included in setup_user_handlers()

The router should be registered alongside other user routers like shop_router.
  </action>
  <verify>grep -q "rewards_router" bot/handlers/user/__init__.py</verify>
  <done>Rewards router registered in user handlers</done>
</task>

<task type="auto">
  <name>Task 5: Integrate Rewards into Shop Purchase Flow</name>
  <files>bot/handlers/user/shop.py</files>
  <action>
Modify the shop purchase handler to trigger reward checking:

**In shop_confirm_purchase_handler (after successful purchase):**
- After completing purchase and delivering content
- Call `container.reward.check_rewards_on_event(user_id, "purchase_completed", {"product_id": product_id})`
- Get unlocked rewards list
- If rewards unlocked:
  - Build grouped notification
  - Send message combining purchase confirmation and new rewards
  - Include [Reclamar] buttons

**Message format:**
```
ðŸŽ© <b>Compra Completada</b>

Ha adquirido: {product_name}
Precio: {price} besitos

âœ¨ <b>Nuevas Recompensas Desbloqueadas:</b>
â€¢ Primera Compra - 100 besitos
â€¢ Comprador Frecuente - Insignia

[Reclamar Recompensas] [Continuar]
```

This ensures FIRST_PURCHASE and BESITOS_SPENT conditions are checked after each purchase.
  </action>
  <verify>grep -q "purchase_completed" bot/handlers/user/shop.py || grep -q "check_rewards_on_event" bot/handlers/user/shop.py</verify>
  <done>Reward checking integrated into shop purchase flow</done>
</task>

</tasks>

<verification>
- ServiceContainer has reward property with lazy loading
- User can access /rewards command to view available rewards
- User can claim rewards via callback buttons
- Daily gift triggers reward checking with grouped notifications
- Shop purchase triggers reward checking
- Rewards router is registered in user handlers
</verification>

<success_criteria>
- RewardService accessible via container.reward
- /rewards command shows available rewards with status
- Claim callbacks process rewards correctly
- Daily gift flow includes reward checking
- Shop purchase flow includes reward checking
- Grouped notifications combine multiple achievements
</success_criteria>

<output>
After completion, create `.planning/phases/23-rewards-system/23-03-SUMMARY.md`
</output>
