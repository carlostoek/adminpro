---
phase: 09-user-management
plan: 03
type: execute
wave: 3
depends_on: [09-01, 09-02]
files_modified: [bot/handlers/admin/users.py, bot/handlers/admin/main.py, bot/handlers/admin/menu_callbacks.py]
autonomous: true

must_haves:
  truths:
    - "Admin puede navegar a menÃº de gestiÃ³n de usuarios desde menÃº principal"
    - "Admin puede ver lista de usuarios con paginaciÃ³n (20 por pÃ¡gina)"
    - "Admin puede filtrar usuarios por rol (todos, VIP, Free)"
    - "Admin puede buscar usuario por username o ID"
    - "Admin puede ver perfil detallado de usuario con tabs (Overview, Subscription, Activity, Interests)"
    - "Admin puede cambiar rol de usuario con confirmaciÃ³n"
    - "Admin recibe mensaje de error si intenta modificarse a sÃ­ mismo"
    - "Admin recibe mensaje de error si no es super admin e intenta modificar otro admin"
    - "Cambio de rol se registra en UserRoleChangeLog con changed_by"
  artifacts:
    - path: "bot/handlers/admin/users.py"
      provides: "User management callback handlers for navigation, listing, search, detail view, and role change"
      min_lines: 350
      exports: ["callback_users_menu", "callback_users_list", "callback_users_page", "callback_user_view", "callback_user_role", "callback_user_role_confirm", "callback_users_search", "callback_users_search_results"]
  key_links:
    - from: "bot/handlers/admin/main.py"
      to: "bot/handlers/admin/users.py"
      via: "admin:users callback handler registration"
      pattern: "@admin_router\\.callback_query\\(F\\.data == \"admin:users\"\\)"
    - from: "callback handlers"
      to: "UserManagementService"
      via: "ServiceContainer.user_management"
      pattern: "await container\\.user_management\\."
    - from: "callback handlers"
      to: "AdminUserMessages"
      via: "ServiceContainer.message.admin.user"
      pattern: "container\\.message\\.admin\\.user\\."
---

<objective>
Create user management handlers (bot/handlers/admin/users.py) with callback handlers for navigation, user listing with pagination and filters, search functionality, tabbed user detail view (Overview, Subscription, Activity, Interests), and role change functionality with confirmation and permission validation using UserManagementService and AdminUserMessages.

Purpose: Complete user management interface with full view and modify operations (list, search, view details, change role) following established admin handler patterns (content.py, interests.py) with unified callback structure admin:users:* and admin:user:*.
Output: New users.py handler file with 10+ callback handlers, integrated into admin router with Users FSM states for search.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-user-management/09-CONTEXT.md

@bot/handlers/admin/content.py
@bot/handlers/admin/interests.py
@bot/utils/pagination.py
@bot/services/user_management.py (plan 09-01)
@bot/services/message/admin_user.py (plan 09-02)
@bot/states/admin.py (for FSM states)
@.planning/phases/07-admin-menu-content-management/07-02-PLAN.md
@.planning/phases/08-interest-notification-system/08-04-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FSM states for user management</name>
  <files>bot/states/admin.py</files>
  <action>
Update bot/states/admin.py to add user management FSM states:

1. Add UserManagementStates state group:
```python
class UserManagementStates(StatesGroup):
    """FSM states for user management flow."""
    searching_user = State()  # Waiting for user to enter search query
```

2. Place after existing state groups (ContentPackageStates, etc.)

DO NOT:
- Modify existing state groups
- Add unnecessary states (search confirmation is enough)
  </action>
  <verify>
1. UserManagementStates state group exists
2. Has searching_user state
3. Extends StatesGroup
4. Placed logically with other admin states
  </verify>
  <done>
UserManagementStates FSM state group added with searching_user state for user search flow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create users.py handler file with navigation and list callbacks</name>
  <files>bot/handlers/admin/users.py</files>
  <action>
Create bot/handlers/admin/users.py with user management callback handlers:

1. File structure:
```python
"""
User Management Handlers - Admin interface for managing users.

Handlers for listing, viewing, searching, and changing user roles.
"""
import logging
from aiogram import Router, F, Bot
from aiogram.types import CallbackQuery, Message
from sqlalchemy.ext.asyncio import AsyncSession

from bot.middlewares import DatabaseMiddleware
from bot.services.container import ServiceContainer
from bot.states.admin import UserManagementStates
from bot.database.enums import UserRole

logger = logging.getLogger(__name__)

# Router for user management handlers
users_router = Router(name="admin_users")

# Apply middleware (AdminAuth already on admin_router, this integrates into it)
users_router.callback_query.middleware(DatabaseMiddleware())
users_router.message.middleware(DatabaseMiddleware())
```

2. Required callback handlers:

**a. Menu handler (admin:users):**
```python
@users_router.callback_query(F.data == "admin:users")
async def callback_users_menu(callback: CallbackQuery, session: AsyncSession):
    """
    Show main user management menu.

    Args:
        callback: Callback query
        session: SesiÃ³n de BD (inyectada por middleware)
    """
    logger.debug(f"ğŸ‘¥ Admin {callback.from_user.id} opened user management menu")

    container = ServiceContainer(session, callback.bot)

    # Get user counts by role
    _, total_count = await container.user_management.get_user_list(limit=1)
    _, vip_count = await container.user_management.get_user_list(role=UserRole.VIP, limit=1)
    _, free_count = await container.user_management.get_user_list(role=UserRole.FREE, limit=1)
    _, admin_count = await container.user_management.get_user_list(role=UserRole.ADMIN, limit=1)

    # Get menu message
    text, keyboard = container.message.admin.user.users_menu(
        total_users=total_count,
        vip_count=vip_count,
        free_count=free_count,
        admin_count=admin_count
    )

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")
        await callback.message.answer(text=text, reply_markup=keyboard, parse_mode="HTML")

    await callback.answer()
```

**b. List handler (admin:users:list:{filter}):**
```python
@users_router.callback_query(F.data.startswith("admin:users:list:"))
async def callback_users_list(callback: CallbackQuery, session: AsyncSession):
    """
    Show users list with filter.

    Callback data format: "admin:users:list:{filter_type}"

    Filters:
    - all: All users
    - vip: Only VIP users
    - free: Only Free users

    Args:
        callback: Callback query
        session: SesiÃ³n de BD
    """
    logger.debug(f"ğŸ‘¥ Admin {callback.from_user.id} viewing users list")

    container = ServiceContainer(session, callback.bot)

    # Extract filter type from callback
    parts = callback.data.split(":")
    filter_type = parts[3] if len(parts) > 3 else "all"

    # Map filter to UserRole
    role_filter = None
    if filter_type == "vip":
        role_filter = UserRole.VIP
    elif filter_type == "free":
        role_filter = UserRole.FREE

    # Get users with pagination (first page)
    users, total_count = await container.user_management.get_user_list(
        role=role_filter,
        limit=20,
        offset=0,
        sort_newest_first=True
    )

    # Calculate total pages
    total_pages = (total_count + 19) // 20  # Round up

    # Generate list message
    if users:
        text, keyboard = container.message.admin.user.users_list(
            users=users,
            page=1,
            total_pages=total_pages,
            filter_type=filter_type,
            total_count=total_count
        )
    else:
        # Empty list message
        text = f"ğŸ‘¥ <b>Usuarios: {filter_type.title()}</b>\n\n<i>No hay usuarios para mostrar.</i>"
        from aiogram.utils.keyboard import InlineKeyboardBuilder, InlineKeyboardButton
        keyboard = InlineKeyboardBuilder()
        keyboard.row(
            InlineKeyboardButton(text="ğŸ”™ Volver", callback_data="admin:users:menu")
        )
        keyboard = keyboard.as_markup()

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")
        await callback.message.answer(text=text, reply_markup=keyboard, parse_mode="HTML")

    await callback.answer()
```

**c. Page handler (admin:users:page:{page}:{filter}):**
```python
@users_router.callback_query(F.data.startswith("admin:users:page:"))
async def callback_users_page(callback: CallbackQuery, session: AsyncSession):
    """
    Show specific page of users list.

    Callback data format: "admin:users:page:{page_num}:{filter_type}"

    Args:
        callback: Callback query
        session: SesiÃ³n de BD
    """
    container = ServiceContainer(session, callback.bot)

    # Extract page and filter from callback
    parts = callback.data.split(":")
    page = int(parts[3]) if len(parts) > 3 else 1
    filter_type = parts[4] if len(parts) > 4 else "all"

    # Map filter to UserRole
    role_filter = None
    if filter_type == "vip":
        role_filter = UserRole.VIP
    elif filter_type == "free":
        role_filter = UserRole.FREE

    # Get users with pagination
    offset = (page - 1) * 20
    users, total_count = await container.user_management.get_user_list(
        role=role_filter,
        limit=20,
        offset=offset,
        sort_newest_first=True
    )

    # Calculate total pages
    total_pages = (total_count + 19) // 20

    # Generate list message
    if users:
        text, keyboard = container.message.admin.user.users_list(
            users=users,
            page=page,
            total_pages=total_pages,
            filter_type=filter_type,
            total_count=total_count
        )
    else:
        # Empty list
        text = f"ğŸ‘¥ <b>Usuarios: {filter_type.title()}</b>\n\n<i>No hay usuarios para mostrar.</i>"
        from aiogram.utils.keyboard import InlineKeyboardBuilder, InlineKeyboardButton
        keyboard = InlineKeyboardBuilder()
        keyboard.row(
            InlineKeyboardButton(text="ğŸ”™ Volver", callback_data="admin:users:menu")
        )
        keyboard = keyboard.as_markup()

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")

    await callback.answer()
```

**d. Search prompt handler (admin:users:search):**
```python
@users_router.callback_query(F.data == "admin:users:search")
async def callback_users_search(callback: CallbackQuery, state, session: AsyncSession):
    """
    Prompt user to enter search query.

    Args:
        callback: Callback query
        state: FSM state
        session: SesiÃ³n de BD
    """
    logger.debug(f"ğŸ” Admin {callback.from_user.id} initiating user search")

    # Set FSM state
    await state.set_state(UserManagementStates.searching_user)

    # Get search prompt message
    from bot.services.container import ServiceContainer
    container = ServiceContainer(session, callback.bot)
    text, keyboard = container.message.admin.user.user_search_prompt()

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")
        await callback.message.answer(text=text, reply_markup=keyboard, parse_mode="HTML")

    await callback.answer()
```

**e. Search message handler (FSM state):**
```python
@users_router.message(UserManagementStates.searching_user)
async def callback_users_search_results(message: Message, state, session: AsyncSession):
    """
    Process user search query and display results.

    Args:
        message: Message with search query
        state: FSM state
        session: SesiÃ³n de BD
    """
    logger.debug(f"ğŸ” Admin {message.from_user.id} searching for user: {message.text}")

    container = ServiceContainer(session, message.bot)

    # Search for users
    query = message.text.strip()
    users = await container.user_management.search_users(query=query, limit=10)

    # Clear FSM state
    await state.clear()

    # Generate results message
    text, keyboard = container.message.admin.user.user_search_results(users=users, query=query)

    await message.answer(text=text, reply_markup=keyboard, parse_mode="HTML")
```

**f. User detail view handler (admin:user:view:{id}:{tab}):**
```python
@users_router.callback_query(F.data.startswith("admin:user:view:"))
async def callback_user_view(callback: CallbackQuery, session: AsyncSession):
    """
    Show detailed user profile with tabs.

    Callback data format: "admin:user:view:{user_id}:{tab}"

    Tabs: overview, subscription, activity, interests

    Args:
        callback: Callback query
        session: SesiÃ³n de BD
    """
    container = ServiceContainer(session, callback.bot)

    # Extract user_id and tab from callback
    parts = callback.data.split(":")
    user_id = int(parts[3]) if len(parts) > 3 else None
    tab = parts[4] if len(parts) > 4 else "overview"

    if not user_id:
        await callback.answer("âŒ ID de usuario invÃ¡lido", show_alert=True)
        return

    # Get user info
    user_info = await container.user_management.get_user_info(user_id=user_id)

    if not user_info:
        await callback.answer("âŒ Usuario no encontrado", show_alert=True)
        return

    # Generate appropriate tab message
    if tab == "overview":
        text, keyboard = container.message.admin.user.user_detail_overview(user_info)
    elif tab == "subscription":
        text, keyboard = container.message.admin.user.user_detail_subscription(user_info)
    elif tab == "activity":
        text, keyboard = container.message.admin.user.user_detail_activity(user_info)
    elif tab == "interests":
        # Get user interests
        from bot.database.models import UserInterest
        interests, _ = await container.interest.get_interests(user_id=user_id, limit=10)
        text, keyboard = container.message.admin.user.user_detail_interests(user_info, interests)
    else:
        text, keyboard = container.message.admin.user.user_detail_overview(user_info)

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")

    await callback.answer()
```

**g. Role change confirmation handler (admin:user:role:{id}):**
```python
@users_router.callback_query(F.data.startswith("admin:user:role:"))
async def callback_user_role(callback: CallbackQuery, session: AsyncSession):
    """
    Show role change confirmation dialog.

    Callback data format: "admin:user:role:{user_id}"

    Args:
        callback: Callback query
        session: SesiÃ³n de BD
    """
    container = ServiceContainer(session, callback.bot)

    # Extract user_id from callback
    parts = callback.data.split(":")
    user_id = int(parts[3]) if len(parts) > 3 else None

    if not user_id:
        await callback.answer("âŒ ID de usuario invÃ¡lido", show_alert=True)
        return

    # Check if this is a confirm callback (admin:user:role:confirm:{id}:{role})
    if len(parts) > 4 and parts[4] == "confirm":
        # Handle actual role change in separate handler
        await callback_user_role_confirm(callback, session)
        return

    # Get user info
    user_info = await container.user_management.get_user_info(user_id=user_id)

    if not user_info:
        await callback.answer("âŒ Usuario no encontrado", show_alert=True)
        return

    # Show role selection dialog
    from aiogram.utils.keyboard import InlineKeyboardBuilder, InlineKeyboardButton

    user_name = user_info.get("first_name", "Usuario")
    current_role = user_info["role"]

    text = (
        f"ğŸ”„ <b>Cambiar Rol de Usuario</b>\n\n"
        f"ğŸ‘¤ <b>Usuario:</b> {user_name}\n"
        f"ğŸ†” <b>ID:</b> {user_id}\n"
        f"ğŸ“ <b>Rol actual:</b> {current_role.value}\n\n"
        f"<i>Seleccione el nuevo rol:</i>"
    )

    keyboard = InlineKeyboardBuilder()

    # Add role options (excluding current role)
    if current_role != UserRole.VIP:
        keyboard.row(
            InlineKeyboardButton(text="ğŸ’ VIP", callback_data=f"admin:user:role:confirm:{user_id}:vip")
        )
    if current_role != UserRole.FREE:
        keyboard.row(
            InlineKeyboardButton(text="ğŸ‘¤ Free", callback_data=f"admin:user:role:confirm:{user_id}:free")
        )
    if current_role != UserRole.ADMIN:
        keyboard.row(
            InlineKeyboardButton(text="ğŸ‘‘ Admin", callback_data=f"admin:user:role:confirm:{user_id}:admin")
        )

    keyboard.row(
        InlineKeyboardButton(text="âŒ Cancelar", callback_data=f"admin:user:view:{user_id}:overview")
    )

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard.as_markup(), parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")

    await callback.answer()
```

**h. Role change action handler (admin:user:role:confirm:{id}:{role}):**
```python
@users_router.callback_query(F.data.startswith("admin:user:role:confirm:"))
async def callback_user_role_confirm(callback: CallbackQuery, session: AsyncSession):
    """
    Execute role change (confirmed).

    Callback data format: "admin:user:role:confirm:{user_id}:{new_role}"

    Args:
        callback: Callback query
        session: SesiÃ³n de BD
    """
    container = ServiceContainer(session, callback.bot)

    # Extract user_id and new_role from callback
    parts = callback.data.split(":")
    user_id = int(parts[4]) if len(parts) > 4 else None
    new_role_str = parts[5] if len(parts) > 5 else None

    if not user_id or not new_role_str:
        await callback.answer("âŒ ParÃ¡metros invÃ¡lidos", show_alert=True)
        return

    # Map role string to UserRole enum
    role_map = {
        "vip": UserRole.VIP,
        "free": UserRole.FREE,
        "admin": UserRole.ADMIN
    }
    new_role = role_map.get(new_role_str.lower())

    if not new_role:
        await callback.answer("âŒ Rol invÃ¡lido", show_alert=True)
        return

    # Get current user info
    user_info = await container.user_management.get_user_info(user_id=user_id)

    if not user_info:
        await callback.answer("âŒ Usuario no encontrado", show_alert=True)
        return

    old_role = user_info["role"]
    admin_id = callback.from_user.id

    # Perform role change
    success, message = await container.user_management.change_user_role(
        user_id=user_id,
        new_role=new_role,
        changed_by=admin_id
    )

    if not success:
        # Show error message
        await callback.answer(f"âŒ {message}", show_alert=True)
        text, keyboard = container.message.admin.user.action_error(message)
        try:
            await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
        except Exception as e:
            logger.warning(f"Could not edit message: {e}")
        return

    # Show success message
    text, keyboard = container.message.admin.user.role_change_success(
        user_info=user_info,
        old_role=old_role,
        new_role=new_role
    )

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")

    await callback.answer("âœ… Rol cambiado exitosamente", show_alert=True)
    logger.info(f"âœ… Admin {admin_id} changed user {user_id} role from {old_role.value} to {new_role.value}")
```

**i. Filters handler (admin:users:filters:{current}):**
```python
@users_router.callback_query(F.data.startswith("admin:users:filters"))
async def callback_users_filters(callback: CallbackQuery, session: AsyncSession):
    """
    Show filter selection screen.

    Callback data format: "admin:users:filters" or "admin:users:filters:{current_filter}"

    Args:
        callback: Callback query
        session: SesiÃ³n de BD
    """
    from aiogram.utils.keyboard import InlineKeyboardBuilder, InlineKeyboardButton

    # Extract current filter
    parts = callback.data.split(":")
    current_filter = parts[3] if len(parts) > 3 else "all"

    filter_names = {
        "all": "Todos los Usuarios",
        "vip": "Solo VIP",
        "free": "Solo Free"
    }

    text = (
        f"ğŸ” <b>Filtros de Usuarios</b>\n\n"
        f"<i>Filtro actual: {filter_names.get(current_filter, 'Todos')}</i>\n\n"
        f"<i>Seleccione un nuevo filtro:</i>"
    )

    keyboard = InlineKeyboardBuilder()
    keyboard.row(
        InlineKeyboardButton(text="ğŸ‘¥ Todos", callback_data="admin:users:list:all")
    )
    keyboard.row(
        InlineKeyboardButton(text="ğŸ’ Solo VIP", callback_data="admin:users:list:vip"),
        InlineKeyboardButton(text="ğŸ‘¤ Solo Free", callback_data="admin:users:list:free")
    )
    keyboard.row(
        InlineKeyboardButton(text="ğŸ”™ Volver", callback_data="admin:users:menu")
    )

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard.as_markup(), parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")

    await callback.answer()
```

**j. No-op handler for pagination button:**
```python
@users_router.callback_query(F.data == "admin:users:noop")
async def callback_users_noop(callback: CallbackQuery):
    """
    No-op handler for pagination page number button.

    Args:
        callback: Callback query
    """
    await callback.answer()
```

3. Import UserRole at top (already imported).

DO NOT:
- Add AdminAuthMiddleware (applied at admin_router level)
- Call session.commit() (SessionContextManager handles it)
- Use hardcoded pagination (use UserManagementService methods)
- Use InlineKeyboardBuilder directly for messages (use AdminUserMessages keyboards)
- Forget callback.answer() at end of handlers
- Handle "message is not modified" errors gracefully (try/except on edit_text)
  </action>
  <verify>
1. File created: bot/handlers/admin/users.py
2. Has users_router with Router(name="admin_users")
3. Has DatabaseMiddleware registered on callback_query and message
4. Has 10+ callback handlers: menu, list, page, search, search_results, user_view, user_role, user_role_confirm, filters, noop
5. All handlers use ServiceContainer
6. All handlers use AdminUserMessages for text/keyboards (except role selection which uses inline builder for dynamic options)
7. All callback handlers call callback.answer()
8. No session.commit() calls
9. Pagination uses UserManagementService.get_user_list with limit/offset
10. Filter mapping: all, vip, free
11. User view supports tabs: overview, subscription, activity, interests
12. Role change has confirmation dialog with role selection
13. Permission validation via UserManagementService._can_modify_user
14. Follows admin handler pattern (content.py, interests.py)
15. FSM state used for search flow
16. Handles "message is not modified" errors with try/except
  </verify>
  <done>
User management handler file created with navigation, listing, search, detail view with tabs, and role change callbacks, using UserManagementService and AdminUserMessages.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate users_router into admin router</name>
  <files>bot/handlers/admin/main.py</files>
  <action>
Update bot/handlers/admin/main.py to include users_router:

1. Import users_router:
```python
from bot.handlers.admin import users as admin_users
```

2. After admin_router definition, include users_router:
```python
# Include user management router
admin_router.include_router(admin_users.users_router)
```

3. Placement: After other router includes (content, interests, etc.), before handler definitions

DO NOT:
- Modify existing handlers
- Change AdminAuthMiddleware application (stays on admin_router)
- Duplicate router registration
  </action>
  <verify>
1. admin_users.users_router imported
2. admin_router.include_router() called for users_router
3. User management callbacks registered in admin router
4. Existing admin handlers unchanged
5. AdminAuthMiddleware still applies (via admin_router inheritance)
  </verify>
  <done>
Users router integrated into admin router, all user management callbacks active.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add Users button to admin main menu</name>
  <files>bot/handlers/admin/menu.py</files>
  <action>
Update bot/handlers/admin/menu.py to add Users button to admin main menu:

1. Locate the admin menu keyboard generation (typically in a function or handler)

2. Add Users button after Interests and before Config:
```python
keyboard.row(
    InlineKeyboardButton(text="ğŸ“¦ Paquetes", callback_data="admin:content"),
    InlineKeyboardButton(text="ğŸ”” Intereses", callback_data="admin:interests")
)
keyboard.row(
    InlineKeyboardButton(text="ğŸ‘¥ Usuarios", callback_data="admin:users")
)
keyboard.row(
    InlineKeyboardButton(text="âš™ï¸ ConfiguraciÃ³n", callback_data="admin:config")
)
```

3. Placement: Grouped with management features (Content, Interests, Users)

DO NOT:
- Remove or modify other menu buttons
- Change button order significantly (keep logical grouping)
- Change button text or callback data format
  </action>
  <verify>
1. Users button exists in admin main menu keyboard
2. Button has ğŸ‘¥ emoji and "Usuarios" text
3. Callback data is "admin:users"
4. Positioned after Interests and before Config
5. Existing menu buttons unchanged
  </verify>
  <done>
Users button added to admin main menu, grouped with management features.
  </done>
</task>

</tasks>

<verification>
Overall phase verification:
1. bot/handlers/admin/users.py exists with users_router
2. 10+ callback handlers implemented (menu, list, page, search, search_results, user_view, user_role, user_role_confirm, filters, noop)
3. UserManagementStates FSM state group added with searching_user state
4. users_router included in admin_router
5. Admin can navigate: /admin â†’ Usuarios â†’ Ver Todos â†’ View Detail (tabs)
6. Admin can search users by username or ID
7. Admin can filter list by role (All, VIP, Free)
8. Pagination works with Next/Prev buttons (20 per page)
9. User detail view has 4 tabs: Overview, Subscription, Activity, Interests
10. Role change works with selection dialog and confirmation
11. Permission validation prevents self-actions
12. Permission validation prevents non-super-admin from modifying admins
13. Role changes logged to UserRoleChangeLog with changed_by
14. All handlers use AdminUserMessages
15. All handlers call callback.answer()
16. No session commits in handlers
17. "Message is not modified" errors handled gracefully
18. Users button in admin main menu
</verification>

<success_criteria>
1. Admin clicks "ğŸ‘¥ Usuarios" and sees user management menu with counts
2. Admin clicks "ğŸ‘¥ Ver Todos" and sees all users list (paginated, 20 per page)
3. Admin clicks "ğŸ’ Solo VIP" and sees only VIP users
4. Admin can navigate pages with Next/Prev buttons
5. Admin clicks "ğŸ” Buscar Usuario" and enters search query
6. Admin sees search results with view buttons
7. Admin clicks user and sees detail view with Overview tab
8. Admin can switch tabs (Subscription, Activity, Interests)
9. Admin clicks "ğŸ”„ Cambiar Rol" and sees role selection dialog
10. Admin selects new role and sees confirmation dialog
11. Admin confirms and sees success message
12. Admin trying to change own role sees error message
13. Non-super-admin trying to change admin role sees error message
14. All navigation works with back buttons
15. Role change appears in user's Activity tab
</success_criteria>

<output>
After completion, create `.planning/phases/09-user-management/09-03-SUMMARY.md`
</output>
