---
phase: 09-user-management
plan: 04
type: execute
wave: 4
depends_on: [09-01, 09-02, 09-03]
files_modified: [bot/handlers/admin/users.py, bot/handlers/admin/menu_callbacks.py]
autonomous: true

must_haves:
  truths:
    - "Admin puede expulsar usuario de canales con confirmaci√≥n"
    - "Expulsi√≥n usa bot.ban_chat_member para canales VIP y Free"
    - "Admin recibe mensaje de error si intenta expulsarse a s√≠ mismo"
    - "Admin recibe mensaje de error si no es super admin e intenta expulsar otro admin"
    - "Expulsi√≥n exitosa muestra canales de los que fue removido el usuario"
    - "Funciones de bloqueo/desbloqueo muestran mensaje de implementaci√≥n futura"
    - "Bot√≥n de bloqueo en perfil de usuario (placeholder para Phase 10+)"
  artifacts:
    - path: "bot/handlers/admin/users.py"
      provides: "Expel and placeholder block/unblock callback handlers with permission validation"
      min_lines: 150 (additional to plan 09-03)
      exports: ["callback_user_expel", "callback_user_expel_confirm", "callback_user_block"]
  key_links:
    - from: "callback_user_expel_confirm"
      to: "UserManagementService.expel_user_from_channels"
      via: "ServiceContainer.user_management"
      pattern: "await container\\.user_management\\.expel_user_from_channels"
    - from: "callback handlers"
      to: "AdminUserMessages"
      via: "ServiceContainer.message.admin.user"
      pattern: "container\\.message\\.admin\\.user\\.expel_"
---

<objective>
Add expel user from channels functionality with confirmation dialog, permission validation, and feedback showing which channels the user was removed from. Add placeholder handlers for block/unblock with future implementation message.

Purpose: Complete user management administrative actions with expel from channels functionality using bot.ban_chat_member API, following established handler patterns with proper permission boundaries and user feedback.
Output: Additional callback handlers in users.py for expel and block operations, integrated with existing user detail view.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-user-management/09-CONTEXT.md

@bot/handlers/admin/users.py (plan 09-03)
@bot/services/user_management.py (plan 09-01)
@bot/services/message/admin_user.py (plan 09-02)
@.planning/phases/09-user-management/09-03-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add expel and block handlers to users.py</name>
  <files>bot/handlers/admin/users.py</files>
  <action>
Update bot/handlers/admin/users.py to add expel and block handlers:

1. Add expel confirmation handler:
```python
@users_router.callback_query(F.data.startswith("admin:user:expel:"))
async def callback_user_expel(callback: CallbackQuery, session: AsyncSession):
    """
    Show expel confirmation dialog or execute expel action.

    Callback data format:
    - "admin:user:expel:{user_id}" - Show confirmation
    - "admin:user:expel:confirm:{user_id}" - Execute expel

    Args:
        callback: Callback query
        session: Sesi√≥n de BD
    """
    container = ServiceContainer(session, callback.bot)

    # Extract user_id from callback
    parts = callback.data.split(":")

    # Check if this is a confirm callback
    if len(parts) > 4 and parts[4] == "confirm":
        await callback_user_expel_confirm(callback, session)
        return

    user_id = int(parts[3]) if len(parts) > 3 else None

    if not user_id:
        await callback.answer("‚ùå ID de usuario inv√°lido", show_alert=True)
        return

    # Get user info
    user_info = await container.user_management.get_user_info(user_id=user_id)

    if not user_info:
        await callback.answer("‚ùå Usuario no encontrado", show_alert=True)
        return

    # Check permissions first
    can_modify, error_msg = await container.user_management._can_modify_user(
        target_user_id=user_id,
        admin_user_id=callback.from_user.id
    )

    if not can_modify:
        await callback.answer(f"‚ùå {error_msg}", show_alert=True)
        return

    # Show confirmation dialog
    text, keyboard = container.message.admin.user.expel_confirm(user_info)

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")

    await callback.answer()
```

2. Add expel action handler:
```python
@users_router.callback_query(F.data.startswith("admin:user:expel:confirm:"))
async def callback_user_expel_confirm(callback: CallbackQuery, session: AsyncSession):
    """
    Execute user expulsion from channels (confirmed).

    Callback data format: "admin:user:expel:confirm:{user_id}"

    Args:
        callback: Callback query
        session: Sesi√≥n de BD
    """
    container = ServiceContainer(session, callback.bot)

    # Extract user_id from callback
    parts = callback.data.split(":")
    user_id = int(parts[4]) if len(parts) > 4 else None

    if not user_id:
        await callback.answer("‚ùå ID de usuario inv√°lido", show_alert=True)
        return

    # Get user info before expulsion
    user_info = await container.user_management.get_user_info(user_id=user_id)

    if not user_info:
        await callback.answer("‚ùå Usuario no encontrado", show_alert=True)
        return

    admin_id = callback.from_user.id

    # Perform expulsion
    success, message = await container.user_management.expel_user_from_channels(
        user_id=user_id,
        expelled_by=admin_id
    )

    if not success:
        # Show error message
        await callback.answer(f"‚ùå {message}", show_alert=True)
        text, keyboard = container.message.admin.user.action_error(message)
        try:
            await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
        except Exception as e:
            logger.warning(f"Could not edit message: {e}")
        return

    # Parse expelled channels from message
    # Message format: "Usuario expulsado de canales: VIP, Free"
    expelled_from = []
    if "VIP" in message:
        expelled_from.append("VIP")
    if "Free" in message:
        expelled_from.append("Free")

    # Show success message
    text, keyboard = container.message.admin.user.expel_success(
        user_info=user_info,
        expelled_from=expelled_from
    )

    try:
        await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")

    await callback.answer("‚úÖ Usuario expulsado", show_alert=True)
    logger.info(f"‚úÖ Admin {admin_id} expelled user {user_id} from channels: {', '.join(expelled_from)}")
```

3. Add block handler (placeholder for future implementation):
```python
@users_router.callback_query(F.data.startswith("admin:user:block:"))
async def callback_user_block(callback: CallbackQuery, session: AsyncSession):
    """
    Handle block user action (placeholder for future implementation).

    Callback data format: "admin:user:block:{user_id}"

    Note: Full implementation requires adding User.is_blocked field to database.
    This handler shows a placeholder message explaining the feature is planned.

    Args:
        callback: Callback query
        session: Sesi√≥n de BD
    """
    container = ServiceContainer(session, callback.bot)

    # Extract user_id from callback
    parts = callback.data.split(":")
    user_id = int(parts[3]) if len(parts) > 3 else None

    if not user_id:
        await callback.answer("‚ùå ID de usuario inv√°lido", show_alert=True)
        return

    # Check permissions first
    can_modify, error_msg = await container.user_management._can_modify_user(
        target_user_id=user_id,
        admin_user_id=callback.from_user.id
    )

    if not can_modify:
        await callback.answer(f"‚ùå {error_msg}", show_alert=True)
        return

    # Show placeholder message
    placeholder_text = (
        f"üö´ <b>Bloquear Usuario</b>\n\n"
        f"<i>Esta funci√≥n estar√° disponible en una pr√≥xima versi√≥n.</i>\n\n"
        f"<b>Estado:</b> Planificado\n"
        f"<b>Requisito:</b> Migraci√≥n de base de datos para agregar campo de bloqueo\n\n"
        f"<i>El bloqueo impedir√° que el usuario use el bot, pero no lo expulsar√° de los canales. "
        f"Use la opci√≥n 'Expulsar' para remover al usuario de los canales.</i>"
    )

    from aiogram.utils.keyboard import InlineKeyboardBuilder, InlineKeyboardButton
    keyboard = InlineKeyboardBuilder()
    keyboard.row(
        InlineKeyboardButton(text="üîô Volver al Perfil", callback_data=f"admin:user:view:{user_id}:overview")
    )

    try:
        await callback.message.edit_text(text=placeholder_text, reply_markup=keyboard.as_markup(), parse_mode="HTML")
    except Exception as e:
        logger.warning(f"Could not edit message: {e}")

    await callback.answer("‚ö†Ô∏è Funci√≥n planificada para pr√≥xima versi√≥n", show_alert=True)
    logger.info(f"‚ÑπÔ∏è Admin {callback.from_user.id} attempted to block user {user_id} (feature not yet implemented)")
```

4. Update user_detail_overview keyboard in AdminUserMessages to include Block button:
   - Note: This should already be in plan 09-02, but verify it exists.

DO NOT:
- Implement full block/unblock without User.is_blocked field
- Call session.commit() (SessionContextManager handles it)
- Forget to validate permissions before showing confirmation
- Forget callback.answer() at end of handlers
  </action>
  <verify>
1. callback_user_expel handler exists
2. callback_user_expel_confirm handler exists
3. callback_user_block handler exists (placeholder)
4. Expel confirmation dialog shows user info and warning
5. Expel action calls UserManagementService.expel_user_from_channels
6. Expel success shows which channels user was removed from
7. Block handler shows placeholder message about future implementation
8. All handlers validate permissions via _can_modify_user
9. All handlers call callback.answer()
10. Error handling with try/except for message edits
11. Logging for expel actions
  </verify>
  <done>
Expel and block handlers added to users.py with permission validation, confirmation dialogs, and appropriate user feedback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update AdminUserMessages to include Block button in detail view</name>
  <files>bot/services/message/admin_user.py</files>
  <action>
Verify bot/services/message/admin_user.py has Block button in user detail keyboards:

1. Check user_detail_overview method - should have both action buttons:
```python
keyboard.row(
    InlineKeyboardButton(text="üîÑ Cambiar Rol", callback_data=f"admin:user:role:{user_id}"),
    InlineKeyboardButton(text="üö´ Bloquear", callback_data=f"admin:user:block:{user_id}")
)
keyboard.row(
    InlineKeyboardButton(text="üö´ Expulsar", callback_data=f"admin:user:expel:{user_id}")
)
```

2. Same for user_detail_subscription, user_detail_activity, user_detail_interests

3. If Block button is missing, add it to all tab methods.

DO NOT:
- Remove or modify other buttons
- Change callback data format
- Remove Expel button
  </action>
  <verify>
1. Block button exists in all user detail tab keyboards
2. Block button has üö´ emoji and "Bloquear" text
3. Callback data is "admin:user:block:{user_id}"
4. Expel button also exists in all keyboards
5. Both action buttons in same row or adjacent rows
  </verify>
  <done>
Block button verified/added to all user detail tab keyboards in AdminUserMessages.
  </done>
</task>

</tasks>

<verification>
Overall phase verification:
1. callback_user_expel handler exists in users.py
2. callback_user_expel_confirm handler exists in users.py
3. callback_user_block handler exists in users.py (placeholder)
4. Expel confirmation shows user info and explanation of action
5. Expel action calls UserManagementService.expel_user_from_channels
6. Expel success message shows which channels (VIP, Free) user was removed from
7. Block handler shows placeholder about future implementation
8. Permission validation prevents self-expel
9. Permission validation prevents non-super-admin from expelling admins
10. All handlers call callback.answer()
11. Error handling with try/except
12. Logging for expel actions
13. Block button appears in all user detail tab keyboards
14. Expel button appears in all user detail tab keyboards
15. Both action buttons accessible from user profile
</verification>

<success_criteria>
1. Admin clicks "üö´ Expulsar" in user profile and sees confirmation dialog
2. Confirmation dialog explains user will be removed from channels
3. Admin confirms and sees success message with channels listed
4. Admin trying to expel self sees error message
5. Non-super-admin trying to expel admin sees error message
6. Admin clicks "üö´ Bloquear" and sees placeholder message
7. Placeholder message explains feature is planned for future version
8. Placeholder message suggests using Expel as alternative
9. Expelled user is actually banned from VIP channel (if member)
10. Expelled user is actually banned from Free channel (if member)
11. Both buttons (Bloquear, Expulsar) visible in all user profile tabs
</success_criteria>

<output>
After completion, create `.planning/phases/09-user-management/09-04-SUMMARY.md`
</output>
