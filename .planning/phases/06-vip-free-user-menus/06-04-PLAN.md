---
phase: 06-vip-free-user-menus
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03"]
files_modified:
  - /data/data/com.termux/files/home/repos/c1/bot/utils/keyboards.py
  - /data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py
  - /data/data/com.termux/files/home/repos/c1/bot/handlers/vip/callbacks.py
  - /data/data/com.termux/files/home/repos/c1/bot/handlers/free/callbacks.py
autonomous: true

must_haves:
  truths:
    - "Unified navigation system replaces hardcoded keyboard creation"
    - "All menus have consistent 'Volver' and 'Salir' buttons following Lucien's terminology"
    - "Navigation callback patterns are standardized across VIP and Free menus"
    - "UserMenuProvider methods use navigation helpers for keyboard creation"
    - "Hardcoded keyboard creation removed from handlers"
    - "Button texts comply with VOICE-06 requirement (Lucien's Spanish terminology)"
  artifacts:
    - path: "/data/data/com.termux/files/home/repos/c1/bot/utils/keyboards.py"
      provides: "Enhanced keyboard factory with navigation helpers"
      min_lines: 50
      contains: "def create_menu_navigation"
    - path: "/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py"
      provides: "Updated UserMenuProvider using navigation helpers"
      contains: "create_menu_navigation"
  key_links:
    - from: "/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py"
      to: "/data/data/com.termux/files/home/repos/c1/bot/utils/keyboards.py"
      via: "navigation helper calls"
      pattern: "create_menu_navigation"
    - from: "/data/data/com.termux/files/home/repos/c1/bot/handlers/vip/callbacks.py"
      to: "/data/data/com.termux/files/home/repos/c1/bot/utils/keyboards.py"
      via: "standardized callback patterns"
      pattern: "menu:back|menu:exit"
---

<objective>
Implement unified menu navigation system with back buttons, replace hardcoded keyboard creation in handlers, and ensure consistent navigation patterns across all menus.

Purpose: Enable NAV-04 (handlers integrated with LucienVoiceService) and NAV-05 (system replaces hardcoded keyboards.py) requirements. Create consistent navigation experience with standardized back/exit buttons and callback patterns.

Output: Enhanced keyboard factory with navigation helpers, updated UserMenuProvider using navigation helpers, and standardized callback patterns across VIP and Free menus.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Reference existing keyboard patterns and navigation
@/data/data/com.termux/files/home/repos/c1/bot/utils/keyboards.py
@/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py
@/data/data/com.termux/files/home/repos/c1/bot/handlers/vip/callbacks.py
@/data/data/com.termux/files/home/repos/c1/bot/handlers/free/callbacks.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance keyboard factory with navigation helpers</name>
  <files>/data/data/com.termux/files/home/repos/c1/bot/utils/keyboards.py</files>
  <action>
Update `/data/data/com.termux/files/home/repos/c1/bot/utils/keyboards.py` to add navigation helper functions:

1. Add new imports at top if needed:
   ```python
   from typing import List, Optional
   from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
   from aiogram.utils.keyboard import InlineKeyboardBuilder
   ```

2. Add navigation helper functions after existing `create_inline_keyboard` function:
   ```python
   def create_menu_navigation(
       include_back: bool = True,
       include_exit: bool = True,
       back_text: str = "‚¨ÖÔ∏è Volver",
       exit_text: str = "‚ùå Salir",
       back_callback: str = "menu:back",
       exit_callback: str = "menu:exit"
   ) -> List[List[dict]]:
       """
       Crea filas de navegaci√≥n est√°ndar para men√∫s.

       Args:
           include_back: Incluir bot√≥n "Volver"
           include_exit: Incluir bot√≥n "Salir"
           back_text: Texto del bot√≥n "Volver"
           exit_text: Texto del bot√≥n "Salir"
           back_callback: Callback data para "Volver"
           exit_callback: Callback data para "Salir"

       Returns:
           Lista de filas de navegaci√≥n para usar con create_inline_keyboard

       Ejemplo:
           # Crear teclado con contenido + navegaci√≥n
           content_buttons = [[{"text": "Opci√≥n 1", "callback_data": "opt1"}]]
           nav_rows = create_menu_navigation()
           all_buttons = content_buttons + nav_rows
           keyboard = create_inline_keyboard(all_buttons)
       """
       navigation_rows = []

       if include_back and include_exit:
           # Ambos botones en misma fila
           navigation_rows.append([
               {"text": back_text, "callback_data": back_callback},
               {"text": exit_text, "callback_data": exit_callback}
           ])
       elif include_back:
           # Solo bot√≥n "Volver"
           navigation_rows.append([
               {"text": back_text, "callback_data": back_callback}
           ])
       elif include_exit:
           # Solo bot√≥n "Salir"
           navigation_rows.append([
               {"text": exit_text, "callback_data": exit_callback}
           ])

       return navigation_rows


   def create_content_with_navigation(
       content_buttons: List[List[dict]],
       include_back: bool = True,
       include_exit: bool = True,
       **nav_kwargs
   ) -> InlineKeyboardMarkup:
       """
       Crea teclado con botones de contenido + navegaci√≥n est√°ndar.

       Convenience wrapper que combina create_inline_keyboard y create_menu_navigation.

       Args:
           content_buttons: Botones de contenido (mismo formato que create_inline_keyboard)
           include_back: Incluir bot√≥n "Volver"
           include_exit: Incluir bot√≥n "Salir"
           **nav_kwargs: Argumentos adicionales para create_menu_navigation

       Returns:
           InlineKeyboardMarkup con contenido y navegaci√≥n

       Ejemplo:
           content = [[{"text": "Paquete 1", "callback_data": "pkg:1"}]]
           keyboard = create_content_with_navigation(content)
       """
       nav_rows = create_menu_navigation(
           include_back=include_back,
           include_exit=include_exit,
           **nav_kwargs
       )
       all_buttons = content_buttons + nav_rows
       return create_inline_keyboard(all_buttons)
   ```

3. Update docstring at top of file to mention new navigation helpers:
   ```python
   """
   Keyboard Factory - Generador de teclados inline.

   Funciones:
   - create_inline_keyboard: Crea teclado a partir de estructura de botones
   - create_menu_navigation: Crea filas de navegaci√≥n est√°ndar (Volver/Salir)
   - create_content_with_navigation: Combina contenido con navegaci√≥n

   Centraliza la creaci√≥n de keyboards para consistencia visual y navegaci√≥n.
   """
   ```

4. Test the new functions:
   Create test script `/tmp/test_navigation.py`:
   ```python
   import sys
   sys.path.insert(0, '/data/data/com.termux/files/home/repos/c1')

   from bot.utils.keyboards import create_menu_navigation, create_content_with_navigation

   # Test 1: create_menu_navigation
   nav = create_menu_navigation()
   print(f"‚úÖ create_menu_navigation() returns {len(nav)} row(s)")
   print(f"‚úÖ First row has {len(nav[0])} button(s)")

   # Test 2: create_content_with_navigation
   content = [[{"text": "Test", "callback_data": "test:1"}]]
   keyboard = create_content_with_navigation(content)
   print("‚úÖ create_content_with_navigation creates keyboard")

   # Test 3: Custom text
   nav_custom = create_menu_navigation(back_text="Custom Back", exit_text="Custom Exit")
   print("‚úÖ Custom text works")

   print("\nüéâ Navigation helpers test passed")
   ```

5. Run test:
   ```bash
   cd /data/data/com.termux/files/home/repos/c1
   python /tmp/test_navigation.py
   ```

6. Clean up:
   ```bash
   rm /tmp/test_navigation.py
   ```
  </action>
  <verify>
1. `create_menu_navigation` function added to keyboards.py
2. `create_content_with_navigation` convenience wrapper added
3. Functions return correct structures for use with `create_inline_keyboard`
4. Test script runs successfully
5. Documentation updated to mention navigation helpers
  </verify>
  <done>Keyboard factory enhanced with navigation helper functions.</done>
</task>

<task type="auto">
  <name>Task 2: Update UserMenuProvider to use navigation helpers</name>
  <files>/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py</files>
  <action>
Update the `UserMenuMessages` class in `/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py` to use the new navigation helpers:

1. Update imports at top of file:
   ```python
   from aiogram.types import InlineKeyboardMarkup
   from bot.utils.keyboards import create_inline_keyboard, create_menu_navigation, create_content_with_navigation
   ```

2. Update each method to use navigation helpers:

   For `vip_menu_greeting` method:
   ```python
   def vip_menu_greeting(self, ...):
       # ... existing message generation code ...

       # Create content buttons
       content_buttons = [
           [{"text": "‚≠ê Contenido VIP", "callback_data": "vip:content_vip"}],
           [{"text": "üíé VIP Premium", "callback_data": "vip:premium"}],
           [{"text": "üìö Biblioteca", "callback_data": "vip:library"}],
           [{"text": "üìÖ Mi Suscripci√≥n", "callback_data": "vip:subscription"}],
           [{"text": "üîÑ Extender VIP", "callback_data": "vip:extend"}],
           [{"text": "üë• Invitar Amigos", "callback_data": "vip:invite"}],
       ]

       # Create keyboard with navigation
       keyboard = create_content_with_navigation(content_buttons)

       return text, keyboard
   ```

   For `free_menu_greeting` method:
   ```python
   def free_menu_greeting(self, ...):
       # ... existing message generation code ...

       # Create content buttons
       content_buttons = [
           [{"text": "üÜì Mi Contenido", "callback_data": "free:content"}],
           [{"text": "üìö Tutoriales", "callback_data": "free:tutorials"}],
           [{"text": "üéÅ Muestras VIP", "callback_data": "free:vip_samples"}],
           [{"text": "‚≠ê Convertirse en VIP", "callback_data": "free:become_vip"}],
           [{"text": "üíé Ver Beneficios VIP", "callback_data": "free:vip_info"}],
           [{"text": "üîë Canjear Token", "callback_data": "free:redeem_token"}],
           [{"text": "üìã Solicitar Acceso Free", "callback_data": "free:request_access"}],
           [{"text": "‚è≥ Estado de Cola", "callback_data": "free:queue_status"}],
           [{"text": "üå∏ Redes Sociales", "callback_data": "free:social"}],
           [{"text": "‚ùì Ayuda", "callback_data": "free:help"}],
       ]

       # Create keyboard with navigation
       keyboard = create_content_with_navigation(content_buttons)

       return text, keyboard
   ```

   For `vip_premium_section` method:
   ```python
   def vip_premium_section(self, ...):
       # ... existing message generation code ...

       # Create placeholder content buttons (will be populated with actual packages)
       content_buttons = [
           [{"text": "üì¶ Paquete Premium 1", "callback_data": "interest:package:1"}],
           [{"text": "üì¶ Paquete Premium 2", "callback_data": "interest:package:2"}],
           # Note: In actual implementation, these would be generated dynamically
           # based on packages from ContentService
       ]

       # Create keyboard with navigation (only back button, no exit in submenu)
       keyboard = create_content_with_navigation(
           content_buttons,
           include_exit=False  # Submenus only have back button
       )

       return text, keyboard
   ```

   For `free_content_section` method:
   ```python
   def free_content_section(self, ...):
       # ... existing message generation code ...

       # Create placeholder content buttons
       content_buttons = [
           [{"text": "üì¶ Contenido Gratuito 1", "callback_data": "interest:package:101"}],
           [{"text": "üì¶ Contenido Gratuito 2", "callback_data": "interest:package:102"}],
           # Note: Will be generated dynamically from FREE_CONTENT packages
       ]

       # Create keyboard with navigation (only back button)
       keyboard = create_content_with_navigation(
           content_buttons,
           include_exit=False
       )

       return text, keyboard
   ```

3. Update docstrings to mention navigation helper usage:
   Add note in class docstring: "Uses create_content_with_navigation for consistent navigation buttons."

4. Test the updated UserMenuProvider:
   Create test script `/tmp/test_usermenu_nav.py`:
   ```python
   import sys
   sys.path.insert(0, '/data/data/com.termux/files/home/repos/c1')

   from bot.services.message import LucienVoiceService

   service = LucienVoiceService()
   menu = service.user.menu

   # Test VIP menu has navigation
   text, kb = menu.vip_menu_greeting("Test User", None)
   print(f"‚úÖ VIP menu text length: {len(text)}")
   print(f"‚úÖ VIP menu keyboard type: {type(kb)}")

   # Test Free menu has navigation
   text, kb = menu.free_menu_greeting("Test User", None)
   print(f"‚úÖ Free menu text length: {len(text)}")
   print(f"‚úÖ Free menu keyboard type: {type(kb)}")

   # Test premium section has back button only
   text, kb = menu.vip_premium_section("Test User", 3)
   print(f"‚úÖ Premium section has back button only")

   print("\nüéâ UserMenuProvider navigation test passed")
   ```

5. Run test:
   ```bash
   cd /data/data/com.termux/files/home/repos/c1
   python /tmp/test_usermenu_nav.py
   ```

6. Clean up:
   ```bash
   rm /tmp/test_usermenu_nav.py
   ```
  </action>
  <verify>
1. UserMenuProvider imports navigation helper functions
2. All methods use `create_content_with_navigation` for keyboard creation
3. Main menus have both back and exit buttons
4. Submenus (premium/content sections) have back button only
5. Test script runs successfully
6. Keyboard structures are consistent across all methods
  </verify>
  <done>UserMenuProvider updated to use navigation helpers for consistent keyboard creation.</done>
</task>

<task type="auto">
  <name>Task 3: Verify and standardize callback patterns with Lucien terminology</name>
  <files>
    /data/data/com.termux/files/home/repos/c1/bot/handlers/vip/callbacks.py
    /data/data/com.termux/files/home/repos/c1/bot/handlers/free/callbacks.py
    /data/data/com.termux/files/home/repos/c1/bot/utils/keyboards.py
  </files>
  <action>
Verify that VIP and Free callback handlers use standardized navigation patterns with Lucien's terminology and update if needed:

1. Check VIP callbacks already have correct patterns (from Plan 02):
   - `menu:back` - handled by `handle_menu_back`
   - `menu:exit` - handled by `handle_menu_exit`
   Verify these handlers exist and work correctly.

2. Check Free callbacks already have correct patterns (from Plan 03):
   - `menu:back` - handled by `handle_menu_back`
   - `menu:exit` - handled by `handle_menu_exit`
   Verify these handlers exist and work correctly.

3. Verify Lucien terminology compliance (VOICE-06 requirement):
   - Check that button texts in `create_menu_navigation` function use Lucien's terminology
   - Default texts should be "‚¨ÖÔ∏è Volver" and "‚ùå Salir" (Spanish, formal)
   - Verify no hardcoded English button texts remain
   - Check that all navigation button texts follow the style guide

4. Create integration test to verify navigation works end-to-end with terminology check:
   ```python
   # /tmp/test_nav_integration.py
   import sys
   sys.path.insert(0, '/data/data/com.termux/files/home/repos/c1')

   from bot.handlers.vip.callbacks import vip_callbacks_router
   from bot.handlers.free.callbacks import free_callbacks_router
   from bot.utils.keyboards import create_menu_navigation

   # Check VIP router has navigation handlers
   vip_handlers = [h.callback.__name__ for h in vip_callbacks_router.handlers]
   assert 'handle_menu_back' in vip_handlers, "VIP missing handle_menu_back"
   assert 'handle_menu_exit' in vip_handlers, "VIP missing handle_menu_exit"
   print("‚úÖ VIP navigation handlers present")

   # Check Free router has navigation handlers
   free_handlers = [h.callback.__name__ for h in free_callbacks_router.handlers]
   assert 'handle_menu_back' in free_handlers, "Free missing handle_menu_back"
   assert 'handle_menu_exit' in free_handlers, "Free missing handle_menu_exit"
   print("‚úÖ Free navigation handlers present")

   # Check callback data patterns
   print("‚úÖ Navigation callback patterns standardized:")
   print("  - 'menu:back' returns to main menu")
   print("  - 'menu:exit' closes menu")

   # Verify Lucien terminology in navigation buttons
   nav_rows = create_menu_navigation()
   back_button_text = nav_rows[0][0]["text"]
   exit_button_text = nav_rows[0][1]["text"]

   # Check Spanish terminology (Lucien's voice uses formal Spanish)
   assert "Volver" in back_button_text, f"Back button should contain 'Volver', got: {back_button_text}"
   assert "Salir" in exit_button_text, f"Exit button should contain 'Salir', got: {exit_button_text}"
   print("‚úÖ Navigation buttons use Lucien's Spanish terminology")

   # Check no English hardcoded texts
   english_terms = ["Back", "Exit", "Close", "Return"]
   for term in english_terms:
       assert term not in back_button_text, f"Back button contains English term: {term}"
       assert term not in exit_button_text, f"Exit button contains English term: {term}"
   print("‚úÖ No English hardcoded button texts")

   print("\nüéâ Navigation integration test passed with Lucien terminology verification")
   ```

5. Run test:
   ```bash
   cd /data/data/com.termux/files/home/repos/c1
   python /tmp/test_nav_integration.py
   ```

6. If any issues found, fix them:
   - Ensure handlers import correct menu functions
   - Verify error handling is consistent
   - Check that callback filters match exactly "menu:back" and "menu:exit"
   - Update button texts in `create_menu_navigation` to use Lucien's terminology if needed

7. Clean up:
   ```bash
   rm /tmp/test_nav_integration.py
   ```

8. Final verification - check that hardcoded keyboard creation is removed:
   Search for any remaining hardcoded keyboard creation in handlers:
   ```bash
   cd /data/data/com.termux/files/home/repos/c1
   grep -r "InlineKeyboardBuilder" bot/handlers/vip/ bot/handlers/free/ | grep -v "__pycache__"
   grep -r "create_inline_keyboard" bot/handlers/vip/ bot/handlers/free/ | grep -v "__pycache__"
   ```
   Should only find references in callback handlers for specific cases (like social media), not in main menu handlers.
  </action>
  <verify>
1. VIP and Free callback routers have standardized navigation handlers
2. `menu:back` and `menu:exit` callback patterns are consistent
3. Navigation button texts use Lucien's Spanish terminology ("Volver", "Salir")
4. No English hardcoded button texts remain
5. Integration test passes with terminology verification
6. Hardcoded keyboard creation removed from main menu handlers
7. Navigation works correctly in both VIP and Free menus with Lucien's voice compliance
  </verify>
  <done>Navigation callback patterns verified and standardized across VIP and Free menus with Lucien terminology compliance.</done>
</task>

</tasks>

<verification>
Overall verification for Plan 04:
1. Run all test scripts - all tests must pass
2. Verify navigation helpers work correctly in keyboards.py
3. Check UserMenuProvider uses navigation helpers for all keyboard creation
4. Confirm VIP and Free menus have consistent navigation buttons
5. Ensure submenus have back button only (no exit button)
6. Validate that hardcoded keyboard creation is removed from handlers
7. Test end-to-end navigation flow works
</verification>

<success_criteria>
1. ‚úÖ Keyboard factory enhanced with `create_menu_navigation` and `create_content_with_navigation`
2. ‚úÖ UserMenuProvider updated to use navigation helpers for all keyboard creation
3. ‚úÖ Main menus have both back and exit buttons
4. ‚úÖ Submenus have back button only
5. ‚úÖ Navigation callback patterns standardized across VIP and Free menus
6. ‚úÖ Hardcoded keyboard creation removed from main menu handlers
7. ‚úÖ All integration tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-vip-free-user-menus/06-04-SUMMARY.md`
</output>
