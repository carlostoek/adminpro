---
phase: 06-vip-free-user-menus
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py
  - /data/data/com.termux/files/home/repos/c1/bot/services/message/__init__.py
  - /data/data/com.termux/files/home/repos/c1/bot/services/content.py
autonomous: true

must_haves:
  truths:
    - "UserMenuProvider exists with VIP menu messages following Lucien's voice"
    - "UserMenuProvider exists with Free menu messages following Lucien's voice"
    - "UserMenuProvider is integrated into LucienVoiceService structure"
    - "VIP menu messages include subscription information placeholders"
    - "Free menu messages include content browsing placeholders"
    - "ContentService exists and has required methods for Phase 6"
    - "RoleDetectionMiddleware is registered in main.py for automatic role detection"
    - "MenuRouter exists for role-based menu routing"
    - "UserMenuProvider has helper method to convert ContentPackage objects to dynamic keyboard buttons"
  artifacts:
    - path: "/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py"
      provides: "UserMenuProvider class with VIP and Free menu messages"
      min_lines: 150
      contains: "class UserMenuMessages(BaseMessageProvider)"
    - path: "/data/data/com.termux/files/home/repos/c1/bot/services/message/__init__.py"
      provides: "Integration of UserMenuProvider into LucienVoiceService"
      contains: "UserMenuMessages"
    - path: "/data/data/com.termux/files/home/repos/c1/bot/services/content.py"
      provides: "ContentService with get_active_packages method"
      contains: "async def get_active_packages"
  key_links:
    - from: "/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py"
      to: "/data/data/com.termux/files/home/repos/c1/bot/services/message/base.py"
      via: "inheritance from BaseMessageProvider"
      pattern: "class UserMenuMessages\\(BaseMessageProvider\\)"
    - from: "/data/data/com.termux/files/home/repos/c1/bot/services/message/__init__.py"
      to: "/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py"
      via: "import and export"
      pattern: "from \\.user_menu import UserMenuMessages"
    - from: "/data/data/com.termux/files/home/repos/c1/bot/handlers/vip/callbacks.py"
      to: "/data/data/com.termux/files/home/repos/c1/bot/services/content.py"
      via: "ContentService calls for VIP_PREMIUM packages"
      pattern: "container\\.content\\.get_active_packages.*ContentCategory\\.VIP_PREMIUM"
    - from: "/data/data/com.termux/files/home/repos/c1/main.py"
      to: "/data/data/com.termux/files/home/repos/c1/bot/middlewares/role_detection.py"
      via: "RoleDetectionMiddleware registration"
      pattern: "dispatcher\\.update\\.middleware\\(RoleDetectionMiddleware\\(\\)\\)"
    - from: "/data/data/com.termux/files/home/repos/c1/bot/handlers/menu_router.py"
      to: "/data/data/com.termux/files/home/repos/c1/bot/services/role_detection.py"
      via: "RoleDetectionService calls for user role"
      pattern: "container\\.role_detection\\.get_user_role"
---

<objective>
Create UserMenuProvider with VIP and Free menu messages in Lucien's voice.

Purpose: Provide consistent Lucien-voiced messages for VIP and Free user menus, replacing hardcoded text in handlers with voice-compliant templates. This enables VOICE-01 and VOICE-02 requirements.

Output: UserMenuMessages class integrated into LucienVoiceService with methods for VIP menu greeting, Free menu greeting, and content package display messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Reference existing message provider patterns
@/data/data/com.termux/files/home/repos/c1/bot/services/message/admin_main.py
@/data/data/com.termux/files/home/repos/c1/bot/services/message/user_start.py
@/data/data/com.termux/files/home/repos/c1/bot/services/message/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 0: Verify Phase 5 ContentService dependency</name>
  <files>/data/data/com.termux/files/home/repos/c1/bot/services/content.py</files>
  <action>
Verify that Phase 5 dependencies exist and are properly integrated for Phase 6:

1. **ContentService verification:**
   - Check that ContentService file exists at `/data/data/com.termux/files/home/repos/c1/bot/services/content.py`
   - Verify ContentService has `get_active_packages` method with signature:
     ```python
     async def get_active_packages(
         self,
         category: ContentCategory,
         limit: int = 20,
         offset: int = 0
     ) -> List[ContentPackage]
     ```
   - Check that ContentCategory enum exists with required values:
     - `VIP_PREMIUM` (for VIP premium section)
     - `FREE_CONTENT` (for Free content section)

2. **RoleDetectionMiddleware registration verification:**
   - Check that RoleDetectionMiddleware is registered in `/data/data/com.termux/files/home/repos/c1/main.py`
   - Verify lines 92-96 in main.py import and register RoleDetectionMiddleware:
     ```python
     from bot.middlewares import DatabaseMiddleware, AdminAuthMiddleware, RoleDetectionMiddleware
     dispatcher.update.middleware(DatabaseMiddleware())
     dispatcher.message.middleware(AdminAuthMiddleware())
     dispatcher.update.middleware(RoleDetectionMiddleware())
     dispatcher.callback_query.middleware(RoleDetectionMiddleware())
     ```

3. **MenuRouter integration verification:**
   - Check that MenuRouter exists at `/data/data/com.termux/files/home/repos/c1/bot/handlers/menu_router.py`
   - Verify MenuRouter has `_route_to_menu()` method that uses `data["user_role"]`
   - Check that MenuRouter is imported and used in main application routing

4. Create a comprehensive verification script `/tmp/verify_phase5_deps.py`:
   ```python
   import sys
   sys.path.insert(0, '/data/data/com.termux/files/home/repos/c1')

   print("üîç Phase 5 Dependency Verification for Phase 6")
   print("=" * 50)

   # 1. ContentService verification
   try:
       from bot.services.content import ContentService
       print("‚úÖ 1. ContentService import successful")

       import inspect
       sig = inspect.signature(ContentService.get_active_packages)
       params = list(sig.parameters.keys())
       assert 'category' in params, "get_active_packages missing 'category' parameter"
       assert 'limit' in params, "get_active_packages missing 'limit' parameter"
       print("‚úÖ 2. get_active_packages has correct parameters")

       from bot.database.enums import ContentCategory
       assert hasattr(ContentCategory, 'VIP_PREMIUM'), "Missing VIP_PREMIUM enum"
       assert hasattr(ContentCategory, 'FREE_CONTENT'), "Missing FREE_CONTENT enum"
       print("‚úÖ 3. ContentCategory enum has required values")
   except Exception as e:
       print(f"‚ùå ContentService verification failed: {e}")
       sys.exit(1)

   # 2. RoleDetectionMiddleware registration verification
   try:
       with open('/data/data/com.termux/files/home/repos/c1/main.py', 'r') as f:
           main_content = f.read()

       # Check imports
       assert 'from bot.middlewares import' in main_content, "Middleware imports not found"
       assert 'RoleDetectionMiddleware' in main_content, "RoleDetectionMiddleware import not found"

       # Check registration
       assert 'dispatcher.update.middleware(RoleDetectionMiddleware())' in main_content, \
           "RoleDetectionMiddleware not registered on dispatcher.update"
       assert 'dispatcher.callback_query.middleware(RoleDetectionMiddleware())' in main_content, \
           "RoleDetectionMiddleware not registered on dispatcher.callback_query"
       print("‚úÖ 4. RoleDetectionMiddleware registered in main.py")
   except Exception as e:
       print(f"‚ùå RoleDetectionMiddleware verification failed: {e}")
       sys.exit(1)

   # 3. MenuRouter integration verification
   try:
       from bot.handlers.menu_router import MenuRouter
       print("‚úÖ 5. MenuRouter import successful")

       # Check _route_to_menu method exists
       assert hasattr(MenuRouter, '_route_to_menu'), "MenuRouter missing _route_to_menu method"
       print("‚úÖ 6. MenuRouter has _route_to_menu method")

       # Check main.py includes MenuRouter in routing
       with open('/data/data/com.termux/files/home/repos/c1/main.py', 'r') as f:
           main_content = f.read()

       # Look for MenuRouter usage (could be via register_all_handlers)
       if 'MenuRouter' in main_content or 'menu_router' in main_content:
           print("‚úÖ 7. MenuRouter referenced in main.py")
       else:
           print("‚ö†Ô∏è  MenuRouter not directly referenced in main.py (may be via register_all_handlers)")
   except Exception as e:
       print(f"‚ùå MenuRouter verification failed: {e}")
       sys.exit(1)

   print("\n" + "=" * 50)
   print("üéâ Phase 5 dependencies verified and ready for Phase 6!")
   ```
5. Run verification script:
   ```bash
   cd /data/data/com.termux/files/home/repos/c1
   python /tmp/verify_phase5_deps.py
   ```
6. Clean up:
   ```bash
   rm /tmp/verify_phase5_deps.py
   ```
  </action>
  <verify>
1. ContentService file exists with `get_active_packages` method
2. ContentCategory enum has VIP_PREMIUM and FREE_CONTENT values
3. RoleDetectionMiddleware is registered in main.py (lines 92-96)
4. MenuRouter exists with `_route_to_menu` method
5. Comprehensive verification script runs without errors
  </verify>
  <done>Phase 5 ContentService dependency verified and ready for Phase 6 usage.</done>
</task>

<task type="auto">
  <name>Task 1: Create UserMenuMessages provider class</name>
  <files>/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py</files>
  <action>
Create a new file `bot/services/message/user_menu.py` with UserMenuMessages class inheriting from BaseMessageProvider.

Follow the existing pattern from AdminMainMessages and UserStartMessages:
- Class inherits from BaseMessageProvider
- Stateless design: no session or bot stored as instance variables
- All methods return (text, keyboard) tuples for complete UI
- Use Lucien's voice from docs/guia-estilo.md
- Include docstrings with voice rationale for each method

Required methods:
1. `vip_menu_greeting()` - Main VIP menu greeting with subscription info placeholders
   - Parameters: user_name, vip_expires_at (Optional[datetime]), user_id (Optional[int]), session_history (Optional[SessionMessageHistory])
   - Returns: (text, keyboard) for VIP main menu
   - Voice: VIP users are "miembros del c√≠rculo exclusivo" (exclusive circle members)
   - Include placeholders for subscription expiration: "Su membres√≠a expira el [fecha]" or "Su membres√≠a es permanente"
   - Weighted variations: 60% common, 30% alternate, 10% poetic

2. `free_menu_greeting()` - Main Free menu greeting with content browsing
   - Parameters: user_name, free_queue_position (Optional[int]), user_id (Optional[int]), session_history (Optional[SessionMessageHistory])
   - Returns: (text, keyboard) for Free main menu
   - Voice: Free users are "visitantes del jard√≠n p√∫blico" (public garden visitors)
   - Include placeholders for queue status if applicable
   - Weighted variations: 70% welcoming, 30% informative

3. `vip_premium_section()` - VIP premium content section
   - Parameters: user_name, packages (List[ContentPackage]), user_id (Optional[int]), session_history (Optional[SessionMessageHistory])
   - Returns: (text, keyboard) for VIP premium content listing
   - Voice: Premium content is "tesoros del sanctum" (sanctum treasures)
   - Include package count in message: "[count] tesoros disponibles"
   - Use `_create_package_buttons()` to generate dynamic "Me interesa" buttons from packages list

4. `free_content_section()` - Free content browsing section
   - Parameters: user_name, packages (List[ContentPackage]), user_id (Optional[int]), session_history (Optional[SessionMessageHistory])
   - Returns: (text, keyboard) for Free content listing
   - Voice: Free content is "muestras del jard√≠n" (garden samples)
   - Include package count in message: "[count] muestras disponibles"
   - Use `_create_package_buttons()` to generate dynamic "Me interesa" buttons from packages list

Keyboard structure for each method:
- Use `create_inline_keyboard` from `bot.utils.keyboards`
- Include navigation buttons: "Volver" (callback_data: "menu:back"), "Salir" (callback_data: "menu:exit")
- For content sections: use `_create_package_buttons()` helper to generate dynamic "Me interesa" buttons from ContentPackage objects

Add helper method to UserMenuMessages class:
```python
def _create_package_buttons(self, packages: List[ContentPackage]) -> List[List[dict]]:
    """
    Convierte lista de ContentPackage a filas de botones "Me interesa".

    Args:
        packages: Lista de ContentPackage objects

    Returns:
        Lista de filas de botones para create_inline_keyboard
    """
    if not packages:
        return []

    buttons = []
    for package in packages:
        # Truncate title if too long for button text
        title = package.title
        if len(title) > 30:
            title = title[:27] + "..."

        button_row = [{
            "text": f"‚≠ê {title} - Me interesa",
            "callback_data": f"interest:package:{package.id}"
        }]
        buttons.append(button_row)

    return buttons
```

Implementation notes:
- Use `self._compose()` for message composition
- Use `self._choose_variant()` for weighted variations
- Follow existing import patterns: `from aiogram.types import InlineKeyboardMarkup`, `from bot.utils.keyboards import create_inline_keyboard`
- Add import for ContentPackage: `from bot.database.models import ContentPackage`
- Include proper type hints and docstrings
  </action>
  <verify>
1. File exists at `/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py`
2. Class `UserMenuMessages` inherits from `BaseMessageProvider`
3. All 4 required methods exist with correct signatures
4. Methods return tuples (text, InlineKeyboardMarkup)
5. Voice patterns match Lucien's style (uses "usted", refined language)
6. Keyboard creation uses `create_inline_keyboard`
7. Weighted variations implemented with `self._choose_variant()`
8. Helper method `_create_package_buttons()` exists to convert ContentPackage list to keyboard buttons
  </verify>
  <done>UserMenuMessages class created with all 4 methods following Lucien voice patterns and returning complete (text, keyboard) tuples.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate UserMenuMessages into LucienVoiceService</name>
  <files>/data/data/com.termux/files/home/repos/c1/bot/services/message/__init__.py</files>
  <action>
Update `bot/services/message/__init__.py` to integrate UserMenuMessages into the existing structure:

1. Import UserMenuMessages at top of file:
   ```python
   from .user_menu import UserMenuMessages
   ```

2. Update `UserMessages` class to include `menu` property:
   - Add `_menu` instance variable in `__init__`
   - Create `@property menu` method that lazy-loads UserMenuMessages
   - Update docstring to mention new menu provider

3. Update `LucienVoiceService` class documentation:
   - Update architecture diagram in docstring to include user.menu
   - Update examples to show usage of `container.message.user.menu.vip_menu_greeting()`

4. Update `__all__` export list to include `UserMenuMessages`

Follow the existing pattern from `UserStartMessages` and `UserFlowMessages` integration:
- Lazy loading pattern with `@property`
- Namespace organization under `user.menu`
- Update type hints and documentation

Example integration:
```python
class UserMessages:
    def __init__(self):
        self._start = None
        self._flows = None
        self._menu = None  # NEW

    @property
    def menu(self):
        if self._menu is None:
            from .user_menu import UserMenuMessages
            self._menu = UserMenuMessages()
        return self._menu
```

Update LucienVoiceService docstring architecture diagram:
```
LucienVoiceService (this class)
    ‚îú‚îÄ common: CommonMessages ‚úÖ
    ‚îú‚îÄ admin: AdminMessages ‚úÖ
    ‚îî‚îÄ user: UserMessages ‚úÖ
        ‚îú‚îÄ start: UserStartMessages ‚úÖ
        ‚îú‚îÄ flows: UserFlowMessages ‚úÖ
        ‚îî‚îÄ menu: UserMenuMessages ‚úÖ NEW
```

Add usage example in LucienVoiceService docstring:
```python
# User menu messages
text, kb = container.message.user.menu.vip_menu_greeting(
    user_name="Juan",
    vip_expires_at=expiry_date,
    user_id=user.id,
    session_history=session_ctx
)
```
  </action>
  <verify>
1. `UserMenuMessages` imported in `__init__.py`
2. `UserMessages` class has `_menu` instance variable and `@property menu` method
3. `LucienVoiceService` docstring updated with new architecture
4. `__all__` list includes `UserMenuMessages`
5. Type hints and documentation updated
6. Can access `container.message.user.menu.vip_menu_greeting()` in Python interpreter
  </verify>
  <done>UserMenuMessages fully integrated into LucienVoiceService and accessible via `container.message.user.menu`.</done>
</task>

<task type="auto">
  <name>Task 3: Test UserMenuMessages integration</name>
  <files>/data/data/com.termux/files/home/repos/c1/bot/services/message/__init__.py</files>
  <action>
Create a simple test script to verify UserMenuMessages integration works correctly:

1. Create a test file `/tmp/test_usermenu.py` with:
   ```python
   import sys
   sys.path.insert(0, '/data/data/com.termux/files/home/repos/c1')

   from bot.services.message import LucienVoiceService, UserMenuMessages

   # Test 1: Import works
   print("‚úÖ Test 1: UserMenuMessages import successful")

   # Test 2: LucienVoiceService has user.menu property
   service = LucienVoiceService()
   assert hasattr(service.user, 'menu'), "service.user should have 'menu' property"
   print("‚úÖ Test 2: LucienVoiceService.user.menu property exists")

   # Test 3: UserMenuMessages methods exist
   menu_provider = service.user.menu
   assert hasattr(menu_provider, 'vip_menu_greeting'), "Missing vip_menu_greeting method"
   assert hasattr(menu_provider, 'free_menu_greeting'), "Missing free_menu_greeting method"
   assert hasattr(menu_provider, 'vip_premium_section'), "Missing vip_premium_section method"
   assert hasattr(menu_provider, 'free_content_section'), "Missing free_content_section method"
   print("‚úÖ Test 3: All required methods exist")

   # Test 4: Methods return correct types (text, keyboard)
   text, kb = menu_provider.vip_menu_greeting("Test User", None)
   assert isinstance(text, str), "vip_menu_greeting should return string"
   assert 'üé©' in text, "Message should contain Lucien's emoji"
   print("‚úÖ Test 4: vip_menu_greeting returns correct types")

   print("\nüéâ All tests passed! UserMenuMessages integration successful.")
   ```

2. Run the test script to verify integration:
   ```bash
   cd /data/data/com.termux/files/home/repos/c1
   python /tmp/test_usermenu.py
   ```

3. If tests fail, debug and fix issues:
   - Check import paths
   - Verify property implementation
   - Ensure methods have correct signatures

4. Clean up test file after verification:
   ```bash
   rm /tmp/test_usermenu.py
   ```
  </action>
  <verify>
1. Test script created and runs without errors
2. All 4 assertions pass
3. UserMenuMessages methods return (text, keyboard) tuples
4. Messages contain Lucien's voice markers (üé© emoji, refined language)
5. Integration accessible via `container.message.user.menu`
  </verify>
  <done>UserMenuMessages integration tested and working correctly with LucienVoiceService.</done>
</task>

</tasks>

<verification>
Overall verification for Plan 01:
1. Run the test script from Task 3 - all tests must pass
2. Check that `UserMenuMessages` class exists with all 4 methods
3. Verify integration in `LucienVoiceService` via `container.message.user.menu`
4. Ensure voice consistency: all messages use Lucien's style (usted, refined language, üé© emoji)
5. Confirm keyboard creation uses `create_inline_keyboard` with proper callback_data patterns
</verification>

<success_criteria>
1. ‚úÖ UserMenuMessages class created at `/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py` (150+ lines)
2. ‚úÖ UserMenuMessages integrated into LucienVoiceService via `container.message.user.menu`
3. ‚úÖ All 4 methods implemented: vip_menu_greeting, free_menu_greeting, vip_premium_section, free_content_section
4. ‚úÖ Methods return (text, InlineKeyboardMarkup) tuples following existing patterns
5. ‚úÖ Voice consistency: uses Lucien's style with weighted variations
6. ‚úÖ Test script passes all assertions
</success_criteria>

<output>
After completion, create `.planning/phases/06-vip-free-user-menus/06-01-SUMMARY.md`
</output>
