---
phase: 06-vip-free-user-menus
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py
  - /data/data/com.termux/files/home/repos/c1/bot/services/message/__init__.py
  - /data/data/com.termux/files/home/repos/c1/bot/services/message/__init__.py
autonomous: true

must_haves:
  truths:
    - "UserMenuProvider exists with VIP menu messages following Lucien's voice"
    - "UserMenuProvider exists with Free menu messages following Lucien's voice"
    - "UserMenuProvider is integrated into LucienVoiceService structure"
    - "VIP menu messages include subscription information placeholders"
    - "Free menu messages include content browsing placeholders"
  artifacts:
    - path: "/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py"
      provides: "UserMenuProvider class with VIP and Free menu messages"
      min_lines: 150
      contains: "class UserMenuMessages(BaseMessageProvider)"
    - path: "/data/data/com.termux/files/home/repos/c1/bot/services/message/__init__.py"
      provides: "Integration of UserMenuProvider into LucienVoiceService"
      contains: "UserMenuMessages"
  key_links:
    - from: "/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py"
      to: "/data/data/com.termux/files/home/repos/c1/bot/services/message/base.py"
      via: "inheritance from BaseMessageProvider"
      pattern: "class UserMenuMessages\\(BaseMessageProvider\\)"
    - from: "/data/data/com.termux/files/home/repos/c1/bot/services/message/__init__.py"
      to: "/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py"
      via: "import and export"
      pattern: "from \\.user_menu import UserMenuMessages"
---

<objective>
Create UserMenuProvider with VIP and Free menu messages in Lucien's voice.

Purpose: Provide consistent Lucien-voiced messages for VIP and Free user menus, replacing hardcoded text in handlers with voice-compliant templates. This enables VOICE-01 and VOICE-02 requirements.

Output: UserMenuMessages class integrated into LucienVoiceService with methods for VIP menu greeting, Free menu greeting, and content package display messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Reference existing message provider patterns
@/data/data/com.termux/files/home/repos/c1/bot/services/message/admin_main.py
@/data/data/com.termux/files/home/repos/c1/bot/services/message/user_start.py
@/data/data/com.termux/files/home/repos/c1/bot/services/message/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UserMenuMessages provider class</name>
  <files>/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py</files>
  <action>
Create a new file `bot/services/message/user_menu.py` with UserMenuMessages class inheriting from BaseMessageProvider.

Follow the existing pattern from AdminMainMessages and UserStartMessages:
- Class inherits from BaseMessageProvider
- Stateless design: no session or bot stored as instance variables
- All methods return (text, keyboard) tuples for complete UI
- Use Lucien's voice from docs/guia-estilo.md
- Include docstrings with voice rationale for each method

Required methods:
1. `vip_menu_greeting()` - Main VIP menu greeting with subscription info placeholders
   - Parameters: user_name, vip_expires_at (Optional[datetime]), user_id (Optional[int]), session_history (Optional[SessionMessageHistory])
   - Returns: (text, keyboard) for VIP main menu
   - Voice: VIP users are "miembros del cÃ­rculo exclusivo" (exclusive circle members)
   - Include placeholders for subscription expiration: "Su membresÃ­a expira el [fecha]" or "Su membresÃ­a es permanente"
   - Weighted variations: 60% common, 30% alternate, 10% poetic

2. `free_menu_greeting()` - Main Free menu greeting with content browsing
   - Parameters: user_name, free_queue_position (Optional[int]), user_id (Optional[int]), session_history (Optional[SessionMessageHistory])
   - Returns: (text, keyboard) for Free main menu
   - Voice: Free users are "visitantes del jardÃ­n pÃºblico" (public garden visitors)
   - Include placeholders for queue status if applicable
   - Weighted variations: 70% welcoming, 30% informative

3. `vip_premium_section()` - VIP premium content section
   - Parameters: user_name, package_count (int), user_id (Optional[int]), session_history (Optional[SessionMessageHistory])
   - Returns: (text, keyboard) for VIP premium content listing
   - Voice: Premium content is "tesoros del sanctum" (sanctum treasures)
   - Include placeholder for package count: "[count] tesoros disponibles"

4. `free_content_section()` - Free content browsing section
   - Parameters: user_name, package_count (int), user_id (Optional[int]), session_history (Optional[SessionMessageHistory])
   - Returns: (text, keyboard) for Free content listing
   - Voice: Free content is "muestras del jardÃ­n" (garden samples)
   - Include placeholder for package count: "[count] muestras disponibles"

Keyboard structure for each method:
- Use `create_inline_keyboard` from `bot.utils.keyboards`
- Include navigation buttons: "Volver" (callback_data: "menu:back"), "Salir" (callback_data: "menu:exit")
- For content sections: include "Me interesa" buttons with placeholder callback_data patterns

Implementation notes:
- Use `self._compose()` for message composition
- Use `self._choose_variant()` for weighted variations
- Follow existing import patterns: `from aiogram.types import InlineKeyboardMarkup`, `from bot.utils.keyboards import create_inline_keyboard`
- Include proper type hints and docstrings
  </action>
  <verify>
1. File exists at `/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py`
2. Class `UserMenuMessages` inherits from `BaseMessageProvider`
3. All 4 required methods exist with correct signatures
4. Methods return tuples (text, InlineKeyboardMarkup)
5. Voice patterns match Lucien's style (uses "usted", refined language)
6. Keyboard creation uses `create_inline_keyboard`
7. Weighted variations implemented with `self._choose_variant()`
  </verify>
  <done>UserMenuMessages class created with all 4 methods following Lucien voice patterns and returning complete (text, keyboard) tuples.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate UserMenuMessages into LucienVoiceService</name>
  <files>/data/data/com.termux/files/home/repos/c1/bot/services/message/__init__.py</files>
  <action>
Update `bot/services/message/__init__.py` to integrate UserMenuMessages into the existing structure:

1. Import UserMenuMessages at top of file:
   ```python
   from .user_menu import UserMenuMessages
   ```

2. Update `UserMessages` class to include `menu` property:
   - Add `_menu` instance variable in `__init__`
   - Create `@property menu` method that lazy-loads UserMenuMessages
   - Update docstring to mention new menu provider

3. Update `LucienVoiceService` class documentation:
   - Update architecture diagram in docstring to include user.menu
   - Update examples to show usage of `container.message.user.menu.vip_menu_greeting()`

4. Update `__all__` export list to include `UserMenuMessages`

Follow the existing pattern from `UserStartMessages` and `UserFlowMessages` integration:
- Lazy loading pattern with `@property`
- Namespace organization under `user.menu`
- Update type hints and documentation

Example integration:
```python
class UserMessages:
    def __init__(self):
        self._start = None
        self._flows = None
        self._menu = None  # NEW

    @property
    def menu(self):
        if self._menu is None:
            from .user_menu import UserMenuMessages
            self._menu = UserMenuMessages()
        return self._menu
```

Update LucienVoiceService docstring architecture diagram:
```
LucienVoiceService (this class)
    â”œâ”€ common: CommonMessages âœ…
    â”œâ”€ admin: AdminMessages âœ…
    â””â”€ user: UserMessages âœ…
        â”œâ”€ start: UserStartMessages âœ…
        â”œâ”€ flows: UserFlowMessages âœ…
        â””â”€ menu: UserMenuMessages âœ… NEW
```

Add usage example in LucienVoiceService docstring:
```python
# User menu messages
text, kb = container.message.user.menu.vip_menu_greeting(
    user_name="Juan",
    vip_expires_at=expiry_date,
    user_id=user.id,
    session_history=session_ctx
)
```
  </action>
  <verify>
1. `UserMenuMessages` imported in `__init__.py`
2. `UserMessages` class has `_menu` instance variable and `@property menu` method
3. `LucienVoiceService` docstring updated with new architecture
4. `__all__` list includes `UserMenuMessages`
5. Type hints and documentation updated
6. Can access `container.message.user.menu.vip_menu_greeting()` in Python interpreter
  </verify>
  <done>UserMenuMessages fully integrated into LucienVoiceService and accessible via `container.message.user.menu`.</done>
</task>

<task type="auto">
  <name>Task 3: Test UserMenuMessages integration</name>
  <files>/data/data/com.termux/files/home/repos/c1/bot/services/message/__init__.py</files>
  <action>
Create a simple test script to verify UserMenuMessages integration works correctly:

1. Create a test file `/tmp/test_usermenu.py` with:
   ```python
   import sys
   sys.path.insert(0, '/data/data/com.termux/files/home/repos/c1')

   from bot.services.message import LucienVoiceService, UserMenuMessages

   # Test 1: Import works
   print("âœ… Test 1: UserMenuMessages import successful")

   # Test 2: LucienVoiceService has user.menu property
   service = LucienVoiceService()
   assert hasattr(service.user, 'menu'), "service.user should have 'menu' property"
   print("âœ… Test 2: LucienVoiceService.user.menu property exists")

   # Test 3: UserMenuMessages methods exist
   menu_provider = service.user.menu
   assert hasattr(menu_provider, 'vip_menu_greeting'), "Missing vip_menu_greeting method"
   assert hasattr(menu_provider, 'free_menu_greeting'), "Missing free_menu_greeting method"
   assert hasattr(menu_provider, 'vip_premium_section'), "Missing vip_premium_section method"
   assert hasattr(menu_provider, 'free_content_section'), "Missing free_content_section method"
   print("âœ… Test 3: All required methods exist")

   # Test 4: Methods return correct types (text, keyboard)
   text, kb = menu_provider.vip_menu_greeting("Test User", None)
   assert isinstance(text, str), "vip_menu_greeting should return string"
   assert 'ðŸŽ©' in text, "Message should contain Lucien's emoji"
   print("âœ… Test 4: vip_menu_greeting returns correct types")

   print("\nðŸŽ‰ All tests passed! UserMenuMessages integration successful.")
   ```

2. Run the test script to verify integration:
   ```bash
   cd /data/data/com.termux/files/home/repos/c1
   python /tmp/test_usermenu.py
   ```

3. If tests fail, debug and fix issues:
   - Check import paths
   - Verify property implementation
   - Ensure methods have correct signatures

4. Clean up test file after verification:
   ```bash
   rm /tmp/test_usermenu.py
   ```
  </action>
  <verify>
1. Test script created and runs without errors
2. All 4 assertions pass
3. UserMenuMessages methods return (text, keyboard) tuples
4. Messages contain Lucien's voice markers (ðŸŽ© emoji, refined language)
5. Integration accessible via `container.message.user.menu`
  </verify>
  <done>UserMenuMessages integration tested and working correctly with LucienVoiceService.</done>
</task>

</tasks>

<verification>
Overall verification for Plan 01:
1. Run the test script from Task 3 - all tests must pass
2. Check that `UserMenuMessages` class exists with all 4 methods
3. Verify integration in `LucienVoiceService` via `container.message.user.menu`
4. Ensure voice consistency: all messages use Lucien's style (usted, refined language, ðŸŽ© emoji)
5. Confirm keyboard creation uses `create_inline_keyboard` with proper callback_data patterns
</verification>

<success_criteria>
1. âœ… UserMenuMessages class created at `/data/data/com.termux/files/home/repos/c1/bot/services/message/user_menu.py` (150+ lines)
2. âœ… UserMenuMessages integrated into LucienVoiceService via `container.message.user.menu`
3. âœ… All 4 methods implemented: vip_menu_greeting, free_menu_greeting, vip_premium_section, free_content_section
4. âœ… Methods return (text, InlineKeyboardMarkup) tuples following existing patterns
5. âœ… Voice consistency: uses Lucien's style with weighted variations
6. âœ… Test script passes all assertions
</success_criteria>

<output>
After completion, create `.planning/phases/06-vip-free-user-menus/06-01-SUMMARY.md`
</output>
