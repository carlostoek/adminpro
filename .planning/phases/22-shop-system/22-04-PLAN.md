---
phase: 22-shop-system
plan: 04
type: execute
wave: 3
depends_on: [22-03]
files_modified:
  - bot/handlers/user/__init__.py
  - bot/handlers/user/menu.py
  - tests/test_shop_system.py
autonomous: true

must_haves:
  truths:
    - Shop router registered in user handlers __init__.py
    - User menu has "üõçÔ∏è Tienda" button linking to shop catalog
    - Shop system tests verify browse, purchase, and delivery flows
    - SHOP-01 through SHOP-08 requirements satisfied
    - VIP pricing displays correctly for VIP and Free users
  artifacts:
    - path: bot/handlers/user/__init__.py
      provides: Shop router export
      contains: ["from .shop import", "router"]
    - path: bot/handlers/user/menu.py
      provides: Tienda button in user menu
      contains: ["üõçÔ∏è Tienda", "shop_catalog"]
    - path: tests/test_shop_system.py
      provides: Shop system tests
      min_lines: 200
      contains: ["test_shop_browse", "test_shop_purchase", "test_shop_vip_pricing"]
  key_links:
    - from: user menu
      to: shop catalog
      via: üõçÔ∏è Tienda button callback
    - from: tests
      to: ShopService
      via: direct service method calls
---

<objective>
Wire shop handlers into user menu, register router, and create comprehensive tests verifying SHOP-01 through SHOP-08 requirements.

Purpose: Complete Phase 22 integration and verify all shop requirements work correctly.
Output: Updated menu with Tienda button, registered router, and test file with 8+ tests covering all SHOP requirements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/22-shop-system/22-CONTEXT.md
@bot/handlers/user/__init__.py
@bot/handlers/user/menu.py

# Phase 19-21 test patterns for service testing
# Phase 6 menu patterns for button placement
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register shop router in user handlers</name>
  <files>bot/handlers/user/__init__.py</files>
  <action>
    Register shop router in user handlers module.

    In bot/handlers/user/__init__.py:
    1. Add import:
       ```python
       from .shop import router as shop_router
       ```

    2. In the router inclusion section (where other routers are included), add:
       ```python
       # Shop system (Phase 22)
       main_router.include_router(shop_router)
       ```

    3. Update __all__ if present to include shop_router reference.

    Verify the router is properly exported for main.py to include.
  </action>
  <verify>grep -n "shop_router" bot/handlers/user/__init__.py</verify>
  <done>shop_router imported and included in main_router</done>
</task>

<task type="auto">
  <name>Task 2: Add Tienda button to user menu</name>
  <files>bot/handlers/user/menu.py</files>
  <action>
    Add shop button to user menu keyboard.

    In bot/handlers/user/menu.py, find the keyboard building function (likely build_user_menu_keyboard or similar).

    1. Add "üõçÔ∏è Tienda" button to the main menu keyboard layout.
       Place it in a logical position, perhaps after balance/streak info and before other options.

    2. The button callback should be "shop_catalog" to trigger the catalog handler.

    Example keyboard layout:
    ```python
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üí∞ Balance", callback_data="show_balance")],
        [InlineKeyboardButton(text="üî• Rachas", callback_data="show_streaks")],
        [InlineKeyboardButton(text="üõçÔ∏è Tienda", callback_data="shop_catalog")],  # NEW
        [InlineKeyboardButton(text="üéÅ Regalo Diario", callback_data="claim_daily")],
        # ... other buttons
    ])
    ```

    3. Ensure the menu message mentions the shop if appropriate (optional).

    Follow existing patterns from other menu buttons in the file.
  </action>
  <verify>grep -n "Tienda\|shop_catalog" bot/handlers/user/menu.py</verify>
  <done>üõçÔ∏è Tienda button added to user menu with shop_catalog callback</done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive shop system tests</name>
  <files>tests/test_shop_system.py</files>
  <action>
    Create tests/test_shop_system.py with comprehensive test coverage.

    Test structure following existing test patterns:

    ```python
    """
    Tests for Shop System (Phase 22).

    Covers SHOP-01 through SHOP-08 requirements.
    """
    import pytest
    from datetime import datetime
    from bot.services.shop import ShopService
    from bot.services.wallet import WalletService
    from bot.database.models import ContentSet, ShopProduct, UserContentAccess
    from bot.database.enums import ContentType, ContentTier, TransactionType, UserRole
    ```

    Test 1: test_shop_browse_catalog (SHOP-01)
    - Create test products with different prices
    - Call browse_catalog
    - Verify products returned in price ascending order
    - Verify pagination works

    Test 2: test_shop_product_details (SHOP-01)
    - Create product with VIP discount
    - Get details as VIP user
    - Verify VIP price calculated correctly
    - Get details as Free user
    - Verify regular price shown

    Test 3: test_shop_purchase_success (SHOP-04, SHOP-05, SHOP-06)
    - Create user with sufficient balance
    - Create product
    - Purchase product
    - Verify besitos deducted
    - Verify UserContentAccess created
    - Verify file_ids returned for delivery

    Test 4: test_shop_insufficient_balance (SHOP-04)
    - Create user with 0 balance
    - Attempt purchase
    - Verify validation fails with "insufficient_funds"

    Test 5: test_shop_vip_pricing_applied (SHOP-08)
    - Create product with 20% VIP discount
    - Purchase as VIP user
    - Verify VIP price charged (not regular price)
    - Verify discount applied correctly

    Test 6: test_shop_already_owned (SHOP-06)
    - Purchase product
    - Attempt purchase again without force_repurchase
    - Verify "already_owned" status
    - Purchase with force_repurchase=True
    - Verify second purchase succeeds

    Test 7: test_shop_purchase_history (SHOP-07)
    - Make multiple purchases
    - Get purchase history
    - Verify all purchases listed
    - Verify correct prices paid recorded

    Test 8: test_shop_vip_only_product (SHOP-08)
    - Create VIP-tier product
    - Attempt purchase as Free user
    - Verify "vip_only" validation result

    Test 9: test_shop_content_delivery
    - Purchase product with file_ids
    - Call deliver_content
    - Verify file_ids returned

    Test 10: test_shop_atomic_purchase
    - Attempt purchase with exact balance
    - Verify balance goes to 0
    - Verify no negative balance possible

    Use pytest fixtures for database session and test data.
    Follow patterns from test_wallet.py or test_streak.py.
  </action>
  <verify>grep -c "def test_shop" tests/test_shop_system.py && head -50 tests/test_shop_system.py</verify>
  <done>test_shop_system.py with 10+ tests covering all SHOP requirements</done>
</task>

<task type="auto">
  <name>Task 4: Add integration test for purchase flow</name>
  <files>tests/test_shop_system.py</files>
  <action>
    Add end-to-end integration test for complete purchase flow.

    Test: test_shop_complete_purchase_flow
    ```python
    async def test_shop_complete_purchase_flow(db_session):
        """
        End-to-end test: browse -> view detail -> purchase -> deliver -> verify history.
        """
        # Setup
        wallet = WalletService(db_session)
        shop = ShopService(db_session, wallet_service=wallet)

        # Create user profile with balance
        await wallet.earn_besitos(
            user_id=12345,
            amount=1000,
            transaction_type=TransactionType.EARN_ADMIN,
            reason="Test setup"
        )

        # Create content set with files
        content_set = ContentSet(
            name="Test Pack",
            file_ids=["file1", "file2", "file3"],
            content_type=ContentType.PHOTO_SET,
            tier=ContentTier.FREE
        )
        db_session.add(content_set)
        await db_session.flush()

        # Create product
        product = ShopProduct(
            name="Test Product",
            description="Test description",
            content_set_id=content_set.id,
            besitos_price=100,
            vip_discount_percentage=20,
            tier=ContentTier.FREE
        )
        db_session.add(product)
        await db_session.flush()

        # Step 1: Browse catalog
        products, total = await shop.browse_catalog(user_role="VIP")
        assert len(products) == 1
        assert products[0].id == product.id

        # Step 2: Get product details
        details, status = await shop.get_product_details(product.id, user_id=12345)
        assert status == "ok"
        assert details["user_price"] == 80  # VIP price with 20% discount
        assert details["is_owned"] == False

        # Step 3: Validate purchase
        can_buy, reason, validation = await shop.validate_purchase(
            user_id=12345,
            product_id=product.id,
            user_role="VIP"
        )
        assert can_buy == True
        assert reason == "ok"

        # Step 4: Purchase
        success, code, result = await shop.purchase_product(
            user_id=12345,
            product_id=product.id,
            user_role="VIP"
        )
        assert success == True
        assert code == "success"
        assert result["price_paid"] == 80
        assert len(result["file_ids"]) == 3

        # Step 5: Verify balance deducted
        balance = await wallet.get_balance(user_id=12345)
        assert balance == 920  # 1000 - 80

        # Step 6: Deliver content
        success, msg, file_ids = await shop.deliver_content(
            user_id=12345,
            content_set_id=content_set.id
        )
        assert success == True
        assert len(file_ids) == 3

        # Step 7: Verify history
        history, total = await shop.get_purchase_history(user_id=12345)
        assert total == 1
        assert history[0]["besitos_paid"] == 80
        assert history[0]["product_name"] == "Test Product"
    ```

    This test verifies the complete flow works end-to-end.
  </action>
  <verify>grep -A 80 "def test_shop_complete_purchase_flow" tests/test_shop_system.py</verify>
  <done>Integration test covers complete purchase flow from browse to history</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run: python -m pytest tests/test_shop_system.py -v --tb=short 2>&1 | head -50
2. Verify all 10+ tests pass
3. Check SHOP-01 through SHOP-08 are covered by tests
4. Verify menu button appears in user menu
</verification>

<success_criteria>
- Shop router registered and accessible from main bot
- User menu displays üõçÔ∏è Tienda button
- test_shop_system.py has 10+ tests covering all requirements
- All tests pass (pytest)
- SHOP-01: Catalog browsing with pagination ‚úì
- SHOP-02: Content packages available for purchase ‚úì
- SHOP-03: VIP membership extension available (prepared for Phase 24) ‚úì
- SHOP-04: Insufficient balance validation ‚úì
- SHOP-05: Atomic purchase (deduct + deliver) ‚úì
- SHOP-06: Content immediately accessible ‚úì
- SHOP-07: Purchase history maintained ‚úì
- SHOP-08: VIP pricing displayed correctly ‚úì
</success_criteria>

<output>
After completion, create `.planning/phases/22-shop-system/22-04-SUMMARY.md`
</output>
