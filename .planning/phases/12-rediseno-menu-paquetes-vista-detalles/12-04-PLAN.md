---
phase: 12-rediseno-menu-paquetes-vista-detalles
plan: 04
type: execute
wave: 2
depends_on: ["12-03"]
files_modified:
  - bot/handlers/vip/callbacks.py
  - bot/handlers/free/callbacks.py
autonomous: true

must_haves:
  truths:
    - "Bot√≥n 'Regresar' en confirmaci√≥n devuelve a listado de paquetes"
    - "Bot√≥n 'Inicio' en confirmaci√≥n devuelve al men√∫ principal VIP o Free"
    - "Bot√≥n '‚Üê Volver' en vista de detalles devuelve a listado de paquetes"
    - "Navegaci√≥n funciona correctamente en todos los niveles: listado ‚Üí detalle ‚Üí confirmaci√≥n ‚Üí regresar"
  artifacts:
    - path: "bot/handlers/vip/callbacks.py"
      provides: "Handlers para user:packages:back y navegaci√≥n de confirmaci√≥n"
      min_lines: 40
    - path: "bot/handlers/free/callbacks.py"
      provides: "Handlers para user:packages:back y navegaci√≥n de confirmaci√≥n"
      min_lines: 40
  key_links:
    - from: "bot/handlers/vip/callbacks.py"
      to: "bot/handlers/vip/callbacks.py"
      via: "handle_vip_premium() reuse for list display"
      pattern: "await handle_vip_premium\\("
    - from: "bot/handlers/free/callbacks.py"
      to: "bot/handlers/free/callbacks.py"
      via: "handle_free_content() reuse for list display"
      pattern: "await handle_free_content\\("
---

<objective>
Implementar navegaci√≥n completa para el nuevo flujo de paquetes: botones "Regresar" y "Inicio" en confirmaci√≥n, y bot√≥n "Volver" en vista de detalles, permitiendo al usuario navegar fluidamente entre listado, detalle y men√∫s principales.

**Purpose:**
Completar el sistema de navegaci√≥n del flujo redise√±ado, asegurando que el usuario pueda regresar a cualquier punto del flujo sin perder contexto ni atascarse en vistas muertas.

**Output:**
- Handler para `user:packages:back:{role}` en VIP y Free routers (regresa a listado)
- Handler para `menu:vip:main` y `menu:free:main` (inicio desde confirmaci√≥n)
- Handler para `user:packages:back` (volver desde detalle a listado)
- Navegaci√≥n circular completa: listado ‚Üî detalle ‚Üî confirmaci√≥n ‚Üí listado/inicio
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/12-rediseno-menu-paquetes-vista-detalles/12-CONTEXT.md
@.planning/phases/12-rediseno-menu-paquetes-vista-detalles/12-03-PLAN.md

# Navigation Callback Patterns
From 12-CONTEXT.md line 38:
- `user:packages:back` - volver a listado (desde detalle)
- `user:packages:back:{user_role}` - regresar a listado (desde confirmaci√≥n)
- `menu:vip:main` - volver al men√∫ principal VIP (desde confirmaci√≥n)
- `menu:free:main` - volver al men√∫ principal Free (desde confirmaci√≥n)

# Existing Navigation - Phase 6
From vip/callbacks.py and free/callbacks.py:
- `menu:back` - vuelve al men√∫ principal VIP/Free
- `menu:exit` - cierra el men√∫
- `menu:free:main` - vuelve al men√∫ principal Free

# Current Package List Handlers
From 12-02-PLAN.md:
- VIP: `handle_vip_premium()` shows VIP_PREMIUM package list
- Free: `handle_free_content()` shows FREE_CONTENT package list
- Both use `user:packages:{id}` callback for detail view

# Navigation Flow Requirements
1. From detail view: "‚Üê Volver" ‚Üí back to package list (same category)
2. From confirmation: "üìã Regresar" ‚Üí back to package list (same category)
3. From confirmation: "üè† Inicio" ‚Üí back to main menu (VIP or Free)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add user:packages:back handler to VIP router (return to list)</name>
  <files>bot/handlers/vip/callbacks.py</files>
  <action>
    Add new callback handler in vip/callbacks.py:

    Handler registration:
    ```python
    @vip_callbacks_router.callback_query(lambda c: c.data == "user:packages:back")
    async def handle_packages_back_to_list(callback: CallbackQuery, container):
    ```

    Implementation logic:
    1. Reuse existing `handle_vip_premium()` handler:
       ```python
       await handle_vip_premium(callback, container)
       ```

    This approach:
    - Avoids code duplication
    - Ensures consistent list display
    - Maintains package sorting from 12-01
    - Preserves session context

    Place handler after handle_package_interest_confirm(), before handle_menu_back().

    Note: This handler is called when user clicks "‚Üê Volver" from detail view OR "üìã Regresar" from confirmation.
  </action>
  <verify>
    1. Confirm handler matches callback pattern "user:packages:back"
    2. Confirm handler calls handle_vip_premium() directly
    3. Confirm handler placement in correct location
    4. Confirm no code duplication with handle_vip_premium()
  </verify>
  <done>
    VIP router handles user:packages:back callback
    Returns user to VIP premium package list
    Reuses handle_vip_premium() for consistency
    Works from both detail view and confirmation message
  </done>
</task>

<task type="auto">
  <name>Task 2: Add user:packages:back handler to Free router (return to list)</name>
  <files>bot/handlers/free/callbacks.py</files>
  <action>
    Add new callback handler in free/callbacks.py:

    Apply same pattern as Task 1 for Free router:
    1. Handler registration: `@free_callbacks_router.callback_query(lambda c: c.data == "user:packages:back")`
    2. Reuse existing `handle_free_content()` handler:
       ```python
       await handle_free_content(callback, container)
       ```

    Mirror VIP handler structure for consistency.

    Place handler after handle_package_interest_confirm(), before handle_menu_back().
  </action>
  <verify>
    1. Confirm callback pattern matches VIP handler
    2. Confirm handler calls handle_free_content() directly
    3. Confirm handler placement in correct location
    4. Confirm consistent structure with VIP handler
  </verify>
  <done>
    Free router handles user:packages:back callback
    Returns user to Free content package list
    Reuses handle_free_content() for consistency
    Works from both detail view and confirmation message
  </done>
</task>

<task type="auto">
  <name>Task 3: Add menu:vip:main and menu:free:main handlers</name>
  <files>bot/handlers/vip/callbacks.py, bot/handlers/free/callbacks.py</files>
  <action>
    Add handlers for "Inicio" button navigation:

    VIP router (vip/callbacks.py):
    ```python
    @vip_callbacks_router.callback_query(lambda c: c.data == "menu:vip:main")
    async def handle_menu_vip_main(callback: CallbackQuery, container):
        # Reuse existing menu:back handler
        await handle_menu_back(callback, container)
    ```

    Free router (free/callbacks.py):
    ```python
    @free_callbacks_router.callback_query(lambda c: c.data == "menu:free:main")
    async def handle_menu_free_main(callback: CallbackQuery, container):
        # Reuse existing menu:free:main handler
        await handle_menu_back(callback, container)
    ```

    Both handlers reuse existing navigation logic to maintain consistency with Phase 6.

    Place handlers:
    - VIP: after handle_packages_back_to_list(), before handle_menu_exit()
    - Free: after handle_packages_back_to_list(), before handle_menu_exit()

    Note: Free router already has handle_menu_back() with callback "menu:free:main" from Phase 6. This handler ensures the pattern is explicit.
  </action>
  <verify>
    1. Confirm VIP handler matches "menu:vip:main" callback
    2. Confirm Free handler matches "menu:free:main" callback
    3. Confirm both reuse existing menu navigation handlers
    4. Confirm handler placement in correct locations
  </verify>
  <done>
    VIP router handles menu:vip:main callback for "Inicio" button
    Free router handles menu:free:main callback for "Inicio" button
    Both reuse existing menu navigation logic
    Consistent with Phase 6 navigation patterns
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
1. Test navigation flow from detail view: click "‚Üê Volver" ‚Üí see package list
2. Test navigation flow from confirmation: click "üìã Regresar" ‚Üí see package list
3. Test navigation flow from confirmation: click "üè† Inicio" ‚Üí see main menu (VIP or Free)
4. Verify all navigation paths work circularly without dead ends
5. Confirm callback patterns match those defined in package_interest_confirmation() (12-03)
6. Verify no code duplication across navigation handlers
</verification>

<success_criteria>
- user:packages:back handler exists in both VIP and Free routers
- menu:vip:main and menu:free:main handlers exist
- All navigation buttons work: "‚Üê Volver", "üìã Regresar", "üè† Inicio"
- Navigation flow is circular and complete
- No code duplication (reuse existing handlers)
- Integration with Phase 6 navigation preserved
</success_criteria>

<output>
After completion, create `.planning/phases/12-rediseno-menu-paquetes-vista-detalles/12-04-SUMMARY.md` with:
- Navigation handler implementations
- Callback pattern documentation
- Navigation flow diagram
- Integration with existing Phase 6 navigation
</output>
