---
phase: 12-rediseno-menu-paquetes-vista-detalles
plan: 03
type: execute
wave: 2
depends_on: ["12-02"]
files_modified:
  - bot/handlers/vip/callbacks.py
  - bot/handlers/free/callbacks.py
  - bot/services/message/user_flow.py
autonomous: true

must_haves:
  truths:
    - "Usuario ve lista de paquetes ‚Üí clic en paquete ‚Üí ve detalles ‚Üí clic 'Me interesa' ‚Üí mensaje de confirmaci√≥n con contacto"
    - "Mensaje de confirmaci√≥n incluye bot√≥n 'Escribirme' ‚Üí tg://resolve?username=<CREATOR_USERNAME>"
    - "Mensaje de confirmaci√≥n incluye bot√≥n 'Regresar' ‚Üí vuelve a listado de paquetes"
    - "Mensaje de confirmaci√≥n incluye bot√≥n 'Inicio' ‚Üí devuelve al men√∫ principal"
    - "Voz del mensaje es directa/c√°lida (no Lucien - m√°s personal)"
  artifacts:
    - path: "bot/services/message/user_flow.py"
      provides: "M√©todo package_interest_confirmation() con mensaje c√°lido y botones de contacto"
      min_lines: 60
    - path: "bot/handlers/vip/callbacks.py"
      provides: "Handler para callback user:package:interest:{package_id}"
      min_lines: 50
    - path: "bot/handlers/free/callbacks.py"
      provides: "Handler para callback user:package:interest:{package_id}"
      min_lines: 50
  key_links:
    - from: "bot/handlers/vip/callbacks.py"
      to: "bot/services/message/user_flow.py"
      via: "package_interest_confirmation() method call"
      pattern: "package_interest_confirmation\\("
    - from: "bot/handlers/free/callbacks.py"
      to: "bot/services/message/user_flow.py"
      via: "package_interest_confirmation() method call"
      pattern: "package_interest_confirmation\\("
---

<objective>
Implementar flujo post-inter√©s con mensaje de confirmaci√≥n personal, bot√≥n de contacto directo a la creadora y navegaci√≥n flexible (regresar a listado o volver al men√∫ principal).

**Purpose:**
Convertir el registro de inter√©s en una apertura de canal de comunicaci√≥n personal, no solo una notificaci√≥n administrativa. El usuario siente que est√° conectando directamente con Diana.

**Output:**
- Nuevo m√©todo package_interest_confirmation() en UserFlowMessages
- Handlers para user:package:interest:{id} en VIP y Free routers
- Confirmaci√≥n con bot√≥n "Escribirme" (tg://resolve link), "Regresar" (a listado), "Inicio" (a men√∫ principal)
- Tono directo/c√°lido (no Lucien - m√°s personal y cercano)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/12-rediseno-menu-paquetes-vista-detalles/12-CONTEXT.md
@.planning/phases/12-rediseno-menu-paquetes-vista-detalles/12-02-PLAN.md

# Phase 12 Context - Post-Interest Message
From 12-CONTEXT.md lines 26-34:
- Mensaje directo/c√°lido: "Gracias por tu inter√©s! ü´∂\n\nEn un momento me pongo en contacto personalmente contigo üòä\n\nSi no quieres esperar da clic aqu√≠ abajo ‚¨áÔ∏è para escribirme en mi Telegram personal!"
- Bot√≥n "Escribirme" ‚Üí tg://resolve?username=<CREATOR_USERNAME> (fallback a profile link si no hay username)
- Bot√≥n "Regresar" ‚Üí devuelve al listado de paquetes
- Bot√≥n "Inicio" ‚Üí devuelve al men√∫ principal (VIP o Free)
- Voz del mensaje: Tono directo/c√°lido (no Lucien - m√°s personal)

# Config - CREATOR_USERNAME
From config.py environment variable:
- CREATOR_USERNAME: Telegram username de Diana (ej: "diana_artista")
- Used for tg://resolve?username= links
- Fallback: if not set, use tg://user?id={CREATOR_USER_ID} or profile URL

# Existing Interest Registration
From Phase 8 (interest notification system):
- InterestService.register_interest() handles deduplication (5min window)
- Returns (success, status, interest) tuple
- Existing handlers use callback pattern `interest:package:{id}`
- This plan introduces NEW pattern `user:package:interest:{id}` for user-facing flow
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add package_interest_confirmation() method to UserFlowMessages</name>
  <files>bot/services/message/user_flow.py</files>
  <action>
    Add new method `package_interest_confirmation(user_name: str, package_name: str, user_role: str = "VIP") -> Tuple[str, InlineKeyboardMarkup]`:

    Method signature:
    ```python
    def package_interest_confirmation(
        self,
        user_name: str,
        package_name: str,
        user_role: str = "VIP",
        user_id: Optional[int] = None,
        session_history: Optional["SessionMessageHistory"] = None
    ) -> Tuple[str, InlineKeyboardMarkup]:
    ```

    Message structure (WARM, PERSONAL tone - NOT Lucien):
    ```
    Gracias por tu inter√©s! ü´∂

    En un momento me pongo en contacto personalmente contigo üòä

    Si no quieres esperar da clic aqu√≠ abajo ‚¨áÔ∏è para escribirme en mi Telegram personal!
    ```

    Notes:
    - Use user_name in greeting (optional, or keep generic "Gracias por tu inter√©s")
    - NO üé© Lucien emoji - this is Diana's personal voice
    - Warm, direct, approachable tone
    - Include package_name in message or button text for context

    Keyboard structure:
    1. Primary action row: "‚úâÔ∏è Escribirme" button:
       - If CREATOR_USERNAME exists: url=`tg://resolve?username={CREATOR_USERNAME}`
       - Fallback: url=`https://t.me/{CREATOR_USERNAME}` or profile link
    2. Secondary actions row (2 buttons):
       - "üìã Regresar" ‚Üí callback: `user:packages:back:{user_role}`
       - "üè† Inicio" ‚Üí callback: `menu:{user_role.lower()}:main`

    Use `create_inline_keyboard()` or `InlineKeyboardMarkup` directly.

    Place method after existing flow methods, maintaining alphabetical order.

    Import CREATOR_USERNAME from config at module top if not already imported.
  </action>
  <verify>
    1. Confirm method has all required parameters with type hints
    2. Confirm message tone is warm/personal (no üé©, no Lucien voice)
    3. Confirm keyboard has 3 buttons in 2 rows (Escribirme alone, Regresar+Inicio together)
    4. Confirm "Escribirme" button uses tg://resolve?username= pattern
    5. Confirm callback patterns for Regresar and Inicio include user_role
  </verify>
  <done>
    package_interest_confirmation() generates warm, personal confirmation message
    Message uses Diana's voice (not Lucien's)
    Keyboard includes "Escribirme", "Regresar", and "Inicio" buttons
    "Escribirme" uses tg://resolve?username= pattern with fallback
    Navigation buttons include user_role context for correct routing
  </done>
</task>

<task type="auto">
  <name>Task 2: Add user:package:interest:{id} handler to VIP router</name>
  <files>bot/handlers/vip/callbacks.py</files>
  <action>
    Add new callback handler in vip/callbacks.py after the package detail handler:

    Handler registration:
    ```python
    @vip_callbacks_router.callback_query(lambda c: c.data and c.data.startswith("user:package:interest:"))
    async def handle_package_interest_confirm(callback: CallbackQuery, container):
    ```

    Implementation logic:
    1. Extract package_id: `package_id = int(callback.data.split(":")[-1])`
    2. Fetch package: `package = await container.content.get_package_by_id(package_id)`
    3. If package not found: await callback.answer("‚ö†Ô∏è Paquete no encontrado", show_alert=True); return
    4. Register interest using InterestService:
       ```python
       success, status, interest = await container.interest.register_interest(
           user_id=callback.from_user.id,
           package_id=package_id
       )
       ```
    5. If success is True:
       - Send admin notification (reuse existing `_send_admin_interest_notification()` function)
       - Generate confirmation message:
         ```python
         text, keyboard = container.message.user.flow.package_interest_confirmation(
             user_name=callback.from_user.first_name or "Usuario",
             package_name=package.name,
             user_role="VIP",
             user_id=callback.from_user.id,
             session_history=container.message.get_session_context(container)
         )
         ```
       - Update message: `await callback.message.edit_text(text, parse_mode="HTML", reply_markup=keyboard)`
       - Answer: `await callback.answer("‚úÖ Inter√©s registrado")`
    6. If success is False and status == "debounce":
       - Show subtle feedback: `await callback.answer("‚úÖ Inter√©s registrado previamente")`
       - DO NOT update message or send notification
    7. If success is False (error):
       - Show error alert: `await callback.answer("‚ö†Ô∏è Error registrando inter√©s", show_alert=True)`

    Keep existing admin notification logic from Phase 8 (it still works).

    Place handler after handle_package_detail(), before handle_vip_status().
  </action>
  <verify>
    1. Confirm callback pattern matches `user:package:interest:{id}` (3 colons)
    2. Confirm interest registration uses InterestService
    3. Confirm admin notification still sent on success
    4. Confirm confirmation message generated on success
    5. Confirm debounce logic prevents duplicate notifications
    6. Confirm error handling covers all cases
  </verify>
  <done>
    VIP router handles user:package:interest:{id} callbacks
    Registers interest via InterestService (with deduplication)
    Sends admin notification on successful interest registration
    Shows warm confirmation message to user on success
    Handles debounce window gracefully
  </done>
</task>

<task type="auto">
  <name>Task 3: Add user:package:interest:{id} handler to Free router</name>
  <files>bot/handlers/free/callbacks.py</files>
  <action>
    Add new callback handler in free/callbacks.py after the package detail handler:

    Apply same implementation pattern as Task 2:
    1. Same handler registration: `@free_callbacks_router.callback_query(lambda c: c.data and c.data.startswith("user:package:interest:"))`
    2. Same interest registration logic
    3. Same admin notification call (reuse existing function)
    4. Use user_role="Free" when calling package_interest_confirmation()
    5. Same debounce and error handling

    Mirror VIP handler structure, only changing user_role parameter.

    Place handler after handle_package_detail(), before handle_vip_info().
  </action>
  <verify>
    1. Confirm callback pattern matches VIP handler
    2. Confirm package_interest_confirmation() called with user_role="Free"
    3. Confirm admin notification sent with user_role="Free"
    4. Confirm debounce logic matches VIP handler
    5. Confirm handler placement in correct location
  </verify>
  <done>
    Free router handles user:package:interest:{id} callbacks
    Uses user_role="Free" for context-aware messages
    Consistent logic with VIP handler
    Admin notifications specify Free user context
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
1. Test complete flow: list ‚Üí detail ‚Üí "Me interesa" ‚Üí confirmation message
2. Verify "Escribirme" button opens Telegram chat with creator
3. Verify "Regresar" button returns to package list
4. Verify "Inicio" button returns to main menu (VIP or Free)
5. Verify admin notification still sent (Phase 8 integration preserved)
6. Verify debounce window prevents duplicate notifications
7. Confirm message tone is warm/personal (Diana's voice, not Lucien's)
</verification>

<success_criteria>
- package_interest_confirmation() method exists with warm, personal message
- VIP and Free routers handle user:package:interest:{id} callbacks
- Confirmation message shows "Escribirme", "Regresar", "Inicio" buttons
- "Escribirme" uses tg://resolve?username= pattern
- Admin notifications still sent (Phase 8 feature preserved)
- Debounce logic prevents duplicate notifications
- Message tone is personal (not Lucien's voice)
</success_criteria>

<output>
After completion, create `.planning/phases/12-rediseno-menu-paquetes-vista-detalles/12-03-SUMMARY.md` with:
- New package_interest_confirmation() method
- Interest registration flow with confirmation
- Navigation patterns from confirmation message
- Admin notification integration preserved
</output>
