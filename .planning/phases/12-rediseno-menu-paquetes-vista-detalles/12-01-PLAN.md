---
phase: 12-rediseno-menu-paquetes-vista-detalles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/services/message/user_menu.py
autonomous: true

must_haves:
  truths:
    - "Usuario ve lista de paquetes con botones individuales (solo nombre + emoji)"
    - "Cada bot√≥n lleva a vista de detalles del paquete espec√≠fico"
    - "No hay botones gen√©ricos 'Me interesa' en la lista"
    - "La lista est√° ordenada por precio (menor a mayor, gratuitos primero)"
  artifacts:
    - path: "bot/services/message/user_menu.py"
      provides: "Mensajes de lista de paquetes con botones individuales"
      min_lines: 50
  key_links:
    - from: "bot/services/message/user_menu.py"
      to: "bot/handlers/vip/callbacks.py y bot/handlers/free/callbacks.py"
      via: "user:packages:{package_id} callback pattern"
      pattern: "user:packages:\\d+"
---

<objective>
Redise√±ar la presentaci√≥n de paquetes en lista con botones individuales por paquete, sin precios ni categor√≠as visibles, ordenados por precio.

**Purpose:**
Eliminar la confusi√≥n actual donde los usuarios registran inter√©s sin ver detalles del paquete. El nuevo flujo obliga al usuario a ver detalles antes de decidir, mejorando la calidad de los leads.

**Output:**
- M√©todo actualizado en UserMenuMessages para generar lista minimalista
- Botones con callback pattern `user:packages:{package_id}`
- Ordenamiento inteligente por precio (gratuitos primero, luego ascendente)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/12-rediseno-menu-paquetes-vista-detalles/12-CONTEXT.md
@.planning/PROJECT.md

# Prior Work - Phase 6 Package Menus
vip_premium_section() y free_content_section() actualmente:
- Muestran nombre + descripci√≥n + precio en lista
- Usan callback pattern `interest:package:{package_id}`
- Bot√≥n gen√©rico "‚≠ê {name} - Me interesa"
- Sin ordenamiento espec√≠fico

# Database Model - ContentPackage
Campos disponibles (bot/database/models.py l√≠nea 469+):
- id: Integer (PK)
- name: String(200) - Nombre del paquete
- description: String(500) - Descripci√≥n
- price: Numeric(10,2) - Precio (nullable)
- category: Enum(ContentCategory) - FREE_CONTENT, VIP_CONTENT, VIP_PREMIUM
- is_active: Boolean - Soft delete
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add helper method for package sorting by price</name>
  <files>bot/services/message/user_menu.py</files>
  <action>
    Add static method `_sort_packages_by_price(packages: List[ContentPackage]) -> List[ContentPackage]`:

    Sorting logic:
    1. Separate packages into: free (price is None) and paid (price is not None)
    2. Sort paid packages by price ASC (lowest first)
    3. Return: free packages first, then paid packages

    Use list comprehension with key parameter:
    - Free packages: `sorted([p for p in packages if p.price is None], key=lambda p: p.name)`
    - Paid packages: `sorted([p for p in packages if p.price is not None], key=lambda p: (p.price, p.name))`
    - Concatenate: `free_packages + paid_packages`

    Place method after existing helper methods, before keyboard factory methods.
  </action>
  <verify>
    1. Read method and confirm it has type hints for input/output
    2. Confirm free packages come before paid packages
    3. Confirm paid packages are sorted by price ascending
  </verify>
  <done>
    Free packages (price=None) appear first in sorted list
    Paid packages sorted by price ASC, then by name ASC for ties
    Method returns List[ContentPackage] with deterministic order
  </done>
</task>

<task type="auto">
  <name>Task 2: Update vip_premium_section() to use minimal list format</name>
  <files>bot/services/message/user_menu.py</files>
  <action>
    Refactor `vip_premium_section()` method (lines 212-278):

    Changes:
    1. Call `self._sort_packages_by_price(packages)` to sort
    2. Update message body to remove price/category from display:
       - Remove line showing package count (keep just "tesoros disponibles" text)
       - Simplify body text: focus on "explorar tesoros" not listing details
    3. Replace `_create_package_buttons()` call with new inline logic:
       - Create list of button rows: `[{"text": "üì¶ {package.name}", "callback_data": f"user:packages:{package.id}"}]`
       - One package per row (vertical list)
       - No price, no emoji prefix except üì¶ for all
    4. Use `create_content_with_navigation()` with new button list
    5. Keep back button: "‚¨ÖÔ∏è Volver al Men√∫ VIP" with callback "menu:back"

    DO NOT change Lucien's voice text - just simplify presentation.
  </action>
  <verify>
    1. Confirm packages are sorted before creating buttons
    2. Confirm callback format is `user:packages:{package_id}` (NOT `interest:package:`)
    3. Confirm buttons show only "üì¶ {name}" (no price, no category emoji)
    4. Confirm back button navigation is preserved
  </verify>
  <done>
    vip_premium_section() generates minimalist package list
    Callback pattern changed from `interest:package:{id}` to `user:packages:{id}`
    Free packages appear first, then paid packages sorted by price
    List shows only package names, no prices or categories
  </done>
</task>

<task type="auto">
  <name>Task 3: Update free_content_section() to use minimal list format</name>
  <files>bot/services/message/user_menu.py</files>
  <action>
    Refactor `free_content_section()` method (lines 280-350):

    Apply same changes as Task 2 to free content section:
    1. Call `self._sort_packages_by_price(packages)` to sort
    2. Update message body to remove details from display
    3. Replace `_create_package_buttons()` with new inline logic:
       - Callback format: `user:packages:{package_id}`
       - Button text: "üì¶ {package.name}" (minimalist)
    4. Use `create_content_with_navigation()` with new button list
    5. Keep back button: "‚¨ÖÔ∏è Volver al Men√∫ Free" with callback "menu:free:main"

    Mirror vip_premium_section() structure for consistency.
  </action>
  <verify>
    1. Confirm packages are sorted before creating buttons
    2. Confirm callback format is `user:packages:{package_id}`
    3. Confirm buttons show only "üì¶ {name}"
    4. Confirm back button navigation is preserved
  </verify>
  <done>
    free_content_section() generates minimalist package list
    Callback pattern changed to `user:packages:{id}`
    Free packages appear first, then paid packages sorted by price
    Consistent structure with vip_premium_section()
  </done>
</task>

<task type="auto">
  <name>Task 4: Remove obsolete _create_package_buttons() helper method</name>
  <files>bot/services/message/user_menu.py</files>
  <action>
    Delete the `_create_package_buttons()` method (lines 352-379) since it's no longer used after Tasks 2 and 3 refactor.

    This method created "Me interesa" buttons which are being replaced by package detail navigation.
  </action>
  <verify>
    1. Confirm method is deleted
    2. Confirm no other code references this method
  </verify>
  <done>
    Obsolete _create_package_buttons() method removed
    No references to old method in codebase
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
1. Code review user_menu.py: confirm callback patterns use `user:packages:` prefix
2. Verify sorting logic handles None prices correctly (free packages first)
3. Verify Lucien's voice messages remain unchanged (only presentation simplified)
4. Check that both VIP and Free sections follow same structure
</verification>

<success_criteria>
- VIP and Free package lists show minimalist format (name only)
- Callbacks use `user:packages:{package_id}` pattern (not `interest:package:`)
- Packages sorted: free first, then by price ascending
- No prices or categories visible in list
- Navigation buttons preserved (back to main menu)
</success_criteria>

<output>
After completion, create `.planning/phases/12-rediseno-menu-paquetes-vista-detalles/12-01-SUMMARY.md` with:
- Changes made to user_menu.py
- New sorting algorithm explanation
- Callback pattern migration from `interest:package:` to `user:packages:`
</output>
