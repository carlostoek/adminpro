---
phase: 12-rediseno-menu-paquetes-vista-detalles
plan: 02
type: execute
wave: 1
depends_on: ["12-01"]
files_modified:
  - bot/services/message/user_menu.py
  - bot/handlers/vip/callbacks.py
  - bot/handlers/free/callbacks.py
autonomous: true

must_haves:
  truths:
    - "Al hacer clic en paquete, se muestra vista detallada (nombre, descripci√≥n, precio, tipo)"
    - "Vista de detalles incluye bot√≥n 'Me interesa' para registrar inter√©s"
    - "Solo existe bot√≥n '‚Üê Volver' en vista de detalles (sin 'Salir')"
    - "Metadatos mostrados: nombre, descripci√≥n, precio, tipo y categor√≠a (no is_active ni created_at)"
  artifacts:
    - path: "bot/services/message/user_menu.py"
      provides: "M√©todo package_detail_view() con vista completa del paquete"
      min_lines: 80
    - path: "bot/handlers/vip/callbacks.py"
      provides: "Handler para callback user:packages:{package_id}"
      min_lines: 40
    - path: "bot/handlers/free/callbacks.py"
      provides: "Handler para callback user:packages:{package_id}"
      min_lines: 40
  key_links:
    - from: "bot/handlers/vip/callbacks.py"
      to: "bot/services/message/user_menu.py"
      via: "package_detail_view() method call"
      pattern: "package_detail_view\\("
    - from: "bot/handlers/free/callbacks.py"
      to: "bot/services/message/user_menu.py"
      via: "package_detail_view() method call"
      pattern: "package_detail_view\\("
---

<objective>
Crear vista de detalles de paquete con informaci√≥n completa y bot√≥n "Me interesa", manejada por nuevos callbacks en routers VIP y Free.

**Purpose:**
Permitir al usuario ver toda la informaci√≥n relevante del paquete (descripci√≥n, precio, tipo) antes de decidir registrar inter√©s, mejorando la calidad de conversi√≥n.

**Output:**
- Nuevo m√©todo package_detail_view() en UserMenuMessages
- Handlers en vip/callbacks.py y free/callbacks.py para user:packages:{id}
- Vista detallada con bot√≥n "Me interesa" y navegaci√≥n de vuelta
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/12-rediseno-menu-paquetes-vista-detalles/12-CONTEXT.md
@.planning/phases/12-rediseno-menu-paquetes-vista-detalles/12-01-PLAN.md

# Phase 12 Context - Detail View Requirements
From 12-CONTEXT.md lines 20-38:
- Descripci√≥n completa (sin truncar)
- Formato de precio: "Precio: $15.00" o "Acceso gratuito"
- Badges con emoji: "üëë Premium" / "üå∑ Garden" + categor√≠a icono
- Metadatos: solo campos user-facing (nombre, descripci√≥n, precio, tipo, categor√≠a)
- Botones: solo "‚Üê Volver" (sin "Salir")
- Callback: `user:package:interest:{package_id}` para bot√≥n "Me interesa"

# ContentPackage Model Fields
From bot/database/models.py:
- name: String(200) - Nombre del paquete
- description: String(500) - Descripci√≥n (nullable)
- price: Numeric(10,2) - Precio (nullable)
- category: Enum(ContentCategory) - FREE_CONTENT, VIP_CONTENT, VIP_PREMIUM
- is_active: Boolean - NO mostrar en vista usuario
- created_at: DateTime - NO mostrar en vista usuario
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add package_detail_view() method to UserMenuMessages</name>
  <files>bot/services/message/user_menu.py</files>
  <action>
    Add new method `package_detail_view(package: ContentPackage, user_role: str = "VIP") -> Tuple[str, InlineKeyboardMarkup]`:

    Method signature:
    ```python
    def package_detail_view(
        self,
        package: ContentPackage,
        user_role: str = "VIP",
        user_id: Optional[int] = None,
        session_history: Optional["SessionMessageHistory"] = None
    ) -> Tuple[str, InlineKeyboardMarkup]:
    ```

    Message structure:
    1. Header: `üé© <b>Lucien:</b>` with contextual intro
    2. Title: Package name in bold
    3. Description: Full description (use `<i>{description}</i>` if exists, else "Sin descripci√≥n")
    4. Price section:
       - If price is None: "üí∞ <b>Precio:</b> Acceso gratuito"
       - If price exists: "üí∞ <b>Precio:</b> ${price:.2f}"
    5. Type badge:
       - Map category to emoji: VIP_PREMIUM="üíé", VIP_CONTENT="üëë", FREE_CONTENT="üå∏"
       - Add badge: "{emoji} {category_label}"
       - Labels: "Premium Exclusivo", "Contenido VIP", "Contenido Gratuito"
    6. Footer: Lucien-voiced closing based on user_role ("c√≠rculo" for VIP, "jard√≠n" for Free)

    Keyboard structure:
    1. Action button row: "‚≠ê Me interesa" with callback `user:package:interest:{package.id}`
    2. Navigation row: "‚¨ÖÔ∏è Volver" with callback:
       - `user:packages:back` if from VIP
       - `user:packages:back` if from Free (same pattern)

    Use `create_inline_keyboard()` from utils.keyboards.

    Place method after free_content_section(), before keyboard factory methods.
  </action>
  <verify>
    1. Confirm method has all required parameters with type hints
    2. Confirm price formatting handles None (shows "Acceso gratuito")
    3. Confirm category badges have correct emoji mapping
    4. Confirm keyboard has "Me interesa" button and "Volver" button only
    5. Confirm callback pattern is `user:package:interest:{package_id}`
  </verify>
  <done>
    package_detail_view() generates complete package detail view
    Shows name, description, price, and category badges
    Includes "‚≠ê Me interesa" button with correct callback pattern
    Includes "‚¨ÖÔ∏è Volver" navigation button
    Lucien's voice adapts based on user_role parameter
  </done>
</task>

<task type="auto">
  <name>Task 2: Add user:packages:{id} callback handler to VIP router</name>
  <files>bot/handlers/vip/callbacks.py</files>
  <action>
    Add new callback handler in vip/callbacks.py after handle_vip_premium():

    Handler registration:
    ```python
    @vip_callbacks_router.callback_query(lambda c: c.data and c.data.startswith("user:packages:"))
    async def handle_package_detail(callback: CallbackQuery, container):
    ```

    Implementation logic:
    1. Extract package_id: `package_id = int(callback.data.split(":")[-1])`
    2. Fetch package: `package = await container.content.get_package_by_id(package_id)`
    3. If package not found: await callback.answer("‚ö†Ô∏è Paquete no encontrado", show_alert=True); return
    4. Get session context: `session_ctx = container.message.get_session_context(container)`
    5. Generate detail view:
       ```python
       text, keyboard = container.message.user.menu.package_detail_view(
           package=package,
           user_role="VIP",
           user_id=callback.from_user.id,
           session_history=session_ctx
       )
       ```
    6. Update message: `await callback.message.edit_text(text, parse_mode="HTML", reply_markup=keyboard)`
    7. Answer callback: `await callback.answer()`

    Error handling:
    - Wrap in try/except
    - Log errors with user_id and package_id
    - Show user-friendly alert on error

    Place handler after handle_vip_premium(), before handle_vip_status().
  </action>
  <verify>
    1. Confirm callback pattern matches `user:packages:{id}` (with colon, not dash)
    2. Confirm package fetched from ContentService
    3. Confirm package_detail_view() called with user_role="VIP"
    4. Confirm error handling covers package not found and exceptions
    5. Confirm callback.answer() called to remove loading state
  </verify>
  <done>
    VIP router handles user:packages:{id} callbacks
    Fetches package by ID from ContentService
    Displays detail view using package_detail_view()
    Handles errors gracefully with user feedback
  </done>
</task>

<task type="auto">
  <name>Task 3: Add user:packages:{id} callback handler to Free router</name>
  <files>bot/handlers/free/callbacks.py</files>
  <action>
    Add new callback handler in free/callbacks.py after handle_free_content():

    Apply same implementation pattern as Task 2:
    1. Same handler registration pattern: `@free_callbacks_router.callback_query(lambda c: c.data and c.data.startswith("user:packages:"))`
    2. Same extraction logic for package_id
    3. Same error handling structure
    4. Use user_role="Free" when calling package_detail_view()
    5. Same message update pattern

    Mirror VIP handler structure for consistency, only changing user_role parameter.
  </action>
  <verify>
    1. Confirm callback pattern matches VIP handler
    2. Confirm package_detail_view() called with user_role="Free"
    3. Confirm error handling matches VIP handler pattern
    4. Confirm handler placement after handle_free_content()
  </verify>
  <done>
    Free router handles user:packages:{id} callbacks
    Uses user_role="Free" for context-aware messages
    Consistent structure with VIP handler
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
1. Test callback flow: click package button ‚Üí see detail view ‚Üí verify all fields present
2. Verify "Me interesa" button callback format: `user:package:interest:{id}`
3. Verify "Volver" button callback format: `user:packages:back`
4. Confirm detail view works for both VIP and Free users
5. Verify error handling when package_id is invalid
</verification>

<success_criteria>
- package_detail_view() method exists and generates complete detail view
- VIP and Free routers both handle user:packages:{id} callbacks
- Detail view shows name, description, price, category badge
- Detail view has "Me interesa" button with correct callback
- Detail view has "Volver" button (no "Salir" button)
- Error handling for invalid package IDs
</success_criteria>

<output>
After completion, create `.planning/phases/12-rediseno-menu-paquetes-vista-detalles/12-02-SUMMARY.md` with:
- New package_detail_view() method signature and implementation
- Callback handlers added to VIP and Free routers
- Callback pattern documentation
</output>
