---
wave: 1
depends_on: ["21-01"]
files_modified:
  - bot/services/streak.py
  - bot/services/container.py
autonomous: false
---

# 21-02: StreakService - Core Logic

## Goal
Create StreakService with core streak tracking logic including claim validation, streak calculation, and UTC-based day boundaries.

## Tasks

<task>
Create bot/services/streak.py with StreakService class

Constructor:
- Accept session: AsyncSession
- Accept wallet_service: WalletService (for crediting besitos)
- Store logger
</task>

<task>
Implement _get_or_create_streak(user_id, streak_type) method
- Returns existing UserStreak or creates new one
- Uses session.get() with composite key pattern
</task>

<task>
Implement _get_utc_date(dt) helper method
- Returns date portion in UTC
- Used for day boundary calculations
</task>

<task>
Implement can_claim_daily_gift(user_id) method
- Returns (bool, str) tuple
- Checks if user has claimed today (UTC date comparison)
- Returns (True, "available") if can claim
- Returns (False, "already_claimed") if claimed today
- Returns (False, "next_claim_in_Xh_Ym") with time until next claim
</task>

<task>
Implement calculate_streak_bonus(current_streak) method
- Base: 20 besitos
- Bonus: min(current_streak * 2, 50) besitos
- Returns tuple (base, bonus, total)
</task>

<task>
Implement claim_daily_gift(user_id) method
- Returns (success: bool, result: dict)
- Checks if can claim using can_claim_daily_gift
- Calculates streak (increment if consecutive day, reset to 1 if new/missed)
- Calculates besitos (base + streak bonus)
- Credits besitos via wallet_service.earn_besitos()
- Updates UserStreak record
- Returns dict with: success, base_amount, streak_bonus, total, new_streak, longest_streak
</task>

<task>
Implement get_streak_info(user_id, streak_type) method
- Returns dict with current streak info
- Fields: current_streak, longest_streak, last_claim_date, can_claim, next_claim_time
</task>

<task>
Implement reset_streak(user_id, streak_type) method
- Called by background job when streak expires
- Sets current_streak to 0
- Does NOT affect longest_streak (that's historical)
</task>

<task>
Update bot/services/container.py to add streak service
- Add _streak_service = None field
- Add @property def streak(self) with lazy loading
- Inject wallet_service when creating StreakService
- Add "streak" to get_loaded_services()
</task>

## Verification
- [ ] StreakService can be accessed via container.streak
- [ ] can_claim_daily_gift correctly identifies same-day claims
- [ ] Streak increments on consecutive days
- [ ] Streak resets to 1 after missing a day
- [ ] Bonus calculation caps at 50 besitos
- [ ] WalletService integration credits besitos correctly

## Must-Haves for Goal-Backward Verification
1. StreakService tracks daily gift availability per 24h period (STREAK-01)
2. Streak bonus calculation works (base + capped bonus) (STREAK-02)
3. Streak increments for consecutive claims (STREAK-03)
4. Streak resets when missed (STREAK-04)
