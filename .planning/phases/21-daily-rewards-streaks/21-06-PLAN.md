---
wave: 3
depends_on: ["21-02", "21-03"]
files_modified:
  - bot/background/tasks.py
  - bot/services/streak.py
autonomous: false
---

# 21-06: UTC Midnight Background Job

## Goal
Create background job that runs at UTC midnight to handle streak expiration for users who missed a day (STREAK-07).

## Tasks

<task>
Implement process_streak_expirations() method in StreakService
- Find all DAILY_GIFT streaks where last_claim_date < today (UTC)
- Set current_streak = 0 for those records
- Return count of reset streaks
- Log each reset for audit trail
</task>

<task>
Implement process_reaction_streak_expirations() method in StreakService
- Find all REACTION streaks where last_reaction_date < today (UTC)
- Set current_streak = 0 for those records
- Return count of reset reaction streaks
</task>

<task>
Add expire_streaks() background task to bot/background/tasks.py
- Runs at UTC midnight (CronTrigger hour=0, minute=0)
- Uses get_session() context manager
- Calls container.streak.process_streak_expirations()
- Calls container.streak.process_reaction_streak_expirations()
- Logs summary: "X daily streaks reset, Y reaction streaks reset"
</task>

<task>
Register streak expiration job in start_background_tasks()
- Add CronTrigger job at UTC midnight
- Job ID: "expire_streaks"
- Name: "Expiraci√≥n de rachas diarias"
- max_instances=1
</task>

<task>
Add streak reset logging for analytics
- Log user_id and previous streak length for each reset
- This data may be useful for future engagement analysis
</task>

## Verification
- [ ] Background job runs at UTC midnight
- [ ] Daily streaks reset when user missed a day
- [ ] Reaction streaks reset when user missed a day
- [ ] Longest_streak is preserved (not reset)
- [ ] Job appears in scheduler status

## Must-Haves for Goal-Backward Verification
1. Background job runs at UTC midnight (STREAK-07)
2. Streaks reset for users who missed claiming
3. Reaction streaks also handled
