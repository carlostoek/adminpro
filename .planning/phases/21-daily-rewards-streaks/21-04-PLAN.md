---
wave: 2
depends_on: ["21-02"]
files_modified:
  - bot/handlers/user/streak.py
  - bot/handlers/user/__init__.py
  - bot/states/user.py
autonomous: false
---

# 21-04: Daily Gift Handler

## Goal
Create handler for daily gift claim with Lucien's voice and detailed breakdown display.

## Tasks

<task>
Add StreakStates to bot/states/user.py
- daily_gift_confirm: Waiting for user to confirm claim
- daily_gift_claimed: Just claimed, showing countdown
</task>

<task>
Create bot/handlers/user/streak.py handler module

Import requirements:
- Router from aiogram
- FSMContext for state management
- ServiceContainer from bot.services.container
- Lucien voice patterns from docs/guia-estilo.md
</task>

<task>
Implement /daily_gift command handler
- Check if user can claim (via streak_service.can_claim_daily_gift)
- If available: Show claim button with streak preview
- If already claimed: Show countdown to next claim
- Use Lucien's voice (ðŸŽ©) for all messages
</task>

<task>
Implement claim_daily_gift callback handler
- Handle callback_data="claim_daily_gift"
- Call streak_service.claim_daily_gift(user_id)
- On success: Show detailed breakdown
  Format:
  "ðŸŽ© <b>Lucien:</b>
  <i>Ah... Diana ha notado su constancia.</i>

  ðŸ”¥ <b>Racha actual:</b> {streak} dÃ­as
  ðŸ’° <b>Base:</b> {base} besitos
  âœ¨ <b>Bonus por racha:</b> +{bonus} besitos
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ðŸ’Ž <b>Total recibido:</b> {total} besitos

  <i>Excelente elecciÃ³n volver hoy...</i>"
- On already claimed: Show countdown
- On error: Show Lucien error message
</task>

<task>
Implement get_countdown_text(next_claim_time) helper
- Calculate hours and minutes until next claim
- Format: "PrÃ³ximo regalo en 14h 32m"
- Use UTC midnight as reference point
</task>

<task>
Register handlers in bot/handlers/user/__init__.py
- Import streak router
- Include in main user router
</task>

<task>
Register /daily_gift command in bot registration
- Add to command list if using bot.set_my_commands
</task>

## Verification
- [ ] /daily_gift command shows claim button when available
- [ ] Claim button triggers streak_service.claim_daily_gift
- [ ] Success message shows detailed breakdown (base + bonus = total)
- [ ] Already claimed shows countdown timer
- [ ] All messages use Lucien's voice (ðŸŽ©, formal, elegant)

## Must-Haves for Goal-Backward Verification
1. User can claim daily gift once per 24h (STREAK-01)
2. User receives base + streak bonus besitos (STREAK-02)
3. Detailed breakdown shows base, bonus, and total
