---
wave: 3
depends_on: ["21-01", "21-02", "21-03", "21-04", "21-05", "21-06"]
files_modified:
  - tests/unit/services/test_streak.py
  - tests/integration/test_daily_gift.py
autonomous: false
---

# 21-07: Streak System Tests

## Goal
Comprehensive tests for streak functionality including edge cases and integration scenarios.

## Tasks

<task>
Create tests/unit/services/test_streak.py

Test StreakService core methods:
- test_get_or_create_streak_creates_new: Verify new streak creation
- test_get_or_create_streak_returns_existing: Verify retrieval of existing
- test_can_claim_daily_gift_first_time: New user can claim
- test_can_claim_daily_gift_same_day: Cannot claim twice same day
- test_can_claim_daily_gift_next_day: Can claim after UTC midnight
- test_calculate_streak_bonus_no_streak: Base amount only
- test_calculate_streak_bonus_with_streak: Base + bonus
- test_calculate_streak_bonus_max_cap: Bonus capped at 50
- test_claim_daily_gift_increments_streak: Streak goes 0 -> 1 -> 2
- test_claim_daily_gift_resets_after_miss: Streak resets to 1 after gap
- test_get_streak_info_returns_correct_data: All fields present
</task>

<task>
Test reaction streak methods:
- test_record_reaction_new_day_increments: Streak increases on new day
- test_record_reaction_same_day_no_change: No double counting
- test_record_reaction_first_reaction: Creates streak record
- test_get_reaction_streak_returns_correct_value: Retrieval works
</task>

<task>
Create tests/integration/test_daily_gift.py

Integration tests:
- test_daily_gift_full_flow: Claim -> verify balance -> verify streak
- test_daily_gift_wallet_integration: Verify besitos credited via WalletService
- test_daily_gift_cannot_claim_twice: Second claim rejected
- test_daily_gift_streak_persists: Streak survives across sessions
</task>

<task>
Test edge cases:
- test_streak_across_dst_transition: UTC consistency maintained
- test_streak_at_utc_midnight_boundary: Exact midnight handling
- test_concurrent_claims_atomic: No race conditions
- test_streak_with_long_gap: Resets correctly after multiple days
</task>

<task>
Test background job:
- test_expire_streaks_resets_missed: Streaks reset when missed
- test_expire_streaks_preserves_longest: Historical max kept
- test_expire_streaks_skips_current: Today's streaks preserved
</task>

<task>
Verify voice consistency in tests:
- All user-facing messages contain "ðŸŽ©"
- Messages follow Lucien's voice patterns from guia-estilo.md
- Streak display uses "ðŸ”¥" emoji
</task>

## Verification
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] Edge case tests pass
- [ ] Background job tests pass
- [ ] Test coverage > 80% for streak.py

## Must-Haves for Goal-Backward Verification
1. All 7 requirements (STREAK-01 through STREAK-07) have test coverage
2. Edge cases (DST, midnight boundary, concurrency) tested
3. Voice consistency verified in message tests
