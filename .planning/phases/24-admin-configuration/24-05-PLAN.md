---
phase: 24-admin-configuration
plan: 05
type: execute
wave: 2
depends_on: ["24-04"]
files_modified:
  - bot/handlers/admin/user_gamification.py
  - bot/handlers/admin/__init__.py
autonomous: true

must_haves:
  truths:
    - Admin can search for user by ID or username
    - Admin can view user's complete gamification profile
    - Profile includes balance, total earned, total spent, level
    - Profile includes streak information (daily gift, reaction)
    - Profile includes recent transaction history
    - Profile includes rewards status
    - Profile includes shop purchases
  artifacts:
    - path: "bot/handlers/admin/user_gamification.py"
      provides: "Admin handlers for user gamification profile viewing"
      contains: ["admin:user:lookup", "admin:user:profile", "admin:user:transactions", "admin:user:rewards"]
    - path: "bot/handlers/admin/__init__.py"
      provides: "Router registration"
      contains: ["user_gamification"]
  key_links:
    - from: "bot/handlers/admin/user_gamification.py"
      to: "bot/services/wallet.py"
      via: "WalletService for profile and transactions"
      pattern: "container.wallet"
    - from: "bot/handlers/admin/user_gamification.py"
      to: "bot/services/streak.py"
      via: "StreakService for streak info"
      pattern: "container.streak"
    - from: "bot/handlers/admin/user_gamification.py"
      to: "bot/services/reward.py"
      via: "RewardService for user rewards"
      pattern: "container.reward"
    - from: "bot/handlers/admin/user_gamification.py"
      to: "bot/services/shop.py"
      via: "ShopService for purchase history"
      pattern: "container.shop"
---

<objective>
Implement user gamification profile viewer for admin (ADMIN-08).

Purpose: Allow administrators to view any user's complete gamification profile including balance, streaks, history, rewards, and purchases.
Output: User gamification profile handlers with search and detailed view functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@bot/services/wallet.py
@bot/services/streak.py
@bot/services/reward.py
@bot/services/shop.py
@bot/handlers/admin/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create User Gamification Profile Handler</name>
  <files>bot/handlers/admin/user_gamification.py</files>
  <action>
Create bot/handlers/admin/user_gamification.py with handlers for user gamification profile viewing:

**Imports:**
- Import logging, aiogram (F, CallbackQuery, Message)
- Import admin_router from bot.handlers.admin.main
- Import ServiceContainer from bot.services.container
- Import create_inline_keyboard from bot.utils.keyboards
- Import StreakType from bot.database.enums
- Import select from sqlalchemy
- Import User from bot.database.models

**User Lookup Handler (admin:user:lookup):**
- Callback handler for "admin:user:lookup"
- Initialize FSM: UserLookupState.waiting_for_user
- Prompt: "ğŸ© Ingrese ID de usuario o @username:"
- Keyboard: "ğŸ”™ Cancelar" -> admin:main

**Process User Input (state: waiting_for_user):**
- Parse input:
  - If numeric: treat as user_id
  - If starts with @: treat as username (without @)
  - Else: treat as username
- Query User table:
  ```python
  if input_text.isdigit():
      result = await session.execute(
          select(User).where(User.user_id == int(input_text))
      )
  else:
      username = input_text.lstrip('@')
      result = await session.execute(
          select(User).where(User.username == username)
      )
  user = result.scalar_one_or_none()
  ```
- If not found: show error, stay in state
- If found: clear state, redirect to profile view

**User Profile Handler (admin:user:profile:{user_id}):**
- Gather all user data:
  ```python
  # Profile
  profile = await container.wallet.get_profile(user_id)

  # Streaks
  daily_streak = await container.streak.get_streak_info(user_id, StreakType.DAILY_GIFT)
  reaction_streak = await container.streak.get_streak_info(user_id, StreakType.REACTION)

  # Stats
  reward_stats = await container.reward.get_user_reward_stats(user_id)
  shop_stats = await container.shop.get_user_shop_stats(user_id)
  ```

- Format message with Lucien's voice (ğŸ©):
  ```
  ğŸ© <b>Perfil de GamificaciÃ³n</b>

  <b>ğŸ‘¤ Usuario:</b> {user.full_name}
  <b>ID:</b> <code>{user.user_id}</code>
  <b>Username:</b> @{user.username or 'N/A'}
  <b>Rol:</b> {user.role}

  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â”ƒ <b>ğŸ’° ECONOMÃA</b>
  â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â”ƒ Balance: <b>{balance}</b> ğŸ’°
  â”ƒ Total ganado: {total_earned} ğŸ’°
  â”ƒ Total gastado: {total_spent} ğŸ’°
  â”ƒ Nivel: <b>{level}</b> â­
  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â”ƒ <b>ğŸ”¥ RACHAS</b>
  â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â”ƒ Regalo diario: <b>{daily_streak['current_streak']}</b> dÃ­as
  â”ƒ   (RÃ©cord: {daily_streak['longest_streak']})
  â”ƒ Reacciones: <b>{reaction_streak['current_streak']}</b> dÃ­as
  â”ƒ   (RÃ©cord: {reaction_streak['longest_streak']})
  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â”ƒ <b>ğŸ† RECOMPENSAS</b>
  â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â”ƒ Desbloqueadas: {reward_stats['total_unlocked']}
  â”ƒ Reclamadas: {reward_stats['total_claimed']}
  â”ƒ Disponibles: {reward_stats['currently_unlocked']}
  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â”ƒ <b>ğŸ›ï¸ TIENDA</b>
  â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â”ƒ Compras: {shop_stats['total_purchases']}
  â”ƒ Gastado: {shop_stats['total_besitos_spent']} ğŸ’°
  â”ƒ Contenido: {shop_stats['unique_content_owned']} items
  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ```

- Keyboard:
  - "ğŸ“œ Transacciones" -> admin:user:transactions:{user_id}
  - "ğŸ† Recompensas" -> admin:user:rewards:{user_id}
  - "ğŸ›ï¸ Compras" -> admin:user:purchases:{user_id}
  - "ğŸ” Otro Usuario" -> admin:user:lookup
  - "ğŸ”™ Volver" -> admin:main

**Transactions Handler (admin:user:transactions:{user_id}):**
- Get paginated transaction history:
  ```python
  transactions, total = await container.wallet.get_transaction_history(
      user_id=user_id, page=page, per_page=10
  )
  ```
- Format:
  ```
  ğŸ© <b>Historial de Transacciones</b>
  Usuario: {user_id} | PÃ¡gina {page}/{total_pages}

  {for each transaction}
  {emoji} {amount} ğŸ’° - {type}
  <i>{reason}</i>
  {date}
  ---
  ```
  - Earn emoji: â• (green)
  - Spend emoji: â– (red)
- Keyboard:
  - "â¬…ï¸" / "â¡ï¸" for pagination
  - "ğŸ”™ Perfil" -> admin:user:profile:{user_id}

**Rewards Handler (admin:user:rewards:{user_id}):**
- Get available rewards:
  ```python
  rewards = await container.reward.get_available_rewards(user_id, include_secret=True)
  ```
- Format:
  ```
  ğŸ© <b>Recompensas del Usuario</b>

  <b>Disponibles para reclamar:</b>
  {list unlocked rewards}

  <b>Bloqueadas:</b>
  {list locked rewards with progress}

  <b>Reclamadas:</b>
  {list claimed rewards}
  ```
- Show status emoji: ğŸ”“ Unlocked, ğŸ”’ Locked, âœ… Claimed, â° Expired
- Keyboard: "ğŸ”™ Perfil" -> admin:user:profile:{user_id}

**Purchases Handler (admin:user:purchases:{user_id}):**
- Get purchase history:
  ```python
  purchases, total = await container.shop.get_purchase_history(
      user_id=user_id, page=page, per_page=10
  )
  ```
- Format:
  ```
  ğŸ© <b>Historial de Compras</b>
  Usuario: {user_id} | PÃ¡gina {page}/{total_pages}

  {for each purchase}
  ğŸ›ï¸ {product_name}
  ğŸ’° {besitos_paid} besitos
  ğŸ“… {date}
  ---
  ```
- Keyboard:
  - "â¬…ï¸" / "â¡ï¸" for pagination
  - "ğŸ”™ Perfil" -> admin:user:profile:{user_id}

**States Class (add to bot/states/admin.py):**
```python
class UserLookupState(StatesGroup):
    """States for user lookup flow."""
    waiting_for_user = State()
```

**Helper Functions:**
- format_transaction_type(type) -> str: Human-readable transaction types
- format_datetime(dt) -> str: Format datetime for display
- get_user_by_id_or_username(session, input_text) -> Optional[User]
  </action>
  <verify>grep -q "admin:user:lookup" bot/handlers/admin/user_gamification.py && grep -q "UserLookupState" bot/states/admin.py</verify>
  <done>User gamification handlers exist with profile view, transactions, rewards, and purchases</done>
</task>

<task type="auto">
  <name>Task 2: Register Router and Add Menu Button</name>
  <files>
    - bot/handlers/admin/__init__.py
    - bot/handlers/admin/main.py
  </files>
  <action>
1. Update bot/handlers/admin/__init__.py:
   - Import user_gamification router
   - Include it in admin_router

2. Update bot/handlers/admin/main.py admin menu:
   - Add "ğŸ‘¤ Buscar Usuario" button to main admin menu
   - Callback data: "admin:user:lookup"
   - Position in user management section

3. Update bot/handlers/admin/main.py callback_admin_config:
   - Add link to user lookup if appropriate
  </action>
  <verify>grep -q "user_gamification" bot/handlers/admin/__init__.py && grep -q "admin:user:lookup" bot/handlers/admin/main.py</verify>
  <done>User gamification router registered and menu button added</done>
</task>

</tasks>

<verification>
- User lookup accepts ID or username
- Profile view shows complete gamification data
- Transactions view shows paginated history
- Rewards view shows status of all rewards
- Purchases view shows shop history
- Navigation between views works correctly
- All operations use Lucien's voice (ğŸ©)
</verification>

<success_criteria>
- Admin can search for user by ID or username
- Admin can view user's gamification profile (balance, level, totals)
- Admin can view user's streaks (daily gift, reaction)
- Admin can view user's transaction history (paginated)
- Admin can view user's rewards status
- Admin can view user's shop purchases
- All data pulled from appropriate services
- Lucien's voice used for all messages
</success_criteria>

<output>
After completion, create `.planning/phases/24-admin-configuration/24-05-SUMMARY.md`
</output>
