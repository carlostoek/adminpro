---
phase: 24-admin-configuration
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/handlers/admin/reward_management.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - Reward delete confirmation dialog displays without Telegram API error
    - "message is not modified" exception is handled gracefully
    - Delete flow works even when message content would be identical
  artifacts:
    - path: "bot/handlers/admin/reward_management.py"
      provides: "Fixed callback_reward_delete handler"
      pattern: "TelegramBadRequest.*message is not modified"
  key_links:
    - from: "callback_reward_delete"
      to: "callback.message.edit_text"
      via: "try-except TelegramBadRequest"
---

<objective>
Fix TelegramBadRequest error in reward delete confirmation dialog.

Purpose: When admin clicks delete on a reward, the handler tries to edit the message but fails with "message is not modified" error because the confirmation dialog content may be identical to the reward details view.

Output: Fixed handler with proper exception handling.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/24-admin-configuration/24-UAT.md
@bot/handlers/admin/reward_management.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TelegramBadRequest import and fix exception handling</name>
  <files>bot/handlers/admin/reward_management.py</files>
  <action>
Fix the callback_reward_delete handler at line 712 in bot/handlers/admin/reward_management.py.

1. Add import at top of file (if not already present):
   ```python
   from aiogram.exceptions import TelegramBadRequest
   ```

2. Locate the callback_reward_delete function (around line 690-713):
   ```python
   @reward_router.callback_query(F.data.startswith("admin:reward:delete:"))
   async def callback_reward_delete(callback: CallbackQuery, session: AsyncSession):
   ```

3. Wrap the edit_text call in try-except to handle "message is not modified" error:

   Current code (around line 712):
   ```python
   await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
   await callback.answer()
   ```

   Replace with:
   ```python
   try:
       await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
   except TelegramBadRequest as e:
       if "message is not modified" in str(e).lower():
           # Message content identical, just answer callback
           pass
       else:
           # Re-raise other Telegram errors
           raise
   await callback.answer()
   ```

This follows the same pattern used in other handlers:
- bot/handlers/user/reactions.py line 224-228
- bot/handlers/admin/management.py line 221-225
- bot/handlers/admin/vip.py line 78-82
  </action>
  <verify>
grep -n "TelegramBadRequest" bot/handlers/admin/reward_management.py
grep -n "message is not modified" bot/handlers/admin/reward_management.py
  </verify>
  <done>TelegramBadRequest imported and handled in callback_reward_delete</done>
</task>

<task type="auto">
  <name>Task 2: Verify other edit_text calls in reward_management.py</name>
  <files>bot/handlers/admin/reward_management.py</files>
  <action>
Check all other edit_text calls in reward_management.py for similar issues and add exception handling where needed.

Search for all edit_text calls:
```bash
grep -n "edit_text" bot/handlers/admin/reward_management.py
```

For each edit_text that could potentially have identical content (especially in confirmation flows), add the same try-except pattern.

Key locations to check:
1. callback_reward_delete (already fixed in Task 1)
2. Any other delete confirmation handlers
3. Toggle status handlers that might show same content

The pattern to apply:
```python
try:
    await callback.message.edit_text(text=text, reply_markup=keyboard, parse_mode="HTML")
except TelegramBadRequest as e:
    if "message is not modified" in str(e).lower():
        pass  # Ignore identical content error
    else:
        raise
```
  </action>
  <verify>grep -c "except TelegramBadRequest" bot/handlers/admin/reward_management.py</verify>
  <done>All vulnerable edit_text calls have exception handling</done>
</task>

</tasks>

<verification>
1. TelegramBadRequest is imported from aiogram.exceptions
2. callback_reward_delete has try-except around edit_text
3. "message is not modified" is checked case-insensitively
4. Other TelegramBadRequest errors are re-raised
</verification>

<success_criteria>
- Admin can click delete on a reward without error
- Confirmation dialog displays correctly
- If message content is identical, error is silently ignored
- Other Telegram errors are still raised properly
</success_criteria>

<output>
After completion, create `.planning/phases/24-admin-configuration/24-07-SUMMARY.md`
</output>
