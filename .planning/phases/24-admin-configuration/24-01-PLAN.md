---
phase: 24-admin-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/handlers/admin/economy_config.py
  - bot/handlers/admin/__init__.py
autonomous: true

must_haves:
  truths:
    - Admin can view current economy configuration values
    - Admin can update besitos per reaction value
    - Admin can update besitos for daily gift value
    - Admin can update streak bonus value
    - Admin can update max reactions per day limit
    - All changes are validated (positive integers only)
  artifacts:
    - path: "bot/handlers/admin/economy_config.py"
      provides: "Admin handlers for economy configuration"
      contains: ["admin:economy_config", "admin:economy:set_besitos_reaction", "admin:economy:set_daily_gift", "admin:economy:set_streak_bonus", "admin:economy:set_max_reactions"]
    - path: "bot/handlers/admin/__init__.py"
      provides: "Router registration for economy config handlers"
      contains: ["economy_config"]
  key_links:
    - from: "bot/handlers/admin/economy_config.py"
      to: "bot/services/config.py"
      via: "ConfigService methods"
      pattern: "container.config.set_besitos_per_reaction|set_besitos_daily_gift|set_besitos_daily_streak_bonus|set_max_reactions_per_day"
---

<objective>
Implement admin handlers for configuring economy values (ADMIN-01, ADMIN-02).

Purpose: Allow administrators to configure besitos earning rates and daily limits through the Telegram bot interface.
Output: Economy configuration handlers with inline keyboard navigation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@bot/services/config.py
@bot/handlers/admin/main.py
@bot/handlers/admin/dashboard.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Economy Config Handler Module</name>
  <files>bot/handlers/admin/economy_config.py</files>
  <action>
Create bot/handlers/admin/economy_config.py with handlers for economy configuration:

**Imports and Router:**
- Import logging, aiogram (F, CallbackQuery), sqlalchemy (AsyncSession)
- Import admin_router from bot.handlers.admin.main
- Import ServiceContainer from bot.services.container
- Import create_inline_keyboard from bot.utils.keyboards

**Main Handler (admin:economy_config):**
- Callback handler for "admin:economy_config" data
- Display current economy configuration:
  - Besitos per reaction (default: 5)
  - Besitos for daily gift (default: 50)
  - Streak bonus per day (default: 10)
  - Max reactions per day (default: 20)
- Use ConfigService getters: get_besitos_per_reaction(), get_besitos_daily_gift(), get_besitos_daily_streak_bonus(), get_max_reactions_per_day()
- Format message with Lucien's voice (üé©):
  ```
  üé© <b>Configuraci√≥n de Econom√≠a</b>

  <b>Valores Actuales:</b>
  üí∞ Besitos por reacci√≥n: <b>{value}</b>
  üéÅ Besitos regalo diario: <b>{value}</b>
  üî• Bonus por racha: <b>{value}</b>
  ‚ö° M√°x. reacciones/d√≠a: <b>{value}</b>

  <i>Seleccione un valor para modificar...</i>
  ```
- Keyboard with 4 buttons (2x2 grid):
  - "üí∞ Reacci√≥n" -> admin:economy:edit:reaction
  - "üéÅ Regalo" -> admin:economy:edit:daily
  - "üî• Racha" -> admin:economy:edit:streak
  - "‚ö° L√≠mite" -> admin:economy:edit:limit
  - "üîô Volver" -> admin:config

**Edit Handlers (FSM pattern):**
Create handlers for each configuration value using FSM (Finite State Machine) states:

1. **Reaction Handler:**
   - Callback: "admin:economy:edit:reaction"
   - Prompt user: "üé© Ingrese la cantidad de besitos por reacci√≥n (n√∫mero positivo):"
   - Use FSM state: EconomyConfigState.waiting_for_reaction_value
   - On message: validate integer > 0, call container.config.set_besitos_per_reaction(value)
   - Show success/error message with result
   - Return to economy config menu

2. **Daily Gift Handler:**
   - Callback: "admin:economy:edit:daily"
   - Prompt: "üé© Ingrese los besitos para regalo diario base (n√∫mero positivo):"
   - State: EconomyConfigState.waiting_for_daily_value
   - Validate and call set_besitos_daily_gift()

3. **Streak Bonus Handler:**
   - Callback: "admin:economy:edit:streak"
   - Prompt: "üé© Ingrese el bonus por d√≠a de racha (n√∫mero positivo):"
   - State: EconomyConfigState.waiting_for_streak_value
   - Validate and call set_besitos_daily_streak_bonus()

4. **Max Reactions Handler:**
   - Callback: "admin:economy:edit:limit"
   - Prompt: "üé© Ingrese el m√°ximo de reacciones por d√≠a (n√∫mero positivo):"
   - State: EconomyConfigState.waiting_for_limit_value
   - Validate and call set_max_reactions_per_day()

**Validation:**
- All values must be positive integers (> 0)
- Show error message with Lucien's voice if invalid: "üé© <b>Valor inv√°lido</b> - Debe ser un n√∫mero entero positivo."
- On success: "üé© <b>Configuraci√≥n actualizada</b> - El valor ha sido modificado."

**Error Handling:**
- Try-except around all DB operations
- Log errors with context
- Show user-friendly error messages
  </action>
  <verify>grep -q "admin:economy_config" bot/handlers/admin/economy_config.py && grep -q "set_besitos_per_reaction" bot/handlers/admin/economy_config.py</verify>
  <done>Economy config handlers exist with all 4 configuration options and FSM states</done>
</task>

<task type="auto">
  <name>Task 2: Add Economy Config States</name>
  <files>bot/states/admin.py</files>
  <action>
Add FSM states for economy configuration to bot/states/admin.py:

**New States Class:**
```python
class EconomyConfigState(StatesGroup):
    """States for economy configuration flow."""
    waiting_for_reaction_value = State()
    waiting_for_daily_value = State()
    waiting_for_streak_value = State()
    waiting_for_limit_value = State()
```

Add this after existing admin states. Import StatesGroup from aiogram.fsm.state if not already imported.
  </action>
  <verify>grep -q "class EconomyConfigState" bot/states/admin.py</verify>
  <done>EconomyConfigState states group exists with 4 waiting states</done>
</task>

<task type="auto">
  <name>Task 3: Register Router and Add Menu Button</name>
  <files>
    - bot/handlers/admin/__init__.py
    - bot/handlers/admin/main.py
  </files>
  <action>
1. Update bot/handlers/admin/__init__.py:
   - Import economy_config router
   - Include it in admin_router

2. Update bot/handlers/admin/main.py callback_admin_config:
   - Add "üí∞ Econom√≠a" button to the config menu keyboard
   - Callback data: "admin:economy_config"
   - Position: After "Reacciones" button, before "Volver"

The config menu should show:
- "Reacciones" -> config:reactions
- "üí∞ Econom√≠a" -> admin:economy_config
- "üîô Volver" -> admin:main
  </action>
  <verify>grep -q "economy_config" bot/handlers/admin/__init__.py && grep -q "admin:economy_config" bot/handlers/admin/main.py</verify>
  <done>Economy config router registered and menu button added</done>
</task>

</tasks>

<verification>
- Economy config handlers respond to admin:economy_config callback
- All 4 configuration values can be viewed and modified
- FSM states properly manage the input flow
- Validation rejects non-positive integers
- Changes persist to database via ConfigService
- Menu integration works correctly
</verification>

<success_criteria>
- Admin can view current economy configuration
- Admin can update besitos per reaction
- Admin can update daily gift besitos
- Admin can update streak bonus
- Admin can update max reactions per day
- All values validated as positive integers
- Lucien's voice (üé©) used for all messages
</success_criteria>

<output>
After completion, create `.planning/phases/24-admin-configuration/24-01-SUMMARY.md`
</output>
