---
phase: 24-admin-configuration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/handlers/admin/shop_management.py
  - bot/handlers/admin/__init__.py
autonomous: true

must_haves:
  truths:
    - Admin can view list of shop products
    - Admin can create new shop product with name, description, price, tier
    - Admin can toggle product active/inactive status
    - Admin can view product details
    - Products link to ContentSet for fulfillment
  artifacts:
    - path: "bot/handlers/admin/shop_management.py"
      provides: "Admin handlers for shop product management"
      contains: ["admin:shop", "admin:shop:create", "admin:shop:toggle", "admin:shop:details"]
    - path: "bot/handlers/admin/__init__.py"
      provides: "Router registration for shop management"
      contains: ["shop_management"]
  key_links:
    - from: "bot/handlers/admin/shop_management.py"
      to: "bot/services/shop.py"
      via: "ShopService for product operations"
      pattern: "container.shop"
    - from: "bot/handlers/admin/shop_management.py"
      to: "bot/database/models.py"
      via: "ShopProduct and ContentSet models"
      pattern: "ShopProduct|ContentSet"
---

<objective>
Implement admin handlers for shop product management (ADMIN-03, ADMIN-04).

Purpose: Allow administrators to create shop products with besitos pricing and enable/disable products.
Output: Shop management handlers with product creation flow and toggle functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@bot/services/shop.py
@bot/database/models.py
@bot/handlers/admin/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Shop Management Handler Module</name>
  <files>bot/handlers/admin/shop_management.py</files>
  <action>
Create bot/handlers/admin/shop_management.py with handlers for shop product management:

**Imports:**
- Import logging, aiogram (F, CallbackQuery, Message)
- Import admin_router from bot.handlers.admin.main
- Import ServiceContainer from bot.services.container
- Import create_inline_keyboard from bot.utils.keyboards
- Import ContentTier from bot.database.enums
- Import select from sqlalchemy

**Main Menu Handler (admin:shop):**
- Callback handler for "admin:shop"
- Display shop management menu with Lucien's voice (üé©):
  ```
  üé© <b>Gesti√≥n de Tienda</b>

  <b>Acciones disponibles:</b>
  ‚Ä¢ Crear nuevo producto
  ‚Ä¢ Ver/Editar productos existentes
  ‚Ä¢ Activar/Desactivar productos

  <i>Seleccione una opci√≥n...</i>
  ```
- Keyboard:
  - "‚ûï Crear Producto" -> admin:shop:create:start
  - "üìã Listar Productos" -> admin:shop:list
  - "üîô Volver" -> admin:main

**List Products Handler (admin:shop:list):**
- Show paginated list of products (5 per page)
- For each product show: name, price, tier, status (active/inactive)
- Format: "{emoji} {name} - {price}üí∞ ({tier}) {status_emoji}"
  - Active: üü¢, Inactive: üî¥
  - Tier: FREE=‚ö™, VIP=üü°, PREMIUM=üî¥
- Buttons per product:
  - "{name}" -> admin:shop:details:{product_id}
  - "üîÑ" (toggle) -> admin:shop:toggle:{product_id}
- Navigation: "‚¨ÖÔ∏è" "‚û°Ô∏è" for pagination
- "üîô Volver" -> admin:shop

**Product Details Handler (admin:shop:details:{id}):**
- Show full product information:
  ```
  üé© <b>Detalles del Producto</b>

  <b>Nombre:</b> {name}
  <b>Descripci√≥n:</b> {description}
  <b>Precio:</b> {besitos_price} besitos
  <b>Precio VIP:</b> {vip_price} besitos
  <b>Tier:</b> {tier}
  <b>Estado:</b> {active/inactive}
  <b>Compras:</b> {purchase_count}
  <b>ContentSet:</b> {content_set_name} ({file_count} archivos)
  ```
- Keyboard:
  - "üîÑ {Activate|Deactivate}" -> admin:shop:toggle:{id}
  - "üîô Lista" -> admin:shop:list

**Toggle Product Handler (admin:shop:toggle:{id}):**
- Toggle is_active status for product
- Use direct SQLAlchemy query:
  ```python
  result = await session.execute(
      select(ShopProduct).where(ShopProduct.id == product_id)
  )
  product = result.scalar_one_or_none()
  if product:
      product.is_active = not product.is_active
      await session.commit()
  ```
- Show confirmation message with new status
- Return to product list

**Create Product Flow (FSM):**

1. **Start (admin:shop:create:start):**
   - Initialize FSM state: ShopCreateState.waiting_for_name
   - Prompt: "üé© Ingrese el nombre del producto:"

2. **Name Input (state: waiting_for_name):**
   - Validate: non-empty, max 200 chars
   - Store in FSM data
   - Next state: waiting_for_description
   - Prompt: "üé© Ingrese la descripci√≥n:"

3. **Description Input (state: waiting_for_description):**
   - Validate: max 1000 chars
   - Store in FSM data
   - Next state: waiting_for_price
   - Prompt: "üé© Ingrese el precio en besitos (n√∫mero positivo):"

4. **Price Input (state: waiting_for_price):**
   - Validate: positive integer
   - Store in FSM data
   - Next state: waiting_for_tier
   - Show tier selection keyboard:
     - "‚ö™ FREE" -> tier:free
     - "üü° VIP" -> tier:vip
     - "üî¥ PREMIUM" -> tier:premium

5. **Tier Selection (callback: tier:{value}):**
   - Store tier in FSM data
   - Next state: waiting_for_content_set
   - Show ContentSet selection:
     - Query active ContentSets
     - Show as buttons: "{name} ({file_count} files)" -> content_set:{id}
     - "‚ûï Crear Nuevo ContentSet" -> content_set:create (optional)

6. **ContentSet Selection (state: waiting_for_content_set):**
   - Validate ContentSet exists
   - Store in FSM data
   - Show summary and confirm:
     ```
     üé© <b>Confirmar Creaci√≥n</b>

     <b>Nombre:</b> {name}
     <b>Precio:</b> {price} besitos
     <b>Tier:</b> {tier}
     <b>ContentSet:</b> {content_set_name}

     <i>¬øCrear este producto?</i>
     ```
   - Keyboard: "‚úÖ Confirmar" / "‚ùå Cancelar"

7. **Confirm Creation:**
   - Create ShopProduct with FSM data
   - Set is_active=True by default
   - Calculate vip_price = price * 0.8 (20% discount default)
   - Clear FSM state
   - Show success message
   - Return to shop menu

**States Class (add to bot/states/admin.py):**
```python
class ShopCreateState(StatesGroup):
    """States for shop product creation flow."""
    waiting_for_name = State()
    waiting_for_description = State()
    waiting_for_price = State()
    waiting_for_tier = State()
    waiting_for_content_set = State()
    waiting_for_confirmation = State()
```

**Error Handling:**
- All DB operations in try-except
- Log errors with context
- User-friendly error messages with Lucien's voice
  </action>
  <verify>grep -q "admin:shop" bot/handlers/admin/shop_management.py && grep -q "ShopCreateState" bot/states/admin.py</verify>
  <done>Shop management handlers exist with product creation FSM and toggle functionality</done>
</task>

<task type="auto">
  <name>Task 2: Register Shop Router and Add Menu Button</name>
  <files>
    - bot/handlers/admin/__init__.py
    - bot/handlers/admin/main.py
  </files>
  <action>
1. Update bot/handlers/admin/__init__.py:
   - Import shop_management router
   - Include it in admin_router

2. Update bot/handlers/admin/main.py admin menu:
   - Add "üõçÔ∏è Tienda" button to main admin menu
   - Callback data: "admin:shop"
   - Position in appropriate section (after VIP management)

3. Update bot/handlers/admin/main.py callback_admin_config:
   - Add shop management link if needed, or rely on main menu
  </action>
  <verify>grep -q "shop_management" bot/handlers/admin/__init__.py && grep -q "admin:shop" bot/handlers/admin/main.py</verify>
  <done>Shop router registered and menu button added</done>
</task>

</tasks>

<verification>
- Shop menu displays correctly with Lucien's voice
- Product list shows all products with pagination
- Product creation flow works through all FSM states
- Toggle activation works and persists
- Product details show complete information
- ContentSet linking works correctly
</verification>

<success_criteria>
- Admin can view paginated list of shop products
- Admin can create new product with name, description, price, tier, ContentSet
- Admin can toggle product active/inactive status
- Admin can view detailed product information
- All operations use Lucien's voice (üé©)
- FSM properly manages creation flow
</success_criteria>

<output>
After completion, create `.planning/phases/24-admin-configuration/24-02-SUMMARY.md`
</output>
