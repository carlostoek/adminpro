---
phase: 24-admin-configuration
plan: 03
type: execute
wave: 2
depends_on: ["24-02"]
files_modified:
  - bot/handlers/admin/reward_management.py
  - bot/handlers/admin/__init__.py
autonomous: true

must_haves:
  truths:
    - Admin can view list of rewards
    - Admin can create new reward with name, description, type, value
    - Admin can create conditions inline during reward creation
    - Admin can toggle reward active/inactive status
    - Conditions support AND/OR logic with groups
  artifacts:
    - path: "bot/handlers/admin/reward_management.py"
      provides: "Admin handlers for reward and condition management"
      contains: ["admin:rewards", "admin:reward:create", "admin:reward:condition:add", "admin:reward:toggle"]
    - path: "bot/handlers/admin/__init__.py"
      provides: "Router registration for reward management"
      contains: ["reward_management"]
  key_links:
    - from: "bot/handlers/admin/reward_management.py"
      to: "bot/database/models.py"
      via: "Reward and RewardCondition models"
      pattern: "Reward|RewardCondition"
    - from: "bot/handlers/admin/reward_management.py"
      to: "bot/database/enums.py"
      via: "RewardType, RewardConditionType, RewardStatus"
      pattern: "RewardType|RewardConditionType"
---

<objective>
Implement admin handlers for reward and condition management (ADMIN-05, ADMIN-06).

Purpose: Allow administrators to create rewards with cascading condition creation and inline condition management.
Output: Reward management handlers with integrated condition creation flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@bot/database/models.py
@bot/database/enums.py
@bot/services/reward.py
@bot/handlers/admin/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Reward Management Handler Module</name>
  <files>bot/handlers/admin/reward_management.py</files>
  <action>
Create bot/handlers/admin/reward_management.py with handlers for reward and condition management:

**Imports:**
- Import logging, aiogram (F, CallbackQuery, Message)
- Import admin_router from bot.handlers.admin.main
- Import ServiceContainer from bot.services.container
- Import create_inline_keyboard from bot.utils.keyboards
- Import RewardType, RewardConditionType from bot.database.enums
- Import Reward, RewardCondition from bot.database.models
- Import select from sqlalchemy

**Main Menu Handler (admin:rewards):**
- Callback handler for "admin:rewards"
- Display reward management menu with Lucien's voice (üé©):
  ```
  üé© <b>Gesti√≥n de Recompensas</b>

  <b>Acciones disponibles:</b>
  ‚Ä¢ Crear nueva recompensa
  ‚Ä¢ Ver/Editar recompensas
  ‚Ä¢ Gestionar condiciones

  <i>Seleccione una opci√≥n...</i>
  ```
- Keyboard:
  - "‚ûï Crear Recompensa" -> admin:reward:create:start
  - "üìã Listar Recompensas" -> admin:reward:list
  - "üîô Volver" -> admin:main

**List Rewards Handler (admin:reward:list):**
- Show paginated list of rewards (5 per page)
- For each reward show: name, type emoji, status, condition count
- Format: "{type_emoji} {name} {status_emoji} ({conditions} cond.)"
  - Type emojis: BESITOS=üí∞, CONTENT=üéÅ, BADGE=üèÜ, VIP_EXTENSION=‚≠ê
  - Active: üü¢, Inactive: üî¥, Secret: üîí
- Buttons per reward:
  - "{name}" -> admin:reward:details:{reward_id}
  - "üîÑ" (toggle) -> admin:reward:toggle:{reward_id}
- Navigation: "‚¨ÖÔ∏è" "‚û°Ô∏è" for pagination
- "üîô Volver" -> admin:rewards

**Reward Details Handler (admin:reward:details:{id}):**
- Show full reward information:
  ```
  üé© <b>Detalles de Recompensa</b>

  <b>Nombre:</b> {name}
  <b>Descripci√≥n:</b> {description}
  <b>Tipo:</b> {type_emoji} {type}
  <b>Valor:</b> {formatted_value}
  <b>Repetible:</b> {s√≠/no}
  <b>Secreta:</b> {s√≠/no}
  <b>Ventana:</b> {hours} horas
  <b>Estado:</b> {active/inactive}
  <b>Orden:</b> {sort_order}

  <b>Condiciones ({count}):</b>
  {list of conditions with type and value}
  ```
- Keyboard:
  - "‚ûï Agregar Condici√≥n" -> admin:reward:condition:add:{id}
  - "üîÑ {Activar|Desactivar}" -> admin:reward:toggle:{id}
  - "üóëÔ∏è Eliminar" -> admin:reward:delete:{id} (with confirmation)
  - "üîô Lista" -> admin:reward:list

**Toggle Reward Handler (admin:reward:toggle:{id}):**
- Toggle is_active status
- Show confirmation with new status
- Return to reward list or details

**Create Reward Flow (FSM):**

1. **Start (admin:reward:create:start):**
   - Initialize FSM: RewardCreateState.waiting_for_name
   - Prompt: "üé© Ingrese el nombre de la recompensa:"

2. **Name Input (state: waiting_for_name):**
   - Validate: non-empty, max 200 chars
   - Store in FSM data
   - Next state: waiting_for_description
   - Prompt: "üé© Ingrese la descripci√≥n:"

3. **Description Input (state: waiting_for_description):**
   - Validate: max 1000 chars
   - Store in FSM data
   - Next state: waiting_for_type
   - Show type selection:
     - "üí∞ Besitos" -> reward_type:besitos
     - "üéÅ Contenido" -> reward_type:content
     - "üèÜ Insignia" -> reward_type:badge
     - "‚≠ê Extensi√≥n VIP" -> reward_type:vip_extension

4. **Type Selection (callback: reward_type:{type}):**
   - Store type in FSM data
   - Next state depends on type:
     - BESITOS -> waiting_for_besitos_amount
     - CONTENT -> waiting_for_content_set
     - BADGE -> waiting_for_badge_name
     - VIP_EXTENSION -> waiting_for_vip_days

5. **Value Input (type-specific states):**
   - **waiting_for_besitos_amount:**
     - Prompt: "üé© Ingrese cantidad de besitos (10-1000):"
     - Validate: integer between 10-1000
     - Store: {"amount": value}

   - **waiting_for_content_set:**
     - Show ContentSet selection list
     - Store: {"content_set_id": value}

   - **waiting_for_badge_name:**
     - Prompt: "üé© Ingrese nombre de la insignia:"
     - Then: "üé© Ingrese emoji de la insignia (ej: üî•):"
     - Store: {"badge_name": name, "emoji": emoji}

   - **waiting_for_vip_days:**
     - Prompt: "üé© Ingrese d√≠as de extensi√≥n VIP (1-30):"
     - Validate: 1-30
     - Store: {"days": value}

6. **Behavior Configuration (state: waiting_for_behavior):**
   - After value input, show behavior options:
   - "¬øEs repetible?" -> Buttons: "S√≠" / "No"
   - "¬øEs secreta?" -> Buttons: "S√≠" / "No"
   - "Ventana de reclamo (horas):" -> Buttons: "24h" / "72h" / "168h (7d)" / "Custom"
   - Store all in FSM data

7. **Condition Creation Prompt (state: waiting_for_conditions):**
   - Show reward summary
   - Prompt: "¬øDesea agregar condiciones ahora?"
   - Keyboard:
     - "‚ûï Agregar Condici√≥n" -> Start condition creation inline
     - "‚úÖ Crear sin condiciones" -> Create reward and finish

8. **Create Reward:**
   - Create Reward record with FSM data
   - Clear FSM state
   - Show success message with reward ID
   - If conditions requested, start condition creation flow

**Inline Condition Creation Flow:**

1. **Start (admin:reward:condition:add:{reward_id} or inline from creation):**
   - Set state: RewardConditionState.waiting_for_type
   - Show condition type selection:
     ```
     üé© <b>Tipo de Condici√≥n</b>

     <b>Num√©ricas:</b>
     ‚Ä¢ Racha de d√≠as
     ‚Ä¢ Puntos totales
     ‚Ä¢ Nivel alcanzado
     ‚Ä¢ Besitos gastados

     <b>Eventos:</b>
     ‚Ä¢ Primera compra
     ‚Ä¢ Primer regalo diario
     ‚Ä¢ Primera reacci√≥n

     <b>Exclusi√≥n:</b>
     ‚Ä¢ No VIP
     ‚Ä¢ No reclamado antes
     ```
   - Keyboard with all condition types

2. **Type Selection (state: waiting_for_type):**
   - Store condition_type in FSM data
   - If type requires value (STREAK_LENGTH, TOTAL_POINTS, LEVEL_REACHED, BESITOS_SPENT):
     - Next state: waiting_for_value
     - Prompt with context: "üé© Ingrese valor umbral para {type}:"
   - Else (event/exclusion types):
     - Skip to group selection

3. **Value Input (state: waiting_for_value):**
   - Validate based on condition type:
     - STREAK_LENGTH: 1-365
     - TOTAL_POINTS: 1-100000
     - LEVEL_REACHED: 1-100
     - BESITOS_SPENT: 1-100000
   - Store condition_value in FSM data

4. **Group Selection (state: waiting_for_group):**
   - Prompt: "üé© ¬øGrupo l√≥gico?"
   - Explanation: "Grupo 0 = AND (todas deben cumplirse). Grupo 1+ = OR (al menos una del grupo)"
   - Keyboard: "0 (AND)" / "1 (OR)" / "2 (OR)" / "3 (OR)"
   - Store condition_group in FSM data

5. **Create Condition:**
   - Create RewardCondition with:
     - reward_id
     - condition_type
     - condition_value (or None)
     - condition_group
   - Show success message
   - Prompt: "¬øAgregar otra condici√≥n?"
   - Keyboard: "‚ûï S√≠" -> repeat flow / "‚úÖ No, finalizar" -> back to reward details

**States Classes (add to bot/states/admin.py):**
```python
class RewardCreateState(StatesGroup):
    """States for reward creation flow."""
    waiting_for_name = State()
    waiting_for_description = State()
    waiting_for_type = State()
    waiting_for_besitos_amount = State()
    waiting_for_content_set = State()
    waiting_for_badge_name = State()
    waiting_for_badge_emoji = State()
    waiting_for_vip_days = State()
    waiting_for_behavior = State()
    waiting_for_repeatable = State()
    waiting_for_secret = State()
    waiting_for_claim_window = State()
    waiting_for_conditions = State()

class RewardConditionState(StatesGroup):
    """States for condition creation flow."""
    waiting_for_type = State()
    waiting_for_value = State()
    waiting_for_group = State()
```

**Helper Functions:**
- format_reward_value(type, value) -> str: Format reward value for display
- get_condition_type_display(condition_type) -> str: Human-readable condition names
- validate_condition_value(type, value) -> bool: Validate value ranges
  </action>
  <verify>grep -q "admin:rewards" bot/handlers/admin/reward_management.py && grep -q "RewardCreateState" bot/states/admin.py && grep -q "RewardConditionState" bot/states/admin.py</verify>
  <done>Reward management handlers exist with creation flow and inline condition creation</done>
</task>

<task type="auto">
  <name>Task 2: Register Reward Router and Add Menu Button</name>
  <files>
    - bot/handlers/admin/__init__.py
    - bot/handlers/admin/main.py
  </files>
  <action>
1. Update bot/handlers/admin/__init__.py:
   - Import reward_management router
   - Include it in admin_router

2. Update bot/handlers/admin/main.py admin menu:
   - Add "üèÜ Recompensas" button to main admin menu
   - Callback data: "admin:rewards"
   - Position in appropriate section
  </action>
  <verify>grep -q "reward_management" bot/handlers/admin/__init__.py && grep -q "admin:rewards" bot/handlers/admin/main.py</verify>
  <done>Reward router registered and menu button added</done>
</task>

</tasks>

<verification>
- Rewards menu displays correctly with Lucien's voice
- Reward list shows all rewards with pagination
- Reward creation flow works through all FSM states
- Type-specific value inputs work correctly
- Inline condition creation works during reward creation
- Standalone condition addition works from reward details
- Condition groups (AND/OR) work correctly
- Toggle activation works and persists
</verification>

<success_criteria>
- Admin can view paginated list of rewards
- Admin can create reward with name, description, type, value
- Admin can configure reward behavior (repeatable, secret, claim window)
- Admin can create conditions inline during reward creation
- Admin can add conditions to existing rewards
- Conditions support value-based, event-based, and exclusion types
- Condition groups support AND (0) and OR (1+) logic
- All operations use Lucien's voice (üé©)
</success_criteria>

<output>
After completion, create `.planning/phases/24-admin-configuration/24-03-SUMMARY.md`
</output>
