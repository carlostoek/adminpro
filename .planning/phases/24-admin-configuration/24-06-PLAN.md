---
phase: 24-admin-configuration
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/handlers/admin/content_set_management.py
  - bot/handlers/admin/__init__.py
  - bot/services/message/admin_main.py
  - bot/states/admin.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - Admin can create ContentSets via FSM flow
    - Admin can list existing ContentSets
    - Admin can view ContentSet details
    - Admin can toggle ContentSet active status
    - Admin can access ContentSet management from main menu
    - ContentSet creation supports file upload (forwarded messages)
  artifacts:
    - path: "bot/handlers/admin/content_set_management.py"
      provides: "ContentSet CRUD handlers"
      min_lines: 400
    - path: "bot/states/admin.py"
      provides: "ContentSetCreateState FSM states"
      contains: "class ContentSetCreateState"
  key_links:
    - from: "bot/handlers/admin/__init__.py"
      to: "content_set_management.py"
      via: "include_router"
    - from: "bot/services/message/admin_main.py"
      to: "admin:content_sets"
      via: "menu button callback"
---

<objective>
Create ContentSet management handlers to enable product creation in shop.

Purpose: The shop product creation wizard requires ContentSets to exist, but there's no admin interface to create them. This gap blocks the entire product creation flow.

Output: Complete ContentSet CRUD module with menu integration.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/24-admin-configuration/24-UAT.md
@bot/handlers/admin/shop_management.py
@bot/handlers/admin/__init__.py
@bot/services/message/admin_main.py
@bot/states/admin.py
@bot/database/models.py
@bot/database/enums.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ContentSetCreateState FSM states</name>
  <files>bot/states/admin.py</files>
  <action>
Add ContentSetCreateState StatesGroup to bot/states/admin.py after the UserLookupState class.

Follow the same pattern as ShopCreateState and RewardCreateState:

```python
class ContentSetCreateState(StatesGroup):
    """
    States for ContentSet creation flow.

    Flujo de creaciÃ³n de ContentSet:
    1. Admin selecciona "Gestionar ContentSets" â†’ "Crear ContentSet"
    2. Bot entra en waiting_for_name
    3. Admin envÃ­a nombre del ContentSet
    4. Bot entra en waiting_for_description
    5. Admin envÃ­a descripciÃ³n (opcional, /skip)
    6. Bot entra en waiting_for_content_type
    7. Admin selecciona tipo: [Fotos] [Video] [Audio] [Mixto]
    8. Bot entra en waiting_for_tier
    9. Admin selecciona tier: [FREE] [VIP] [PREMIUM] [GIFT]
    10. Bot entera en waiting_for_files
    11. Admin forwards one or more messages with media
    12. Admin sends /done to finish uploading
    13. Bot entra en waiting_for_confirmation
    14. Admin confirma o cancela
    15. Bot crea ContentSet y sale del estado

    Estados:
    - waiting_for_name: Nombre del ContentSet (requerido)
    - waiting_for_description: DescripciÃ³n (opcional)
    - waiting_for_content_type: Tipo de contenido via botones
    - waiting_for_tier: Tier via botones
    - waiting_for_files: Recolectando file_ids de mensajes forwarded
    - waiting_for_confirmation: ConfirmaciÃ³n final
    """
    waiting_for_name = State()
    waiting_for_description = State()
    waiting_for_content_type = State()
    waiting_for_tier = State()
    waiting_for_files = State()
    waiting_for_confirmation = State()
```
  </action>
  <verify>grep -A 30 "class ContentSetCreateState" bot/states/admin.py</verify>
  <done>ContentSetCreateState class exists with all 6 states defined</done>
</task>

<task type="auto">
  <name>Task 2: Create content_set_management.py handlers</name>
  <files>bot/handlers/admin/content_set_management.py</files>
  <action>
Create bot/handlers/admin/content_set_management.py with complete CRUD handlers.

Structure following shop_management.py and reward_management.py patterns:

1. **Router and imports:**
   - Import Router, F, CallbackQuery, Message, FSMContext
   - Import AsyncSession, select, func
   - Import ServiceContainer, create_inline_keyboard
   - Import ContentSet, ContentType, ContentTier
   - Import ContentSetCreateState
   - Create content_set_router = Router(name="content_set_management")

2. **Constants:**
   - CONTENT_SETS_PER_PAGE = 5
   - CONTENT_TYPE_EMOJIS mapping
   - TIER_EMOJIS mapping

3. **Menu handler** (callback_admin_content_sets):
   - Callback: "admin:content_sets"
   - Shows menu with "Crear ContentSet" and "Listar ContentSets" buttons
   - Voice: Lucien (ğŸ©) - formal mayordomo tone

4. **List handler** (callback_content_set_list):
   - Callback: "admin:content_sets:list"
   - Paginated list showing: name, type emoji, tier emoji, active status
   - Navigation: Prev/Next buttons
   - Each item clickable for details

5. **Detail handler** (callback_content_set_details):
   - Callback: "admin:content_set:details:{id}"
   - Shows full info: name, description, type, tier, file count, created date
   - Actions: Toggle active, Delete, Back to list

6. **Create start handler** (callback_content_set_create_start):
   - Callback: "admin:content_sets:create:start"
   - Initializes FSM state: waiting_for_name
   - Prompts for name

7. **FSM handlers:**
   - process_name: Validate non-empty, max 200 chars, go to waiting_for_description
   - process_description: Allow /skip, go to waiting_for_content_type
   - callback_select_content_type: Show buttons [Fotos] [Video] [Audio] [Mixto], go to waiting_for_tier
   - callback_select_tier: Show buttons [FREE] [VIP] [PREMIUM] [GIFT], go to waiting_for_files
   - process_files: Collect file_ids from forwarded messages, wait for /done command
   - process_done: When /done received, show summary and go to waiting_for_confirmation
   - callback_confirm: Create ContentSet in DB, confirm with Lucien's voice
   - callback_cancel: Clear state, return to menu

8. **Toggle handler** (callback_content_set_toggle):
   - Callback: "admin:content_set:toggle:{id}"
   - Toggle is_active field

9. **Delete handler** (callback_content_set_delete):
   - Callback: "admin:content_set:delete:{id}"
   - Show confirmation dialog
   - Confirm callback: "admin:content_set:delete:confirm:{id}"

File extraction from forwarded messages:
- Check message.photo[-1].file_id for photos
- Check message.video.file_id for videos
- Check message.audio.file_id or message.voice.file_id for audio
- Store all file_ids in a list in FSM data
- Show count of collected files after each upload

Voice guidelines (Lucien ğŸ©):
- Formal, elegant, mayordomo tone
- Third person/usted ("su ContentSet", "por favor")
- Use ğŸ© emoji in headers
- Examples:
  - "ğŸ© <b>GestiÃ³n de ContentSets</b>"
  - "<i>Por favor, envÃ­e el nombre del conjunto...</i>"
  - "âœ… ContentSet creado exitosamente."
  </action>
  <verify>wc -l bot/handlers/admin/content_set_management.py && head -50 bot/handlers/admin/content_set_management.py</verify>
  <done>File exists with 400+ lines, all handlers implemented</done>
</task>

<task type="auto">
  <name>Task 3: Register router and add menu button</name>
  <files>bot/handlers/admin/__init__.py, bot/services/message/admin_main.py</files>
  <action>
1. Update bot/handlers/admin/__init__.py:
   - Add import: `from bot.handlers.admin.content_set_management import content_set_router`
   - Add include_router before reward_router (to maintain logical order):
     `admin_router.include_router(content_set_router)`

2. Update bot/services/message/admin_main.py in _admin_main_menu_keyboard method (around line 233-246):
   - Add button after "ğŸ“¦ Paquetes de Contenido" line:
     `[{"text": "ğŸ“ ContentSets", "callback_data": "admin:content_sets"}]`
   - Position: Between "ğŸ“¦ Paquetes de Contenido" and "ğŸ”” Intereses"

The keyboard should look like:
```python
return create_inline_keyboard([
    [{"text": "ğŸ“Š Dashboard Completo", "callback_data": "admin:dashboard"}],
    [{"text": "ğŸ‘‘ CÃ­rculo Exclusivo VIP", "callback_data": "admin:vip"}],
    [{"text": "ğŸ“º VestÃ­bulo de Acceso", "callback_data": "admin:free"}],
    [{"text": "ğŸ“¦ Paquetes de Contenido", "callback_data": "admin:content"}],
    [{"text": "ğŸ“ ContentSets", "callback_data": "admin:content_sets"}],  # NEW
    [{"text": "ğŸ›ï¸ Tienda", "callback_data": "admin:shop"}],
    [{"text": "ğŸ† Recompensas", "callback_data": "admin:rewards"}],
    [{"text": "ğŸ”” Intereses", "callback_data": "admin:interests"}],
    [{"text": "ğŸ‘¥ GestiÃ³n de Usuarios", "callback_data": "admin:users"}],
    [{"text": "ğŸ‘¤ Buscar Usuario", "callback_data": "admin:user:lookup"}],
    [{"text": "âš™ï¸ CalibraciÃ³n del Reino", "callback_data": "admin:config"}],
    [{"text": "ğŸ’° Planes de SuscripciÃ³n", "callback_data": "admin:pricing"}],
    [{"text": "ğŸ“ˆ Observaciones del Reino", "callback_data": "admin:stats"}],
])
```
  </action>
  <verify>
grep "content_set_router" bot/handlers/admin/__init__.py
grep "admin:content_sets" bot/services/message/admin_main.py
  </verify>
  <done>Router imported and included, menu button added</done>
</task>

</tasks>

<verification>
1. Import ContentSetCreateState in content_set_management.py works
2. All callbacks follow pattern: admin:content_sets:*
3. File extraction handles photo, video, audio, voice message types
4. Lucien's voice (ğŸ©) used consistently
5. Menu button appears in admin main menu
</verification>

<success_criteria>
- Admin can click "ğŸ“ ContentSets" in main menu
- Admin can create ContentSet via 6-step FSM wizard
- Admin can list and view ContentSet details
- Admin can toggle ContentSet active status
- Shop product creation wizard can find ContentSets
</success_criteria>

<output>
After completion, create `.planning/phases/24-admin-configuration/24-06-SUMMARY.md`
</output>
