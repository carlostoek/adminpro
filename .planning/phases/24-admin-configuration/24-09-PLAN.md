---
phase: 24-admin-configuration
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/database/enums.py
  - bot/handlers/admin/user_gamification.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - TransactionType enum includes EARN_SHOP_REFUND value
    - format_transaction_type() can map EARN_SHOP_REFUND to display name
    - User transaction history displays without AttributeError
  artifacts:
    - path: "bot/database/enums.py"
      provides: "EARN_SHOP_REFUND enum value"
      contains: "EARN_SHOP_REFUND = \"EARN_SHOP_REFUND\""
    - path: "bot/handlers/admin/user_gamification.py"
      provides: "Transaction type mapping"
      pattern: "EARN_SHOP_REFUND.*Reembolso"
  key_links:
    - from: "TransactionType enum"
      to: "format_transaction_type()"
      via: "TransactionType.EARN_SHOP_REFUND reference"
---

<objective>
Add missing EARN_SHOP_REFUND to TransactionType enum.

Purpose: The user_gamification.py handler references TransactionType.EARN_SHOP_REFUND in format_transaction_type() but this value doesn't exist in the TransactionType enum, causing AttributeError when viewing transaction history.

Output: Updated enum with EARN_SHOP_REFUND value and proper display name.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/24-admin-configuration/24-UAT.md
@bot/database/enums.py
@bot/handlers/admin/user_gamification.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add EARN_SHOP_REFUND to TransactionType enum</name>
  <files>bot/database/enums.py</files>
  <action>
Add EARN_SHOP_REFUND to the TransactionType enum in bot/database/enums.py.

Current enum values (around lines 296-303):
```python
EARN_REACTION = "EARN_REACTION"
EARN_DAILY = "EARN_DAILY"
EARN_STREAK = "EARN_STREAK"
EARN_REWARD = "EARN_REWARD"
EARN_ADMIN = "EARN_ADMIN"
SPEND_SHOP = "SPEND_SHOP"
SPEND_ADMIN = "SPEND_ADMIN"
```

Add EARN_SHOP_REFUND after EARN_ADMIN:
```python
EARN_REACTION = "EARN_REACTION"
EARN_DAILY = "EARN_DAILY"
EARN_STREAK = "EARN_STREAK"
EARN_REWARD = "EARN_REWARD"
EARN_ADMIN = "EARN_ADMIN"
EARN_SHOP_REFUND = "EARN_SHOP_REFUND"  # NEW
SPEND_SHOP = "SPEND_SHOP"
SPEND_ADMIN = "SPEND_ADMIN"
```

Also update the docstring (around lines 287-295) to document the new type:
```python
"""
Tipos:
    EARN_REACTION: Ganancia por reaccionar a contenido
    EARN_DAILY: Ganancia por reclamar regalo diario
    EARN_STREAK: Ganancia por mantener racha
    EARN_REWARD: Ganancia por completar logro/recompensa
    EARN_ADMIN: Ganancia otorgada por administrador
    EARN_SHOP_REFUND: Reembolso de compra en tienda  # NEW
    SPEND_SHOP: Gasto en tienda
    SPEND_ADMIN: Gasto por ajuste de administrador
"""
```

Also add display_name mapping in the display_name property (around lines 310-320):
```python
names = {
    TransactionType.EARN_REACTION: "Reacción",
    TransactionType.EARN_DAILY: "Regalo Diario",
    TransactionType.EARN_STREAK: "Racha",
    TransactionType.EARN_REWARD: "Recompensa",
    TransactionType.EARN_ADMIN: "Otorgado por Admin",
    TransactionType.EARN_SHOP_REFUND: "Reembolso de Tienda",  # NEW
    TransactionType.SPEND_SHOP: "Compra en Tienda",
    TransactionType.SPEND_ADMIN: "Ajuste por Admin"
}
```
  </action>
  <verify>
grep -n "EARN_SHOP_REFUND" bot/database/enums.py
  </verify>
  <done>EARN_SHOP_REFUND added to enum, docstring, and display_name mapping</done>
</task>

<task type="auto">
  <name>Task 2: Verify user_gamification.py mapping</name>
  <files>bot/handlers/admin/user_gamification.py</files>
  <action>
Verify that bot/handlers/admin/user_gamification.py format_transaction_type() function has the correct mapping for EARN_SHOP_REFUND.

Current code (around line 34-45):
```python
def format_transaction_type(tx_type: TransactionType) -> str:
    """Format transaction type to human-readable string."""
    type_names = {
        TransactionType.EARN_REACTION: "Reacción",
        TransactionType.EARN_DAILY: "Regalo diario",
        TransactionType.EARN_SHOP_REFUND: "Reembolso tienda",
        TransactionType.EARN_ADMIN: "Crédito admin",
        TransactionType.EARN_REWARD: "Recompensa",
        TransactionType.SPEND_SHOP: "Compra tienda",
        TransactionType.SPEND_ADMIN: "Débito admin",
    }
    return type_names.get(tx_type, tx_type.value)
```

The mapping already exists and uses "Reembolso tienda" as the display name. This is fine and will work once the enum value is added.

No changes needed to user_gamification.py - the mapping is already correct.
  </action>
  <verify>
grep -n "EARN_SHOP_REFUND" bot/handlers/admin/user_gamification.py
  </verify>
  <done>Mapping in user_gamification.py is correct and consistent</done>
</task>

</tasks>

<verification>
1. EARN_SHOP_REFUND exists in TransactionType enum
2. EARN_SHOP_REFUND has display_name in enum's display_name property
3. format_transaction_type() in user_gamification.py has mapping for EARN_SHOP_REFUND
4. Enum is_earn property correctly identifies EARN_SHOP_REFUND as earn type (starts with "EARN_")
</verification>

<success_criteria>
- TransactionType.EARN_SHOP_REFUND exists and is accessible
- Viewing user transaction history doesn't raise AttributeError
- EARN_SHOP_REFUND transactions display as "Reembolso tienda" or "Reembolso de Tienda"
</success_criteria>

<output>
After completion, create `.planning/phases/24-admin-configuration/24-09-SUMMARY.md`
</output>
