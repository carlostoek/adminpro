---
phase: 25-broadcasting-improvements-optional-reactions-and-content-protection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/services/channel.py
  - bot/handlers/admin/broadcast.py
  - bot/states/admin.py
autonomous: true

must_haves:
  truths:
    - "Admin can toggle reaction buttons on/off per message during broadcast flow"
    - "Admin can enable/disable content protection (no download) per message"
    - "Both options are configurable in the preview/confirmation step of broadcast FSM"
    - "Channel service supports protect_content parameter in all send methods"
  artifacts:
    - path: "bot/services/channel.py"
      provides: "send_to_channel with protect_content support"
      contains: "protect_content: bool = False"
    - path: "bot/states/admin.py"
      provides: "BroadcastStates extended with configuration states"
      contains: "configuring_options"
    - path: "bot/handlers/admin/broadcast.py"
      provides: "Toggle handlers for reactions and content protection"
      contains: "broadcast:toggle_reactions, broadcast:toggle_protection"
  key_links:
    - from: "bot/handlers/admin/broadcast.py"
      to: "bot/services/channel.py"
      via: "send_to_channel with add_reactions and protect_content params"
      pattern: "container.channel.send_to_channel"
---

<objective>
Extend broadcast FSM and channel service to support optional reaction buttons and content protection per message.

Purpose: Give admins fine-grained control over message features during broadcasting instead of always applying reactions.
Output: Updated FSM states, channel service with protect_content support, and toggle handlers in broadcast flow.
</objective>

<execution_context>
@/data/data/com.termux/files/home/.claude/get-shit-done/workflows/execute-plan.md
@/data/data/com.termux/files/home/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/data/data/com.termux/files/home/repos/adminpro/bot/handlers/admin/broadcast.py
@/data/data/com.termux/files/home/repos/adminpro/bot/services/channel.py
@/data/data/com.termux/files/home/repos/adminpro/bot/states/admin.py
@/data/data/com.termux/files/home/repos/adminpro/bot/utils/keyboards.py

## Current Implementation

**Broadcast FSM (bot/states/admin.py):**
- waiting_for_content: Admin sends content (text/photo/video)
- waiting_for_confirmation: Preview shown with Confirm/Cancel/Change buttons

**Current Flow:**
1. Admin clicks "Enviar Publicacion" -> waiting_for_content
2. Admin sends content -> process_broadcast_content saves to FSM data
3. Preview shown -> waiting_for_confirmation
4. Admin confirms -> callback_broadcast_confirm sends with add_reactions=True (hardcoded)

**Channel Service (bot/services/channel.py):**
- send_to_channel() has add_reactions: bool = True parameter
- No protect_content parameter currently
- Uses aiogram's send_photo/send_video/send_message methods

**Telegram Content Protection:**
- protect_content=True parameter prevents downloading/saving content
- Supported in send_photo, send_video, send_document, etc.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend BroadcastStates with configuration state</name>
  <files>bot/states/admin.py</files>
  <action>
Add a new state `configuring_options` to BroadcastStates class.

This state will be entered after content is received and before confirmation.
The flow becomes:
- waiting_for_content -> receive content -> configuring_options -> waiting_for_confirmation

Add the state between waiting_for_content and waiting_for_confirmation in the docstring to document the new flow.

Do NOT remove existing states - only add the new one.
  </action>
  <verify>grep -n "configuring_options" bot/states/admin.py</verify>
  <done>BroadcastStates has configuring_options state defined</done>
</task>

<task type="auto">
  <name>Task 2: Add protect_content parameter to send_to_channel</name>
  <files>bot/services/channel.py</files>
  <action>
Extend send_to_channel() method signature to include protect_content parameter:
- Add protect_content: bool = False parameter
- Pass protect_content to all aiogram send methods (send_photo, send_video, send_message)
- Update docstring to document the new parameter

The method signature should be:
```python
async def send_to_channel(
    self,
    channel_id: str,
    text: Optional[str] = None,
    photo: Optional[str] = None,
    video: Optional[str] = None,
    add_reactions: bool = True,
    protect_content: bool = False,
    **kwargs
) -> Tuple[bool, str, Optional[Message]]:
```

Ensure protect_content is passed to:
- self.bot.send_photo(..., protect_content=protect_content)
- self.bot.send_video(..., protect_content=protect_content)
- self.bot.send_message(..., protect_content=protect_content)
  </action>
  <verify>grep -n "protect_content" bot/services/channel.py | head -10</verify>
  <done>send_to_channel accepts and uses protect_content parameter</done>
</task>

<task type="auto">
  <name>Task 3: Modify broadcast flow to include options configuration step</name>
  <files>bot/handlers/admin/broadcast.py</files>
  <action>
Modify the broadcast flow to include the new configuration step:

1. Update process_broadcast_content() to:
   - Store default options in FSM data: add_reactions=True, protect_content=False
   - Transition to BroadcastStates.configuring_options instead of waiting_for_confirmation
   - Show options configuration UI instead of preview

2. Create new handler for configuring_options state that displays:
   - Current settings (reactions ON/OFF, protection ON/OFF)
   - Toggle buttons for each option
   - "Continuar" button to proceed to preview
   - "Cancelar" button to abort

3. Create callback handlers:
   - broadcast:toggle_reactions - toggles add_reactions in FSM data
   - broadcast:toggle_protection - toggles protect_content in FSM data
   - broadcast:continue - proceeds to waiting_for_confirmation

4. Update callback_broadcast_confirm() to:
   - Read add_reactions and protect_content from FSM data
   - Pass both parameters to container.channel.send_to_channel()

Use Lucien's voice (formal, mayordomo tone with ðŸŽ© emoji) for all messages.
  </action>
  <verify>grep -n "configuring_options\|toggle_reactions\|toggle_protection" bot/handlers/admin/broadcast.py</verify>
  <done>Broadcast flow has options configuration step with toggle handlers</done>
</task>

</tasks>

<verification>
- BroadcastStates has configuring_options state
- send_to_channel accepts protect_content parameter and passes it to aiogram
- process_broadcast_content transitions to configuring_options with default settings
- Options configuration UI shows current toggle states
- Toggle callbacks update FSM data correctly
- Confirm handler reads both options from FSM data and passes to send_to_channel
</verification>

<success_criteria>
1. Admin can start broadcast flow and see options configuration step
2. Admin can toggle reaction buttons on/off before sending
3. Admin can toggle content protection on/off before sending
4. Message is sent with correct reaction and protection settings
5. Both options default to sensible values (reactions ON, protection OFF)
</success_criteria>

<output>
After completion, create `.planning/phases/25-broadcasting-improvements-optional-reactions-and-content-protection/25-01-SUMMARY.md`
</output>
