---
phase: 02-template-organization-admin-migration
plan: 02
type: execute
wave: 1
depends_on: [02-01]
files_modified:
  - bot/services/message/admin_free.py
  - bot/handlers/admin/free.py
autonomous: true

must_haves:
  truths:
    - "Admin can navigate Free menu and all messages come from AdminFreeMessages (zero hardcoded strings)"
    - "Free menu shows conditional content based on wait_time and is_configured flags"
    - "Wait time setup prompts validate input >= 1 minute"
    - "Each message method returns tuple (text, keyboard) with integrated inline keyboards"
    - "Channel setup messages mirror VIP patterns but adapted for Free context"
  artifacts:
    - path: "bot/services/message/admin_free.py"
      provides: "AdminFreeMessages provider with Free-specific messages"
      min_lines: 180
      contains: "class AdminFreeMessages(BaseMessageProvider)"
    - path: "bot/handlers/admin/free.py"
      provides: "Migrated Free handlers using message service"
      contains: "container.message.admin.free"
  key_links:
    - from: "bot/handlers/admin/free.py"
      to: "bot/services/message/admin_free.py"
      via: "container.message.admin.free property"
      pattern: "container\\.message\\.admin\\.free\\."
    - from: "AdminFreeMessages"
      to: "BaseMessageProvider"
      via: "inheritance"
      pattern: "class AdminFreeMessages\\(BaseMessageProvider\\)"
    - from: "AdminFreeMessages"
      to: "bot/utils/formatters.py"
      via: "format_duration_minutes import"
      pattern: "from bot\\.utils\\.formatters import"
    - from: "AdminFreeMessages"
      to: "bot/utils/keyboards.py"
      via: "create_inline_keyboard import"
      pattern: "create_inline_keyboard"
---

<objective>
Create AdminFreeMessages provider and migrate Free handlers to use centralized message service.

Purpose: Extend navigation-based message provider pattern to Free admin flow, implementing conditional content for wait time configuration and maintaining voice consistency with VIP provider patterns.

Output: AdminFreeMessages class with methods returning (text, keyboard) tuples for all Free admin screens; free.py handlers refactored to use message service with zero hardcoded strings.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-template-organization-admin-migration/02-CONTEXT.md
@.planning/phases/02-template-organization-admin-migration/02-RESEARCH.md
@.planning/phases/02-template-organization-admin-migration/02-01-SUMMARY.md

@bot/services/message/admin_vip.py
@bot/services/message/base.py
@bot/handlers/admin/free.py
@bot/utils/formatters.py
@bot/utils/keyboards.py
@docs/guia-estilo.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AdminFreeMessages provider class</name>
  <files>bot/services/message/admin_free.py</files>
  <action>
Create new file bot/services/message/admin_free.py with AdminFreeMessages provider class.

**Class Structure:**
```python
"""
Admin Free Messages Provider - Free channel management messages.

Provides messages for Free channel setup, wait time configuration, and queue management.
"""
from typing import Tuple
import random
from aiogram.types import InlineKeyboardMarkup

from bot.services.message.base import BaseMessageProvider
from bot.utils.keyboards import create_inline_keyboard
from bot.utils.formatters import format_duration_minutes

class AdminFreeMessages(BaseMessageProvider):
    """
    Admin Free channel management messages provider.

    Voice Characteristics (from docs/guia-estilo.md):
    - Free channel = "vest铆bulo" (vestibule/entry)
    - Wait time = "tiempo de contemplaci贸n" (contemplation time)
    - Queue = "lista de espera" (waiting list)
    - Uses "usted", never "t煤"
    - Emoji  always present
    - References Diana for authority validation

    Stateless Design:
    - No session or bot stored as instance variables
    - All context passed as method parameters
    - Returns (text, keyboard) tuples for complete UI
    """
```

**Methods to implement:**

1. `free_menu(self, is_configured: bool, channel_name: str = "Canal Free", wait_time_minutes: int = 0) -> Tuple[str, InlineKeyboardMarkup]`
   - 3 greeting variations with weighted random selection using `random.choices()`:
     * Weight [0.5]: "El vest铆bulo de Diana permanece accesible, custodio..."
     * Weight [0.3]: "La antesala del c铆rculo exclusivo aguarda su calibraci贸n..."
     * Weight [0.2]: "Bienvenido a la zona de preparaci贸n..."
   - Conditional body based on is_configured
   - Show wait_time using format_duration_minutes()
   - Returns configured or unconfigured keyboard

2. `setup_channel_prompt(self) -> Tuple[str, InlineKeyboardMarkup]`
   - Instructions for forwarding Free channel message
   - Cancel button only
   - Similar to VIP prompt but adapted for Free context

3. `channel_configured_success(self, channel_name: str, channel_id: str) -> Tuple[str, InlineKeyboardMarkup]`
   - Success message for Free channel setup
   - "vest铆bulo est谩 listo" terminology
   - Keyboard with "view_queue" option

4. `wait_time_setup_prompt(self, current_wait_time: int) -> Tuple[str, InlineKeyboardMarkup]`
   - Show current wait time using format_duration_minutes()
   - Instructions for new wait time input
   - Example: "<code>5</code>"
   - Cancel button

5. `wait_time_updated(self, new_wait_time: int) -> Tuple[str, InlineKeyboardMarkup]`
   - Success message for wait time update
   - Use format_duration_minutes() for display
   - Keyboard with Free menu options

6. `invalid_wait_time_input(self, reason: str = "invalid") -> Tuple[str, InlineKeyboardMarkup]`
   - Error message for invalid wait time input
   - reason: "not_number" or "too_low" or "invalid"
   - Cancel button

7. `config_menu(self, wait_time_minutes: int) -> Tuple[str, InlineKeyboardMarkup]`
   - Configuration submenu for Free channel
   - Show current wait time
   - Options: change wait time, reconfigure channel

**Private keyboard factory methods:**
- `_free_configured_keyboard(self) -> InlineKeyboardMarkup`
- `_free_unconfigured_keyboard(self) -> InlineKeyboardMarkup`
- `_free_config_submenu_keyboard(self) -> InlineKeyboardMarkup`

**Voice guidelines:**
- Use "vest铆bulo" for Free channel (entryway before VIP)
- Use "tiempo de contemplaci贸n" for wait time
- Use "lista de espera" for queue
- Reference Diana appropriately
- Include  emoji in header
- Use "usted" never "t煤"
- Use "..." for dramatic pauses

**Weighted variation implementation example:**
```python
greetings = [
    ("Variaci贸n 1...", 0.5),
    ("Variaci贸n 2...", 0.3),
    ("Variaci贸n 3...", 0.2),
]
selected, = random.choices([g[0] for g in greetings], weights=[g[1] for g in greetings])
```

DO NOT include any handler-specific logic or database queries in provider. Provider only formats messages.
</action>
  <verify>python3 -c "from bot.services.message.admin_free import AdminFreeMessages; msg = AdminFreeMessages(); print('Provider imported successfully')"</verify>
  <done>AdminFreeMessages class exists with all required methods returning (text, keyboard) tuples</done>
</task>

<task type="auto">
  <name>Task 2: Migrate free.py handlers to use AdminFreeMessages</name>
  <files>bot/handlers/admin/free.py</files>
  <action>
Refactor bot/handlers/admin/free.py to use AdminFreeMessages provider for all message text/keyboards.

**Migration approach:**
1. Remove hardcoded message strings (lines 73-85, 119-129, 190-196, 230-236, 270-296, 329-333)
2. Remove free_menu_keyboard() function (line 23-46) - now in provider
3. Update each handler to call container.message.admin.free methods

**Handler migrations:**

1. `callback_free_menu` (line 49-97):
   - Get is_configured, channel_name, wait_time from container
   - Call: `text, keyboard = await container.message.admin.free.free_menu(is_configured, channel_name, wait_time)`
   - Remove text construction (lines 73-85)

2. `callback_free_setup` (line 100-143):
   - Call: `text, keyboard = await container.message.admin.free.setup_channel_prompt()`
   - Remove text construction (lines 119-129)

3. `process_free_channel_forward` success case (line 189-196):
   - Call: `text, keyboard = await container.message.admin.free.channel_configured_success(channel_title, channel_id)`
   - Remove text construction (lines 190-196)

4. `callback_set_wait_time` (line 208-250):
   - Get current_wait_time from container.config
   - Call: `text, keyboard = await container.message.admin.free.wait_time_setup_prompt(current_wait_time)`
   - Remove text construction (lines 230-236)

5. `process_wait_time_input` validation errors (line 269-285, 279-285):
   - Not number case: Call `container.message.admin.free.invalid_wait_time_input("not_number")`
   - Too low case: Call `container.message.admin.free.invalid_wait_time_input("too_low")`
   - Remove hardcoded error messages

6. `process_wait_time_input` success case (line 293-296):
   - Call: `text, keyboard = await container.message.admin.free.wait_time_updated(minutes)`
   - Remove text construction (lines 294-296)

7. `callback_free_config` (line 315-351):
   - Get wait_time from container
   - Call: `text, keyboard = await container.message.admin.free.config_menu(wait_time)`
   - Remove text construction (lines 329-333)

**Error handling:**
- Keep existing try/except blocks for edit_text "message is not modified"
- Keep validation logic for wait time input
- Only replace message text/keyboard construction

**DO NOT change:**
- Handler logic and flow
- FSM state transitions
- Database queries
- Callback data strings
- Logging statements
</action>
  <verify>grep -n "container.message.admin.free" bot/handlers/admin/free.py | wc -l</verify>
  <done>free.py uses container.message.admin.free for all messages, no hardcoded HTML strings remain</done>
</task>

</tasks>

<verification>
1. AdminFreeMessages class imported successfully
2. All required methods return (text, keyboard) tuples
3. free.py handlers call container.message.admin.free methods
4. No hardcoded message strings in free.py
5. Voice consistency: "vest铆bulo", "tiempo de contemplaci贸n" used
6. 2-3 greeting variations implemented in free_menu() using weighted random.choices()
7. Keyboards integrated in all provider methods
8. format_duration_minutes() used for wait time display
9. Conditional content based on is_configured flag
</verification>

<success_criteria>
1. Admin can navigate Free menu and all messages come from LucienVoiceService
2. Free menu shows conditional content based on wait_time and is_configured
3. Wait time setup prompts validate input >= 1 minute
4. Each message method returns tuple (text, keyboard)
5. Channel setup messages mirror VIP patterns
6. Zero hardcoded message strings in free.py handlers
7. All voice rules from guia-estilo.md followed
8. Weighted variations use random.choices() with weights parameter
</success_criteria>

<output>
After completion, create `.planning/phases/02-template-organization-admin-migration/02-02-SUMMARY.md` with:
- Files modified: admin_free.py (new), free.py
- Methods created in AdminFreeMessages
- Handlers migrated
- Voice patterns implemented
- Weighted variation implementation
- Next steps for 02-03 plan
</output>
