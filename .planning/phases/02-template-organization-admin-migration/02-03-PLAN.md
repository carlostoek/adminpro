---
phase: 02-template-organization-admin-migration
plan: 03
type: execute
wave: 2
depends_on: [02-01, 02-02]
files_modified:
  - bot/services/message/admin_main.py
  - bot/handlers/admin/main.py
  - bot/utils/keyboards.py
  - bot/services/message/__init__.py
autonomous: true

must_haves:
  truths:
    - "Admin can access /admin command and all messages come from AdminMainMessages (zero hardcoded strings)"
    - "Main menu shows 2-3 variations for greeting with weighted random selection"
    - "Config status message shows missing items when not fully configured"
    - "Each message method returns tuple (text, keyboard) with integrated inline keyboards"
    - "Navigation callbacks (admin:main, admin:config, config:status) use message service"
  artifacts:
    - path: "bot/services/message/admin_main.py"
      provides: "AdminMainMessages provider for main admin menu"
      min_lines: 150
      contains: "class AdminMainMessages(BaseMessageProvider)"
    - path: "bot/handlers/admin/main.py"
      provides: "Migrated main admin handlers using message service"
      contains: "container.message.admin.main"
    - path: "bot/utils/keyboards.py"
      provides: "Updated admin_main_menu_keyboard with Lucien voice"
      modified: true
  key_links:
    - from: "bot/handlers/admin/main.py"
      to: "bot/services/message/admin_main.py"
      via: "container.message.admin.main property"
      pattern: "container\\.message\\.admin\\.main\\."
    - from: "AdminMainMessages"
      to: "BaseMessageProvider"
      via: "inheritance"
      pattern: "class AdminMainMessages\\(BaseMessageProvider\\)"
    - from: "bot/handlers/admin/main.py"
      to: "bot/utils/keyboards.py"
      via: "admin_main_menu_keyboard import"
      pattern: "from bot\\.utils\\.keyboards import.*admin_main_menu_keyboard"
---

<objective>
Create AdminMainMessages provider, migrate main admin handlers, and update keyboard utilities with Lucien voice.

Purpose: Complete admin handler migration by centralizing main admin menu messages, implementing navigation-based organization, and updating utility keyboard factories to match new voice-consistent patterns.

Output: AdminMainMessages class with methods for main admin screens; main.py handlers refactored; admin_main_menu_keyboard updated with Lucien voice terminology; LucienVoiceService exports updated.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-template-organization-admin-migration/02-CONTEXT.md
@.planning/phases/02-template-organization-admin-migration/02-RESEARCH.md
@.planning/phases/02-template-organization-admin-migration/02-01-SUMMARY.md
@.planning/phases/02-template-organization-admin-migration/02-02-SUMMARY.md

@bot/services/message/admin_vip.py
@bot/services/message/admin_free.py
@bot/services/message/base.py
@bot/handlers/admin/main.py
@bot/utils/keyboards.py
@docs/guia-estilo.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AdminMainMessages provider class</name>
  <files>bot/services/message/admin_main.py</files>
  <action>
Create new file bot/services/message/admin_main.py with AdminMainMessages provider class.

**Class Structure:**
```python
"""
Admin Main Messages Provider - Main admin menu messages.

Provides messages for main admin menu navigation and configuration status.
"""
from typing import Tuple, List
import random
from aiogram.types import InlineKeyboardMarkup

from bot.services.message.base import BaseMessageProvider
from bot.utils.keyboards import create_inline_keyboard

class AdminMainMessages(BaseMessageProvider):
    """
    Admin main menu messages provider.

    Voice Characteristics (from docs/guia-estilo.md):
    - Admin = "custodio" (custodian) or "guardi√°n" (guardian)
    - Main menu = "sanctum" or "dominios de Diana"
    - Configuration = "calibraci√≥n del reino"
    - Uses "usted", never "t√∫"
    - Emoji üé© always present
    - References Diana for authority validation

    Stateless Design:
    - No session or bot stored as instance variables
    - All context passed as method parameters
    - Returns (text, keyboard) tuples for complete UI
    """
```

**Methods to implement:**

1. `admin_menu_greeting(self, is_configured: bool, missing_items: List[str] = None) -> Tuple[str, InlineKeyboardMarkup]`
   - 3 greeting variations with weighted random selection using `random.choices()`:
     * Weight [0.5]: "Ah, el custodio de los dominios de Diana..."
     * Weight [0.3]: "Bienvenido de nuevo al sanctum, guardi√°n..."
     * Weight [0.2]: "Los portales del reino aguardan su direcci√≥n..."
   - Conditional body based on is_configured:
     * If configured: "Todo est√° en orden. ¬øQu√© aspecto del reino requiere su atenci√≥n hoy?"
     * If not configured: Show missing_items joined with ", "
   - Returns admin_main_menu_keyboard() from utils/keyboards.py

2. `config_menu(self) -> Tuple[str, InlineKeyboardMarkup]`
   - Configuration submenu message
   - "Desde aqu√≠ puede ajustar los par√°metros del reino..."
   - Returns config_menu_keyboard() from utils/keyboards.py

3. `config_status(self, vip_reactions: List[str], free_reactions: List[str], is_vip_configured: bool, is_free_configured: bool, wait_time: int) -> Tuple[str, InlineKeyboardMarkup]`
   - Complete configuration status message
   - Format reactions list with " ".join()
   - Show channel config status (emoji indicators)
   - Show wait time for Free channel
   - Returns config_menu_keyboard()

4. `config_status_summary_base(self, vip_reactions: List[str], free_reactions: List[str]) -> str`
   - Helper method to build config summary text
   - Used by config_status for re-used content
   - Returns formatted HTML string

**Voice guidelines:**
- Use "custodio" or "guardi√°n" for admin
- Use "reino" for system/domain
- Use "calibraci√≥n" for configuration
- Reference Diana appropriately
- Include üé© emoji in header
- Use "usted" never "t√∫"
- Use "..." for dramatic pauses

**Weighted variation implementation example:**
```python
greetings = [
    ("Variaci√≥n 1...", 0.5),
    ("Variaci√≥n 2...", 0.3),
    ("Variaci√≥n 3...", 0.2),
]
selected, = random.choices([g[0] for g in greetings], weights=[g[1] for g in greetings])
```

**Keyboard integration:**
- Import admin_main_menu_keyboard from utils/keyboards.py
- Import config_menu_keyboard from utils/keyboards.py
- These will be updated in Task 2 with Lucien voice

DO NOT include any handler-specific logic or database queries in provider. Provider only formats messages.
</action>
  <verify>python3 -c "from bot.services.message.admin_main import AdminMainMessages; msg = AdminMainMessages(); print('Provider imported successfully')"</verify>
  <done>AdminMainMessages class exists with all required methods returning (text, keyboard) tuples</done>
</task>

<task type="auto">
  <name>Task 2: Update admin_main_menu_keyboard with Lucien voice</name>
  <files>bot/utils/keyboards.py</files>
  <action>
Update bot/utils/keyboards.py to add Lucien voice terminology to keyboard buttons.

**Update admin_main_menu_keyboard() function (line 59-81):**

Change button text from technical to Lucien voice:
- "üìä Dashboard Completo" ‚Üí keep (already good)
- "üì∫ Gesti√≥n Canal VIP" ‚Üí "üëë C√≠rculo Exclusivo VIP"
- "üì∫ Gesti√≥n Canal Free" ‚Üí "üì∫ Vest√≠bulo de Acceso"
- "‚öôÔ∏è Configuraci√≥n" ‚Üí "‚öôÔ∏è Calibraci√≥n del Reino"
- "üí∞ Tarifas" ‚Üí "üí∞ Planes de Suscripci√≥n"
- "üìä Estad√≠sticas" ‚Üí "üìà Observaciones del Reino"

**Keep callback_data the same:**
- admin:dashboard
- admin:vip
- admin:free
- admin:config
- admin:pricing
- admin:stats

**Update config_menu_keyboard() function (line 143-161):**

Change button text:
- "üìä Ver Estado de Configuraci√≥n" ‚Üí "üìä Estado del Reino"
- "‚öôÔ∏è Configurar Reacciones VIP" ‚Üí "üëë Reacciones del C√≠rculo"
- "‚öôÔ∏è Configurar Reacciones Free" ‚Üí "üì∫ Reacciones del Vest√≠bulo"
- "üîô Volver al Men√∫ Principal" ‚Üí keep

**Add new function for admin navigation:**
```python
def admin_navigation_keyboard() -> InlineKeyboardMarkup:
    """
    Keyboard with admin section navigation.

    Returns:
        InlineKeyboardMarkup with navigation options
    """
    return create_inline_keyboard([
        [{"text": "üëë C√≠rculo Exclusivo VIP", "callback_data": "admin:vip"}],
        [{"text": "üì∫ Vest√≠bulo de Acceso", "callback_data": "admin:free"}],
        [{"text": "‚öôÔ∏è Calibraci√≥n del Reino", "callback_data": "admin:config"}],
        [{"text": "üí∞ Planes de Suscripci√≥n", "callback_data": "admin:pricing"}],
        [{"text": "üìà Observaciones del Reino", "callback_data": "admin:stats"}],
    ])
```

**Update stats_menu_keyboard() function (line 98-118):**
- "üìä Ver Stats VIP Detalladas" ‚Üí "üìä Observaciones del C√≠rculo"
- "üìä Ver Stats Free Detalladas" ‚Üí "üìä Observaciones del Vest√≠bulo"
- "üéüÔ∏è Ver Stats de Tokens" ‚Üí "üéüÔ∏è Registro de Invitaciones"
- "üîÑ Actualizar Estad√≠sticas" ‚Üí "üîÑ Actualizar Observaciones"
</action>
  <verify>python3 -c "from bot.utils.keyboards import admin_main_menu_keyboard; kb = admin_main_menu_keyboard(); print('Keyboard updated successfully')"</verify>
  <done>All admin keyboard buttons use Lucien voice terminology</done>
</task>

<task type="auto">
  <name>Task 3: Migrate main.py handlers to use AdminMainMessages</name>
  <files>bot/handlers/admin/main.py</files>
  <action>
Refactor bot/handlers/admin/main.py to use AdminMainMessages provider for all message text/keyboards.

**Migration approach:**
1. Update imports to include AdminMainMessages (via container)
2. Remove hardcoded message strings (lines 52-65, 95-108, 141-145, 185-196)
3. Remove admin_main_menu_keyboard import (line 14) - now used from provider
4. Update each handler to call container.message.admin.main methods

**Handler migrations:**

1. `cmd_admin` (line 32-71):
   - Get config_status from container.config
   - Extract is_configured and missing_items
   - Call: `text, keyboard = await container.message.admin.main.admin_menu_greeting(is_configured, missing_items)`
   - Remove text construction (lines 52-65)
   - Keep keyboard import for now (will be from provider after Task 2)

2. `callback_admin_main` (line 74-125):
   - Get config_status from container.config
   - Extract is_configured and missing_items
   - Call: `text, keyboard = await container.message.admin.main.admin_menu_greeting(is_configured, missing_items)`
   - Remove text construction (lines 95-108)
   - Keep try/except for edit_text "message is not modified"

3. `callback_admin_config` (line 128-160):
   - Call: `text, keyboard = await container.message.admin.main.config_menu()`
   - Remove text construction (lines 141-145)

4. `callback_config_status` (line 163-210):
   - Get vip_reactions, free_reactions from container.config
   - Get is_vip_configured, is_free_configured from container.channel
   - Get wait_time from container.config
   - Call: `text, keyboard = await container.message.admin.main.config_status(vip_reactions, free_reactions, is_vip_configured, is_free_configured, wait_time)`
   - Remove text construction (lines 185-196)
   - Keep try/except for edit_text

**Import updates:**
- Remove: `from bot.utils.keyboards import admin_main_menu_keyboard, back_to_main_menu_keyboard, config_menu_keyboard` (line 13-17)
- Keyboards now accessed via provider or utils as needed
- Keep other imports (AdminAuthMiddleware, DatabaseMiddleware, ServiceContainer, etc.)

**Error handling:**
- Keep existing try/except blocks for edit_text "message is not modified"
- Keep logging statements
- Only replace message text/keyboard construction

**DO NOT change:**
- Handler logic and flow
- Database queries via container
- Callback data strings
- Logging statements
- Middleware configuration
</action>
  <verify>grep -n "container.message.admin.main" bot/handlers/admin/main.py | wc -l</verify>
  <done>main.py uses container.message.admin.main for all messages, no hardcoded HTML strings remain</done>
</task>

<task type="auto">
  <name>Task 4: Update LucienVoiceService exports</name>
  <files>bot/services/message/__init__.py</files>
  <action>
Update bot/services/message/__init__.py to complete AdminMessages namespace implementation.

**Update AdminMessages class:**
- The vip and free properties are already implemented from 02-01
- The main property should now work (AdminMainMessages exists)

**Update __all__ exports:**
```python
__all__ = [
    "BaseMessageProvider",
    "CommonMessages",
    "LucienVoiceService",
    "AdminMessages",
    "AdminMainMessages",
    "AdminVIPMessages",
    "AdminFreeMessages",
]
```

**Add direct imports for convenience:**
```python
# Direct imports for type hints and external access
from .admin_main import AdminMainMessages
from .admin_vip import AdminVIPMessages
from .admin_free import AdminFreeMessages
```

**Verify all three providers are importable:**
- AdminMainMessages
- AdminVIPMessages
- AdminFreeMessages

**Update docstring:**
- Update LucienVoiceService docstring to reflect complete admin namespace
- Document all three providers (main, vip, free)
</action>
  <verify>python3 -c "from bot.services.message import AdminMainMessages, AdminVIPMessages, AdminFreeMessages; print('All providers importable')"</verify>
  <done>LucienVoiceService exports complete with all three admin providers</done>
</task>

</tasks>

<verification>
1. AdminMainMessages class imported successfully
2. All required methods return (text, keyboard) tuples
3. main.py handlers call container.message.admin.main methods
4. No hardcoded message strings in main.py
5. Voice consistency: "custodio", "reino", "calibraci√≥n" used
6. 2-3 greeting variations implemented in admin_menu_greeting() using weighted random.choices()
7. Keyboards in utils/keyboards.py updated with Lucien voice
8. admin_main_menu_keyboard uses "C√≠rculo Exclusivo VIP" and "Vest√≠bulo de Acceso"
9. LucienVoiceService exports all three admin providers
10. All admin handler files (main.py, vip.py, free.py) migrated
</verification>

<success_criteria>
1. Admin can access /admin command and all messages come from LucienVoiceService
2. Main menu shows 2-3 variations for greeting using weighted selection
3. Config status message shows missing items when not fully configured
4. Each message method returns tuple (text, keyboard)
5. Navigation callbacks use message service
6. Zero hardcoded message strings in main.py handlers
7. Keyboard buttons use Lucien voice terminology
8. All three admin providers exported from LucienVoiceService
9. Phase 2 requirements complete
10. Weighted variations use random.choices() with weights parameter
</success_criteria>

<output>
After completion, create `.planning/phases/02-template-organization-admin-migration/02-03-SUMMARY.md` with:
- Files modified: admin_main.py (new), main.py, keyboards.py, __init__.py
- Methods created in AdminMainMessages
- Handlers migrated
- Voice patterns implemented
- Keyboard terminology updates
- Phase 2 completion summary
- All admin flows migrated to message service
- Ready for Phase 3 (User Flow Migration)
</output>
