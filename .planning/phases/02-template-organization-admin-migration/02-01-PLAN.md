---
phase: 02-template-organization-admin-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/services/message/admin_vip.py
  - bot/handlers/admin/vip.py
  - bot/services/message/__init__.py
autonomous: true

must_haves:
  truths:
    - "Admin can navigate VIP menu and all messages come from AdminVIPMessages (zero hardcoded strings)"
    - "VIP menu shows 2-3 variations for greeting message using weighted random selection"
    - "Token generation message adapts based on plan selected"
    - "Each message method returns tuple (text, keyboard) with integrated inline keyboards"
    - "Channel setup prompt uses conditional states (is_configured flag)"
  artifacts:
    - path: "bot/services/message/admin_vip.py"
      provides: "AdminVIPMessages provider with VIP-specific messages"
      min_lines: 200
      contains: "class AdminVIPMessages(BaseMessageProvider)"
    - path: "bot/handlers/admin/vip.py"
      provides: "Migrated VIP handlers using message service"
      contains: "container.message.admin.vip"
  key_links:
    - from: "bot/handlers/admin/vip.py"
      to: "bot/services/message/admin_vip.py"
      via: "container.message.admin.vip property"
      pattern: "container\\.message\\.admin\\.vip\\."
    - from: "AdminVIPMessages"
      to: "BaseMessageProvider"
      via: "inheritance"
      pattern: "class AdminVIPMessages\\(BaseMessageProvider\\)"
    - from: "AdminVIPMessages"
      to: "bot/utils/formatters.py"
      via: "format_datetime, format_currency imports"
      pattern: "from bot\\.utils\\.formatters import"
    - from: "AdminVIPMessages"
      to: "bot/utils/keyboards.py"
      via: "create_inline_keyboard import"
      pattern: "create_inline_keyboard"
---

<objective>
Create AdminVIPMessages provider and migrate VIP handlers to use centralized message service.

Purpose: Establish navigation-based message provider pattern for VIP admin flow, implementing template composition, keyboard integration, and message variations as defined in Phase 2 research.

Output: AdminVIPMessages class with methods returning (text, keyboard) tuples for all VIP admin screens; vip.py handlers refactored to use message service with zero hardcoded strings.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-template-organization-admin-migration/02-CONTEXT.md
@.planning/phases/02-template-organization-admin-migration/02-RESEARCH.md
@.planning/phases/01-service-foundation-voice-rules/01-03-SUMMARY.md

@bot/services/message/base.py
@bot/services/message/common.py
@bot/services/message/__init__.py
@bot/handlers/admin/vip.py
@bot/utils/formatters.py
@bot/utils/keyboards.py
@docs/guia-estilo.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AdminVIPMessages provider class</name>
  <files>bot/services/message/admin_vip.py</files>
  <action>
Create new file bot/services/message/admin_vip.py with AdminVIPMessages provider class.

**Class Structure:**
```python
"""
Admin VIP Messages Provider - VIP management messages.

Provides messages for VIP channel setup, token generation, and VIP management.
"""
from typing import Tuple
from datetime import datetime
import random
from aiogram.types import InlineKeyboardMarkup

from bot.services.message.base import BaseMessageProvider
from bot.utils.keyboards import create_inline_keyboard
from bot.utils.formatters import format_datetime, format_currency

class AdminVIPMessages(BaseMessageProvider):
    """
    Admin VIP management messages provider.

    Voice Characteristics (from docs/guia-estilo.md):
    - VIP channel = "c铆rculo exclusivo" (exclusive circle)
    - Token = "invitaci贸n" (invitation, never "token" in user-facing text)
    - Setup = "calibraci贸n" (calibration, implies precision)
    - Uses "usted", never "t煤"
    - Emoji  always present
    - References Diana for authority validation

    Stateless Design:
    - No session or bot stored as instance variables
    - All context passed as method parameters
    - Returns (text, keyboard) tuples for complete UI
    """
```

**Methods to implement:**

1. `vip_menu(self, is_configured: bool, channel_name: str = "Canal VIP", subscriber_count: int = 0) -> Tuple[str, InlineKeyboardMarkup]`
   - 3 greeting variations with weighted random selection using `random.choices()`:
     * Weight [0.5]: "Ah, el c铆rculo exclusivo. Todo est谩 preparado para sus decisiones, custodio..."
     * Weight [0.3]: "El santuario VIP aguarda su direcci贸n, guardi谩n de Diana..."
     * Weight [0.2]: "Bienvenido a la c谩mara de decisiones exclusivas..."
   - Conditional body based on is_configured
   - Returns configured or unconfigured keyboard

2. `token_generated(self, plan_name: str, duration_days: int, price: float, currency: str, token: str, deep_link: str, expiry_date: datetime) -> Tuple[str, InlineKeyboardMarkup]`
   - Uses format_currency() for price
   - Uses format_datetime() for expiry
   - Returns keyboard with "Copiar Pase" button

3. `setup_channel_prompt(self) -> Tuple[str, InlineKeyboardMarkup]`
   - Instructions for forwarding channel message
   - Cancel button only

4. `channel_configured_success(self, channel_name: str, channel_id: str) -> Tuple[str, InlineKeyboardMarkup]`
   - Success message with Diana reference
   - Keyboard with emit invitation button

5. `select_plan_for_token(self, plans: list[dict]) -> Tuple[str, InlineKeyboardMarkup]`
   - plans dict: {"id": int, "name": str, "duration_days": int, "price": float, "currency": str}
   - Build plan list with format_currency()
   - Dynamic keyboard with plan buttons

6. `no_plans_configured(self) -> Tuple[str, InlineKeyboardMarkup]`
   - Error message guiding to pricing setup
   - Keyboard with "Configurar Tarifas" and "Volver"

**Private keyboard factory methods:**
- `_vip_configured_keyboard(self) -> InlineKeyboardMarkup`
- `_vip_unconfigured_keyboard(self) -> InlineKeyboardMarkup`

**Voice guidelines:**
- Use "c铆rculo exclusivo" for VIP channel
- Use "invitaci贸n" for token
- Use "calibraci贸n" for setup
- Reference Diana for authority ("Diana prefiere...", "Diana aprobar谩...")
- Include  emoji in header
- Use "usted" never "t煤"
- Use "..." for dramatic pauses

**Weighted variation implementation example:**
```python
greetings = [
    ("Variaci贸n 1...", 0.5),
    ("Variaci贸n 2...", 0.3),
    ("Variaci贸n 3...", 0.2),
]
selected, = random.choices([g[0] for g in greetings], weights=[g[1] for g in greetings])
```

DO NOT include any handler-specific logic or database queries in provider. Provider only formats messages.
</action>
  <verify>python3 -c "from bot.services.message.admin_vip import AdminVIPMessages; msg = AdminVIPMessages(); print('Provider imported successfully')"</verify>
  <done>AdminVIPMessages class exists with all required methods returning (text, keyboard) tuples</done>
</task>

<task type="auto">
  <name>Task 2: Integrate AdminMessages namespace in LucienVoiceService</name>
  <files>bot/services/message/__init__.py</files>
  <action>
Update bot/services/message/__init__.py to add AdminMessages namespace.

**Add AdminMessages namespace class:**
```python
class AdminMessages:
    """
    Admin messages namespace for organization.

    Provides access to AdminMainMessages, AdminVIPMessages, AdminFreeMessages.

    Usage:
        msg = container.message.admin
        text, kb = msg.vip.vip_menu(is_configured=True)
        text, kb = msg.main.admin_menu_greeting(is_configured=True)
    """

    def __init__(self):
        self._main = None
        self._vip = None
        self._free = None

    @property
    def main(self) -> "AdminMainMessages":
        """Main admin menu messages."""
        if self._main is None:
            from .admin_main import AdminMainMessages
            self._main = AdminMainMessages()
        return self._main

    @property
    def vip(self) -> "AdminVIPMessages":
        """VIP admin messages."""
        if self._vip is None:
            from .admin_vip import AdminVIPMessages
            self._vip = AdminVIPMessages()
        return self._vip

    @property
    def free(self) -> "AdminFreeMessages":
        """Free admin messages."""
        if self._free is None:
            from .admin_free import AdminFreeMessages
            self._free = AdminFreeMessages()
        return self._free
```

**Update LucienVoiceService class:**
- Add `self._admin = None` in __init__
- Add `@property admin(self) -> AdminMessages` method
- Update docstring to reflect new structure

**Update imports:**
- Add AdminMainMessages, AdminVIPMessages, AdminFreeMessages to __all__ (will create in subsequent plans, stub with None for now)
</action>
  <verify>python3 -c "from bot.services.message import LucienVoiceService; s = LucienVoiceService(); print(hasattr(s, 'admin'))"</verify>
  <done>LucienVoiceService has admin property returning AdminMessages namespace with vip property</done>
</task>

<task type="auto">
  <name>Task 3: Migrate vip.py handlers to use AdminVIPMessages</name>
  <files>bot/handlers/admin/vip.py</files>
  <action>
Refactor bot/handlers/admin/vip.py to use AdminVIPMessages provider for all message text/keyboards.

**Migration approach:**
1. Remove hardcoded message strings (lines 80-91, 127-137, 202-209, 269-290, 369-389, 430-436)
2. Remove vip_menu_keyboard() function (line 27-54) - now in provider
3. Update each handler to call container.message.admin.vip methods

**Handler migrations:**

1. `callback_vip_menu` (line 57-103):
   - Get is_configured from container.channel
   - Get channel_name and subscriber_count if configured
   - Call: `text, keyboard = await container.message.admin.vip.vip_menu(is_configured, channel_name, subscriber_count)`
   - Remove text construction (lines 73-91)

2. `callback_vip_setup` (line 106-151):
   - Call: `text, keyboard = await container.message.admin.vip.setup_channel_prompt()`
   - Remove text construction (lines 127-137)

3. `process_vip_channel_forward` success case (line 198-209):
   - Call: `text, keyboard = await container.message.admin.vip.channel_configured_success(channel_title, channel_id)`
   - Remove text construction (lines 202-209)

4. `callback_generate_token_select_plan` - no plans case (line 258-268):
   - Call: `text, keyboard = await container.message.admin.vip.no_plans_configured()`
   - Remove text/keyboard construction

5. `callback_generate_token_with_plan` success (line 361-399):
   - Call: `text, keyboard = await container.message.admin.vip.token_generated(...)`
   - Remove text construction (lines 369-389)

6. `callback_vip_config` (line 422-454):
   - Keep simple (config submenu, can be migrated in main.py plan or leave as-is for now)

**Error handling:**
- Keep existing try/except blocks for edit_text "message is not modified"
- Keep validation logic for channel setup
- Only replace message text/keyboard construction

**DO NOT change:**
- Handler logic and flow
- FSM state transitions
- Database queries
- Callback data strings
- Logging statements
</action>
  <verify>grep -n "container.message.admin.vip" bot/handlers/admin/vip.py | wc -l</verify>
  <done>vip.py uses container.message.admin.vip for all messages, no hardcoded HTML strings remain</done>
</task>

</tasks>

<verification>
1. AdminVIPMessages class imported successfully
2. All required methods return (text, keyboard) tuples
3. LucienVoiceService has admin namespace with vip property
4. vip.py handlers call container.message.admin.vip methods
5. No hardcoded message strings in vip.py
6. Voice consistency: "c铆rculo exclusivo", "invitaci贸n", "calibraci贸n" used
7. 2-3 greeting variations implemented in vip_menu() using weighted random.choices()
8. Keyboards integrated in all provider methods
9. Formatters (format_datetime, format_currency) used for dynamic data
</verification>

<success_criteria>
1. Admin can navigate VIP menu and all messages come from LucienVoiceService
2. VIP menu shows 2-3 variations for greeting using weighted selection
3. Token generation message adapts based on plan selected
4. Each message method returns tuple (text, keyboard)
5. Channel setup prompt uses conditional states (is_configured flag)
6. Zero hardcoded message strings in vip.py handlers
7. All voice rules from guia-estilo.md followed
8. Weighted variations use random.choices() with weights parameter
</success_criteria>

<output>
After completion, create `.planning/phases/02-template-organization-admin-migration/02-01-SUMMARY.md` with:
- Files modified: admin_vip.py (new), vip.py, __init__.py
- Methods created in AdminVIPMessages
- Handlers migrated
- Voice patterns implemented
- Weighted variation implementation
- Next steps for 02-02 plan
</output>
