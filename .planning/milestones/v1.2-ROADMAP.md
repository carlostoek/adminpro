# Milestone v1.2: Primer Despliegue

**Status:** ✅ SHIPPED 2026-01-30
**Phases:** 14-18
**Total Plans:** 21

## Overview

Transformación desde un bot Telegram local con SQLite hacia una solución production-ready en Railway con PostgreSQL, testing comprehensivo y profiling de performance. El viaje establece infraestructura de despliegue (v1.2), cimiento para caching avanzado (v1.3), y optimización continua.

## Phases

### Phase 14: Database Migration Foundation

**Goal**: PostgreSQL-ready database layer with automatic dialect detection and Alembic migrations
**Depends on**: Phase 13 (v1.1 complete)
**Plans**: 4 plans

Plans:

- [x] 14-01: Database abstraction layer with dialect detection
- [x] 14-02a: Alembic configuration
- [x] 14-02b: Initial migration generation
- [x] 14-03: Auto-migration on startup and rollback support

**Details:**
- PostgreSQL and SQLite dual-dialect support with automatic URL detection
- Database URL parser with automatic dialect detection and driver auto-injection
- Refactored engine.py with dialect-specific initialization (QueuePool for PostgreSQL, NullPool for SQLite)
- Alembic configured with initial migration creating all 9 tables
- Auto-migration on startup in production mode (ENV=production)
- Rollback support with scripts/migrate.py helper

---

### Phase 15: Health Check & Railway Preparation

**Goal**: Health monitoring endpoint and Railway deployment configuration
**Depends on**: Phase 14
**Plans**: 5 plans

Plans:

- [x] 15-01: FastAPI health check endpoint with DB status
- [x] 15-02: Concurrent bot and health API execution
- [x] 15-03: Railway.toml and Dockerfile configuration
- [x] 15-04: Environment variable validation and webhook/polling mode switching
- [x] 15-05: Graceful shutdown fix - Bot responds to Ctrl+C (gap closure)

**Details:**
- FastAPI health check endpoint returning 200/503 based on system health
- Bot and database health checks with comprehensive error handling
- Concurrent execution of bot and health API on separate ports
- Railway.toml configuration for deployment monitoring
- Dockerfile optimized for Railway with multi-stage build and non-root user
- Graceful shutdown with 10-second timeout (down from 150s)

---

### Phase 16: Testing Infrastructure

**Goal**: pytest-asyncio setup with fixtures and in-memory database
**Depends on**: Phase 15
**Plans**: 5 plans

Plans:

- [x] 16-01: pytest-asyncio configuration with async_mode=auto
- [x] 16-02: Core test fixtures (test_db, mock_bot, container)
- [x] 16-03: In-memory database setup with automatic cleanup
- [x] 16-04: Test isolation with transaction rollback
- [x] 16-05: Coverage reporting configuration

**Details:**
- pytest-asyncio configured with asyncio_mode=auto
- 7 fixtures created: test_db, test_session, test_engine, test_invitation_token, mock_bot, container, container_with_preload
- SQLite in-memory database with proper setup/teardown lifecycle
- 44 infrastructure tests passing with complete isolation
- Coverage reporting with branch coverage enabled

---

### Phase 17: System Tests

**Goal**: Comprehensive test coverage for critical flows and message providers
**Depends on**: Phase 16
**Plans**: 4 plans

Plans:

- [x] 17-01: System startup and configuration tests
- [x] 17-02: Menu system tests (Admin/VIP/Free with FSM)
- [x] 17-03: Role detection and user management tests
- [x] 17-04: VIP/Free flow tests and message provider tests

**Details:**
- 212 tests created covering all critical flows
- System startup tests (database, ServiceContainer, BotConfig, background tasks)
- Menu system tests for Admin/VIP/Free with FSM state validation
- Role detection tests validating Admin > VIP > Free priority
- VIP/Free flow tests for tokens, ritual entry, and free approval
- Message provider tests for all 13 Lucien voice providers

---

### Phase 18: Admin Test Runner & Performance Profiling

**Goal**: Centralized test execution and performance bottleneck detection
**Depends on**: Phase 17
**Plans**: 3 plans (plus UAT gap closure)

Plans:

- [x] 18-01: Admin test runner script and Telegram command
- [x] 18-02: Test reporting with coverage and detailed results
- [x] 18-03: Performance profiling with pyinstrument integration
- [x] 18-04: SQLite → PostgreSQL data migration script and N+1 query detection
- [x] 18-05: Fix CLI test runner stdin handling (gap closure)

**Details:**
- CLI test runner script (scripts/run_tests.py) with multiple output formats
- Telegram /run_tests command for admin test execution
- Test reporting with coverage trends, historical tracking, HTML reports
- Performance profiling with pyinstrument integration
- N+1 query detection with SQLAlchemy event monitoring
- SQLite to PostgreSQL migration script with row validation
- Query analyzer utility with eager loading optimization suggestions

---

## Milestone Summary

### Key Decisions

- **Auto-inject database drivers**: Users can use `sqlite://` instead of `sqlite+aiosqlite://`
- **QueuePool for PostgreSQL, NullPool for SQLite**: Appropriate pooling per dialect
- **Fail-fast migration strategy**: Bot does not start if migrations fail in production
- **Separate FastAPI health server**: Independent monitoring from aiogram dispatcher
- **pytest-asyncio auto mode**: No `@pytest.mark.asyncio` decorator needed
- **In-memory SQLite for tests**: Fast, isolated test execution
- **Statistical profiling with pyinstrument**: Low overhead suitable for production

### Issues Resolved

- **uvicorn[standard] build failure on Termux ARM**: Excluded uvloop dependency
- **Graceful shutdown timeout**: Reduced from 150s to 10s for responsive Ctrl+C
- **CLI test runner freeze**: Fixed stdin inheritance causing pytest to wait for input
- **MagicMock event handling**: Added detection before attaching SQLAlchemy event listeners

### Issues Deferred

- **Redis caching layer**: Deferred to v1.3 (requires additional architecture)
- **Monitoring dashboard**: Requires production-stable system first
- **Load testing**: Requires production deployment
- **Automated backups**: Railway feature to configure in v1.3+

### Technical Debt

- **DBMIG-05**: Migration script implemented but not executed in production (will validate during v1.3 deployment)
- **Profile handlers gating**: PROFILE_HANDLERS env var required for automatic profiling (production safety)

---

_For current project status, see .planning/ROADMAP.md_
