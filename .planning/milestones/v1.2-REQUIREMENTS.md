# Requirements Archive: v1.2 Primer Despliegue

**Archived:** 2026-02-01
**Status:** ✅ SHIPPED

This is the archived requirements specification for v1.2.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

# Requirements: LucienVoiceService - v1.2 Primer Despliegue

**Defined:** 2026-01-28
**Core Value:** Consistencia absoluta en la voz de Lucien: cada mensaje del bot debe sonar elegante, misterioso y natural viniendo del mayordomo, sin importar que handler o flujo lo invoque.

## v1.2 Requirements (All Completed)

### Database Migration (DBMIG)

- [x] **DBMIG-01**: Sistema soporta PostgreSQL y SQLite con cambio vía variable de entorno
- [x] **DBMIG-02**: Motor de base de datos detecta automáticamente el dialecto (postgresql+asyncpg vs sqlite+aiosqlite)
- [x] **DBMIG-03**: Alembic está configurado con migración inicial
- [x] **DBMIG-04**: Sistema ejecuta migraciones automáticamente al iniciar (producción)
- [x] **DBMIG-05**: Script de migración de datos SQLite → PostgreSQL (Phase 18)
- [x] **DBMIG-06**: Validación de tipos en todos los modelos previo a migración
- [x] **DBMIG-07**: Rolling back de migraciones soportado

### Health Monitoring (HEALTH)

- [x] **HEALTH-01**: Endpoint HTTP /health retorna estado del bot
- [x] **HEALTH-02**: Health check verifica conexión a base de datos
- [x] **HEALTH-03**: Health check retorna 200 OK si todo está bien, 503 si hay errores
- [x] **HEALTH-04**: Health check se ejecuta en puerto separado (FastAPI + uvicorn)
- [x] **HEALTH-05**: Bot y API de salud corren concurrentemente

### Railway Preparation (RAIL)

- [x] **RAIL-01**: Railway.toml configurado con comando de inicio y health check path
- [x] **RAIL-02**: Dockerfile creado para despliegue en Railway
- [x] **RAIL-03**: Variables de entorno requeridas documentadas
- [x] **RAIL-04**: Validación de variables de entorno al inicio
- [x] **RAIL-05**: Bot puede cambiar entre polling y webhook vía variable de entorno

### Testing Infrastructure (TESTINF)

- [x] **TESTINF-01**: pytest-asyncio configurado con async_mode=auto
- [x] **TESTINF-02**: Fixtures creados (test_db, mock_bot, container)
- [x] **TESTINF-03**: Base de datos en memoria para tests (sqlite+aiosqlite:///:memory:)
- [x] **TESTINF-04**: Aislamiento de tests (cleanup entre tests)
- [x] **TESTINF-05**: Configuración de coverage reporting

### System Tests (TESTSYS)

- [x] **TESTSYS-01**: Test de arranque del sistema (bot inicia, DB conecta, servicios cargan)
- [x] **TESTSYS-02**: Test de handlers de menú principal Admin
- [x] **TESTSYS-03**: Test de handlers de menú VIP
- [x] **TESTSYS-04**: Test de handlers de menú Free
- [x] **TESTSYS-05**: Test de detección de roles (Admin > VIP > Free)
- [x] **TESTSYS-06**: Test de flujo de entrada al canal Free
- [x] **TESTSYS-07**: Test de generación de tokens VIP
- [x] **TESTSYS-08**: Test de flujo ritualizado de entrada VIP (3 etapas)
- [x] **TESTSYS-09**: Test de gestión de configuración (BotConfig)
- [x] **TESTSYS-10**: Test de proveedores de mensajes de Lucien (13 providers)

### Admin Test Runner (ADMINTEST)

- [x] **ADMINTEST-01**: Script /run_tests ejecuta todos los tests
- [x] **ADMINTEST-02**: Admin puede ejecutar tests desde Telegram con comando
- [x] **ADMINTEST-03**: Test runner retorna resultado detallado (pass/fail, coverage)
- [x] **ADMINTEST-04**: Test runner envía reporte al admin via mensaje

### Performance (PERF)

- [x] **PERF-01**: Integración con pyinstrument para profiling
- [x] **PERF-02**: Script para profiling de handlers específicos
- [x] **PERF-03**: Detección de N+1 queries con logs de SQLAlchemy
- [x] **PERF-04**: Optimización de eager loading (selectinload) donde sea necesario

## v1.3 Requirements (Deferred)

### Redis Caching (CACHE)

- **CACHE-01**: Redis FSM state storage (aiogram RedisStorage)
- **CACHE-02**: CacheService para caching de aplicación
- **CACHE-03**: Invalidation de cache en operaciones de escritura
- **CACHE-04**: Multi-layer caching (BotConfig, roles, channels)
- **CACHE-05**: Graceful degradation cuando Redis no está disponible

## Out of Scope

Explícitamente excluidos de v1.2:

| Feature | Reason |
|---------|--------|
| Railway deployment execution | Preparación solo; deploy execution en v1.3+ |
| Redis caching layer | Requiere arquitectura adicional; diferido a v1.3 |
| Monitoring dashboard | Requiere sistema estable primero; v1.3+ |
| Load testing | Requiere producción estable; v1.3+ |
| Automated backups | Feature de Railway; config en v1.3+ |

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| DBMIG-01 | Phase 14 | Complete |
| DBMIG-02 | Phase 14 | Complete |
| DBMIG-03 | Phase 14 | Complete |
| DBMIG-04 | Phase 14 | Complete |
| DBMIG-05 | Phase 18 | Complete |
| DBMIG-06 | Phase 14 | Complete |
| DBMIG-07 | Phase 14 | Complete |
| HEALTH-01 | Phase 15 | Complete |
| HEALTH-02 | Phase 15 | Complete |
| HEALTH-03 | Phase 15 | Complete |
| HEALTH-04 | Phase 15 | Complete |
| HEALTH-05 | Phase 15 | Complete |
| RAIL-01 | Phase 15 | Complete |
| RAIL-02 | Phase 15 | Complete |
| RAIL-03 | Phase 15 | Complete |
| RAIL-04 | Phase 15 | Complete |
| RAIL-05 | Phase 15 | Complete |
| TESTINF-01 | Phase 16 | Complete |
| TESTINF-02 | Phase 16 | Complete |
| TESTINF-03 | Phase 16 | Complete |
| TESTINF-04 | Phase 16 | Complete |
| TESTINF-05 | Phase 16 | Complete |
| TESTSYS-01 | Phase 17 | Complete |
| TESTSYS-02 | Phase 17 | Complete |
| TESTSYS-03 | Phase 17 | Complete |
| TESTSYS-04 | Phase 17 | Complete |
| TESTSYS-05 | Phase 17 | Complete |
| TESTSYS-06 | Phase 17 | Complete |
| TESTSYS-07 | Phase 17 | Complete |
| TESTSYS-08 | Phase 17 | Complete |
| TESTSYS-09 | Phase 17 | Complete |
| TESTSYS-10 | Phase 17 | Complete |
| ADMINTEST-01 | Phase 18 | Complete |
| ADMINTEST-02 | Phase 18 | Complete |
| ADMINTEST-03 | Phase 18 | Complete |
| ADMINTEST-04 | Phase 18 | Complete |
| PERF-01 | Phase 18 | Complete |
| PERF-02 | Phase 18 | Complete |
| PERF-03 | Phase 18 | Complete |
| PERF-04 | Phase 18 | Complete |

**Coverage:**
- v1.2 requirements: 37 total
- Completed: 37 (100%)
- Unmapped: 0 ✓

---

## Milestone Summary

**Shipped:** 37 of 37 v1.2 requirements (100%)

**Adjusted:**
- DBMIG-05: Originally marked as "Pending" in REQUIREMENTS.md but implemented in Phase 18-04
- Multiple TESTINF/TESTSYS/ADMINTEST/PERF requirements: Originally marked as pending but all completed

**Dropped:** None

**Notes:**
- All 37 requirements mapped to phases were completed
- 212 tests passing covering all critical flows
- Performance profiling infrastructure in place
- Database migration tools ready for v1.3 deployment

---

*Archived: 2026-02-01 as part of v1.2 milestone completion*
