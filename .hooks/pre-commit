#!/usr/bin/env python3
"""
Pre-commit hook for voice consistency validation.

This script runs automatically on git commit to check that message provider
files conform to Lucien's voice guidelines. It only checks staged files in
bot/services/message/*.py and blocks commits with violations.

Run with --no-verify to bypass: git commit --no-verify
"""

import sys
import subprocess
from pathlib import Path

# Add parent directory to sys.path to import bot.utils.voice_linter
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from bot.utils.voice_linter import check_file


def get_staged_files() -> list[Path]:
    """Get list of staged Python files.

    Returns:
        List of Path objects for staged files
    """
    # Get staged files (added, copied, modified)
    result = subprocess.run(
        ["git", "diff", "--cached", "--name-only", "--diff-filter=ACM"],
        capture_output=True,
        text=True,
        check=True
    )

    staged_files = []
    for line in result.stdout.strip().split("\n"):
        if line:
            filepath = Path(line)
            if filepath.exists():
                staged_files.append(filepath)

    return staged_files


def is_message_provider_file(filepath: Path) -> bool:
    """Check if file is a message provider.

    Args:
        filepath: Path to check

    Returns:
        True if file is in bot/services/message/*.py
    """
    try:
        # Check if path matches bot/services/message/*.py
        parts = filepath.parts
        if len(parts) >= 3 and parts[0] == "bot" and parts[1] == "services" and parts[2] == "message":
            return filepath.suffix == ".py"
    except (ValueError, IndexError):
        pass

    return False


def main() -> int:
    """Main pre-commit hook entry point.

    Returns:
        0 if no violations (commit allowed)
        1 if violations found (commit blocked)
    """
    # Get staged files
    staged_files = get_staged_files()

    # Filter for message provider files only
    message_files = [f for f in staged_files if is_message_provider_file(f)]

    # Return success if no message provider files changed
    if not message_files:
        return 0

    # Check all message files for violations
    all_violations = []
    for filepath in message_files:
        violations = check_file(filepath)
        for violation in violations:
            all_violations.append((filepath, violation))

    # Return success if no violations
    if not all_violations:
        return 0

    # Print violations and block commit
    print("‚ùå Voice consistency violations detected:\n")

    for filepath, violation in all_violations:
        print(f"  {filepath}:{violation['line']}")
        violation_type = violation["type"].upper().replace("_", " ")
        print(f"    {violation_type}: {violation['message']}\n")

    print("Please fix these violations before committing.")
    print("Voice guidelines: docs/guia-estilo.md")
    print("\nTo bypass this hook (use sparingly): git commit --no-verify")

    return 1


if __name__ == "__main__":
    sys.exit(main())
